!(function(e,t){var r=[],i=e.CANNON||this.CANNON,n=e.OIMO||this.OIMO,s=e.earcut||this.earcut;if("object"==typeof exports&&"object"==typeof module){try{i=i||require("cannon")}catch(e){}try{n=n||require("oimo")}catch(e){}try{s=s||require("earcut")}catch(e){}module.exports=t(i,n,s)}else if("function"==typeof define&&define.amd)require.specified&&require.specified("cannon")&&r.push("cannon"),require.specified&&require.specified("oimo")&&r.push("oimo"),require.specified&&require.specified("earcut")&&r.push("earcut"),define("babylonjs",r,t);else if("object"==typeof exports){try{i=i||require("cannon")}catch(e){}try{n=n||require("oimo")}catch(e){}try{s=s||require("earcut")}catch(e){}exports.babylonjs=t(i,n,s)}else e.BABYLON=t(i,n,s)})(this,(function(e,t,r){e=e||this.CANNON,t=t||this.OIMO,r=r||this.earcut;var i,n=this&&this.__decorate||function(e,t,r,i){var n,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(s<3?n(o):s>3?n(t,r,o):n(t,r))||o);return s>3&&o&&Object.defineProperty(t,r,o),o},s=this&&this.__extends||(function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}})();!(function(e){var t=(function(){function e(){this._defines={},this._currentRank=32,this._maxRank=-1}return e.prototype.unBindMesh=function(){this._mesh=null},e.prototype.addFallback=function(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)},e.prototype.addCPUSkinningFallback=function(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)},Object.defineProperty(e.prototype,"isMoreFallbacks",{get:function(){return this._currentRank<=this._maxRank},enumerable:!0,configurable:!0}),e.prototype.reduce=function(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0&&this._mesh.material){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;for(var r=this._mesh.getScene(),i=0;i<r.meshes.length;i++){var n=r.meshes[i];if(n.material&&(n.computeBonesUsingShaders&&0!==n.numBoneInfluencers))if(n.material.getEffect()===t)n.computeBonesUsingShaders=!1;else if(n.subMeshes)for(var s=0,o=n.subMeshes;s<o.length;s++){var a=o[s],h=a.effect;if(h===t){n.computeBonesUsingShaders=!1;break}}}}else{var u=this._defines[this._currentRank];if(u)for(var i=0;i<u.length;i++)e=e.replace("#define "+u[i],"");this._currentRank++}return e},e})();e.EffectFallbacks=t;var r=(function(){function e(){}return e})();e.EffectCreationOptions=r;var i=(function(){function t(r,i,n,s,o,a,h,u,l,c){void 0===s&&(s=null),void 0===a&&(a=null),void 0===h&&(h=null),void 0===u&&(u=null),void 0===l&&(l=null);var f=this;if(this.uniqueId=0,this.onCompileObservable=new e.Observable,this.onErrorObservable=new e.Observable,this.onBindObservable=new e.Observable,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._isReady=!1,this._compilationError="",this.name=r,i.attributes){var d=i;if(this._engine=n,this._attributesNames=d.attributes,this._uniformsNames=d.uniformsNames.concat(d.samplers),this._samplers=d.samplers.slice(),this.defines=d.defines,this.onError=d.onError,this.onCompiled=d.onCompiled,this._fallbacks=d.fallbacks,this._indexParameters=d.indexParameters,this._transformFeedbackVaryings=d.transformFeedbackVaryings,d.uniformBuffersNames)for(var p=0;p<d.uniformBuffersNames.length;p++)this._uniformBuffersNames[d.uniformBuffersNames[p]]=p}else this._engine=o,this.defines=a,this._uniformsNames=n.concat(s),this._samplers=s?s.slice():[],this._attributesNames=i,this.onError=l,this.onCompiled=u,this._indexParameters=c,this._fallbacks=h;this.uniqueId=t._uniqueIdSeed++;var _,m;r.vertexElement?(_=document.getElementById(r.vertexElement))||(_=r.vertexElement):_=r.vertex||r,r.fragmentElement?(m=document.getElementById(r.fragmentElement))||(m=r.fragmentElement):m=r.fragment||r,this._loadVertexShader(_,(function(e){f._processIncludes(e,(function(e){f._processShaderConversion(e,!1,(function(e){f._loadFragmentShader(m,(function(t){f._processIncludes(t,(function(t){f._processShaderConversion(t,!0,(function(t){if(r){var i=r.vertexElement||r.vertex||r,n=r.fragmentElement||r.fragment||r;f._vertexSourceCode="#define SHADER_NAME vertex:"+i+"\n"+e,f._fragmentSourceCode="#define SHADER_NAME fragment:"+n+"\n"+t}else f._vertexSourceCode=e,f._fragmentSourceCode=t;f._prepareEffect()}))}))}))}))}))}))}return Object.defineProperty(t.prototype,"key",{get:function(){return this._key},enumerable:!0,configurable:!0}),t.prototype.isReady=function(){return this._isReady},t.prototype.getEngine=function(){return this._engine},t.prototype.getProgram=function(){return this._program},t.prototype.getAttributesNames=function(){return this._attributesNames},t.prototype.getAttributeLocation=function(e){return this._attributes[e]},t.prototype.getAttributeLocationByName=function(e){var t=this._attributesNames.indexOf(e);return this._attributes[t]},t.prototype.getAttributesCount=function(){return this._attributes.length},t.prototype.getUniformIndex=function(e){return this._uniformsNames.indexOf(e)},t.prototype.getUniform=function(e){return this._uniforms[this._uniformsNames.indexOf(e)]},t.prototype.getSamplers=function(){return this._samplers},t.prototype.getCompilationError=function(){return this._compilationError},t.prototype.executeWhenCompiled=function(e){if(this.isReady())return void e(this);this.onCompileObservable.add((function(t){e(t)}))},t.prototype._loadVertexShader=function(r,i){if(e.Tools.IsWindowObjectExist()&&r instanceof HTMLElement){return void i(e.Tools.GetDOMTextContent(r))}if("base64:"===r.substr(0,7)){return void i(window.atob(r.substr(7)))}if(t.ShadersStore[r+"VertexShader"])return void i(t.ShadersStore[r+"VertexShader"]);var n;n="."===r[0]||"/"===r[0]||r.indexOf("http")>-1?r:e.Engine.ShadersRepository+r,this._engine._loadFile(n+".vertex.fx",i)},t.prototype._loadFragmentShader=function(r,i){if(e.Tools.IsWindowObjectExist()&&r instanceof HTMLElement){return void i(e.Tools.GetDOMTextContent(r))}if("base64:"===r.substr(0,7)){return void i(window.atob(r.substr(7)))}if(t.ShadersStore[r+"PixelShader"])return void i(t.ShadersStore[r+"PixelShader"]);if(t.ShadersStore[r+"FragmentShader"])return void i(t.ShadersStore[r+"FragmentShader"]);var n;n="."===r[0]||"/"===r[0]||r.indexOf("http")>-1?r:e.Engine.ShadersRepository+r,this._engine._loadFile(n+".fragment.fx",i)},t.prototype._dumpShadersSource=function(t,r,i){var n=this._engine.webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",s=n+(i?i+"\n":"");t=s+t,r=s+r;var o=2,a=/\n/gm,h="\n1\t"+t.replace(a,(function(){return"\n"+o+++"\t"}));o=2;var u="\n1\t"+r.replace(a,(function(){return"\n"+o+++"\t"}));this.name.vertexElement?(e.Tools.Error("Vertex shader: "+this.name.vertexElement+h),e.Tools.Error("Fragment shader: "+this.name.fragmentElement+u)):this.name.vertex?(e.Tools.Error("Vertex shader: "+this.name.vertex+h),e.Tools.Error("Fragment shader: "+this.name.fragment+u)):(e.Tools.Error("Vertex shader: "+this.name+h),e.Tools.Error("Fragment shader: "+this.name+u))},t.prototype._processShaderConversion=function(e,t,r){var i=this._processPrecision(e);if(1==this._engine.webGLVersion)return void r(i);if(-1!==i.indexOf("#version 3"))return void r(i.replace("#version 300 es",""));var n=-1!==i.search(/#extension.+GL_EXT_draw_buffers.+require/),s=/#extension.+(GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,o=i.replace(s,"");o=o.replace(/varying(?![\n\r])\s/g,t?"in ":"out "),o=o.replace(/attribute[ \t]/g,"in "),o=o.replace(/[ \t]attribute/g," in"),t&&(o=o.replace(/texture2DLodEXT\s*\(/g,"textureLod("),o=o.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),o=o.replace(/texture2D\s*\(/g,"texture("),o=o.replace(/textureCube\s*\(/g,"texture("),o=o.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),o=o.replace(/gl_FragColor/g,"glFragColor"),o=o.replace(/gl_FragData/g,"glFragData"),o=o.replace(/void\s+?main\s*\(/g,(n?"":"out vec4 glFragColor;\n")+"void main(")),r(o)},t.prototype._processIncludes=function(r,i){for(var n=this,s=/#include<(.+)>(\((.*)\))*(\[(.*)\])*/g,o=s.exec(r),a=new String(r);null!=o;){var h=o[1];if(-1!==h.indexOf("__decl__")&&(h=h.replace(/__decl__/,""),this._engine.supportsUniformBuffers&&(h=h.replace(/Vertex/,"Ubo"),h=h.replace(/Fragment/,"Ubo")),h+="Declaration"),!t.IncludesShadersStore[h]){var u=e.Engine.ShadersRepository+"ShadersInclude/"+h+".fx";return void this._engine._loadFile(u,(function(e){t.IncludesShadersStore[h]=e,n._processIncludes(a,i)}))}var l=t.IncludesShadersStore[h];if(o[2])for(var c=o[3].split(","),f=0;f<c.length;f+=2){var d=new RegExp(c[f],"g"),p=c[f+1];l=l.replace(d,p)}if(o[4]){var _=o[5];if(-1!==_.indexOf("..")){var m=_.split(".."),g=parseInt(m[0]),v=parseInt(m[1]),y=l.slice(0);l="",isNaN(v)&&(v=this._indexParameters[m[1]]);for(var b=g;b<v;b++)this._engine.supportsUniformBuffers||(y=y.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),l+=y.replace(/\{X\}/g,b.toString())+"\n"}else this._engine.supportsUniformBuffers||(l=l.replace(/light\{X\}.(\w*)/g,(function(e,t){return t+"{X}"}))),l=l.replace(/\{X\}/g,_)}a=a.replace(o[0],l),o=s.exec(r)}i(a)},t.prototype._processPrecision=function(e){return-1===e.indexOf("precision highp float")?e=this._engine.getCaps().highPrecisionShaderSupported?"precision highp float;\n"+e:"precision mediump float;\n"+e:this._engine.getCaps().highPrecisionShaderSupported||(e=e.replace("precision highp float","precision mediump float")),e},t.prototype._rebuildProgram=function(t,r,i,n){var s=this;this._isReady=!1,this._vertexSourceCodeOverride=t,this._fragmentSourceCodeOverride=r,this.onError=function(e,t){n&&n(t)},this.onCompiled=function(){for(var t=s.getEngine().scenes,r=0;r<t.length;r++)t[r].markAllMaterialsAsDirty(e.Material.TextureDirtyFlag);i&&i(s._program)},this._fallbacks=null,this._prepareEffect()},t.prototype.getSpecificUniformLocations=function(e){return this._engine.getUniforms(this._program,e)},t.prototype._prepareEffect=function(){var t=this._attributesNames,r=this.defines,i=this._fallbacks;this._valueCache={};var n=this._program;try{var s=this._engine;if(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._program=s.createRawShaderProgram(this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,void 0,this._transformFeedbackVaryings):this._program=s.createShaderProgram(this._vertexSourceCode,this._fragmentSourceCode,r,void 0,this._transformFeedbackVaryings),this._program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this),s.supportsUniformBuffers)for(var o in this._uniformBuffersNames)this.bindUniformBlock(o,this._uniformBuffersNames[o]);this._uniforms=s.getUniforms(this._program,this._uniformsNames),this._attributes=s.getAttributes(this._program,t);var a;for(a=0;a<this._samplers.length;a++){null==this.getUniform(this._samplers[a])&&(this._samplers.splice(a,1),a--)}s.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),n&&this.getEngine()._deleteProgram(n)}catch(s){this._compilationError=s.message,e.Tools.Error("Unable to compile effect:"),e.Tools.Error("Uniforms: "+this._uniformsNames.map((function(e){return" "+e}))),e.Tools.Error("Attributes: "+t.map((function(e){return" "+e}))),this._dumpShadersSource(this._vertexSourceCode,this._fragmentSourceCode,r),e.Tools.Error("Error: "+this._compilationError),n&&(this._program=n,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)),i&&i.isMoreFallbacks?(e.Tools.Error("Trying next fallback."),this.defines=i.reduce(this.defines,this),this._prepareEffect()):(this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())}},Object.defineProperty(t.prototype,"isSupported",{get:function(){return""===this._compilationError},enumerable:!0,configurable:!0}),t.prototype._bindTexture=function(e,t){this._engine._bindTexture(this._samplers.indexOf(e),t)},t.prototype.setTexture=function(e,t){this._engine.setTexture(this._samplers.indexOf(e),this.getUniform(e),t)},t.prototype.setDepthStencilTexture=function(e,t){this._engine.setDepthStencilTexture(this._samplers.indexOf(e),this.getUniform(e),t)},t.prototype.setTextureArray=function(e,t){if(-1===this._samplers.indexOf(e+"Ex"))for(var r=this._samplers.indexOf(e),i=1;i<t.length;i++)this._samplers.splice(r+i,0,e+"Ex");this._engine.setTextureArray(this._samplers.indexOf(e),this.getUniform(e),t)},t.prototype.setTextureFromPostProcess=function(e,t){this._engine.setTextureFromPostProcess(this._samplers.indexOf(e),t)},t.prototype.setTextureFromPostProcessOutput=function(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers.indexOf(e),t)},t.prototype._cacheMatrix=function(e,t){var r=this._valueCache[e],i=t.updateFlag;return(void 0===r||r!==i)&&(this._valueCache[e]=i,!0)},t.prototype._cacheFloat2=function(e,t,r){var i=this._valueCache[e];if(!i)return i=[t,r],this._valueCache[e]=i,!0;var n=!1;return i[0]!==t&&(i[0]=t,n=!0),i[1]!==r&&(i[1]=r,n=!0),n},t.prototype._cacheFloat3=function(e,t,r,i){var n=this._valueCache[e];if(!n)return n=[t,r,i],this._valueCache[e]=n,!0;var s=!1;return n[0]!==t&&(n[0]=t,s=!0),n[1]!==r&&(n[1]=r,s=!0),n[2]!==i&&(n[2]=i,s=!0),s},t.prototype._cacheFloat4=function(e,t,r,i,n){var s=this._valueCache[e];if(!s)return s=[t,r,i,n],this._valueCache[e]=s,!0;var o=!1;return s[0]!==t&&(s[0]=t,o=!0),s[1]!==r&&(s[1]=r,o=!0),s[2]!==i&&(s[2]=i,o=!0),s[3]!==n&&(s[3]=n,o=!0),o},t.prototype.bindUniformBuffer=function(e,r){var i=this._uniformBuffersNames[r];void 0!==i&&t._baseCache[i]!==e&&(t._baseCache[i]=e,this._engine.bindUniformBufferBase(e,i))},t.prototype.bindUniformBlock=function(e,t){this._engine.bindUniformBlock(this._program,e,t)},t.prototype.setInt=function(e,t){var r=this._valueCache[e];return void 0!==r&&r===t?this:(this._valueCache[e]=t,this._engine.setInt(this.getUniform(e),t),this)},t.prototype.setIntArray=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray(this.getUniform(e),t),this},t.prototype.setIntArray2=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray2(this.getUniform(e),t),this},t.prototype.setIntArray3=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray3(this.getUniform(e),t),this},t.prototype.setIntArray4=function(e,t){return this._valueCache[e]=null,this._engine.setIntArray4(this.getUniform(e),t),this},t.prototype.setFloatArray=function(e,t){return this._valueCache[e]=null,this._engine.setFloatArray(this.getUniform(e),t),this},t.prototype.setFloatArray2=function(e,t){return this._valueCache[e]=null,this._engine.setFloatArray2(this.getUniform(e),t),this},t.prototype.setFloatArray3=function(e,t){return this._valueCache[e]=null,this._engine.setFloatArray3(this.getUniform(e),t),this},t.prototype.setFloatArray4=function(e,t){return this._valueCache[e]=null,this._engine.setFloatArray4(this.getUniform(e),t),this},t.prototype.setArray=function(e,t){return this._valueCache[e]=null,this._engine.setArray(this.getUniform(e),t),this},t.prototype.setArray2=function(e,t){return this._valueCache[e]=null,this._engine.setArray2(this.getUniform(e),t),this},t.prototype.setArray3=function(e,t){return this._valueCache[e]=null,this._engine.setArray3(this.getUniform(e),t),this},t.prototype.setArray4=function(e,t){return this._valueCache[e]=null,this._engine.setArray4(this.getUniform(e),t),this},t.prototype.setMatrices=function(e,t){return t?(this._valueCache[e]=null,this._engine.setMatrices(this.getUniform(e),t),this):this},t.prototype.setMatrix=function(e,t){return this._cacheMatrix(e,t)&&this._engine.setMatrix(this.getUniform(e),t),this},t.prototype.setMatrix3x3=function(e,t){return this._valueCache[e]=null,this._engine.setMatrix3x3(this.getUniform(e),t),this},t.prototype.setMatrix2x2=function(e,t){return this._valueCache[e]=null,this._engine.setMatrix2x2(this.getUniform(e),t),this},t.prototype.setFloat=function(e,t){var r=this._valueCache[e];return void 0!==r&&r===t?this:(this._valueCache[e]=t,this._engine.setFloat(this.getUniform(e),t),this)},t.prototype.setBool=function(e,t){var r=this._valueCache[e];return void 0!==r&&r===t?this:(this._valueCache[e]=t,this._engine.setBool(this.getUniform(e),t?1:0),this)},t.prototype.setVector2=function(e,t){return this._cacheFloat2(e,t.x,t.y)&&this._engine.setFloat2(this.getUniform(e),t.x,t.y),this},t.prototype.setFloat2=function(e,t,r){return this._cacheFloat2(e,t,r)&&this._engine.setFloat2(this.getUniform(e),t,r),this},t.prototype.setVector3=function(e,t){return this._cacheFloat3(e,t.x,t.y,t.z)&&this._engine.setFloat3(this.getUniform(e),t.x,t.y,t.z),this},t.prototype.setFloat3=function(e,t,r,i){return this._cacheFloat3(e,t,r,i)&&this._engine.setFloat3(this.getUniform(e),t,r,i),this},t.prototype.setVector4=function(e,t){return this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&this._engine.setFloat4(this.getUniform(e),t.x,t.y,t.z,t.w),this},t.prototype.setFloat4=function(e,t,r,i,n){return this._cacheFloat4(e,t,r,i,n)&&this._engine.setFloat4(this.getUniform(e),t,r,i,n),this},t.prototype.setColor3=function(e,t){return this._cacheFloat3(e,t.r,t.g,t.b)&&this._engine.setColor3(this.getUniform(e),t),this},t.prototype.setColor4=function(e,t,r){return this._cacheFloat4(e,t.r,t.g,t.b,r)&&this._engine.setColor4(this.getUniform(e),t,r),this},t.prototype.setDirectColor4=function(e,t){return this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&this._engine.setDirectColor4(this.getUniform(e),t),this},t.ResetCache=function(){t._baseCache={}},t._uniqueIdSeed=0,t._baseCache={},t.ShadersStore={},t.IncludesShadersStore={},t})();e.Effect=i})(i||(i={}));var i;!(function(e){var t=(function(){function e(){}return Object.defineProperty(e,"KEYDOWN",{get:function(){return e._KEYDOWN},enumerable:!0,configurable:!0}),Object.defineProperty(e,"KEYUP",{get:function(){return e._KEYUP},enumerable:!0,configurable:!0}),e._KEYDOWN=1,e._KEYUP=2,e})();e.KeyboardEventTypes=t;var r=(function(){function e(e,t){this.type=e,this.event=t}return e})();e.KeyboardInfo=r;var i=(function(e){function t(t,r){var i=e.call(this,t,r)||this;return i.skipOnPointerObservable=!1,i}return s(t,e),t})(r);e.KeyboardInfoPre=i})(i||(i={}));var i;!(function(e){var t=(function(){function e(){}return Object.defineProperty(e,"POINTERDOWN",{get:function(){return e._POINTERDOWN},enumerable:!0,configurable:!0}),Object.defineProperty(e,"POINTERUP",{get:function(){return e._POINTERUP},enumerable:!0,configurable:!0}),Object.defineProperty(e,"POINTERMOVE",{get:function(){return e._POINTERMOVE},enumerable:!0,configurable:!0}),Object.defineProperty(e,"POINTERWHEEL",{get:function(){return e._POINTERWHEEL},enumerable:!0,configurable:!0}),Object.defineProperty(e,"POINTERPICK",{get:function(){return e._POINTERPICK},enumerable:!0,configurable:!0}),Object.defineProperty(e,"POINTERTAP",{get:function(){return e._POINTERTAP},enumerable:!0,configurable:!0}),Object.defineProperty(e,"POINTERDOUBLETAP",{get:function(){return e._POINTERDOUBLETAP},enumerable:!0,configurable:!0}),e._POINTERDOWN=1,e._POINTERUP=2,e._POINTERMOVE=4,e._POINTERWHEEL=8,e._POINTERPICK=16,e._POINTERTAP=32,e._POINTERDOUBLETAP=64,e})();e.PointerEventTypes=t;var r=(function(){function e(e,t){this.type=e,this.event=t}return e})();e.PointerInfoBase=r;var i=(function(t){function r(r,i,n,s){var o=t.call(this,r,i)||this;return o.ray=null,o.skipOnPointerObservable=!1,o.localPosition=new e.Vector2(n,s),o}return s(r,t),r})(r);e.PointerInfoPre=i;var n=(function(e){function t(t,r,i){var n=e.call(this,t,r)||this;return n.pickInfo=i,n}return s(t,e),t})(r);e.PointerInfo=n})(i||(i={}));var i;!(function(e){e.ToGammaSpace=1/2.2,e.ToLinearSpace=2.2,e.Epsilon=.001;var t=(function(){function t(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),this.r=e,this.g=t,this.b=r}return t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"},t.prototype.getClassName=function(){return"Color3"},t.prototype.getHashCode=function(){var e=this.r||0;return e=397*e^(this.g||0),e=397*e^(this.b||0)},t.prototype.toArray=function(e,t){return void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this},t.prototype.toColor4=function(e){return void 0===e&&(e=1),new r(this.r,this.g,this.b,e)},t.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},t.prototype.toLuminance=function(){return.3*this.r+.59*this.g+.11*this.b},t.prototype.multiply=function(e){return new t(this.r*e.r,this.g*e.g,this.b*e.b)},t.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this},t.prototype.equals=function(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b},t.prototype.equalsFloats=function(e,t,r){return this.r===e&&this.g===t&&this.b===r},t.prototype.scale=function(e){return new t(this.r*e,this.g*e,this.b*e)},t.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this},t.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this},t.prototype.clampToRef=function(t,r,i){return void 0===t&&(t=0),void 0===r&&(r=1),i.r=e.Scalar.Clamp(this.r,t,r),i.g=e.Scalar.Clamp(this.g,t,r),i.b=e.Scalar.Clamp(this.b,t,r),this},t.prototype.add=function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b)},t.prototype.addToRef=function(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this},t.prototype.subtract=function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b)},t.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this},t.prototype.clone=function(){return new t(this.r,this.g,this.b)},t.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},t.prototype.copyFromFloats=function(e,t,r){return this.r=e,this.g=t,this.b=r,this},t.prototype.set=function(e,t,r){return this.copyFromFloats(e,t,r)},t.prototype.toHexString=function(){var t=255*this.r|0,r=255*this.g|0,i=255*this.b|0;return"#"+e.Scalar.ToHex(t)+e.Scalar.ToHex(r)+e.Scalar.ToHex(i)},t.prototype.toLinearSpace=function(){var e=new t;return this.toLinearSpaceToRef(e),e},t.prototype.toLinearSpaceToRef=function(t){return t.r=Math.pow(this.r,e.ToLinearSpace),t.g=Math.pow(this.g,e.ToLinearSpace),t.b=Math.pow(this.b,e.ToLinearSpace),this},t.prototype.toGammaSpace=function(){var e=new t;return this.toGammaSpaceToRef(e),e},t.prototype.toGammaSpaceToRef=function(t){return t.r=Math.pow(this.r,e.ToGammaSpace),t.g=Math.pow(this.g,e.ToGammaSpace),t.b=Math.pow(this.b,e.ToGammaSpace),this},t.FromHexString=function(e){if("#"!==e.substring(0,1)||7!==e.length)return new t(0,0,0);var r=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16);return t.FromInts(r,i,n)},t.FromArray=function(e,r){return void 0===r&&(r=0),new t(e[r],e[r+1],e[r+2])},t.FromInts=function(e,r,i){return new t(e/255,r/255,i/255)},t.Lerp=function(e,r,i){return new t(e.r+(r.r-e.r)*i,e.g+(r.g-e.g)*i,e.b+(r.b-e.b)*i)},t.Red=function(){return new t(1,0,0)},t.Green=function(){return new t(0,1,0)},t.Blue=function(){return new t(0,0,1)},t.Black=function(){return new t(0,0,0)},t.White=function(){return new t(1,1,1)},t.Purple=function(){return new t(.5,0,.5)},t.Magenta=function(){return new t(1,0,1)},t.Yellow=function(){return new t(1,1,0)},t.Gray=function(){return new t(.5,.5,.5)},t.Teal=function(){return new t(0,1,1)},t.Random=function(){return new t(Math.random(),Math.random(),Math.random())},t})();e.Color3=t;var r=(function(){function t(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=1),this.r=e,this.g=t,this.b=r,this.a=i}return t.prototype.addInPlace=function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this},t.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},t.prototype.toArray=function(e,t){return void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this},t.prototype.add=function(e){return new t(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)},t.prototype.subtract=function(e){return new t(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)},t.prototype.subtractToRef=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this},t.prototype.scale=function(e){return new t(this.r*e,this.g*e,this.b*e,this.a*e)},t.prototype.scaleToRef=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this},t.prototype.scaleAndAddToRef=function(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this},t.prototype.clampToRef=function(t,r,i){return void 0===t&&(t=0),void 0===r&&(r=1),i.r=e.Scalar.Clamp(this.r,t,r),i.g=e.Scalar.Clamp(this.g,t,r),i.b=e.Scalar.Clamp(this.b,t,r),i.a=e.Scalar.Clamp(this.a,t,r),this},t.prototype.multiply=function(e){return new t(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)},t.prototype.multiplyToRef=function(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t},t.prototype.toString=function(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"},t.prototype.getClassName=function(){return"Color4"},t.prototype.getHashCode=function(){var e=this.r||0;return e=397*e^(this.g||0),e=397*e^(this.b||0),e=397*e^(this.a||0)},t.prototype.clone=function(){return new t(this.r,this.g,this.b,this.a)},t.prototype.copyFrom=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},t.prototype.copyFromFloats=function(e,t,r,i){return this.r=e,this.g=t,this.b=r,this.a=i,this},t.prototype.set=function(e,t,r,i){return this.copyFromFloats(e,t,r,i)},t.prototype.toHexString=function(){var t=255*this.r|0,r=255*this.g|0,i=255*this.b|0,n=255*this.a|0;return"#"+e.Scalar.ToHex(t)+e.Scalar.ToHex(r)+e.Scalar.ToHex(i)+e.Scalar.ToHex(n)},t.prototype.toLinearSpace=function(){var e=new t;return this.toLinearSpaceToRef(e),e},t.prototype.toLinearSpaceToRef=function(t){return t.r=Math.pow(this.r,e.ToLinearSpace),t.g=Math.pow(this.g,e.ToLinearSpace),t.b=Math.pow(this.b,e.ToLinearSpace),t.a=this.a,this},t.prototype.toGammaSpace=function(){var e=new t;return this.toGammaSpaceToRef(e),e},t.prototype.toGammaSpaceToRef=function(t){return t.r=Math.pow(this.r,e.ToGammaSpace),t.g=Math.pow(this.g,e.ToGammaSpace),t.b=Math.pow(this.b,e.ToGammaSpace),t.a=this.a,this},t.FromHexString=function(e){if("#"!==e.substring(0,1)||9!==e.length)return new t(0,0,0,0);var r=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),n=parseInt(e.substring(5,7),16),s=parseInt(e.substring(7,9),16);return t.FromInts(r,i,n,s)},t.Lerp=function(e,r,i){var n=new t(0,0,0,0);return t.LerpToRef(e,r,i,n),n},t.LerpToRef=function(e,t,r,i){i.r=e.r+(t.r-e.r)*r,i.g=e.g+(t.g-e.g)*r,i.b=e.b+(t.b-e.b)*r,i.a=e.a+(t.a-e.a)*r},t.FromArray=function(e,r){return void 0===r&&(r=0),new t(e[r],e[r+1],e[r+2],e[r+3])},t.FromInts=function(e,r,i,n){return new t(e/255,r/255,i/255,n/255)},t.CheckColors4=function(e,t){if(e.length===3*t){for(var r=[],i=0;i<e.length;i+=3){var n=i/3*4;r[n]=e[i],r[n+1]=e[i+1],r[n+2]=e[i+2],r[n+3]=1}return r}return e},t})();e.Color4=r;var i=(function(){function t(e,t){this.x=e,this.y=t}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+"}"},t.prototype.getClassName=function(){return"Vector2"},t.prototype.getHashCode=function(){var e=this.x||0;return e=397*e^(this.y||0)},t.prototype.toArray=function(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,this},t.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},t.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this},t.prototype.copyFromFloats=function(e,t){return this.x=e,this.y=t,this},t.prototype.set=function(e,t){return this.copyFromFloats(e,t)},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,this},t.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this},t.prototype.addVector3=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,this},t.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this},t.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this},t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y)},t.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,this},t.prototype.multiplyByFloats=function(e,r){return new t(this.x*e,this.y*r)},t.prototype.divide=function(e){return new t(this.x/e.x,this.y/e.y)},t.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,this},t.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},t.prototype.negate=function(){return new t(-this.x,-this.y)},t.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this},t.prototype.scale=function(e){var r=new t(0,0);return this.scaleToRef(e,r),r},t.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,this},t.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,this},t.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y},t.prototype.equalsWithEpsilon=function(t,r){return void 0===r&&(r=e.Epsilon),t&&e.Scalar.WithinEpsilon(this.x,t.x,r)&&e.Scalar.WithinEpsilon(this.y,t.y,r)},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},t.prototype.normalize=function(){var e=this.length();if(0===e)return this;var t=1/e;return this.x*=t,this.y*=t,this},t.prototype.clone=function(){return new t(this.x,this.y)},t.Zero=function(){return new t(0,0)},t.One=function(){return new t(1,1)},t.FromArray=function(e,r){return void 0===r&&(r=0),new t(e[r],e[r+1])},t.FromArrayToRef=function(e,t,r){r.x=e[t],r.y=e[t+1]},t.CatmullRom=function(e,r,i,n,s){var o=s*s,a=s*o;return new t(.5*(2*r.x+(-e.x+i.x)*s+(2*e.x-5*r.x+4*i.x-n.x)*o+(-e.x+3*r.x-3*i.x+n.x)*a),.5*(2*r.y+(-e.y+i.y)*s+(2*e.y-5*r.y+4*i.y-n.y)*o+(-e.y+3*r.y-3*i.y+n.y)*a))},t.Clamp=function(e,r,i){var n=e.x;n=n>i.x?i.x:n,n=n<r.x?r.x:n;var s=e.y;return s=s>i.y?i.y:s,s=s<r.y?r.y:s,new t(n,s)},t.Hermite=function(e,r,i,n,s){var o=s*s,a=s*o,h=2*a-3*o+1,u=-2*a+3*o,l=a-2*o+s,c=a-o;return new t(e.x*h+i.x*u+r.x*l+n.x*c,e.y*h+i.y*u+r.y*l+n.y*c)},t.Lerp=function(e,r,i){return new t(e.x+(r.x-e.x)*i,e.y+(r.y-e.y)*i)},t.Dot=function(e,t){return e.x*t.x+e.y*t.y},t.Normalize=function(e){var t=e.clone();return t.normalize(),t},t.Minimize=function(e,r){return new t(e.x<r.x?e.x:r.x,e.y<r.y?e.y:r.y)},t.Maximize=function(e,r){return new t(e.x>r.x?e.x:r.x,e.y>r.y?e.y:r.y)},t.Transform=function(e,r){var i=t.Zero();return t.TransformToRef(e,r,i),i},t.TransformToRef=function(e,t,r){var i=e.x*t.m[0]+e.y*t.m[4]+t.m[12],n=e.x*t.m[1]+e.y*t.m[5]+t.m[13];r.x=i,r.y=n},t.PointInTriangle=function(e,t,r,i){var n=.5*(-r.y*i.x+t.y*(-r.x+i.x)+t.x*(r.y-i.y)+r.x*i.y),s=n<0?-1:1,o=(t.y*i.x-t.x*i.y+(i.y-t.y)*e.x+(t.x-i.x)*e.y)*s,a=(t.x*r.y-t.y*r.x+(t.y-r.y)*e.x+(r.x-t.x)*e.y)*s;return o>0&&a>0&&o+a<2*n*s},t.Distance=function(e,r){return Math.sqrt(t.DistanceSquared(e,r))},t.DistanceSquared=function(e,t){var r=e.x-t.x,i=e.y-t.y;return r*r+i*i},t.Center=function(e,t){var r=e.add(t);return r.scaleInPlace(.5),r},t.DistanceOfPointFromSegment=function(e,r,i){var n=t.DistanceSquared(r,i);if(0===n)return t.Distance(e,r);var s=i.subtract(r),o=Math.max(0,Math.min(1,t.Dot(e.subtract(r),s)/n)),a=r.add(s.multiplyByFloats(o,o));return t.Distance(e,a)},t})();e.Vector2=i;var n=(function(){function t(e,t,r){this.x=e,this.y=t,this.z=r}
return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+"}"},t.prototype.getClassName=function(){return"Vector3"},t.prototype.getHashCode=function(){var e=this.x||0;return e=397*e^(this.y||0),e=397*e^(this.z||0)},t.prototype.asArray=function(){var e=[];return this.toArray(e,0),e},t.prototype.toArray=function(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,this},t.prototype.toQuaternion=function(){return e.Quaternion.RotationYawPitchRoll(this.x,this.y,this.z)},t.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z)},t.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,this},t.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z)},t.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,this},t.prototype.subtractFromFloats=function(e,r,i){return new t(this.x-e,this.y-r,this.z-i)},t.prototype.subtractFromFloatsToRef=function(e,t,r,i){return i.x=this.x-e,i.y=this.y-t,i.z=this.z-r,this},t.prototype.negate=function(){return new t(-this.x,-this.y,-this.z)},t.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this},t.prototype.scale=function(e){return new t(this.x*e,this.y*e,this.z*e)},t.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,this},t.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,this},t.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z},t.prototype.equalsWithEpsilon=function(t,r){return void 0===r&&(r=e.Epsilon),t&&e.Scalar.WithinEpsilon(this.x,t.x,r)&&e.Scalar.WithinEpsilon(this.y,t.y,r)&&e.Scalar.WithinEpsilon(this.z,t.z,r)},t.prototype.equalsToFloats=function(e,t,r){return this.x===e&&this.y===t&&this.z===r},t.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z)},t.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,this},t.prototype.multiplyByFloats=function(e,r,i){return new t(this.x*e,this.y*r,this.z*i)},t.prototype.divide=function(e){return new t(this.x/e.x,this.y/e.y,this.z/e.z)},t.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,this},t.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},t.prototype.minimizeInPlace=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),this},t.prototype.maximizeInPlace=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),this},Object.defineProperty(t.prototype,"isNonUniform",{get:function(){var e=Math.abs(this.x),t=Math.abs(this.y);if(e!==t)return!0;var r=Math.abs(this.z);return e!==r||t!==r},enumerable:!0,configurable:!0}),t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.prototype.normalize=function(){var e=this.length();if(0===e||1===e)return this;var t=1/e;return this.x*=t,this.y*=t,this.z*=t,this},t.prototype.normalizeToNew=function(){var e=new t(0,0,0);return this.normalizeToRef(e),e},t.prototype.normalizeToRef=function(e){var t=this.length();if(0===t||1===t)return e.set(this.x,this.y,this.z),e;var r=1/t;return this.scaleToRef(r,e),e},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},t.prototype.copyFromFloats=function(e,t,r){return this.x=e,this.y=t,this.z=r,this},t.prototype.set=function(e,t,r){return this.copyFromFloats(e,t,r)},t.GetClipFactor=function(e,r,i,n){var s=t.Dot(e,i)-n;return s/(s-(t.Dot(r,i)-n))},t.GetAngleBetweenVectors=function(e,r,i){var n=e.clone().normalize(),s=r.clone().normalize(),o=t.Dot(n,s),a=t.Cross(n,s);return t.Dot(a,i)>0?Math.acos(o):-Math.acos(o)},t.FromArray=function(e,r){return r||(r=0),new t(e[r],e[r+1],e[r+2])},t.FromFloatArray=function(e,r){return t.FromArray(e,r)},t.FromArrayToRef=function(e,t,r){r.x=e[t],r.y=e[t+1],r.z=e[t+2]},t.FromFloatArrayToRef=function(e,r,i){return t.FromArrayToRef(e,r,i)},t.FromFloatsToRef=function(e,t,r,i){i.x=e,i.y=t,i.z=r},t.Zero=function(){return new t(0,0,0)},t.One=function(){return new t(1,1,1)},t.Up=function(){return new t(0,1,0)},t.Forward=function(){return new t(0,0,1)},t.Right=function(){return new t(1,0,0)},t.Left=function(){return new t(-1,0,0)},t.TransformCoordinates=function(e,r){var i=t.Zero();return t.TransformCoordinatesToRef(e,r,i),i},t.TransformCoordinatesToRef=function(e,t,r){var i=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8]+t.m[12],n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9]+t.m[13],s=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10]+t.m[14],o=e.x*t.m[3]+e.y*t.m[7]+e.z*t.m[11]+t.m[15];r.x=i/o,r.y=n/o,r.z=s/o},t.TransformCoordinatesFromFloatsToRef=function(e,t,r,i,n){var s=e*i.m[0]+t*i.m[4]+r*i.m[8]+i.m[12],o=e*i.m[1]+t*i.m[5]+r*i.m[9]+i.m[13],a=e*i.m[2]+t*i.m[6]+r*i.m[10]+i.m[14],h=e*i.m[3]+t*i.m[7]+r*i.m[11]+i.m[15];n.x=s/h,n.y=o/h,n.z=a/h},t.TransformNormal=function(e,r){var i=t.Zero();return t.TransformNormalToRef(e,r,i),i},t.TransformNormalToRef=function(e,t,r){var i=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8],n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9],s=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10];r.x=i,r.y=n,r.z=s},t.TransformNormalFromFloatsToRef=function(e,t,r,i,n){n.x=e*i.m[0]+t*i.m[4]+r*i.m[8],n.y=e*i.m[1]+t*i.m[5]+r*i.m[9],n.z=e*i.m[2]+t*i.m[6]+r*i.m[10]},t.CatmullRom=function(e,r,i,n,s){var o=s*s,a=s*o;return new t(.5*(2*r.x+(-e.x+i.x)*s+(2*e.x-5*r.x+4*i.x-n.x)*o+(-e.x+3*r.x-3*i.x+n.x)*a),.5*(2*r.y+(-e.y+i.y)*s+(2*e.y-5*r.y+4*i.y-n.y)*o+(-e.y+3*r.y-3*i.y+n.y)*a),.5*(2*r.z+(-e.z+i.z)*s+(2*e.z-5*r.z+4*i.z-n.z)*o+(-e.z+3*r.z-3*i.z+n.z)*a))},t.Clamp=function(e,r,i){var n=e.x;n=n>i.x?i.x:n,n=n<r.x?r.x:n;var s=e.y;s=s>i.y?i.y:s,s=s<r.y?r.y:s;var o=e.z;return o=o>i.z?i.z:o,o=o<r.z?r.z:o,new t(n,s,o)},t.Hermite=function(e,r,i,n,s){var o=s*s,a=s*o,h=2*a-3*o+1,u=-2*a+3*o,l=a-2*o+s,c=a-o;return new t(e.x*h+i.x*u+r.x*l+n.x*c,e.y*h+i.y*u+r.y*l+n.y*c,e.z*h+i.z*u+r.z*l+n.z*c)},t.Lerp=function(e,r,i){var n=new t(0,0,0);return t.LerpToRef(e,r,i,n),n},t.LerpToRef=function(e,t,r,i){i.x=e.x+(t.x-e.x)*r,i.y=e.y+(t.y-e.y)*r,i.z=e.z+(t.z-e.z)*r},t.Dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.Cross=function(e,r){var i=t.Zero();return t.CrossToRef(e,r,i),i},t.CrossToRef=function(e,t,r){x.Vector3[0].x=e.y*t.z-e.z*t.y,x.Vector3[0].y=e.z*t.x-e.x*t.z,x.Vector3[0].z=e.x*t.y-e.y*t.x,r.copyFrom(x.Vector3[0])},t.Normalize=function(e){var r=t.Zero();return t.NormalizeToRef(e,r),r},t.NormalizeToRef=function(e,t){t.copyFrom(e),t.normalize()},t.Project=function(e,r,i,n){var s=n.width,o=n.height,a=n.x,u=n.y,l=t._viewportMatrixCache?t._viewportMatrixCache:t._viewportMatrixCache=new h;h.FromValuesToRef(s/2,0,0,0,0,-o/2,0,0,0,0,.5,0,a+s/2,o/2+u,.5,1,l);var c=x.Matrix[0];return r.multiplyToRef(i,c),c.multiplyToRef(l,c),t.TransformCoordinates(e,c)},t.UnprojectFromTransform=function(r,i,n,s,o){var a=x.Matrix[0];s.multiplyToRef(o,a),a.invert(),r.x=r.x/i*2-1,r.y=-(r.y/n*2-1);var h=t.TransformCoordinates(r,a),u=r.x*a.m[3]+r.y*a.m[7]+r.z*a.m[11]+a.m[15];return e.Scalar.WithinEpsilon(u,1)&&(h=h.scale(1/u)),h},t.Unproject=function(e,r,i,n,s,o){var a=t.Zero();return t.UnprojectToRef(e,r,i,n,s,o,a),a},t.UnprojectToRef=function(e,r,i,n,s,o,a){t.UnprojectFloatsToRef(e.x,e.y,e.z,r,i,n,s,o,a)},t.UnprojectFloatsToRef=function(r,i,n,s,o,a,h,u,l){var c=x.Matrix[0];a.multiplyToRef(h,c),c.multiplyToRef(u,c),c.invert();var f=x.Vector3[0];f.x=r/s*2-1,f.y=-(i/o*2-1),f.z=2*n-1,t.TransformCoordinatesToRef(f,c,l);var d=f.x*c.m[3]+f.y*c.m[7]+f.z*c.m[11]+c.m[15];e.Scalar.WithinEpsilon(d,1)&&l.scaleInPlace(1/d)},t.Minimize=function(e,t){var r=e.clone();return r.minimizeInPlace(t),r},t.Maximize=function(e,t){var r=e.clone();return r.maximizeInPlace(t),r},t.Distance=function(e,r){return Math.sqrt(t.DistanceSquared(e,r))},t.DistanceSquared=function(e,t){var r=e.x-t.x,i=e.y-t.y,n=e.z-t.z;return r*r+i*i+n*n},t.Center=function(e,t){var r=e.add(t);return r.scaleInPlace(.5),r},t.RotationFromAxis=function(e,r,i){var n=t.Zero();return t.RotationFromAxisToRef(e,r,i,n),n},t.RotationFromAxisToRef=function(e,t,r,i){var n=x.Quaternion[0];a.RotationQuaternionFromAxisToRef(e,t,r,n),n.toEulerAnglesToRef(i)},t})();e.Vector3=n;var s=(function(){function t(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}return t.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},t.prototype.getClassName=function(){return"Vector4"},t.prototype.getHashCode=function(){var e=this.x||0;return e=397*e^(this.y||0),e=397*e^(this.z||0),e=397*e^(this.w||0)},t.prototype.asArray=function(){var e=new Array;return this.toArray(e,0),e},t.prototype.toArray=function(e,t){return void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this},t.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},t.prototype.addToRef=function(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,this},t.prototype.subtractInPlace=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)},t.prototype.subtractToRef=function(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,this},t.prototype.subtractFromFloats=function(e,r,i,n){return new t(this.x-e,this.y-r,this.z-i,this.w-n)},t.prototype.subtractFromFloatsToRef=function(e,t,r,i,n){return n.x=this.x-e,n.y=this.y-t,n.z=this.z-r,n.w=this.w-i,this},t.prototype.negate=function(){return new t(-this.x,-this.y,-this.z,-this.w)},t.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},t.prototype.scale=function(e){return new t(this.x*e,this.y*e,this.z*e,this.w*e)},t.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,this},t.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,this},t.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},t.prototype.equalsWithEpsilon=function(t,r){return void 0===r&&(r=e.Epsilon),t&&e.Scalar.WithinEpsilon(this.x,t.x,r)&&e.Scalar.WithinEpsilon(this.y,t.y,r)&&e.Scalar.WithinEpsilon(this.z,t.z,r)&&e.Scalar.WithinEpsilon(this.w,t.w,r)},t.prototype.equalsToFloats=function(e,t,r,i){return this.x===e&&this.y===t&&this.z===r&&this.w===i},t.prototype.multiplyInPlace=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},t.prototype.multiply=function(e){return new t(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)},t.prototype.multiplyToRef=function(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,this},t.prototype.multiplyByFloats=function(e,r,i,n){return new t(this.x*e,this.y*r,this.z*i,this.w*n)},t.prototype.divide=function(e){return new t(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)},t.prototype.divideToRef=function(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,this},t.prototype.divideInPlace=function(e){return this.divideToRef(e,this)},t.prototype.minimizeInPlace=function(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this},t.prototype.maximizeInPlace=function(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t.prototype.normalize=function(){var e=this.length();if(0===e)return this;var t=1/e;return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},t.prototype.toVector3=function(){return new n(this.x,this.y,this.z)},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},t.prototype.copyFromFloats=function(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this},t.prototype.set=function(e,t,r,i){return this.copyFromFloats(e,t,r,i)},t.FromArray=function(e,r){return r||(r=0),new t(e[r],e[r+1],e[r+2],e[r+3])},t.FromArrayToRef=function(e,t,r){r.x=e[t],r.y=e[t+1],r.z=e[t+2],r.w=e[t+3]},t.FromFloatArrayToRef=function(e,r,i){t.FromArrayToRef(e,r,i)},t.FromFloatsToRef=function(e,t,r,i,n){n.x=e,n.y=t,n.z=r,n.w=i},t.Zero=function(){return new t(0,0,0,0)},t.One=function(){return new t(1,1,1,1)},t.Normalize=function(e){var r=t.Zero();return t.NormalizeToRef(e,r),r},t.NormalizeToRef=function(e,t){t.copyFrom(e),t.normalize()},t.Minimize=function(e,t){var r=e.clone();return r.minimizeInPlace(t),r},t.Maximize=function(e,t){var r=e.clone();return r.maximizeInPlace(t),r},t.Distance=function(e,r){return Math.sqrt(t.DistanceSquared(e,r))},t.DistanceSquared=function(e,t){var r=e.x-t.x,i=e.y-t.y,n=e.z-t.z,s=e.w-t.w;return r*r+i*i+n*n+s*s},t.Center=function(e,t){var r=e.add(t);return r.scaleInPlace(.5),r},t.TransformNormal=function(e,r){var i=t.Zero();return t.TransformNormalToRef(e,r,i),i},t.TransformNormalToRef=function(e,t,r){var i=e.x*t.m[0]+e.y*t.m[4]+e.z*t.m[8],n=e.x*t.m[1]+e.y*t.m[5]+e.z*t.m[9],s=e.x*t.m[2]+e.y*t.m[6]+e.z*t.m[10];r.x=i,r.y=n,r.z=s,r.w=e.w},t.TransformNormalFromFloatsToRef=function(e,t,r,i,n,s){s.x=e*n.m[0]+t*n.m[4]+r*n.m[8],s.y=e*n.m[1]+t*n.m[5]+r*n.m[9],s.z=e*n.m[2]+t*n.m[6]+r*n.m[10],s.w=i},t})();e.Vector4=s;var o=(function(){function e(e,t){this.width=e,this.height=t}return e.prototype.toString=function(){return"{W: "+this.width+", H: "+this.height+"}"},e.prototype.getClassName=function(){return"Size"},e.prototype.getHashCode=function(){var e=this.width||0;return e=397*e^(this.height||0)},e.prototype.copyFrom=function(e){this.width=e.width,this.height=e.height},e.prototype.copyFromFloats=function(e,t){return this.width=e,this.height=t,this},e.prototype.set=function(e,t){return this.copyFromFloats(e,t)},e.prototype.multiplyByFloats=function(t,r){return new e(this.width*t,this.height*r)},e.prototype.clone=function(){return new e(this.width,this.height)},e.prototype.equals=function(e){return!!e&&(this.width===e.width&&this.height===e.height)},Object.defineProperty(e.prototype,"surface",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),e.Zero=function(){return new e(0,0)},e.prototype.add=function(t){return new e(this.width+t.width,this.height+t.height)},e.prototype.subtract=function(t){return new e(this.width-t.width,this.height-t.height)},e.Lerp=function(t,r,i){return new e(t.width+(r.width-t.width)*i,t.height+(r.height-t.height)*i)},e})();e.Size=o;var a=(function(){function e(e,t,r,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=1),this.x=e,this.y=t,this.z=r,this.w=i}return e.prototype.toString=function(){return"{X: "+this.x+" Y:"+this.y+" Z:"+this.z+" W:"+this.w+"}"},e.prototype.getClassName=function(){return"Quaternion"},e.prototype.getHashCode=function(){var e=this.x||0;return e=397*e^(this.y||0),e=397*e^(this.z||0),e=397*e^(this.w||0)},e.prototype.asArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.equals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.copyFrom=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e.prototype.copyFromFloats=function(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this},e.prototype.set=function(e,t,r,i){return this.copyFromFloats(e,t,r,i)},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)},e.prototype.addInPlace=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},e.prototype.subtract=function(t){return new e(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)},e.prototype.scale=function(t){return new e(this.x*t,this.y*t,this.z*t,this.w*t)},e.prototype.scaleToRef=function(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,this},e.prototype.scaleInPlace=function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},e.prototype.scaleAndAddToRef=function(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,this},e.prototype.multiply=function(t){var r=new e(0,0,0,1);return this.multiplyToRef(t,r),r},e.prototype.multiplyToRef=function(e,t){var r=this.x*e.w+this.y*e.z-this.z*e.y+this.w*e.x,i=-this.x*e.z+this.y*e.w+this.z*e.x+this.w*e.y,n=this.x*e.y-this.y*e.x+this.z*e.w+this.w*e.z,s=-this.x*e.x-this.y*e.y-this.z*e.z+this.w*e.w;return t.copyFromFloats(r,i,n,s),this},e.prototype.multiplyInPlace=function(e){return this.multiplyToRef(e,this),this},e.prototype.conjugateToRef=function(e){return e.copyFromFloats(-this.x,-this.y,-this.z,this.w),this},e.prototype.conjugateInPlace=function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},e.prototype.conjugate=function(){return new e(-this.x,-this.y,-this.z,this.w)},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.prototype.normalize=function(){var e=1/this.length();return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},e.prototype.toEulerAngles=function(e){void 0===e&&(e="YZX");var t=n.Zero();return this.toEulerAnglesToRef(t,e),t},e.prototype.toEulerAnglesToRef=function(e,t){void 0===t&&(t="YZX");var r=this.z,i=this.x,n=this.y,s=this.w,o=s*s,a=r*r,h=i*i,u=n*n,l=n*r-i*s;return l<-.4999999?(e.y=2*Math.atan2(n,s),e.x=Math.PI/2,e.z=0):l>.4999999?(e.y=2*Math.atan2(n,s),e.x=-Math.PI/2,e.z=0):(e.z=Math.atan2(2*(i*n+r*s),-a-h+u+o),e.x=Math.asin(-2*(r*n-i*s)),e.y=Math.atan2(2*(r*i+n*s),a-h-u+o)),this},e.prototype.toRotationMatrix=function(e){var t=this.x*this.x,r=this.y*this.y,i=this.z*this.z,n=this.x*this.y,s=this.z*this.w,o=this.z*this.x,a=this.y*this.w,h=this.y*this.z,u=this.x*this.w;return e.m[0]=1-2*(r+i),e.m[1]=2*(n+s),e.m[2]=2*(o-a),e.m[3]=0,e.m[4]=2*(n-s),e.m[5]=1-2*(i+t),e.m[6]=2*(h+u),e.m[7]=0,e.m[8]=2*(o+a),e.m[9]=2*(h-u),e.m[10]=1-2*(r+t),e.m[11]=0,e.m[12]=0,e.m[13]=0,e.m[14]=0,e.m[15]=1,e._markAsUpdated(),this},e.prototype.fromRotationMatrix=function(t){return e.FromRotationMatrixToRef(t,this),this},e.FromRotationMatrix=function(t){var r=new e;return e.FromRotationMatrixToRef(t,r),r},e.FromRotationMatrixToRef=function(e,t){var r,i=e.m,n=i[0],s=i[4],o=i[8],a=i[1],h=i[5],u=i[9],l=i[2],c=i[6],f=i[10],d=n+h+f;d>0?(r=.5/Math.sqrt(d+1),t.w=.25/r,t.x=(c-u)*r,t.y=(o-l)*r,t.z=(a-s)*r):n>h&&n>f?(r=2*Math.sqrt(1+n-h-f),t.w=(c-u)/r,t.x=.25*r,t.y=(s+a)/r,t.z=(o+l)/r):h>f?(r=2*Math.sqrt(1+h-n-f),t.w=(o-l)/r,t.x=(s+a)/r,t.y=.25*r,t.z=(u+c)/r):(r=2*Math.sqrt(1+f-n-h),t.w=(a-s)/r,t.x=(o+l)/r,t.y=(u+c)/r,t.z=.25*r)},e.Dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},e.AreClose=function(t,r){return e.Dot(t,r)>=0},e.Zero=function(){return new e(0,0,0,0)},e.Inverse=function(t){return new e(-t.x,-t.y,-t.z,t.w)},e.Identity=function(){return new e(0,0,0,1)},e.IsIdentity=function(e){return e&&0===e.x&&0===e.y&&0===e.z&&1===e.w},e.RotationAxis=function(t,r){return e.RotationAxisToRef(t,r,new e)},e.RotationAxisToRef=function(e,t,r){var i=Math.sin(t/2);return e.normalize(),r.w=Math.cos(t/2),r.x=e.x*i,r.y=e.y*i,r.z=e.z*i,r},e.FromArray=function(t,r){return r||(r=0),new e(t[r],t[r+1],t[r+2],t[r+3])},e.RotationYawPitchRoll=function(t,r,i){var n=new e;return e.RotationYawPitchRollToRef(t,r,i,n),n},e.RotationYawPitchRollToRef=function(e,t,r,i){var n=.5*r,s=.5*t,o=.5*e,a=Math.sin(n),h=Math.cos(n),u=Math.sin(s),l=Math.cos(s),c=Math.sin(o),f=Math.cos(o);i.x=f*u*h+c*l*a,i.y=c*l*h-f*u*a,i.z=f*l*a-c*u*h,i.w=f*l*h+c*u*a},e.RotationAlphaBetaGamma=function(t,r,i){var n=new e;return e.RotationAlphaBetaGammaToRef(t,r,i,n),n},e.RotationAlphaBetaGammaToRef=function(e,t,r,i){var n=.5*(r+e),s=.5*(r-e),o=.5*t;i.x=Math.cos(s)*Math.sin(o),i.y=Math.sin(s)*Math.sin(o),i.z=Math.sin(n)*Math.cos(o),i.w=Math.cos(n)*Math.cos(o)},e.RotationQuaternionFromAxis=function(t,r,i){var n=new e(0,0,0,0);return e.RotationQuaternionFromAxisToRef(t,r,i,n),n},e.RotationQuaternionFromAxisToRef=function(t,r,i,n){var s=x.Matrix[0];h.FromXYZAxesToRef(t.normalize(),r.normalize(),i.normalize(),s),e.FromRotationMatrixToRef(s,n)},e.Slerp=function(t,r,i){var n=e.Identity();return e.SlerpToRef(t,r,i,n),n},e.SlerpToRef=function(e,t,r,i){var n,s,o=e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w,a=!1;if(o<0&&(a=!0,o=-o),o>.999999)s=1-r,n=a?-r:r;else{var h=Math.acos(o),u=1/Math.sin(h);s=Math.sin((1-r)*h)*u,n=a?-Math.sin(r*h)*u:Math.sin(r*h)*u}i.x=s*e.x+n*t.x,i.y=s*e.y+n*t.y,i.z=s*e.z+n*t.z,i.w=s*e.w+n*t.w},e.Hermite=function(t,r,i,n,s){var o=s*s,a=s*o,h=2*a-3*o+1,u=-2*a+3*o,l=a-2*o+s,c=a-o;return new e(t.x*h+i.x*u+r.x*l+n.x*c,t.y*h+i.y*u+r.y*l+n.y*c,t.z*h+i.z*u+r.z*l+n.z*c,t.w*h+i.w*u+r.w*l+n.w*c)},e})();e.Quaternion=a;var h=(function(){function e(){this._isIdentity=!1,this._isIdentityDirty=!0,this.m=new Float32Array(16),this._markAsUpdated()}return e.prototype._markAsUpdated=function(){this.updateFlag=e._updateFlagSeed++,this._isIdentityDirty=!0},e.prototype.isIdentity=function(e){return void 0===e&&(e=!1),this._isIdentityDirty&&(this._isIdentityDirty=!1,1!==this.m[0]||1!==this.m[5]||1!==this.m[15]?this._isIdentity=!1:0!==this.m[1]||0!==this.m[2]||0!==this.m[3]||0!==this.m[4]||0!==this.m[6]||0!==this.m[7]||0!==this.m[8]||0!==this.m[9]||0!==this.m[11]||0!==this.m[12]||0!==this.m[13]||0!==this.m[14]?this._isIdentity=!1:this._isIdentity=!0,e||1===this.m[10]||(this._isIdentity=!1)),this._isIdentity},e.prototype.determinant=function(){var e=this.m[10]*this.m[15]-this.m[11]*this.m[14],t=this.m[9]*this.m[15]-this.m[11]*this.m[13],r=this.m[9]*this.m[14]-this.m[10]*this.m[13],i=this.m[8]*this.m[15]-this.m[11]*this.m[12],n=this.m[8]*this.m[14]-this.m[10]*this.m[12],s=this.m[8]*this.m[13]-this.m[9]*this.m[12];return this.m[0]*(this.m[5]*e-this.m[6]*t+this.m[7]*r)-this.m[1]*(this.m[4]*e-this.m[6]*i+this.m[7]*n)+this.m[2]*(this.m[4]*t-this.m[5]*i+this.m[7]*s)-this.m[3]*(this.m[4]*r-this.m[5]*n+this.m[6]*s)},e.prototype.toArray=function(){return this.m},e.prototype.asArray=function(){return this.toArray()},e.prototype.invert=function(){return this.invertToRef(this),this},e.prototype.reset=function(){for(var e=0;e<16;e++)this.m[e]=0;return this._markAsUpdated(),this},e.prototype.add=function(t){var r=new e;return this.addToRef(t,r),r},e.prototype.addToRef=function(e,t){for(var r=0;r<16;r++)t.m[r]=this.m[r]+e.m[r];return t._markAsUpdated(),this},e.prototype.addToSelf=function(e){for(var t=0;t<16;t++)this.m[t]+=e.m[t];return this._markAsUpdated(),this},e.prototype.invertToRef=function(e){var t=this.m[0],r=this.m[1],i=this.m[2],n=this.m[3],s=this.m[4],o=this.m[5],a=this.m[6],h=this.m[7],u=this.m[8],l=this.m[9],c=this.m[10],f=this.m[11],d=this.m[12],p=this.m[13],_=this.m[14],m=this.m[15],g=c*m-f*_,v=l*m-f*p,y=l*_-c*p,b=u*m-f*d,T=u*_-c*d,E=u*p-l*d,x=o*g-a*v+h*y,A=-(s*g-a*b+h*T),M=s*v-o*b+h*E,P=-(s*y-o*T+a*E),R=1/(t*x+r*A+i*M+n*P),S=a*m-h*_,C=o*m-h*p,O=o*_-a*p,D=s*m-h*d,I=s*_-a*d,F=s*p-o*d,L=a*f-h*c,w=o*f-h*l,B=o*c-a*l,U=s*f-h*u,V=s*c-a*u,N=s*l-o*u;return e.m[0]=x*R,e.m[4]=A*R,e.m[8]=M*R,e.m[12]=P*R,e.m[1]=-(r*g-i*v+n*y)*R,e.m[5]=(t*g-i*b+n*T)*R,e.m[9]=-(t*v-r*b+n*E)*R,e.m[13]=(t*y-r*T+i*E)*R,e.m[2]=(r*S-i*C+n*O)*R,e.m[6]=-(t*S-i*D+n*I)*R,e.m[10]=(t*C-r*D+n*F)*R,e.m[14]=-(t*O-r*I+i*F)*R,e.m[3]=-(r*L-i*w+n*B)*R,e.m[7]=(t*L-i*U+n*V)*R,e.m[11]=-(t*w-r*U+n*N)*R,e.m[15]=(t*B-r*V+i*N)*R,e._markAsUpdated(),this},e.prototype.setTranslationFromFloats=function(e,t,r){return this.m[12]=e,this.m[13]=t,this.m[14]=r,this._markAsUpdated(),this},e.prototype.setTranslation=function(e){return this.m[12]=e.x,this.m[13]=e.y,this.m[14]=e.z,this._markAsUpdated(),this},e.prototype.getTranslation=function(){return new n(this.m[12],this.m[13],this.m[14])},e.prototype.getTranslationToRef=function(e){return e.x=this.m[12],e.y=this.m[13],e.z=this.m[14],this},e.prototype.removeRotationAndScaling=function(){return this.setRowFromFloats(0,1,0,0,0),this.setRowFromFloats(1,0,1,0,0),this.setRowFromFloats(2,0,0,1,0),this},e.prototype.multiply=function(t){var r=new e;return this.multiplyToRef(t,r),r},e.prototype.copyFrom=function(e){for(var t=0;t<16;t++)this.m[t]=e.m[t];return this._markAsUpdated(),this},e.prototype.copyToArray=function(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)e[t+r]=this.m[r];return this},e.prototype.multiplyToRef=function(e,t){return this.multiplyToArray(e,t.m,0),t._markAsUpdated(),this},e.prototype.multiplyToArray=function(e,t,r){var i=this.m[0],n=this.m[1],s=this.m[2],o=this.m[3],a=this.m[4],h=this.m[5],u=this.m[6],l=this.m[7],c=this.m[8],f=this.m[9],d=this.m[10],p=this.m[11],_=this.m[12],m=this.m[13],g=this.m[14],v=this.m[15],y=e.m[0],b=e.m[1],T=e.m[2],E=e.m[3],x=e.m[4],A=e.m[5],M=e.m[6],P=e.m[7],R=e.m[8],S=e.m[9],C=e.m[10],O=e.m[11],D=e.m[12],I=e.m[13],F=e.m[14],L=e.m[15];return t[r]=i*y+n*x+s*R+o*D,t[r+1]=i*b+n*A+s*S+o*I,t[r+2]=i*T+n*M+s*C+o*F,t[r+3]=i*E+n*P+s*O+o*L,t[r+4]=a*y+h*x+u*R+l*D,t[r+5]=a*b+h*A+u*S+l*I,t[r+6]=a*T+h*M+u*C+l*F,t[r+7]=a*E+h*P+u*O+l*L,t[r+8]=c*y+f*x+d*R+p*D,t[r+9]=c*b+f*A+d*S+p*I,t[r+10]=c*T+f*M+d*C+p*F,t[r+11]=c*E+f*P+d*O+p*L,t[r+12]=_*y+m*x+g*R+v*D,t[r+13]=_*b+m*A+g*S+v*I,t[r+14]=_*T+m*M+g*C+v*F,t[r+15]=_*E+m*P+g*O+v*L,this},e.prototype.equals=function(e){return e&&this.m[0]===e.m[0]&&this.m[1]===e.m[1]&&this.m[2]===e.m[2]&&this.m[3]===e.m[3]&&this.m[4]===e.m[4]&&this.m[5]===e.m[5]&&this.m[6]===e.m[6]&&this.m[7]===e.m[7]&&this.m[8]===e.m[8]&&this.m[9]===e.m[9]&&this.m[10]===e.m[10]&&this.m[11]===e.m[11]&&this.m[12]===e.m[12]&&this.m[13]===e.m[13]&&this.m[14]===e.m[14]&&this.m[15]===e.m[15]},e.prototype.clone=function(){return e.FromValues(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5],this.m[6],this.m[7],this.m[8],this.m[9],this.m[10],this.m[11],this.m[12],this.m[13],this.m[14],this.m[15])},e.prototype.getClassName=function(){return"Matrix"},e.prototype.getHashCode=function(){for(var e=this.m[0]||0,t=1;t<16;t++)e=397*e^(this.m[t]||0);return e},e.prototype.decompose=function(t,r,i){return i&&(i.x=this.m[12],i.y=this.m[13],i.z=this.m[14]),t=t||x.Vector3[0],t.x=Math.sqrt(this.m[0]*this.m[0]+this.m[1]*this.m[1]+this.m[2]*this.m[2]),t.y=Math.sqrt(this.m[4]*this.m[4]+this.m[5]*this.m[5]+this.m[6]*this.m[6]),t.z=Math.sqrt(this.m[8]*this.m[8]+this.m[9]*this.m[9]+this.m[10]*this.m[10]),this.determinant()<=0&&(t.y*=-1),0===t.x||0===t.y||0===t.z?(r&&(r.x=0,r.y=0,r.z=0,r.w=1),!1):(r&&(e.FromValuesToRef(this.m[0]/t.x,this.m[1]/t.x,this.m[2]/t.x,0,this.m[4]/t.y,this.m[5]/t.y,this.m[6]/t.y,0,this.m[8]/t.z,this.m[9]/t.z,this.m[10]/t.z,0,0,0,0,1,x.Matrix[0]),a.FromRotationMatrixToRef(x.Matrix[0],r)),!0)},e.prototype.getRow=function(e){if(e<0||e>3)return null;var t=4*e;return new s(this.m[t+0],this.m[t+1],this.m[t+2],this.m[t+3])},e.prototype.setRow=function(e,t){if(e<0||e>3)return this;var r=4*e;return this.m[r+0]=t.x,this.m[r+1]=t.y,this.m[r+2]=t.z,this.m[r+3]=t.w,this._markAsUpdated(),this},e.prototype.transpose=function(){return e.Transpose(this)},e.prototype.transposeToRef=function(t){return e.TransposeToRef(this,t),this},e.prototype.setRowFromFloats=function(e,t,r,i,n){if(e<0||e>3)return this;var s=4*e;return this.m[s+0]=t,this.m[s+1]=r,this.m[s+2]=i,this.m[s+3]=n,this._markAsUpdated(),this},e.prototype.scale=function(t){var r=new e;return this.scaleToRef(t,r),r},e.prototype.scaleToRef=function(e,t){for(var r=0;r<16;r++)t.m[r]=this.m[r]*e;return t._markAsUpdated(),this},e.prototype.scaleAndAddToRef=function(e,t){for(var r=0;r<16;r++)t.m[r]+=this.m[r]*e;return t._markAsUpdated(),this},e.prototype.toNormalMatrix=function(t){this.invertToRef(t),t.transpose();var r=t.m;e.FromValuesToRef(r[0],r[1],r[2],0,r[4],r[5],r[6],0,r[8],r[9],r[10],0,0,0,0,1,t)},e.prototype.getRotationMatrix=function(){var t=e.Identity();return this.getRotationMatrixToRef(t),t},e.prototype.getRotationMatrixToRef=function(t){var r=this.m,i=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),n=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),s=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]);return this.determinant()<=0&&(n*=-1),0===i||0===n||0===s?e.IdentityToRef(t):e.FromValuesToRef(r[0]/i,r[1]/i,r[2]/i,0,r[4]/n,r[5]/n,r[6]/n,0,r[8]/s,r[9]/s,r[10]/s,0,0,0,0,1,t),this},e.FromArray=function(t,r){var i=new e;return r||(r=0),e.FromArrayToRef(t,r,i),i},e.FromArrayToRef=function(e,t,r){for(var i=0;i<16;i++)r.m[i]=e[i+t];r._markAsUpdated()},e.FromFloat32ArrayToRefScaled=function(e,t,r,i){for(var n=0;n<16;n++)i.m[n]=e[n+t]*r;i._markAsUpdated()},e.FromValuesToRef=function(e,t,r,i,n,s,o,a,h,u,l,c,f,d,p,_,m){m.m[0]=e,m.m[1]=t,m.m[2]=r,m.m[3]=i,m.m[4]=n,m.m[5]=s,m.m[6]=o,m.m[7]=a,m.m[8]=h,m.m[9]=u,m.m[10]=l,m.m[11]=c,m.m[12]=f,m.m[13]=d,m.m[14]=p,m.m[15]=_,m._markAsUpdated()},Object.defineProperty(e,"IdentityReadOnly",{get:function(){return e._identityReadOnly},enumerable:!0,configurable:!0}),e.FromValues=function(t,r,i,n,s,o,a,h,u,l,c,f,d,p,_,m){var g=new e;return g.m[0]=t,g.m[1]=r,g.m[2]=i,g.m[3]=n,g.m[4]=s,g.m[5]=o,g.m[6]=a,g.m[7]=h,g.m[8]=u,g.m[9]=l,g.m[10]=c,g.m[11]=f,g.m[12]=d,g.m[13]=p,g.m[14]=_,g.m[15]=m,g},e.Compose=function(t,r,i){var n=e.Identity();return e.ComposeToRef(t,r,i,n),n},e.ComposeToRef=function(t,r,i,n){e.FromValuesToRef(t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1,x.Matrix[1]),r.toRotationMatrix(x.Matrix[0]),x.Matrix[1].multiplyToRef(x.Matrix[0],n),n.setTranslation(i)},e.Identity=function(){return e.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},e.IdentityToRef=function(t){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t)},e.Zero=function(){return e.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)},e.RotationX=function(t){var r=new e;return e.RotationXToRef(t,r),r},e.Invert=function(t){var r=new e;return t.invertToRef(r),r},e.RotationXToRef=function(e,t){var r=Math.sin(e),i=Math.cos(e);t.m[0]=1,t.m[15]=1,t.m[5]=i,t.m[10]=i,t.m[9]=-r,t.m[6]=r,t.m[1]=0,t.m[2]=0,t.m[3]=0,t.m[4]=0,t.m[7]=0,t.m[8]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t._markAsUpdated()},e.RotationY=function(t){var r=new e;return e.RotationYToRef(t,r),r},e.RotationYToRef=function(e,t){var r=Math.sin(e),i=Math.cos(e);t.m[5]=1,t.m[15]=1,t.m[0]=i,t.m[2]=-r,t.m[8]=r,t.m[10]=i,t.m[1]=0,t.m[3]=0,t.m[4]=0,t.m[6]=0,t.m[7]=0,t.m[9]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t._markAsUpdated()},e.RotationZ=function(t){var r=new e;return e.RotationZToRef(t,r),r},e.RotationZToRef=function(e,t){var r=Math.sin(e),i=Math.cos(e);t.m[10]=1,t.m[15]=1,t.m[0]=i,t.m[1]=r,t.m[4]=-r,t.m[5]=i,t.m[2]=0,t.m[3]=0,t.m[6]=0,t.m[7]=0,t.m[8]=0,t.m[9]=0,t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t._markAsUpdated()},e.RotationAxis=function(t,r){var i=e.Zero();return e.RotationAxisToRef(t,r,i),i},e.RotationAxisToRef=function(e,t,r){var i=Math.sin(-t),n=Math.cos(-t),s=1-n;e.normalize(),r.m[0]=e.x*e.x*s+n,r.m[1]=e.x*e.y*s-e.z*i,r.m[2]=e.x*e.z*s+e.y*i,r.m[3]=0,r.m[4]=e.y*e.x*s+e.z*i,r.m[5]=e.y*e.y*s+n,r.m[6]=e.y*e.z*s-e.x*i,r.m[7]=0,r.m[8]=e.z*e.x*s-e.y*i,r.m[9]=e.z*e.y*s+e.x*i,r.m[10]=e.z*e.z*s+n,r.m[11]=0,r.m[15]=1,r._markAsUpdated()},e.RotationYawPitchRoll=function(t,r,i){var n=new e;return e.RotationYawPitchRollToRef(t,r,i,n),n},e.RotationYawPitchRollToRef=function(e,t,r,i){a.RotationYawPitchRollToRef(e,t,r,this._tempQuaternion),this._tempQuaternion.toRotationMatrix(i)},e.Scaling=function(t,r,i){var n=e.Zero();return e.ScalingToRef(t,r,i,n),n},e.ScalingToRef=function(e,t,r,i){i.m[0]=e,i.m[1]=0,i.m[2]=0,i.m[3]=0,i.m[4]=0,i.m[5]=t,i.m[6]=0,i.m[7]=0,i.m[8]=0,i.m[9]=0,i.m[10]=r,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0,i.m[15]=1,i._markAsUpdated()},e.Translation=function(t,r,i){var n=e.Identity();return e.TranslationToRef(t,r,i,n),n},e.TranslationToRef=function(t,r,i,n){e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,r,i,1,n)},e.Lerp=function(t,r,i){var n=e.Zero();return e.LerpToRef(t,r,i,n),n},e.LerpToRef=function(e,t,r,i){
for(var n=0;n<16;n++)i.m[n]=e.m[n]*(1-r)+t.m[n]*r;i._markAsUpdated()},e.DecomposeLerp=function(t,r,i){var n=e.Zero();return e.DecomposeLerpToRef(t,r,i,n),n},e.DecomposeLerpToRef=function(t,r,i,s){var o=x.Vector3[0],h=x.Quaternion[0],u=x.Vector3[1];t.decompose(o,h,u);var l=x.Vector3[2],c=x.Quaternion[1],f=x.Vector3[3];r.decompose(l,c,f);var d=x.Vector3[4];n.LerpToRef(o,l,i,d);var p=x.Quaternion[2];a.SlerpToRef(h,c,i,p);var _=x.Vector3[5];n.LerpToRef(u,f,i,_),e.ComposeToRef(d,p,_,s)},e.LookAtLH=function(t,r,i){var n=e.Zero();return e.LookAtLHToRef(t,r,i,n),n},e.LookAtLHToRef=function(t,r,i,s){r.subtractToRef(t,this._zAxis),this._zAxis.normalize(),n.CrossToRef(i,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),n.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var o=-n.Dot(this._xAxis,t),a=-n.Dot(this._yAxis,t),h=-n.Dot(this._zAxis,t);return e.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,o,a,h,1,s)},e.LookAtRH=function(t,r,i){var n=e.Zero();return e.LookAtRHToRef(t,r,i,n),n},e.LookAtRHToRef=function(t,r,i,s){t.subtractToRef(r,this._zAxis),this._zAxis.normalize(),n.CrossToRef(i,this._zAxis,this._xAxis),0===this._xAxis.lengthSquared()?this._xAxis.x=1:this._xAxis.normalize(),n.CrossToRef(this._zAxis,this._xAxis,this._yAxis),this._yAxis.normalize();var o=-n.Dot(this._xAxis,t),a=-n.Dot(this._yAxis,t),h=-n.Dot(this._zAxis,t);return e.FromValuesToRef(this._xAxis.x,this._yAxis.x,this._zAxis.x,0,this._xAxis.y,this._yAxis.y,this._zAxis.y,0,this._xAxis.z,this._yAxis.z,this._zAxis.z,0,o,a,h,1,s)},e.OrthoLH=function(t,r,i,n){var s=e.Zero();return e.OrthoLHToRef(t,r,i,n,s),s},e.OrthoLHToRef=function(t,r,i,n,s){var o=i,a=n,h=2/t,u=2/r,l=2/(a-o),c=-(a+o)/(a-o);e.FromValuesToRef(h,0,0,0,0,u,0,0,0,0,l,0,0,0,c,1,s)},e.OrthoOffCenterLH=function(t,r,i,n,s,o){var a=e.Zero();return e.OrthoOffCenterLHToRef(t,r,i,n,s,o,a),a},e.OrthoOffCenterLHToRef=function(t,r,i,n,s,o,a){var h=s,u=o,l=2/(r-t),c=2/(n-i),f=2/(u-h),d=-(u+h)/(u-h),p=(t+r)/(t-r),_=(n+i)/(i-n);e.FromValuesToRef(l,0,0,0,0,c,0,0,0,0,f,0,p,_,d,1,a)},e.OrthoOffCenterRH=function(t,r,i,n,s,o){var a=e.Zero();return e.OrthoOffCenterRHToRef(t,r,i,n,s,o,a),a},e.OrthoOffCenterRHToRef=function(t,r,i,n,s,o,a){e.OrthoOffCenterLHToRef(t,r,i,n,s,o,a),a.m[10]*=-1},e.PerspectiveLH=function(t,r,i,n){var s=e.Zero(),o=i,a=n,h=2*o/t,u=2*o/r,l=(a+o)/(a-o),c=-2*a*o/(a-o);return e.FromValuesToRef(h,0,0,0,0,u,0,0,0,0,l,1,0,0,c,0,s),s},e.PerspectiveFovLH=function(t,r,i,n){var s=e.Zero();return e.PerspectiveFovLHToRef(t,r,i,n,s),s},e.PerspectiveFovLHToRef=function(t,r,i,n,s,o){void 0===o&&(o=!0);var a=i,h=n,u=1/Math.tan(.5*t),l=o?u/r:u,c=o?u:u*r,f=(h+a)/(h-a),d=-2*h*a/(h-a);e.FromValuesToRef(l,0,0,0,0,c,0,0,0,0,f,1,0,0,d,0,s)},e.PerspectiveFovRH=function(t,r,i,n){var s=e.Zero();return e.PerspectiveFovRHToRef(t,r,i,n,s),s},e.PerspectiveFovRHToRef=function(t,r,i,n,s,o){void 0===o&&(o=!0);var a=i,h=n,u=1/Math.tan(.5*t),l=o?u/r:u,c=o?u:u*r,f=-(h+a)/(h-a),d=-2*h*a/(h-a);e.FromValuesToRef(l,0,0,0,0,c,0,0,0,0,f,-1,0,0,d,0,s)},e.PerspectiveFovWebVRToRef=function(e,t,r,i,n){void 0===n&&(n=!1);var s=n?-1:1,o=Math.tan(e.upDegrees*Math.PI/180),a=Math.tan(e.downDegrees*Math.PI/180),h=Math.tan(e.leftDegrees*Math.PI/180),u=Math.tan(e.rightDegrees*Math.PI/180),l=2/(h+u),c=2/(o+a);i.m[0]=l,i.m[1]=i.m[2]=i.m[3]=i.m[4]=0,i.m[5]=c,i.m[6]=i.m[7]=0,i.m[8]=(h-u)*l*.5,i.m[9]=-(o-a)*c*.5,i.m[10]=-r/(t-r),i.m[11]=1*s,i.m[12]=i.m[13]=i.m[15]=0,i.m[14]=-2*r*t/(r-t),i._markAsUpdated()},e.GetFinalMatrix=function(t,r,i,n,s,o){var a=t.width,h=t.height,u=t.x,l=t.y,c=e.FromValues(a/2,0,0,0,0,-h/2,0,0,0,0,o-s,0,u+a/2,h/2+l,s,1);return r.multiply(i).multiply(n).multiply(c)},e.GetAsMatrix2x2=function(e){return new Float32Array([e.m[0],e.m[1],e.m[4],e.m[5]])},e.GetAsMatrix3x3=function(e){return new Float32Array([e.m[0],e.m[1],e.m[2],e.m[4],e.m[5],e.m[6],e.m[8],e.m[9],e.m[10]])},e.Transpose=function(t){var r=new e;return e.TransposeToRef(t,r),r},e.TransposeToRef=function(e,t){t.m[0]=e.m[0],t.m[1]=e.m[4],t.m[2]=e.m[8],t.m[3]=e.m[12],t.m[4]=e.m[1],t.m[5]=e.m[5],t.m[6]=e.m[9],t.m[7]=e.m[13],t.m[8]=e.m[2],t.m[9]=e.m[6],t.m[10]=e.m[10],t.m[11]=e.m[14],t.m[12]=e.m[3],t.m[13]=e.m[7],t.m[14]=e.m[11],t.m[15]=e.m[15]},e.Reflection=function(t){var r=new e;return e.ReflectionToRef(t,r),r},e.ReflectionToRef=function(e,t){e.normalize();var r=e.normal.x,i=e.normal.y,n=e.normal.z,s=-2*r,o=-2*i,a=-2*n;t.m[0]=s*r+1,t.m[1]=o*r,t.m[2]=a*r,t.m[3]=0,t.m[4]=s*i,t.m[5]=o*i+1,t.m[6]=a*i,t.m[7]=0,t.m[8]=s*n,t.m[9]=o*n,t.m[10]=a*n+1,t.m[11]=0,t.m[12]=s*e.d,t.m[13]=o*e.d,t.m[14]=a*e.d,t.m[15]=1,t._markAsUpdated()},e.FromXYZAxesToRef=function(e,t,r,i){i.m[0]=e.x,i.m[1]=e.y,i.m[2]=e.z,i.m[3]=0,i.m[4]=t.x,i.m[5]=t.y,i.m[6]=t.z,i.m[7]=0,i.m[8]=r.x,i.m[9]=r.y,i.m[10]=r.z,i.m[11]=0,i.m[12]=0,i.m[13]=0,i.m[14]=0,i.m[15]=1,i._markAsUpdated()},e.FromQuaternionToRef=function(e,t){var r=e.x*e.x,i=e.y*e.y,n=e.z*e.z,s=e.x*e.y,o=e.z*e.w,a=e.z*e.x,h=e.y*e.w,u=e.y*e.z,l=e.x*e.w;t.m[0]=1-2*(i+n),t.m[1]=2*(s+o),t.m[2]=2*(a-h),t.m[3]=0,t.m[4]=2*(s-o),t.m[5]=1-2*(n+r),t.m[6]=2*(u+l),t.m[7]=0,t.m[8]=2*(a+h),t.m[9]=2*(u-l),t.m[10]=1-2*(i+r),t.m[11]=0,t.m[12]=0,t.m[13]=0,t.m[14]=0,t.m[15]=1,t._markAsUpdated()},e._tempQuaternion=new a,e._xAxis=n.Zero(),e._yAxis=n.Zero(),e._zAxis=n.Zero(),e._updateFlagSeed=0,e._identityReadOnly=e.Identity(),e})();e.Matrix=h;var u=(function(){function e(e,t,r,i){this.normal=new n(e,t,r),this.d=i}return e.prototype.asArray=function(){return[this.normal.x,this.normal.y,this.normal.z,this.d]},e.prototype.clone=function(){return new e(this.normal.x,this.normal.y,this.normal.z,this.d)},e.prototype.getClassName=function(){return"Plane"},e.prototype.getHashCode=function(){var e=this.normal.getHashCode();return e=397*e^(this.d||0)},e.prototype.normalize=function(){var e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return 0!==e&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this},e.prototype.transform=function(t){var r=h.Transpose(t),i=this.normal.x,n=this.normal.y,s=this.normal.z,o=this.d;return new e(i*r.m[0]+n*r.m[1]+s*r.m[2]+o*r.m[3],i*r.m[4]+n*r.m[5]+s*r.m[6]+o*r.m[7],i*r.m[8]+n*r.m[9]+s*r.m[10]+o*r.m[11],i*r.m[12]+n*r.m[13]+s*r.m[14]+o*r.m[15])},e.prototype.dotCoordinate=function(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d},e.prototype.copyFromPoints=function(e,t,r){var i,n=t.x-e.x,s=t.y-e.y,o=t.z-e.z,a=r.x-e.x,h=r.y-e.y,u=r.z-e.z,l=s*u-o*h,c=o*a-n*u,f=n*h-s*a,d=Math.sqrt(l*l+c*c+f*f);return i=0!==d?1/d:0,this.normal.x=l*i,this.normal.y=c*i,this.normal.z=f*i,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this},e.prototype.isFrontFacingTo=function(e,t){return n.Dot(this.normal,e)<=t},e.prototype.signedDistanceTo=function(e){return n.Dot(e,this.normal)+this.d},e.FromArray=function(t){return new e(t[0],t[1],t[2],t[3])},e.FromPoints=function(t,r,i){var n=new e(0,0,0,0);return n.copyFromPoints(t,r,i),n},e.FromPositionAndNormal=function(t,r){var i=new e(0,0,0,0);return r.normalize(),i.normal=r,i.d=-(r.x*t.x+r.y*t.y+r.z*t.z),i},e.SignedDistanceToPlaneFromPositionAndNormal=function(e,t,r){var i=-(t.x*e.x+t.y*e.y+t.z*e.z);return n.Dot(r,t)+i},e})();e.Plane=u;var l=(function(){function e(e,t,r,i){this.x=e,this.y=t,this.width=r,this.height=i}return e.prototype.toGlobal=function(t,r){if(t.getRenderWidth){var i=t;return this.toGlobal(i.getRenderWidth(),i.getRenderHeight())}var n=t;return new e(this.x*n,this.y*r,this.width*n,this.height*r)},e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height)},e})();e.Viewport=l;var c=(function(){function e(){}return e.GetPlanes=function(t){for(var r=[],i=0;i<6;i++)r.push(new u(0,0,0,0));return e.GetPlanesToRef(t,r),r},e.GetNearPlaneToRef=function(e,t){t.normal.x=e.m[3]+e.m[2],t.normal.y=e.m[7]+e.m[6],t.normal.z=e.m[11]+e.m[10],t.d=e.m[15]+e.m[14],t.normalize()},e.GetFarPlaneToRef=function(e,t){t.normal.x=e.m[3]-e.m[2],t.normal.y=e.m[7]-e.m[6],t.normal.z=e.m[11]-e.m[10],t.d=e.m[15]-e.m[14],t.normalize()},e.GetLeftPlaneToRef=function(e,t){t.normal.x=e.m[3]+e.m[0],t.normal.y=e.m[7]+e.m[4],t.normal.z=e.m[11]+e.m[8],t.d=e.m[15]+e.m[12],t.normalize()},e.GetRightPlaneToRef=function(e,t){t.normal.x=e.m[3]-e.m[0],t.normal.y=e.m[7]-e.m[4],t.normal.z=e.m[11]-e.m[8],t.d=e.m[15]-e.m[12],t.normalize()},e.GetTopPlaneToRef=function(e,t){t.normal.x=e.m[3]-e.m[1],t.normal.y=e.m[7]-e.m[5],t.normal.z=e.m[11]-e.m[9],t.d=e.m[15]-e.m[13],t.normalize()},e.GetBottomPlaneToRef=function(e,t){t.normal.x=e.m[3]+e.m[1],t.normal.y=e.m[7]+e.m[5],t.normal.z=e.m[11]+e.m[9],t.d=e.m[15]+e.m[13],t.normalize()},e.GetPlanesToRef=function(t,r){e.GetNearPlaneToRef(t,r[0]),e.GetFarPlaneToRef(t,r[1]),e.GetLeftPlaneToRef(t,r[2]),e.GetRightPlaneToRef(t,r[3]),e.GetTopPlaneToRef(t,r[4]),e.GetBottomPlaneToRef(t,r[5])},e})();e.Frustum=c;!(function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD",e[e.BONE=2]="BONE"})(e.Space||(e.Space={}));var f=(function(){function e(){}return e.X=new n(1,0,0),e.Y=new n(0,1,0),e.Z=new n(0,0,1),e})();e.Axis=f;var d=(function(){function e(){}return e.interpolate=function(e,t,r,i,n){for(var s=1-3*i+3*t,o=3*i-6*t,a=3*t,h=e,u=0;u<5;u++){var l=h*h;h-=(s*(l*h)+o*l+a*h-e)*(1/(3*s*l+2*o*h+a)),h=Math.min(1,Math.max(0,h))}return 3*Math.pow(1-h,2)*h*r+3*(1-h)*Math.pow(h,2)*n+Math.pow(h,3)},e})();e.BezierCurve=d;var p;!(function(e){e[e.CW=0]="CW",e[e.CCW=1]="CCW"})(p=e.Orientation||(e.Orientation={}));var _=(function(){function e(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}return e.prototype.degrees=function(){return 180*this._radians/Math.PI},e.prototype.radians=function(){return this._radians},e.BetweenTwoPoints=function(t,r){var i=r.subtract(t);return new e(Math.atan2(i.y,i.x))},e.FromRadians=function(t){return new e(t)},e.FromDegrees=function(t){return new e(t*Math.PI/180)},e})();e.Angle=_;var m=(function(){function e(e,t,r){this.startPoint=e,this.midPoint=t,this.endPoint=r;var n=Math.pow(t.x,2)+Math.pow(t.y,2),s=(Math.pow(e.x,2)+Math.pow(e.y,2)-n)/2,o=(n-Math.pow(r.x,2)-Math.pow(r.y,2))/2,a=(e.x-t.x)*(t.y-r.y)-(t.x-r.x)*(e.y-t.y);this.centerPoint=new i((s*(t.y-r.y)-o*(e.y-t.y))/a,((e.x-t.x)*o-(t.x-r.x)*s)/a),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=_.BetweenTwoPoints(this.centerPoint,this.startPoint);var h=this.startAngle.degrees(),u=_.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),l=_.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();u-h>180&&(u-=360),u-h<-180&&(u+=360),l-u>180&&(l-=360),l-u<-180&&(l+=360),this.orientation=u-h<0?p.CW:p.CCW,this.angle=_.FromDegrees(this.orientation===p.CW?h-l:l-h)}return e})();e.Arc2=m;var g=(function(){function e(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new i(e,t))}return e.prototype.addLineTo=function(e,t){if(this.closed)return this;var r=new i(e,t),n=this._points[this._points.length-1];return this._points.push(r),this._length+=r.subtract(n).length(),this},e.prototype.addArcTo=function(e,t,r,n,s){if(void 0===s&&(s=36),this.closed)return this;var o=this._points[this._points.length-1],a=new i(e,t),h=new i(r,n),u=new m(o,a,h),l=u.angle.radians()/s;u.orientation===p.CW&&(l*=-1);for(var c=u.startAngle.radians()+l,f=0;f<s;f++){var d=Math.cos(c)*u.radius+u.centerPoint.x,_=Math.sin(c)*u.radius+u.centerPoint.y;this.addLineTo(d,_),c+=l}return this},e.prototype.close=function(){return this.closed=!0,this},e.prototype.length=function(){var e=this._length;if(!this.closed){var t=this._points[this._points.length-1];e+=this._points[0].subtract(t).length()}return e},e.prototype.getPoints=function(){return this._points},e.prototype.getPointAtLengthPosition=function(e){if(e<0||e>1)return i.Zero();for(var t=e*this.length(),r=0,n=0;n<this._points.length;n++){var s=(n+1)%this._points.length,o=this._points[n],a=this._points[s],h=a.subtract(o),u=h.length()+r;if(t>=r&&t<=u){var l=h.normalize(),c=t-r;return new i(o.x+l.x*c,o.y+l.y*c)}r=u}return i.Zero()},e.StartingAt=function(t,r){return new e(t,r)},e})();e.Path2=g;var v=(function(){function t(e,t,r){void 0===t&&(t=null),this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array;for(var i=0;i<e.length;i++)this._curve[i]=e[i].clone();this._raw=r||!1,this._compute(t)}return t.prototype.getCurve=function(){return this._curve},t.prototype.getTangents=function(){return this._tangents},t.prototype.getNormals=function(){return this._normals},t.prototype.getBinormals=function(){return this._binormals},t.prototype.getDistances=function(){return this._distances},t.prototype.update=function(e,t){void 0===t&&(t=null);for(var r=0;r<e.length;r++)this._curve[r].x=e[r].x,this._curve[r].y=e[r].y,this._curve[r].z=e[r].z;return this._compute(t),this},t.prototype._compute=function(e){var t=this._curve.length;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[t-1]=this._curve[t-1].subtract(this._curve[t-2]),this._raw||this._tangents[t-1].normalize();var r=this._tangents[0],i=this._normalVector(this._curve[0],r,e);this._normals[0]=i,this._raw||this._normals[0].normalize(),this._binormals[0]=n.Cross(r,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;for(var s,o,a,h,u=1;u<t;u++)s=this._getLastNonNullVector(u),u<t-1&&(o=this._getFirstNonNullVector(u),this._tangents[u]=s.add(o),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+s.length(),a=this._tangents[u],h=this._binormals[u-1],this._normals[u]=n.Cross(h,a),this._raw||this._normals[u].normalize(),this._binormals[u]=n.Cross(a,this._normals[u]),this._raw||this._binormals[u].normalize()},t.prototype._getFirstNonNullVector=function(e){for(var t=1,r=this._curve[e+t].subtract(this._curve[e]);0===r.length()&&e+t+1<this._curve.length;)t++,r=this._curve[e+t].subtract(this._curve[e]);return r},t.prototype._getLastNonNullVector=function(e){for(var t=1,r=this._curve[e].subtract(this._curve[e-t]);0===r.length()&&e>t+1;)t++,r=this._curve[e].subtract(this._curve[e-t]);return r},t.prototype._normalVector=function(t,r,i){var s,o=r.length();if(0===o&&(o=1),void 0===i||null===i){var a;a=e.Scalar.WithinEpsilon(Math.abs(r.y)/o,1,e.Epsilon)?e.Scalar.WithinEpsilon(Math.abs(r.x)/o,1,e.Epsilon)?e.Scalar.WithinEpsilon(Math.abs(r.z)/o,1,e.Epsilon)?n.Zero():new n(0,0,1):new n(1,0,0):new n(0,-1,0),s=n.Cross(r,a)}else s=n.Cross(r,i),n.CrossToRef(s,r,s);return s.normalize(),s},t})();e.Path3D=v;var y=(function(){function e(e){this._length=0,this._points=e,this._length=this._computeLength(e)}return e.CreateQuadraticBezier=function(t,r,i,s){s=s>2?s:3;for(var o=new Array,a=function(e,t,r,i){return(1-e)*(1-e)*t+2*e*(1-e)*r+e*e*i},h=0;h<=s;h++)o.push(new n(a(h/s,t.x,r.x,i.x),a(h/s,t.y,r.y,i.y),a(h/s,t.z,r.z,i.z)));return new e(o)},e.CreateCubicBezier=function(t,r,i,s,o){o=o>3?o:4;for(var a=new Array,h=function(e,t,r,i,n){return(1-e)*(1-e)*(1-e)*t+3*e*(1-e)*(1-e)*r+3*e*e*(1-e)*i+e*e*e*n},u=0;u<=o;u++)a.push(new n(h(u/o,t.x,r.x,i.x,s.x),h(u/o,t.y,r.y,i.y,s.y),h(u/o,t.z,r.z,i.z,s.z)));return new e(a)},e.CreateHermiteSpline=function(t,r,i,s,o){for(var a=new Array,h=1/o,u=0;u<=o;u++)a.push(n.Hermite(t,r,i,s,u*h));return new e(a)},e.CreateCatmullRomSpline=function(t,r,i){var s=new Array,o=1/r,a=0;if(i){for(var h=t.length,u=0;u<h;u++){a=0;for(var l=0;l<r;l++)s.push(n.CatmullRom(t[u%h],t[(u+1)%h],t[(u+2)%h],t[(u+3)%h],a)),a+=o}s.push(s[0])}else{var c=new Array;c.push(t[0].clone()),Array.prototype.push.apply(c,t),c.push(t[t.length-1].clone());for(var u=0;u<c.length-3;u++){a=0;for(var l=0;l<r;l++)s.push(n.CatmullRom(c[u],c[u+1],c[u+2],c[u+3],a)),a+=o}u--,s.push(n.CatmullRom(c[u],c[u+1],c[u+2],c[u+3],a))}return new e(s)},e.prototype.getPoints=function(){return this._points},e.prototype.length=function(){return this._length},e.prototype.continue=function(t){for(var r=this._points[this._points.length-1],i=this._points.slice(),n=t.getPoints(),s=1;s<n.length;s++)i.push(n[s].subtract(n[0]).add(r));return new e(i)},e.prototype._computeLength=function(e){for(var t=0,r=1;r<e.length;r++)t+=e[r].subtract(e[r-1]).length();return t},e})();e.Curve3=y;var b=(function(){function e(e,t){void 0===e&&(e=n.Zero()),void 0===t&&(t=n.Up()),this.position=e,this.normal=t}return e.prototype.clone=function(){return new e(this.position.clone(),this.normal.clone())},e})();e.PositionNormalVertex=b;var T=(function(){function e(e,t,r){void 0===e&&(e=n.Zero()),void 0===t&&(t=n.Up()),void 0===r&&(r=i.Zero()),this.position=e,this.normal=t,this.uv=r}return e.prototype.clone=function(){return new e(this.position.clone(),this.normal.clone(),this.uv.clone())},e})();e.PositionNormalTextureVertex=T;var E=(function(){function e(){}return e.Color3=[t.Black(),t.Black(),t.Black()],e.Vector2=[i.Zero(),i.Zero(),i.Zero()],e.Vector3=[n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero()],e.Vector4=[s.Zero(),s.Zero(),s.Zero()],e.Quaternion=[a.Zero(),a.Zero()],e.Matrix=[h.Zero(),h.Zero(),h.Zero(),h.Zero(),h.Zero(),h.Zero(),h.Zero(),h.Zero()],e})();e.Tmp=E;var x=(function(){function e(){}return e.Vector3=[n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero(),n.Zero()],e.Matrix=[h.Zero(),h.Zero()],e.Quaternion=[a.Zero(),a.Zero(),a.Zero()],e})()})(i||(i={}));var i;!(function(e){var t=(function(){function e(){}return e.WithinEpsilon=function(e,t,r){void 0===r&&(r=1.401298e-45);var i=e-t;return-r<=i&&i<=r},e.ToHex=function(e){var t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()},e.Sign=function(e){return e=+e,0===e||isNaN(e)?e:e>0?1:-1},e.Clamp=function(e,t,r){return void 0===t&&(t=0),void 0===r&&(r=1),Math.min(r,Math.max(t,e))},e.Log2=function(e){return Math.log(e)*Math.LOG2E},e.Repeat=function(e,t){return e-Math.floor(e/t)*t},e.Normalize=function(e,t,r){return(e-t)/(r-t)},e.Denormalize=function(e,t,r){return e*(r-t)+t},e.DeltaAngle=function(t,r){var i=e.Repeat(r-t,360);return i>180&&(i-=360),i},e.PingPong=function(t,r){var i=e.Repeat(t,2*r);return r-Math.abs(i-r)},e.SmoothStep=function(t,r,i){var n=e.Clamp(i);return n=-2*n*n*n+3*n*n,r*n+t*(1-n)},e.MoveTowards=function(t,r,i){return Math.abs(r-t)<=i?r:t+e.Sign(r-t)*i},e.MoveTowardsAngle=function(t,r,i){var n=e.DeltaAngle(t,r),s=0;return-i<n&&n<i?s=r:(r=t+n,s=e.MoveTowards(t,r,i)),s},e.Lerp=function(e,t,r){return e+(t-e)*r},e.LerpAngle=function(t,r,i){var n=e.Repeat(r-t,360);return n>180&&(n-=360),t+n*e.Clamp(i)},e.InverseLerp=function(t,r,i){return t!=r?e.Clamp((i-t)/(r-t)):0},e.Hermite=function(e,t,r,i,n){var s=n*n,o=n*s;return e*(2*o-3*s+1)+r*(-2*o+3*s)+t*(o-2*s+n)+i*(o-s)},e.RandomRange=function(e,t){return e===t?e:Math.random()*(t-e)+e},e.RangeToPercent=function(e,t,r){return(e-t)/(r-t)},e.PercentToRange=function(e,t,r){return(r-t)*e+t},e.NormalizeRadians=function(t){return t-=e.TwoPi*Math.floor((t+Math.PI)/e.TwoPi)},e.TwoPi=2*Math.PI,e})();e.Scalar=t})(i||(i={}));var i;!(function(e){function t(e){var t=e.getClassName();return v[t]||(v[t]={}),v[t]}function r(e){var t=e.getClassName();if(y[t])return y[t];y[t]={};for(var r=y[t],i=e,n=t;n;){var s=v[n];for(var o in s)r[o]=s[o];var a=void 0,h=!1;do{if(a=Object.getPrototypeOf(i),!a.getClassName){h=!0;break}if(a.getClassName()!==n)break;i=a}while(a);if(h)break;n=a.getClassName(),i=a}return r}function i(e,r){return function(i,n){var s=t(i);s[n]||(s[n]={type:e,sourceName:r})}}function n(e,t){return void 0===t&&(t=null),function(r,i){var n=t||"_"+i;Object.defineProperty(r,i,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,r[e].apply(this))},enumerable:!0,configurable:!0})}}function s(e,t){return void 0===t&&(t=null),n(e,t)}function o(e){return i(0,e)}function a(e){return i(1,e)}function h(e){return i(2,e)}function u(e){return i(3,e)}function l(e){return i(4,e)}function c(e){return i(5,e)}function f(e){return i(6,e)}function d(e){return i(7,e)}function p(e){return i(8,e)}function _(e){return i(9,e)}function m(e){return i(10,e)}function g(e){return i(11,e)}var v={},y={},b=function(t,i,n){var s=t();e.Tags&&e.Tags.AddTagsTo(s,i.tags);var o=r(s);for(var a in o){var h=o[a],u=i[a],l=h.type;if(void 0!==u&&null!==u)switch(l){case 0:case 6:case 11:s[a]=u;break;case 1:s[a]=n||u.isRenderTarget?u:u.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:s[a]=n?u:u.clone()}}return s};e.expandToProperty=s,e.serialize=o,e.serializeAsTexture=a,e.serializeAsColor3=h,e.serializeAsFresnelParameters=u,e.serializeAsVector2=l,e.serializeAsVector3=c,e.serializeAsMeshReference=f,e.serializeAsColorCurves=d,e.serializeAsColor4=p,e.serializeAsImageProcessingConfiguration=_,e.serializeAsQuaternion=m,e.serializeAsCameraReference=g;var T=(function(){function t(){}return t.Serialize=function(t,i){i||(i={}),e.Tags&&(i.tags=e.Tags.GetTags(t));var n=r(t);for(var s in n){var o=n[s],a=o.sourceName||s,h=o.type,u=t[s];if(void 0!==u&&null!==u)switch(h){case 0:i[a]=u;break;case 1:i[a]=u.serialize();break;case 2:i[a]=u.asArray();break;case 3:i[a]=u.serialize();break;case 4:case 5:i[a]=u.asArray();break;case 6:i[a]=u.id;break;case 7:i[a]=u.serialize();break;case 8:i[a]=u.asArray();break;case 9:i[a]=u.serialize();break;case 10:i[a]=u.asArray();break;case 11:i[a]=u.id}}return i},t.Parse=function(t,i,n,s){void 0===s&&(s=null);var o=t();s||(s=""),e.Tags&&e.Tags.AddTagsTo(o,i.tags);var a=r(o);for(var h in a){var u=a[h],l=i[u.sourceName||h],c=u.type;if(void 0!==l&&null!==l){var f=o;switch(c){case 0:f[h]=l;break;case 1:n&&(f[h]=e.Texture.Parse(l,n,s));break;case 2:f[h]=e.Color3.FromArray(l);break;case 3:f[h]=e.FresnelParameters.Parse(l);break;case 4:f[h]=e.Vector2.FromArray(l);break;case 5:f[h]=e.Vector3.FromArray(l);break;case 6:n&&(f[h]=n.getLastMeshByID(l));break;case 7:f[h]=e.ColorCurves.Parse(l);break;case 8:f[h]=e.Color4.FromArray(l);break;case 9:f[h]=e.ImageProcessingConfiguration.Parse(l);break;case 10:f[h]=e.Quaternion.FromArray(l);break;case 11:n&&(f[h]=n.getCameraByID(l))}}}return o},t.Clone=function(e,t){return b(e,t,!1)},t.Instanciate=function(e,t){return b(e,t,!0)},t})();e.SerializationHelper=T})(i||(i={}));var i;!(function(e){var t=(function(){function e(){var e=this;this.promise=new Promise(function(t,r){e._resolve=t,e._reject=r})}return Object.defineProperty(e.prototype,"resolve",{get:function(){return this._resolve},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"reject",{get:function(){return this._reject},enumerable:!0,configurable:!0}),e})();e.Deferred=t})(i||(i={}));var i;!(function(e){var t=(function(){function e(e,t,r,i){void 0===t&&(t=!1),this.initalize(e,t,r,i)}return e.prototype.initalize=function(e,t,r,i){return void 0===t&&(t=!1),this.mask=e,this.skipNextObservers=t,this.target=r,this.currentTarget=i,this},e})();e.EventState=t;var r=(function(){function e(e,t,r){void 0===r&&(r=null),this.callback=e,this.mask=t,this.scope=r,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}return e})();e.Observer=r;var i=(function(){function e(){}return e.prototype.dispose=function(){if(this._observers&&this._observables)for(var e=0;e<this._observers.length;e++)this._observables[e].remove(this._observers[e]);this._observers=null,this._observables=null},e.Watch=function(t,r,i,n){void 0===i&&(i=-1),void 0===n&&(n=null);var s=new e;s._observers=new Array,s._observables=t;for(var o=0,a=t;o<a.length;o++){var h=a[o],u=h.add(r,i,!1,n);u&&s._observers.push(u)}return s},e})();e.MultiObserver=i;var n=(function(){function i(e){this._observers=new Array,this._eventState=new t(0),e&&(this._onObserverAdded=e)}return i.prototype.add=function(e,t,i,n,s){if(void 0===t&&(t=-1),void 0===i&&(i=!1),void 0===n&&(n=null),void 0===s&&(s=!1),!e)return null;var o=new r(e,t,n);return o.unregisterOnNextCall=s,i?this._observers.unshift(o):this._observers.push(o),this._onObserverAdded&&this._onObserverAdded(o),o},i.prototype.addOnce=function(e){return this.add(e,void 0,void 0,void 0,!0)},i.prototype.remove=function(e){if(!e)return!1;var t=this._observers.indexOf(e);return-1!==t&&(this._observers.splice(t,1),!0)},i.prototype.removeCallback=function(e,t){for(var r=0;r<this._observers.length;r++)if(this._observers[r].callback===e&&(!t||t===this._observers[r].scope))return this._observers.splice(r,1),!0;return!1},i.prototype._deferUnregister=function(t){var r=this;t.unregisterOnNextCall=!1,t._willBeUnregistered=!0,e.Tools.SetImmediate((function(){r.remove(t)}))},i.prototype.notifyObservers=function(e,t,r,i){if(void 0===t&&(t=-1),!this._observers.length)return!0;var n=this._eventState;n.mask=t,n.target=r,n.currentTarget=i,n.skipNextObservers=!1,n.lastReturnValue=e;for(var s=0,o=this._observers;s<o.length;s++){var a=o[s];if(!a._willBeUnregistered&&(a.mask&t&&(a.scope?n.lastReturnValue=a.callback.apply(a.scope,[e,n]):n.lastReturnValue=a.callback(e,n),a.unregisterOnNextCall&&this._deferUnregister(a)),n.skipNextObservers))return!1}return!0},i.prototype.notifyObserversWithPromise=function(e,t,r,i){var n=this;void 0===t&&(t=-1);var s=Promise.resolve(e);if(!this._observers.length)return s;var o=this._eventState;return o.mask=t,o.target=r,o.currentTarget=i,o.skipNextObservers=!1,this._observers.forEach((function(r){o.skipNextObservers||r._willBeUnregistered||r.mask&t&&(s=r.scope?s.then((function(t){return o.lastReturnValue=t,r.callback.apply(r.scope,[e,o])})):s.then((function(t){return o.lastReturnValue=t,r.callback(e,o)})),r.unregisterOnNextCall&&n._deferUnregister(r))})),s.then((function(){return e}))},i.prototype.notifyObserver=function(e,t,r){void 0===r&&(r=-1);var i=this._eventState;i.mask=r,i.skipNextObservers=!1,e.callback(t,i)},i.prototype.hasObservers=function(){return this._observers.length>0},i.prototype.clear=function(){this._observers=new Array,this._onObserverAdded=null},i.prototype.clone=function(){var e=new i;return e._observers=this._observers.slice(0),e},i.prototype.hasSpecificMask=function(e){void 0===e&&(e=-1);for(var t=0,r=this._observers;t<r.length;t++){var i=r[t];if(i.mask&e||i.mask===e)return!0}return!1},i})();e.Observable=n})(i||(i={}));var i;!(function(e){var t=(function(){function e(t){this.length=0,this.data=new Array(t),this._id=e._GlobalId++}return e.prototype.push=function(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)},e.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e(this.data[t])},e.prototype.sort=function(e){this.data.sort(e)},e.prototype.reset=function(){this.length=0},e.prototype.dispose=function(){this.reset(),this.data&&(this.data.length=0,this.data=[])},e.prototype.concat=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}},e.prototype.indexOf=function(e){var t=this.data.indexOf(e);return t>=this.length?-1:t},e.prototype.contains=function(e){return-1!==this.data.indexOf(e)},e._GlobalId=0,e})();e.SmartArray=t;var r=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._duplicateId=0,t}return s(t,e),t.prototype.push=function(t){e.prototype.push.call(this,t),t.__smartArrayFlags||(t.__smartArrayFlags={}),t.__smartArrayFlags[this._id]=this._duplicateId},t.prototype.pushNoDuplicate=function(e){return(!e.__smartArrayFlags||e.__smartArrayFlags[this._id]!==this._duplicateId)&&(this.push(e),!0)},t.prototype.reset=function(){e.prototype.reset.call(this),this._duplicateId++},t.prototype.concatWithNoDuplicate=function(e){if(0!==e.length){this.length+e.length>this.data.length&&(this.data.length=2*(this.length+e.length));for(var t=0;t<e.length;t++){var r=(e.data||e)[t];this.pushNoDuplicate(r)}}},t})(t);e.SmartArrayNoDuplicate=r})(i||(i={}));var i;!(function(e){function t(e,t){return function(r){r.__bjsclassName__=e,r.__bjsmoduleName__=null!=t?t:null}}var r=(function(e){function t(r,i){var n=e.call(this,r)||this;return n.request=i,n.name="LoadFileError",t._setPrototypeOf(n,t.prototype),n}return s(t,e),t._setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t})(Error);e.LoadFileError=r;var i=(function(){function e(){}return e.ExponentialBackoff=function(e,t){return void 0===e&&(e=3),void 0===t&&(t=500),function(r,i,n){return 0!==i.status||n>=e||-1!==r.indexOf("file:")?-1:Math.pow(2,n)*t}},e})();e.RetryStrategy=i;var n,o=function(t,r){return t?t instanceof e.Mesh?null:t instanceof e.SubMesh?t.clone(r):t.clone?t.clone():null:null},a=(function(){function t(){}return t.Mix=function(e,t,r){return e*(1-r)+t*r},t.Instantiate=function(e){if(t.RegisteredExternalClasses&&t.RegisteredExternalClasses[e])return t.RegisteredExternalClasses[e];for(var r=e.split("."),i=window||this,n=0,s=r.length;n<s;n++)i=i[r[n]];return"function"!=typeof i?null:i},t.Slice=function(e,t,r){return e.slice?e.slice(t,r):Array.prototype.slice.call(e,t,r)},t.SetImmediate=function(e){window.setImmediate?window.setImmediate(e):setTimeout(e,1)},t.IsExponentOfTwo=function(e){var t=1;do{t*=2}while(t<e);return t===e},t.FloatRound=function(e){return Math.fround?Math.fround(e):t._tmpFloatArray[0]=e},t.CeilingPOT=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},t.FloorPOT=function(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,(e|=e>>16)-(e>>1)},t.NearestPOT=function(e){var r=t.CeilingPOT(e),i=t.FloorPOT(e);return r-e>e-i?i:r},t.GetExponentOfTwo=function(r,i,n){void 0===n&&(n=e.Engine.SCALEMODE_NEAREST);var s;switch(n){case e.Engine.SCALEMODE_FLOOR:s=t.FloorPOT(r);break;case e.Engine.SCALEMODE_NEAREST:s=t.NearestPOT(r);break;case e.Engine.SCALEMODE_CEILING:default:s=t.CeilingPOT(r)}return Math.min(s,i)},t.GetFilename=function(e){var t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)},t.GetFolderPath=function(e,t){void 0===t&&(t=!1);var r=e.lastIndexOf("/");return r<0?t?e:"":e.substring(0,r+1)},t.GetDOMTextContent=function(e){for(var t="",r=e.firstChild;r;)3===r.nodeType&&(t+=r.textContent),r=r.nextSibling;return t},t.ToDegrees=function(e){return 180*e/Math.PI},t.ToRadians=function(e){return e*Math.PI/180},t.EncodeArrayBufferTobase64=function(e){for(var t,r,i,n,s,o,a,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u="",l=0,c=new Uint8Array(e);l<c.length;)t=c[l++],r=l<c.length?c[l++]:Number.NaN,i=l<c.length?c[l++]:Number.NaN,n=t>>2,s=(3&t)<<4|r>>4,o=(15&r)<<2|i>>6,a=63&i,isNaN(r)?o=a=64:isNaN(i)&&(a=64),u+=h.charAt(n)+h.charAt(s)+h.charAt(o)+h.charAt(a);return"data:image/png;base64,"+u},t.ExtractMinAndMaxIndexed=function(t,r,i,n,s){void 0===s&&(s=null);for(var o=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),h=i;h<i+n;h++){var u=new e.Vector3(t[3*r[h]],t[3*r[h]+1],t[3*r[h]+2]);o=e.Vector3.Minimize(u,o),a=e.Vector3.Maximize(u,a)}return s&&(o.x-=o.x*s.x+s.y,o.y-=o.y*s.x+s.y,o.z-=o.z*s.x+s.y,a.x+=a.x*s.x+s.y,a.y+=a.y*s.x+s.y,a.z+=a.z*s.x+s.y),{minimum:o,maximum:a}},t.ExtractMinAndMax=function(t,r,i,n,s){void 0===n&&(n=null);var o=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);s||(s=3);for(var h=r;h<r+i;h++){var u=new e.Vector3(t[h*s],t[h*s+1],t[h*s+2]);o=e.Vector3.Minimize(u,o),a=e.Vector3.Maximize(u,a)}return n&&(o.x-=o.x*n.x+n.y,o.y-=o.y*n.x+n.y,o.z-=o.z*n.x+n.y,a.x+=a.x*n.x+n.y,a.y+=a.y*n.x+n.y,a.z+=a.z*n.x+n.y),{minimum:o,maximum:a}},t.Vector2ArrayFeeder=function(t){return function(r){var i=void 0!==t.BYTES_PER_ELEMENT;if(r>=(i?t.length/2:t.length))return null;if(i){var n=t;return new e.Vector2(n[2*r+0],n[2*r+1])}return t[r]}},t.ExtractMinAndMaxVector2=function(t,r){void 0===r&&(r=null);for(var i=new e.Vector2(Number.MAX_VALUE,Number.MAX_VALUE),n=new e.Vector2(-Number.MAX_VALUE,-Number.MAX_VALUE),s=0,o=t(s++);o;)i=e.Vector2.Minimize(o,i),n=e.Vector2.Maximize(o,n),o=t(s++);return r&&(i.x-=i.x*r.x+r.y,i.y-=i.y*r.x+r.y,n.x+=n.x*r.x+r.y,n.y+=n.y*r.x+r.y),{minimum:i,maximum:n}},t.MakeArray=function(e,t){return!0===t||void 0!==e&&null!=e?Array.isArray(e)?e:[e]:null},t.GetPointerPrefix=function(){var e="pointer";return!t.IsWindowObjectExist()||window.PointerEvent||navigator.pointerEnabled||(e="mouse"),e},
t.QueueNewFrame=function(e,r){return t.IsWindowObjectExist()?(r||(r=window),r.requestAnimationFrame?r.requestAnimationFrame(e):r.msRequestAnimationFrame?r.msRequestAnimationFrame(e):r.webkitRequestAnimationFrame?r.webkitRequestAnimationFrame(e):r.mozRequestAnimationFrame?r.mozRequestAnimationFrame(e):r.oRequestAnimationFrame?r.oRequestAnimationFrame(e):window.setTimeout(e,16)):setTimeout(e,16)},t.RequestFullscreen=function(e){var t=e.requestFullscreen||e.msRequestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen;t&&t.call(e)},t.ExitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msCancelFullScreen&&document.msCancelFullScreen()},t.SetCorsBehavior=function(e,r){if((!e||0!==e.indexOf("data:"))&&t.CorsBehavior)if("string"==typeof t.CorsBehavior||t.CorsBehavior instanceof String)r.crossOrigin=t.CorsBehavior;else{var i=t.CorsBehavior(e);i&&(r.crossOrigin=i)}},t.CleanUrl=function(e){return e=e.replace(/#/gm,"%23")},t.LoadImage=function(r,i,n,s){var o,a=!1;r instanceof ArrayBuffer?(o=URL.createObjectURL(new Blob([r])),a=!0):r instanceof Blob?(o=URL.createObjectURL(r),a=!0):(o=t.CleanUrl(r),o=t.PreprocessUrl(r));var h=new Image;t.SetCorsBehavior(o,h);var u=function(){a&&h.src&&URL.revokeObjectURL(h.src),h.removeEventListener("load",u),h.removeEventListener("error",l),i(h)},l=function(e){a&&h.src&&URL.revokeObjectURL(h.src),h.removeEventListener("load",u),h.removeEventListener("error",l),t.Error("Error while trying to load image: "+r),n&&n("Error while trying to load image: "+r,e)};h.addEventListener("load",u),h.addEventListener("error",l);var c=function(){h.src=o},f=function(){s&&s.loadImageFromDB(o,h)};if("data:"!==o.substr(0,5)&&s&&s.enableTexturesOffline&&e.Database.IsUASupportingBlobStorage)s.openAsync(f,c);else{if(-1!==o.indexOf("file:")){var d=decodeURIComponent(o.substring(5).toLowerCase());if(e.FilesInput.FilesToLoad[d]){try{var p;try{p=URL.createObjectURL(e.FilesInput.FilesToLoad[d],{oneTimeOnly:!0})}catch(t){p=URL.createObjectURL(e.FilesInput.FilesToLoad[d])}h.src=p,a=!0}catch(e){h.src=""}return h}}c()}return h},t.LoadFile=function(i,n,s,o,a,h){if(i=t.CleanUrl(i),i=t.PreprocessUrl(i),-1!==i.indexOf("file:")){var u=decodeURIComponent(i.substring(5).toLowerCase());if(e.FilesInput.FilesToLoad[u])return t.ReadFile(e.FilesInput.FilesToLoad[u],n,s,a)}var l=t.BaseUrl+i,c=!1,f={onCompleteObservable:new e.Observable,abort:function(){return c=!0}},d=function(){var e=new XMLHttpRequest,i=null;f.abort=function(){c=!0,e.readyState!==(XMLHttpRequest.DONE||4)&&e.abort(),null!==i&&(clearTimeout(i),i=null)};var o=function(u){e.open("GET",l,!0),a&&(e.responseType="arraybuffer"),s&&e.addEventListener("progress",s);var d=function(){e.removeEventListener("loadend",d),f.onCompleteObservable.notifyObservers(f),f.onCompleteObservable.clear()};e.addEventListener("loadend",d);var p=function(){if(!c&&e.readyState===(XMLHttpRequest.DONE||4)){if(e.removeEventListener("readystatechange",p),e.status>=200&&e.status<300||!t.IsWindowObjectExist()&&0===e.status)return void n(a?e.response:e.responseText,e.responseURL);var s=t.DefaultRetryStrategy;if(s){var f=s(l,e,u);if(-1!==f)return e.removeEventListener("loadend",d),e=new XMLHttpRequest,void(i=setTimeout((function(){return o(u+1)}),f))}var _=new r("Error status: "+e.status+" "+e.statusText+" - Unable to load "+l,e);if(!h)throw _;h(e,_)}};e.addEventListener("readystatechange",p),e.send()};o(0)};if(o&&o.enableSceneOffline){var p=function(){c||d()},_=function(){c||o&&o.loadFileFromDB(i,(function(e){c||n(e),f.onCompleteObservable.notifyObservers(f)}),s?function(e){c||s(e)}:void 0,p,a)};o.openAsync(_,p)}else d();return f},t.LoadScript=function(e,t,r){var i=document.getElementsByTagName("head")[0],n=document.createElement("script");n.type="text/javascript",n.src=e,n.onload=function(){t&&t()},n.onerror=function(t){r&&r("Unable to load script '"+e+"'",t)},i.appendChild(n)},t.ReadFileAsDataURL=function(t,r,i){var n=new FileReader,s={onCompleteObservable:new e.Observable,abort:function(){return n.abort()}};return n.onloadend=function(e){s.onCompleteObservable.notifyObservers(s)},n.onload=function(e){r(e.target.result)},n.onprogress=i,n.readAsDataURL(t),s},t.ReadFile=function(r,i,n,s){var o=new FileReader,a={onCompleteObservable:new e.Observable,abort:function(){return o.abort()}};return o.onloadend=function(e){return a.onCompleteObservable.notifyObservers(a)},o.onerror=function(e){t.Log("Error while reading file: "+r.name),i(JSON.stringify({autoClear:!0,clearColor:[1,0,0],ambientColor:[0,0,0],gravity:[0,-9.807,0],meshes:[],cameras:[],lights:[]}))},o.onload=function(e){i(e.target.result)},n&&(o.onprogress=n),s?o.readAsArrayBuffer(r):o.readAsText(r),a},t.FileAsURL=function(e){var t=new Blob([e]);return(window.URL||window.webkitURL).createObjectURL(t)},t.Format=function(e,t){return void 0===t&&(t=2),e.toFixed(t)},t.CheckExtends=function(e,t,r){e.x<t.x&&(t.x=e.x),e.y<t.y&&(t.y=e.y),e.z<t.z&&(t.z=e.z),e.x>r.x&&(r.x=e.x),e.y>r.y&&(r.y=e.y),e.z>r.z&&(r.z=e.z)},t.DeepCopy=function(e,t,r,i){for(var n in e)if(("_"!==n[0]||i&&-1!==i.indexOf(n))&&(!r||-1===r.indexOf(n))){var s=e[n],a=typeof s;if("function"!==a)try{if("object"===a)if(s instanceof Array){if(t[n]=[],s.length>0)if("object"==typeof s[0])for(var h=0;h<s.length;h++){var u=o(s[h],t);-1===t[n].indexOf(u)&&t[n].push(u)}else t[n]=s.slice(0)}else t[n]=o(s,t);else t[n]=s}catch(e){}}},t.IsEmpty=function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},t.RegisterTopRootEvents=function(e){for(var t=0;t<e.length;t++){var r=e[t];window.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch(e){}}},t.UnregisterTopRootEvents=function(e){for(var t=0;t<e.length;t++){var r=e[t];window.removeEventListener(r.name,r.handler);try{window.parent&&window.parent.removeEventListener(r.name,r.handler)}catch(e){}}},t.DumpFramebuffer=function(e,r,i,s,o,a){void 0===o&&(o="image/png");for(var h=4*e,u=r/2,l=i.readPixels(0,0,e,r),c=0;c<u;c++)for(var f=0;f<h;f++){var d=f+c*h,p=r-c-1,_=f+p*h,m=l[d];l[d]=l[_],l[_]=m}n||(n=document.createElement("canvas")),n.width=e,n.height=r;var g=n.getContext("2d");if(g){var v=g.createImageData(e,r);v.data.set(l),g.putImageData(v,0,0),t.EncodeScreenshotCanvasData(s,o,a)}},t.EncodeScreenshotCanvasData=function(e,r,i){void 0===r&&(r="image/png");var s=n.toDataURL(r);e?e(s):(n.toBlob||(n.toBlob=function(e,t,r){var i=this;setTimeout((function(){for(var n=atob(i.toDataURL(t,r).split(",")[1]),s=n.length,o=new Uint8Array(s),a=0;a<s;a++)o[a]=n.charCodeAt(a);e(new Blob([o],{type:t||"image/png"}))}))}),n.toBlob((function(e){if("download"in document.createElement("a")){if(!i){var r=new Date,n=(r.getFullYear()+"-"+(r.getMonth()+1)).slice(2)+"-"+r.getDate()+"_"+r.getHours()+"-"+("0"+r.getMinutes()).slice(-2);i="screenshot_"+n+".png"}t.Download(e,i)}else{var s=URL.createObjectURL(e),o=window.open("");if(!o)return;var a=o.document.createElement("img");a.onload=function(){URL.revokeObjectURL(s)},a.src=s,o.document.body.appendChild(a)}})))},t.Download=function(e,t){var r=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.style.display="none",i.href=r,i.download=t,i.addEventListener("click",(function(){i.parentElement&&i.parentElement.removeChild(i)})),i.click(),window.URL.revokeObjectURL(r)},t.CreateScreenshot=function(e,r,i,s,o){void 0===o&&(o="image/png");var a,h;if(i.precision)a=Math.round(e.getRenderWidth()*i.precision),h=Math.round(a/e.getAspectRatio(r));else if(i.width&&i.height)a=i.width,h=i.height;else if(i.width&&!i.height)a=i.width,h=Math.round(a/e.getAspectRatio(r));else if(i.height&&!i.width)h=i.height,a=Math.round(h*e.getAspectRatio(r));else{if(isNaN(i))return void t.Error("Invalid 'size' parameter !");h=i,a=i}n||(n=document.createElement("canvas")),n.width=a,n.height=h;var u=n.getContext("2d"),l=e.getRenderWidth()/e.getRenderHeight(),c=a,f=c/l;f>h&&(f=h,c=f*l);var d=Math.max(0,a-c)/2,p=Math.max(0,h-f)/2,_=e.getRenderingCanvas();u&&_&&u.drawImage(_,d,p,c,f),t.EncodeScreenshotCanvasData(s,o)},t.CreateScreenshotUsingRenderTarget=function(r,i,n,s,o,a,h,u){void 0===o&&(o="image/png"),void 0===a&&(a=1),void 0===h&&(h=!1);var l,c;if(n.precision)l=Math.round(r.getRenderWidth()*n.precision),c=Math.round(l/r.getAspectRatio(i)),n={width:l,height:c};else if(n.width&&n.height)l=n.width,c=n.height;else if(n.width&&!n.height)l=n.width,c=Math.round(l/r.getAspectRatio(i)),n={width:l,height:c};else if(n.height&&!n.width)c=n.height,l=Math.round(c*r.getAspectRatio(i)),n={width:l,height:c};else{if(isNaN(n))return void t.Error("Invalid 'size' parameter !");c=n,l=n}var f=i.getScene(),d=null;f.activeCamera!==i&&(d=f.activeCamera,f.activeCamera=i);var p=new e.RenderTargetTexture("screenShot",n,f,!1,!1,e.Engine.TEXTURETYPE_UNSIGNED_INT,!1,e.Texture.NEAREST_SAMPLINGMODE);p.renderList=null,p.samples=a,h&&p.addPostProcess(new e.FxaaPostProcess("antialiasing",1,f.activeCamera)),p.onAfterRenderObservable.add((function(){t.DumpFramebuffer(l,c,r,s,o,u)})),f.incrementRenderId(),f.resetCachedMaterial(),p.render(!0),p.dispose(),d&&(f.activeCamera=d),i.getProjectionMatrix(!0)},t.ValidateXHRData=function(t,r){void 0===r&&(r=7);try{if(1&r){if(t.responseText&&t.responseText.length>0)return!0;if(1===r)return!1}if(2&r){var i=e.TGATools.GetTGAHeader(t.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(2===r)return!1}if(4&r){var n=new Uint8Array(t.response,0,3);return 68===n[0]&&68===n[1]&&83===n[2]}}catch(e){}return!1},t.RandomId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))},t.IsBase64=function(e){return!(e.length<5)&&"data:"===e.substr(0,5)},t.DecodeBase64=function(e){for(var t=atob(e.split(",")[1]),r=t.length,i=new Uint8Array(new ArrayBuffer(r)),n=0;n<r;n++)i[n]=t.charCodeAt(n);return i.buffer},Object.defineProperty(t,"NoneLogLevel",{get:function(){return t._NoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MessageLogLevel",{get:function(){return t._MessageLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t,"WarningLogLevel",{get:function(){return t._WarningLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ErrorLogLevel",{get:function(){return t._ErrorLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t,"AllLogLevel",{get:function(){return t._MessageLogLevel|t._WarningLogLevel|t._ErrorLogLevel},enumerable:!0,configurable:!0}),t._AddLogEntry=function(e){t._LogCache=e+t._LogCache,t.OnNewCacheEntry&&t.OnNewCacheEntry(e)},t._FormatMessage=function(e){var t=function(e){return e<10?"0"+e:""+e},r=new Date;return"["+t(r.getHours())+":"+t(r.getMinutes())+":"+t(r.getSeconds())+"]: "+e},t._LogDisabled=function(e){},t._LogEnabled=function(e){var r=t._FormatMessage(e);console.log("BJS - "+r);var i="<div style='color:white'>"+r+"</div><br>";t._AddLogEntry(i)},t._WarnDisabled=function(e){},t._WarnEnabled=function(e){var r=t._FormatMessage(e);console.warn("BJS - "+r);var i="<div style='color:orange'>"+r+"</div><br>";t._AddLogEntry(i)},t._ErrorDisabled=function(e){},t._ErrorEnabled=function(e){t.errorsCount++;var r=t._FormatMessage(e);console.error("BJS - "+r);var i="<div style='color:red'>"+r+"</div><br>";t._AddLogEntry(i)},Object.defineProperty(t,"LogCache",{get:function(){return t._LogCache},enumerable:!0,configurable:!0}),t.ClearLogCache=function(){t._LogCache="",t.errorsCount=0},Object.defineProperty(t,"LogLevels",{set:function(e){(e&t.MessageLogLevel)===t.MessageLogLevel?t.Log=t._LogEnabled:t.Log=t._LogDisabled,(e&t.WarningLogLevel)===t.WarningLogLevel?t.Warn=t._WarnEnabled:t.Warn=t._WarnDisabled,(e&t.ErrorLogLevel)===t.ErrorLogLevel?t.Error=t._ErrorEnabled:t.Error=t._ErrorDisabled},enumerable:!0,configurable:!0}),t.IsWindowObjectExist=function(){return"undefined"!=typeof window},Object.defineProperty(t,"PerformanceNoneLogLevel",{get:function(){return t._PerformanceNoneLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t,"PerformanceUserMarkLogLevel",{get:function(){return t._PerformanceUserMarkLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t,"PerformanceConsoleLogLevel",{get:function(){return t._PerformanceConsoleLogLevel},enumerable:!0,configurable:!0}),Object.defineProperty(t,"PerformanceLogLevel",{set:function(e){return(e&t.PerformanceUserMarkLogLevel)===t.PerformanceUserMarkLogLevel?(t.StartPerformanceCounter=t._StartUserMark,void(t.EndPerformanceCounter=t._EndUserMark)):(e&t.PerformanceConsoleLogLevel)===t.PerformanceConsoleLogLevel?(t.StartPerformanceCounter=t._StartPerformanceConsole,void(t.EndPerformanceCounter=t._EndPerformanceConsole)):(t.StartPerformanceCounter=t._StartPerformanceCounterDisabled,void(t.EndPerformanceCounter=t._EndPerformanceCounterDisabled))},enumerable:!0,configurable:!0}),t._StartPerformanceCounterDisabled=function(e,t){},t._EndPerformanceCounterDisabled=function(e,t){},t._StartUserMark=function(e,r){if(void 0===r&&(r=!0),!t._performance){if(!t.IsWindowObjectExist())return;t._performance=window.performance}r&&t._performance.mark&&t._performance.mark(e+"-Begin")},t._EndUserMark=function(e,r){void 0===r&&(r=!0),r&&t._performance.mark&&(t._performance.mark(e+"-End"),t._performance.measure(e,e+"-Begin",e+"-End"))},t._StartPerformanceConsole=function(e,r){void 0===r&&(r=!0),r&&(t._StartUserMark(e,r),console.time&&console.time(e))},t._EndPerformanceConsole=function(e,r){void 0===r&&(r=!0),r&&(t._EndUserMark(e,r),console.time&&console.timeEnd(e))},Object.defineProperty(t,"Now",{get:function(){return t.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()},enumerable:!0,configurable:!0}),t.GetClassName=function(e,t){void 0===t&&(t=!1);var r=null;if(!t&&e.getClassName)r=e.getClassName();else{if(e instanceof Object){r=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__}r||(r=typeof e)}return r},t.First=function(e,t){for(var r=0,i=e;r<i.length;r++){var n=i[r];if(t(n))return n}return null},t.getFullClassName=function(e,t){void 0===t&&(t=!1);var r=null,i=null;if(!t&&e.getClassName)r=e.getClassName();else{if(e instanceof Object){var n=t?e:Object.getPrototypeOf(e);r=n.constructor.__bjsclassName__,i=n.constructor.__bjsmoduleName__}r||(r=typeof e)}return r?(null!=i?i+".":"")+r:null},t.arrayOrStringFeeder=function(e){return function(r){if(r>=e.length)return null;var i=e.charCodeAt?e.charCodeAt(r):e[r];return i&&i.getHashCode&&(i=i.getHashCode()),"string"==typeof i?t.hashCodeFromStream(t.arrayOrStringFeeder(i)):i}},t.hashCodeFromStream=function(e){for(var t=0,r=0,i=e(r++);null!=i;)t=(t<<5)-t+i,t|=0,i=e(r++);return t},t.DelayAsync=function(e){return new Promise(function(t){setTimeout((function(){t()}),e)})},t.BaseUrl="",t.DefaultRetryStrategy=i.ExponentialBackoff(),t.CorsBehavior="anonymous",t.UseFallbackTexture=!0,t.RegisteredExternalClasses={},t.fallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z",t._tmpFloatArray=new Float32Array(1),t.PreprocessUrl=function(e){return e},t._NoneLogLevel=0,t._MessageLogLevel=1,t._WarningLogLevel=2,t._ErrorLogLevel=4,t._LogCache="",t.errorsCount=0,t.Log=t._LogEnabled,t.Warn=t._WarnEnabled,t.Error=t._ErrorEnabled,t._PerformanceNoneLogLevel=0,t._PerformanceUserMarkLogLevel=1,t._PerformanceConsoleLogLevel=2,t.StartPerformanceCounter=t._StartPerformanceCounterDisabled,t.EndPerformanceCounter=t._EndPerformanceCounterDisabled,t})();e.Tools=a;var h=(function(){function e(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}return Object.defineProperty(e.prototype,"min",{get:function(){return this._min},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"max",{get:function(){return this._max},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"average",{get:function(){return this._average},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lastSecAverage",{get:function(){return this._lastSecAverage},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"total",{get:function(){return this._totalAccumulated},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"count",{get:function(){return this._totalValueCount},enumerable:!0,configurable:!0}),e.prototype.fetchNewFrame=function(){this._totalValueCount++,this._current=0,this._lastSecValueCount++},e.prototype.addCount=function(t,r){e.Enabled&&(this._current+=t,r&&this._fetchResult())},e.prototype.beginMonitoring=function(){e.Enabled&&(this._startMonitoringTime=a.Now)},e.prototype.endMonitoring=function(t){if(void 0===t&&(t=!0),e.Enabled){t&&this.fetchNewFrame();var r=a.Now;this._current=r-this._startMonitoringTime,t&&this._fetchResult()}},e.prototype._fetchResult=function(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;var e=a.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)},e.Enabled=!0,e})();e.PerfCounter=h,e.className=t;var u=(function(){function e(e,t,r,i){void 0===i&&(i=0),this.iterations=e,this._fn=t,this._successCallback=r,this.index=i-1,this._done=!1}return e.prototype.executeNext=function(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())},e.prototype.breakLoop=function(){this._done=!0,this._successCallback()},e.Run=function(t,r,i,n){void 0===n&&(n=0);var s=new e(t,r,i,n);return s.executeNext(),s},e.SyncAsyncForLoop=function(t,r,i,n,s,o){void 0===o&&(o=0),e.Run(Math.ceil(t/r),(function(e){s&&s()?e.breakLoop():setTimeout((function(){for(var n=0;n<r;++n){var o=e.index*r+n;if(o>=t)break;if(i(o),s&&s()){e.breakLoop();break}}e.executeNext()}),o)}),n)},e})();e.AsyncLoop=u})(i||(i={}));var i;!(function(e){var t;!(function(e){e[e.Pending=0]="Pending",e[e.Fulfilled=1]="Fulfilled",e[e.Rejected=2]="Rejected"})(t||(t={}));var r=(function(){function e(){this.count=0,this.target=0,this.results=[]}return e})(),i=(function(){function i(e){var r=this;if(this._state=t.Pending,this._children=new Array,this._rejectWasConsumed=!1,e)try{e((function(e){r._resolve(e)}),(function(e){r._reject(e)}))}catch(e){this._reject(e)}}return Object.defineProperty(i.prototype,"_result",{get:function(){return this._resultValue},set:function(e){this._resultValue=e,this._parent&&void 0===this._parent._result&&(this._parent._result=e)},enumerable:!0,configurable:!0}),i.prototype.catch=function(e){return this.then(void 0,e)},i.prototype.then=function(r,n){var s=this,o=new i;return o._onFulfilled=r,o._onRejected=n,this._children.push(o),o._parent=this,this._state!==t.Pending&&e.Tools.SetImmediate((function(){if(s._state===t.Fulfilled||s._rejectWasConsumed){var e=o._resolve(s._result);if(void 0!==e&&null!==e)if(void 0!==e._state){var r=e;o._children.push(r),r._parent=o,o=r}else o._result=e}else o._reject(s._reason)})),o},i.prototype._moveChildren=function(e){var r=this;if((h=this._children).push.apply(h,e.splice(0,e.length)),this._children.forEach((function(e){e._parent=r})),this._state===t.Fulfilled)for(var i=0,n=this._children;i<n.length;i++){var s=n[i];s._resolve(this._result)}else if(this._state===t.Rejected)for(var o=0,a=this._children;o<a.length;o++){var s=a[o];s._reject(this._reason)}var h},i.prototype._resolve=function(e){try{this._state=t.Fulfilled;var r=null;if(this._onFulfilled&&(r=this._onFulfilled(e)),void 0!==r&&null!==r)if(void 0!==r._state){var i=r;i._parent=this,i._moveChildren(this._children),e=i._result}else e=r;this._result=e;for(var n=0,s=this._children;n<s.length;n++){s[n]._resolve(e)}this._children.length=0,delete this._onFulfilled,delete this._onRejected}catch(e){this._reject(e,!0)}},i.prototype._reject=function(e,r){if(void 0===r&&(r=!1),this._state=t.Rejected,this._reason=e,this._onRejected&&!r)try{this._onRejected(e),this._rejectWasConsumed=!0}catch(t){e=t}for(var i=0,n=this._children;i<n.length;i++){var s=n[i];this._rejectWasConsumed?s._resolve(null):s._reject(e)}this._children.length=0,delete this._onFulfilled,delete this._onRejected},i.resolve=function(e){var t=new i;return t._resolve(e),t},i._RegisterForFulfillment=function(e,r,i){e.then((function(e){return r.results[i]=e,r.count++,r.count===r.target&&r.rootPromise._resolve(r.results),null}),(function(e){r.rootPromise._state!==t.Rejected&&r.rootPromise._reject(e)}))},i.all=function(e){var t=new i,n=new r;if(n.target=e.length,n.rootPromise=t,e.length)for(var s=0;s<e.length;s++)i._RegisterForFulfillment(e[s],n,s);else t._resolve([]);return t},i.race=function(e){var t=new i;if(e.length)for(var r=0,n=e;r<n.length;r++){var s=n[r];s.then((function(e){return t&&(t._resolve(e),t=null),null}),(function(e){t&&(t._reject(e),t=null)}))}return t},i})(),n=(function(){function e(){}return e.Apply=function(e){if(void 0===e&&(e=!1),e||"undefined"==typeof Promise){window.Promise=i}},e})();e.PromisePolyfill=n})(i||(i={}));var i;!(function(e){var t=(function(){function e(e){this._pendingActions=new Array,this._workerInfos=e.map((function(e){return{worker:e,active:!1}}))}return e.prototype.dispose=function(){for(var e=0,t=this._workerInfos;e<t.length;e++){t[e].worker.terminate()}delete this._workerInfos,delete this._pendingActions},e.prototype.push=function(e){for(var t=0,r=this._workerInfos;t<r.length;t++){var i=r[t];if(!i.active)return void this._execute(i,e)}this._pendingActions.push(e)},e.prototype._execute=function(e,t){var r=this;e.active=!0,t(e.worker,(function(){e.active=!1;var t=r._pendingActions.shift();t&&r._execute(e,t)}))},e})();e.WorkerPool=t})(i||(i={}));var i;!(function(e){var t=(function(){function e(){this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alphaBlend",{get:function(){return this._alphaBlend},set:function(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)},enumerable:!0,configurable:!0}),e.prototype.setAlphaBlendConstants=function(e,t,r,i){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===r&&this._blendConstants[3]===i||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=r,this._blendConstants[3]=i,this._isBlendConstantsDirty=!0)},e.prototype.setAlphaBlendFunctionParameters=function(e,t,r,i){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===r&&this._blendFunctionParameters[3]===i||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=r,this._blendFunctionParameters[3]=i,this._isBlendFunctionParametersDirty=!0)},e.prototype.setAlphaEquationParameters=function(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)},e.prototype.reset=function(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._isBlendEquationParametersDirty[0],this._isBlendEquationParametersDirty[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))},e})();e._AlphaState=t})(i||(i={}));var i;!(function(e){var t=(function(){function e(){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,this.reset()}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"zOffset",{get:function(){return this._zOffset},set:function(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cullFace",{get:function(){return this._cullFace},set:function(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cull",{get:function(){return this._cull},set:function(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{get:function(){return this._depthFunc},set:function(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthMask",{get:function(){return this._depthMask},set:function(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthTest",{get:function(){return this._depthTest},set:function(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frontFace",{get:function(){return this._frontFace},set:function(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)},enumerable:!0,configurable:!0}),e.prototype.reset=function(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1},e.prototype.apply=function(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,0)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))},e})();e._DepthCullingState=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.reset()}return Object.defineProperty(t.prototype,"isDirty",{get:function(){
return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilFunc",{get:function(){return this._stencilFunc},set:function(e){this._stencilFunc!==e&&(this._stencilFunc=e,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncRef",{get:function(){return this._stencilFuncRef},set:function(e){this._stencilFuncRef!==e&&(this._stencilFuncRef=e,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilFuncMask",{get:function(){return this._stencilFuncMask},set:function(e){this._stencilFuncMask!==e&&(this._stencilFuncMask=e,this._isStencilFuncDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilFail",{get:function(){return this._stencilOpStencilFail},set:function(e){this._stencilOpStencilFail!==e&&(this._stencilOpStencilFail=e,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpDepthFail",{get:function(){return this._stencilOpDepthFail},set:function(e){this._stencilOpDepthFail!==e&&(this._stencilOpDepthFail=e,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilOpStencilDepthPass",{get:function(){return this._stencilOpStencilDepthPass},set:function(e){this._stencilOpStencilDepthPass!==e&&(this._stencilOpStencilDepthPass=e,this._isStencilOpDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilMask",{get:function(){return this._stencilMask},set:function(e){this._stencilMask!==e&&(this._stencilMask=e,this._isStencilMaskDirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stencilTest",{get:function(){return this._stencilTest},set:function(e){this._stencilTest!==e&&(this._stencilTest=e,this._isStencilTestDirty=!0)},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=e.Engine.ALWAYS,this._stencilFuncRef=1,this._stencilFuncMask=255,this._stencilOpStencilFail=e.Engine.KEEP,this._stencilOpDepthFail=e.Engine.KEEP,this._stencilOpStencilDepthPass=e.Engine.REPLACE,this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0},t.prototype.apply=function(e){this.isDirty&&(this._isStencilTestDirty&&(this.stencilTest?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.stencilMask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.stencilFunc,this.stencilFuncRef,this.stencilFuncMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.stencilOpStencilFail,this.stencilOpDepthFail,this.stencilOpStencilDepthPass),this._isStencilOpDirty=!1))},t})();e._StencilState=t})(i||(i={}));var i,o=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++){t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e};!(function(e){var t=function(e,t,i,n,s){return r(e,s+(n?n+"\n":"")+t,i)},r=function(e,t,r){var i=e.createShader("vertex"===r?e.VERTEX_SHADER:e.FRAGMENT_SHADER);if(e.shaderSource(i,t),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){var n=e.getShaderInfoLog(i);if(n)throw new Error(n)}if(!i)throw new Error("Something went wrong while compile the shader.");return i},i=function(t,r,i){var n=i.NEAREST,s=i.NEAREST;switch(t){case e.Texture.BILINEAR_SAMPLINGMODE:n=i.LINEAR,s=r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case e.Texture.TRILINEAR_SAMPLINGMODE:n=i.LINEAR,s=r?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case e.Texture.NEAREST_SAMPLINGMODE:n=i.NEAREST,s=r?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case e.Texture.NEAREST_NEAREST_MIPNEAREST:n=i.NEAREST,s=r?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case e.Texture.NEAREST_LINEAR_MIPNEAREST:n=i.NEAREST,s=r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;break;case e.Texture.NEAREST_LINEAR_MIPLINEAR:n=i.NEAREST,s=r?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;break;case e.Texture.NEAREST_LINEAR:n=i.NEAREST,s=i.LINEAR;break;case e.Texture.NEAREST_NEAREST:n=i.NEAREST,s=i.NEAREST;break;case e.Texture.LINEAR_NEAREST_MIPNEAREST:n=i.LINEAR,s=r?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;break;case e.Texture.LINEAR_NEAREST_MIPLINEAR:n=i.LINEAR,s=r?i.NEAREST_MIPMAP_LINEAR:i.NEAREST;break;case e.Texture.LINEAR_LINEAR:n=i.LINEAR,s=i.LINEAR;break;case e.Texture.LINEAR_NEAREST:n=i.LINEAR,s=i.NEAREST}return{min:s,mag:n}},n=function(t,r,i,n,s,o){void 0===o&&(o=null);var a,h=function(){i[r]=a,i._internalCount++,n&&n._removePendingData(a),6===i._internalCount&&s(i)},u=function(e,t){n&&n._removePendingData(a),o&&o(e,t)};a=e.Tools.LoadImage(t,h,u,n?n.database:null),n&&n._addPendingData(a)},s=function(e,t,r,i,s){void 0===s&&(s=null);var o=[];o._internalCount=0;for(var a=0;a<6;a++)n(i[a],a,o,t,r,s)},a=(function(){function e(){}return e})(),h=(function(){function e(){}return e})();e.InstancingAttributeInfo=h;var u=(function(){function e(){}return e})();e.RenderTargetCreationOptions=u;var l=(function(){function e(){}return e})();e.DepthTextureCreationOptions=l;var c=(function(){function e(){}return e})();e.EngineCapabilities=c;var f=(function(){function n(t,r,i,s){void 0===s&&(s=!1);var o=this;this.forcePOTTextures=!1,this.isFullscreen=!1,this.isPointerLock=!1,this.cullBackFaces=!0,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.scenes=new Array,this.postProcesses=new Array,this.onResizeObservable=new e.Observable,this.onCanvasBlurObservable=new e.Observable,this.onCanvasFocusObservable=new e.Observable,this.onCanvasPointerOutObservable=new e.Observable,this.onBeforeTextureInitObservable=new e.Observable,this._vrDisplay=void 0,this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.disableUniformBuffers=!1,this._uniformBuffers=new Array,this.onBeginFrameObservable=new e.Observable,this.onEndFrameObservable=new e.Observable,this.onBeforeShaderCompilationObservable=new e.Observable,this.onAfterShaderCompilationObservable=new e.Observable,this._windowIsBackground=!1,this._webGLVersion=1,this._badOS=!1,this._badDesktopOS=!1,this.disableTextureBindingOptimization=!1,this.onVRDisplayChangedObservable=new e.Observable,this.onVRRequestPresentComplete=new e.Observable,this.onVRRequestPresentStart=new e.Observable,this._colorWrite=!0,this._drawCalls=new e.PerfCounter,this._textureCollisions=new e.PerfCounter,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this.onContextLostObservable=new e.Observable,this.onContextRestoredObservable=new e.Observable,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this._performanceMonitor=new e.PerformanceMonitor,this._fps=60,this._deltaTime=0,this.disablePerformanceMonitorInBackground=!1,this._depthCullingState=new e._DepthCullingState,this._stencilState=new e._StencilState,this._alphaState=new e._AlphaState,this._alphaMode=n.ALPHA_DISABLE,this._internalTexturesCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._firstBoundInternalTextureTracker=new e.DummyInternalTextureTracker,this._lastBoundInternalTextureTracker=new e.DummyInternalTextureTracker,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._activeRequests=new Array,this._texturesSupported=new Array,this.premultipliedAlpha=!0,this._onVRFullScreenTriggered=function(){if(o._vrDisplay&&o._vrDisplay.isPresenting){o._oldSize=new e.Size(o.getRenderWidth(),o.getRenderHeight()),o._oldHardwareScaleFactor=o.getHardwareScalingLevel();var t=o._vrDisplay.getEyeParameters("left");o.setHardwareScalingLevel(1),o.setSize(2*t.renderWidth,t.renderHeight)}else o.setHardwareScalingLevel(o._oldHardwareScaleFactor),o.setSize(o._oldSize.width,o._oldSize.height)},this._boundUniforms={},e.PromisePolyfill.Apply();var h=null;if(n.Instances.push(this),t){if(i=i||{},t.getContext){if(h=t,this._renderingCanvas=h,null!=r&&(i.antialias=r),void 0===i.deterministicLockstep&&(i.deterministicLockstep=!1),void 0===i.lockstepMaxSteps&&(i.lockstepMaxSteps=4),void 0===i.preserveDrawingBuffer&&(i.preserveDrawingBuffer=!1),void 0===i.audioEngine&&(i.audioEngine=!0),void 0===i.stencil&&(i.stencil=!0),!1===i.premultipliedAlpha&&(this.premultipliedAlpha=!1),this._deterministicLockstep=i.deterministicLockstep,this._lockstepMaxSteps=i.lockstepMaxSteps,this._doNotHandleContextLost=!!i.doNotHandleContextLost,navigator&&navigator.userAgent)for(var u=navigator.userAgent,l=0,c=n.ExceptionList;l<c.length;l++){var f=c[l],d=f.key,p=f.targets;if(u.indexOf(d)>-1){if(f.capture&&f.captureConstraint){var _=f.capture,m=f.captureConstraint,g=new RegExp(_),v=g.exec(u);if(v&&v.length>0){var y=parseInt(v[v.length-1]);if(y>=m)continue}}for(var b=0,T=p;b<T.length;b++){var E=T[b];switch(E){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"textureBindingOptimization":this.disableTextureBindingOptimization=!0}}}}if(!i.disableWebGL2Support)try{this._gl=h.getContext("webgl2",i)||h.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2)}catch(e){}if(!this._gl){if(!h)throw new Error("The provided canvas is null or undefined.");try{this._gl=h.getContext("webgl",i)||h.getContext("experimental-webgl",i)}catch(e){throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported");this._onCanvasFocus=function(){o.onCanvasFocusObservable.notifyObservers(o)},this._onCanvasBlur=function(){o.onCanvasBlurObservable.notifyObservers(o)},h.addEventListener("focus",this._onCanvasFocus),h.addEventListener("blur",this._onCanvasBlur),this._onBlur=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.disable(),o._windowIsBackground=!0},this._onFocus=function(){o.disablePerformanceMonitorInBackground&&o._performanceMonitor.enable(),o._windowIsBackground=!1},this._onCanvasPointerOut=function(e){o.onCanvasPointerOutObservable.notifyObservers(e)},window.addEventListener("blur",this._onBlur),window.addEventListener("focus",this._onFocus),h.addEventListener("pointerout",this._onCanvasPointerOut),this._doNotHandleContextLost||(this._onContextLost=function(t){t.preventDefault(),o._contextWasLost=!0,e.Tools.Warn("WebGL context lost."),o.onContextLostObservable.notifyObservers(o)},this._onContextRestored=function(t){setTimeout((function(){o._initGLContext(),o._rebuildEffects(),o._rebuildInternalTextures(),o._rebuildBuffers(),o.wipeCaches(!0),e.Tools.Warn("WebGL context successfully restored."),o.onContextRestoredObservable.notifyObservers(o),o._contextWasLost=!1}),0)},h.addEventListener("webglcontextlost",this._onContextLost,!1),h.addEventListener("webglcontextrestored",this._onContextRestored,!1))}else this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample&&(this._webGLVersion=2),i.stencil=this._gl.getContextAttributes().stencil;var x=i.limitDeviceRatio||window.devicePixelRatio||1;this._hardwareScalingLevel=s?1/Math.min(x,window.devicePixelRatio||1):1,this.resize(),this._isStencilEnable=!!i.stencil,this._initGLContext(),h&&(this._onFullscreenChange=function(){void 0!==document.fullscreen?o.isFullscreen=document.fullscreen:void 0!==document.mozFullScreen?o.isFullscreen=document.mozFullScreen:void 0!==document.webkitIsFullScreen?o.isFullscreen=document.webkitIsFullScreen:void 0!==document.msIsFullScreen&&(o.isFullscreen=document.msIsFullScreen),o.isFullscreen&&o._pointerLockRequested&&h&&(h.requestPointerLock=h.requestPointerLock||h.msRequestPointerLock||h.mozRequestPointerLock||h.webkitRequestPointerLock,h.requestPointerLock&&h.requestPointerLock())},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),document.addEventListener("msfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=function(){o.isPointerLock=document.mozPointerLockElement===h||document.webkitPointerLockElement===h||document.msPointerLockElement===h||document.pointerLockElement===h},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mspointerlockchange",this._onPointerLockChange,!1),document.addEventListener("mozpointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1),this._onVRDisplayPointerRestricted=function(){h&&h.requestPointerLock()},this._onVRDisplayPointerUnrestricted=function(){document.exitPointerLock()},window.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),window.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)),i.audioEngine&&e.AudioEngine&&!n.audioEngine&&(n.audioEngine=new e.AudioEngine);for(var A=0;A<this._caps.maxVertexAttribs;A++)this._currentBufferPointers[A]=new a;this._linkTrackers(this._firstBoundInternalTextureTracker,this._lastBoundInternalTextureTracker),i.autoEnableWebVR&&this.initWebVR(),this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),console.log("Babylon.js engine (v"+n.Version+") launched"),this.enableOfflineSupport=void 0!==e.Database}}return Object.defineProperty(n,"LastCreatedEngine",{get:function(){return 0===n.Instances.length?null:n.Instances[n.Instances.length-1]},enumerable:!0,configurable:!0}),Object.defineProperty(n,"LastCreatedScene",{get:function(){var e=n.LastCreatedEngine;return e?0===e.scenes.length?null:e.scenes[e.scenes.length-1]:null},enumerable:!0,configurable:!0}),n.MarkAllMaterialsAsDirty=function(e,t){for(var r=0;r<n.Instances.length;r++)for(var i=n.Instances[r],s=0;s<i.scenes.length;s++)i.scenes[s].markAllMaterialsAsDirty(e,t)},Object.defineProperty(n,"NEVER",{get:function(){return n._NEVER},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALWAYS",{get:function(){return n._ALWAYS},enumerable:!0,configurable:!0}),Object.defineProperty(n,"LESS",{get:function(){return n._LESS},enumerable:!0,configurable:!0}),Object.defineProperty(n,"EQUAL",{get:function(){return n._EQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(n,"LEQUAL",{get:function(){return n._LEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(n,"GREATER",{get:function(){return n._GREATER},enumerable:!0,configurable:!0}),Object.defineProperty(n,"GEQUAL",{get:function(){return n._GEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(n,"NOTEQUAL",{get:function(){return n._NOTEQUAL},enumerable:!0,configurable:!0}),Object.defineProperty(n,"KEEP",{get:function(){return n._KEEP},enumerable:!0,configurable:!0}),Object.defineProperty(n,"REPLACE",{get:function(){return n._REPLACE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"INCR",{get:function(){return n._INCR},enumerable:!0,configurable:!0}),Object.defineProperty(n,"DECR",{get:function(){return n._DECR},enumerable:!0,configurable:!0}),Object.defineProperty(n,"INVERT",{get:function(){return n._INVERT},enumerable:!0,configurable:!0}),Object.defineProperty(n,"INCR_WRAP",{get:function(){return n._INCR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(n,"DECR_WRAP",{get:function(){return n._DECR_WRAP},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_DISABLE",{get:function(){return n._ALPHA_DISABLE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_ONEONE",{get:function(){return n._ALPHA_ONEONE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_ADD",{get:function(){return n._ALPHA_ADD},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_COMBINE",{get:function(){return n._ALPHA_COMBINE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_SUBTRACT",{get:function(){return n._ALPHA_SUBTRACT},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_MULTIPLY",{get:function(){return n._ALPHA_MULTIPLY},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_MAXIMIZED",{get:function(){return n._ALPHA_MAXIMIZED},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_PREMULTIPLIED",{get:function(){return n._ALPHA_PREMULTIPLIED},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_PREMULTIPLIED_PORTERDUFF",{get:function(){return n._ALPHA_PREMULTIPLIED_PORTERDUFF},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_INTERPOLATE",{get:function(){return n._ALPHA_INTERPOLATE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"ALPHA_SCREENMODE",{get:function(){return n._ALPHA_SCREENMODE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"DELAYLOADSTATE_NONE",{get:function(){return n._DELAYLOADSTATE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"DELAYLOADSTATE_LOADED",{get:function(){return n._DELAYLOADSTATE_LOADED},enumerable:!0,configurable:!0}),Object.defineProperty(n,"DELAYLOADSTATE_LOADING",{get:function(){return n._DELAYLOADSTATE_LOADING},enumerable:!0,configurable:!0}),Object.defineProperty(n,"DELAYLOADSTATE_NOTLOADED",{get:function(){return n._DELAYLOADSTATE_NOTLOADED},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTUREFORMAT_ALPHA",{get:function(){return n._TEXTUREFORMAT_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTUREFORMAT_LUMINANCE",{get:function(){return n._TEXTUREFORMAT_LUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTUREFORMAT_R",{get:function(){return n._TEXTUREFORMAT_R},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTUREFORMAT_RG",{get:function(){return n._TEXTUREFORMAT_RG},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTUREFORMAT_LUMINANCE_ALPHA",{get:function(){return n._TEXTUREFORMAT_LUMINANCE_ALPHA},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTUREFORMAT_RGB",{get:function(){return n._TEXTUREFORMAT_RGB},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTUREFORMAT_RGBA",{get:function(){return n._TEXTUREFORMAT_RGBA},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTURETYPE_UNSIGNED_INT",{get:function(){return n._TEXTURETYPE_UNSIGNED_INT},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTURETYPE_FLOAT",{get:function(){return n._TEXTURETYPE_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(n,"TEXTURETYPE_HALF_FLOAT",{get:function(){return n._TEXTURETYPE_HALF_FLOAT},enumerable:!0,configurable:!0}),Object.defineProperty(n,"SCALEMODE_FLOOR",{get:function(){return n._SCALEMODE_FLOOR},enumerable:!0,configurable:!0}),Object.defineProperty(n,"SCALEMODE_NEAREST",{get:function(){return n._SCALEMODE_NEAREST},enumerable:!0,configurable:!0}),Object.defineProperty(n,"SCALEMODE_CEILING",{get:function(){return n._SCALEMODE_CEILING},enumerable:!0,configurable:!0}),Object.defineProperty(n,"Version",{get:function(){return"3.3.0-alpha.6"},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"supportsUniformBuffers",{get:function(){return this.webGLVersion>1&&!this.disableUniformBuffers},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"needPOTTextures",{get:function(){return this._webGLVersion<2||this.forcePOTTextures},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"doNotHandleContextLost",{get:function(){return this._doNotHandleContextLost},set:function(e){this._doNotHandleContextLost=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"performanceMonitor",{get:function(){return this._performanceMonitor},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"texturesSupported",{get:function(){return this._texturesSupported},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentViewport",{get:function(){return this._cachedViewport},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"emptyTexture",{get:function(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,n.TEXTUREFORMAT_RGBA,!1,!1,e.Texture.NEAREST_SAMPLINGMODE)),this._emptyTexture},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"emptyTexture3D",{get:function(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,n.TEXTUREFORMAT_RGBA,!1,!1,e.Texture.NEAREST_SAMPLINGMODE)),this._emptyTexture3D},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"emptyCubeTexture",{get:function(){if(!this._emptyCubeTexture){var t=new Uint8Array(4),r=[t,t,t,t,t,t];this._emptyCubeTexture=this.createRawCubeTexture(r,1,n.TEXTUREFORMAT_RGBA,n.TEXTURETYPE_UNSIGNED_INT,!1,!1,e.Texture.NEAREST_SAMPLINGMODE)}return this._emptyCubeTexture},enumerable:!0,configurable:!0}),n.prototype._rebuildInternalTextures=function(){for(var e=this._internalTexturesCache.slice(),t=0,r=e;t<r.length;t++){r[t]._rebuild()}},n.prototype._rebuildEffects=function(){for(var t in this._compiledEffects){this._compiledEffects[t]._prepareEffect()}e.Effect.ResetCache()},n.prototype._rebuildBuffers=function(){for(var e=0,t=this.scenes;e<t.length;e++){var r=t[e];r.resetCachedMaterial(),r._rebuildGeometries(),r._rebuildTextures()}for(var i=0,n=this._uniformBuffers;i<n.length;i++){n[i]._rebuild()}},n.prototype._initGLContext=function(){this._caps=new c,this._caps.maxTexturesImageUnits=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxCombinedTexturesImageUnits=this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureImageUnits=this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._caps.maxCubemapTextureSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxRenderTextureSize=this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),this._caps.maxVertexAttribs=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),this._caps.maxVaryingVectors=this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),this._caps.maxFragmentUniformVectors=this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxVertexUniformVectors=this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),this._glVersion=this._gl.getParameter(this._gl.VERSION);var e=this._gl.getExtension("WEBGL_debug_renderer_info");if(null!=e&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor="Unknown vendor"),this._glRenderer||(this._glRenderer="Unknown renderer"),this._gl.HALF_FLOAT_OES=36193,34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842),34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836),35056!==this._gl.DEPTH24_STENCIL8&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.standardDerivatives=this._webGLVersion>1||null!==this._gl.getExtension("OES_standard_derivatives"),this._caps.astc=this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),this._caps.s3tc=this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),this._caps.pvrtc=this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),this._caps.etc1=this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),this._caps.etc2=this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),this._caps.textureAnisotropicFilterExtension=this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.uintIndices=this._webGLVersion>1||null!==this._gl.getExtension("OES_element_index_uint"),this._caps.fragmentDepthSupported=this._webGLVersion>1||null!==this._gl.getExtension("EXT_frag_depth"),this._caps.highPrecisionShaderSupported=!0,this._caps.timerQuery=this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)>0),this._caps.colorBufferFloat=this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float"),this._caps.textureFloat=!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),this._caps.textureFloatLinearFiltering=!(!this._caps.textureFloat||!this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!(!this._caps.textureFloat||!this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloat=!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._webGLVersion>1&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._caps.textureLOD=!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),this._webGLVersion>1)this._caps.drawBuffersExtension=!0;else{var t=this._gl.getExtension("WEBGL_draw_buffers");if(null!==t){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(var r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=t["COLOR_ATTACHMENT"+r+"_WEBGL"]}else this._caps.drawBuffersExtension=!1}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{var i=this._gl.getExtension("WEBGL_depth_texture");null!=i&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{var n=this._gl.getExtension("OES_vertex_array_object");null!=n?(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=n.createVertexArrayOES.bind(n),this._gl.bindVertexArray=n.bindVertexArrayOES.bind(n),this._gl.deleteVertexArray=n.deleteVertexArrayOES.bind(n)):this._caps.vertexArrayObject=!1}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{var s=this._gl.getExtension("ANGLE_instanced_arrays");null!=s?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),this._gl.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),this._gl.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)):this._caps.instancedArrays=!1}if(this._caps.astc&&this.texturesSupported.push("-astc.ktx"),this._caps.s3tc&&this.texturesSupported.push("-dxt.ktx"),this._caps.pvrtc&&this.texturesSupported.push("-pvrtc.ktx"),this._caps.etc2&&this.texturesSupported.push("-etc2.ktx"),this._caps.etc1&&this.texturesSupported.push("-etc1.ktx"),this._gl.getShaderPrecisionFormat){var o=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);o&&(this._caps.highPrecisionShaderSupported=0!==o.precision)}this.setDepthBuffer(!0),this.setDepthFunctionToLessOrEqual(),this.setDepthWrite(!0),this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(var a=0;a<this._maxSimultaneousTextures;a++)this._nextFreeTextureSlots.push(a)},Object.defineProperty(n.prototype,"webGLVersion",{get:function(){return this._webGLVersion},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isStencilEnable",{get:function(){return this._isStencilEnable},enumerable:!0,configurable:!0}),n.prototype._prepareWorkingCanvas=function(){if(!this._workingCanvas){this._workingCanvas=document.createElement("canvas");var e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}},n.prototype.resetTextureCache=function(){for(var e in this._boundTexturesCache)if(this._boundTexturesCache.hasOwnProperty(e)){var t=this._boundTexturesCache[e];t&&this._removeDesignatedSlot(t),this._boundTexturesCache[e]=null}if(!this.disableTextureBindingOptimization){this._nextFreeTextureSlots=[];for(var r=0;r<this._maxSimultaneousTextures;r++)this._nextFreeTextureSlots.push(r)}this._currentTextureChannel=-1},n.prototype.isDeterministicLockStep=function(){return this._deterministicLockstep},n.prototype.getLockstepMaxSteps=function(){return this._lockstepMaxSteps},n.prototype.getGlInfo=function(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}},n.prototype.getAspectRatio=function(e,t){void 0===t&&(t=!1);var r=e.viewport;return this.getRenderWidth(t)*r.width/(this.getRenderHeight(t)*r.height)},n.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)},n.prototype.getRenderWidth=function(e){return void 0===e&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._gl.drawingBufferWidth},n.prototype.getRenderHeight=function(e){return void 0===e&&(e=!1),!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._gl.drawingBufferHeight},n.prototype.getRenderingCanvas=function(){return this._renderingCanvas},n.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null},n.prototype.setHardwareScalingLevel=function(e){this._hardwareScalingLevel=e,this.resize()},n.prototype.getHardwareScalingLevel=function(){return this._hardwareScalingLevel},n.prototype.getLoadedTexturesCache=function(){return this._internalTexturesCache},n.prototype.getCaps=function(){return this._caps},Object.defineProperty(n.prototype,"drawCalls",{get:function(){return e.Tools.Warn("drawCalls is deprecated. Please use SceneInstrumentation class"),0},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"drawCallsPerfCounter",{get:function(){return e.Tools.Warn("drawCallsPerfCounter is deprecated. Please use SceneInstrumentation class"),null},enumerable:!0,configurable:!0}),n.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc},n.prototype.setDepthFunction=function(e){this._depthCullingState.depthFunc=e},n.prototype.setDepthFunctionToGreater=function(){this._depthCullingState.depthFunc=this._gl.GREATER},n.prototype.setDepthFunctionToGreaterOrEqual=function(){this._depthCullingState.depthFunc=this._gl.GEQUAL},n.prototype.setDepthFunctionToLess=function(){this._depthCullingState.depthFunc=this._gl.LESS},n.prototype.setDepthFunctionToLessOrEqual=function(){this._depthCullingState.depthFunc=this._gl.LEQUAL},n.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest},n.prototype.setStencilBuffer=function(e){this._stencilState.stencilTest=e},n.prototype.getStencilMask=function(){return this._stencilState.stencilMask},n.prototype.setStencilMask=function(e){this._stencilState.stencilMask=e},n.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc},n.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef},n.prototype.getStencilFunctionMask=function(){
return this._stencilState.stencilFuncMask},n.prototype.setStencilFunction=function(e){this._stencilState.stencilFunc=e},n.prototype.setStencilFunctionReference=function(e){this._stencilState.stencilFuncRef=e},n.prototype.setStencilFunctionMask=function(e){this._stencilState.stencilFuncMask=e},n.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail},n.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail},n.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass},n.prototype.setStencilOperationFail=function(e){this._stencilState.stencilOpStencilFail=e},n.prototype.setStencilOperationDepthFail=function(e){this._stencilState.stencilOpDepthFail=e},n.prototype.setStencilOperationPass=function(e){this._stencilState.stencilOpStencilDepthPass=e},n.prototype.setDitheringState=function(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)},n.prototype.setRasterizerState=function(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)},n.prototype.stopRenderLoop=function(e){if(!e)return void(this._activeRenderLoops=[]);var t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)},n.prototype._renderLoop=function(){if(!this._contextWasLost){var t=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(t=!1),t){this.beginFrame();for(var r=0;r<this._activeRenderLoops.length;r++){(0,this._activeRenderLoops[r])()}this.endFrame()}}if(this._activeRenderLoops.length>0){var i=null;this._vrDisplay&&this._vrDisplay.isPresenting&&(i=this._vrDisplay),this._frameHandler=e.Tools.QueueNewFrame(this._bindedRenderFunction,i)}else this._renderingQueueLaunched=!1},n.prototype.runRenderLoop=function(t){-1===this._activeRenderLoops.indexOf(t)&&(this._activeRenderLoops.push(t),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._bindedRenderFunction=this._renderLoop.bind(this),this._frameHandler=e.Tools.QueueNewFrame(this._bindedRenderFunction)))},n.prototype.switchFullscreen=function(t){this.isFullscreen?e.Tools.ExitFullscreen():(this._pointerLockRequested=t,this._renderingCanvas&&e.Tools.RequestFullscreen(this._renderingCanvas))},n.prototype.clear=function(e,t,r,i){void 0===i&&(i=!1),this.applyStates();var n=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,void 0!==e.a?e.a:1),n|=this._gl.COLOR_BUFFER_BIT),r&&(this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),i&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)},n.prototype.scissorClear=function(e,t,r,i,n){var s=this._gl,o=s.getParameter(s.SCISSOR_TEST),a=s.getParameter(s.SCISSOR_BOX);s.enable(s.SCISSOR_TEST),s.scissor(e,t,r,i),this.clear(n,!0,!0,!0),s.scissor(a[0],a[1],a[2],a[3]),!0===o?s.enable(s.SCISSOR_TEST):s.disable(s.SCISSOR_TEST)},n.prototype.setViewport=function(e,t,r){var i=t||this.getRenderWidth(),n=r||this.getRenderHeight(),s=e.x||0,o=e.y||0;this._cachedViewport=e,this._gl.viewport(s*i,o*n,i*e.width,n*e.height)},n.prototype.setDirectViewport=function(e,t,r,i){var n=this._cachedViewport;return this._cachedViewport=null,this._gl.viewport(e,t,r,i),n},n.prototype.beginFrame=function(){this.onBeginFrameObservable.notifyObservers(this),this._measureFps()},n.prototype.endFrame=function(){this._badOS&&this.flushFramebuffer(),this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.submitFrame(),this.onEndFrameObservable.notifyObservers(this)},n.prototype.resize=function(){if(!this._vrDisplay||!this._vrDisplay.isPresenting){var e=this._renderingCanvas?this._renderingCanvas.clientWidth:window.innerWidth,t=this._renderingCanvas?this._renderingCanvas.clientHeight:window.innerHeight;this.setSize(e/this._hardwareScalingLevel,t/this._hardwareScalingLevel)}},n.prototype.setSize=function(e,t){if(this._renderingCanvas&&(this._renderingCanvas.width!==e||this._renderingCanvas.height!==t)){this._renderingCanvas.width=e,this._renderingCanvas.height=t;for(var r=0;r<this.scenes.length;r++)for(var i=this.scenes[r],n=0;n<i.cameras.length;n++){var s=i.cameras[n];s._currentRenderId=0}this.onResizeObservable.hasObservers&&this.onResizeObservable.notifyObservers(this)}},n.prototype.isVRDevicePresent=function(){return!!this._vrDisplay},n.prototype.getVRDevice=function(){return this._vrDisplay},n.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable},n.prototype.initWebVRAsync=function(){var t=this,r=function(){var e={vrDisplay:t._vrDisplay,vrSupported:t._vrSupported};t.onVRDisplayChangedObservable.notifyObservers(e),t._webVRInitPromise=new Promise(function(t){t(e)})};return this._onVrDisplayConnect||(this._onVrDisplayConnect=function(e){t._vrDisplay=e.display,r()},this._onVrDisplayDisconnect=function(){t._vrDisplay.cancelAnimationFrame(t._frameHandler),t._vrDisplay=void 0,t._frameHandler=e.Tools.QueueNewFrame(t._bindedRenderFunction),r()},this._onVrDisplayPresentChange=function(){t._vrExclusivePointerMode=t._vrDisplay&&t._vrDisplay.isPresenting},window.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),window.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange)),this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(r),this._webVRInitPromise},n.prototype.enableVR=function(){var e=this;if(this._vrDisplay&&!this._vrDisplay.isPresenting){var t=function(){e.onVRRequestPresentComplete.notifyObservers(!0),e._onVRFullScreenTriggered()},r=function(){e.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this),this._vrDisplay.requestPresent([{source:this.getRenderingCanvas()}]).then(t).catch(r)}},n.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(this._onVRFullScreenTriggered).catch(this._onVRFullScreenTriggered)},n.prototype._getVRDisplaysAsync=function(){var e=this;return new Promise(function(t,r){navigator.getVRDisplays?navigator.getVRDisplays().then((function(r){e._vrSupported=!0,e._vrDisplay=r[0],t({vrDisplay:e._vrDisplay,vrSupported:e._vrSupported})})):(e._vrDisplay=void 0,e._vrSupported=!1,t({vrDisplay:e._vrDisplay,vrSupported:e._vrSupported}))})},n.prototype.bindFramebuffer=function(e,t,r,i,n,s,o){void 0===o&&(o=0),this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this.bindUnboundFramebuffer(e._MSAAFramebuffer?e._MSAAFramebuffer:e._framebuffer);var a=this._gl;e.isCube&&(void 0===t&&(t=0),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,e._webGLTexture,o),s&&(s._generateStencilBuffer?a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,s._webGLTexture,o):a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_CUBE_MAP_POSITIVE_X+t,s._webGLTexture,o))),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,r,i):(r||(r=e.width,o&&(r/=Math.pow(2,o))),i||(i=e.height,o&&(i/=Math.pow(2,o))),a.viewport(0,0,r,i)),this.wipeCaches()},n.prototype.bindUnboundFramebuffer=function(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)},n.prototype.unBindFramebuffer=function(e,t,r){void 0===t&&(t=!1),this._currentRenderTarget=null;var i=this._gl;e._MSAAFramebuffer&&(i.bindFramebuffer(i.READ_FRAMEBUFFER,e._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,e._framebuffer),i.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,i.COLOR_BUFFER_BIT,i.NEAREST)),!e.generateMipMaps||t||e.isCube||(this._bindTextureDirectly(i.TEXTURE_2D,e,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null)),r&&(e._MSAAFramebuffer&&this.bindUnboundFramebuffer(e._framebuffer),r()),this.bindUnboundFramebuffer(null)},n.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t,r){void 0===t&&(t=!1),this._currentRenderTarget=null;var i=this._gl;if(e[0]._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,e[0]._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,e[0]._framebuffer);var n=e[0]._attachments;n||(n=new Array(e.length),e[0]._attachments=n);for(var s=0;s<e.length;s++){for(var o=e[s],a=0;a<n.length;a++)n[a]=i.NONE;n[s]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+s:"COLOR_ATTACHMENT"+s+"_WEBGL"],i.readBuffer(n[s]),i.drawBuffers(n),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(var s=0;s<n.length;s++)n[s]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+s:"COLOR_ATTACHMENT"+s+"_WEBGL"];i.drawBuffers(n)}for(var s=0;s<e.length;s++){var o=e[s];!o.generateMipMaps||t||o.isCube||(this._bindTextureDirectly(i.TEXTURE_2D,o),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}r&&(e[0]._MSAAFramebuffer&&this.bindUnboundFramebuffer(e[0]._framebuffer),r()),this.bindUnboundFramebuffer(null)},n.prototype.generateMipMapsForCubemap=function(e){if(e.generateMipMaps){var t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,e,!0),t.generateMipmap(t.TEXTURE_CUBE_MAP),this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}},n.prototype.flushFramebuffer=function(){this._gl.flush()},n.prototype.restoreDefaultFramebuffer=function(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this.bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()},n.prototype.createUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");return this.bindUniformBuffer(t),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},n.prototype.createDynamicUniformBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");return this.bindUniformBuffer(t),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t},n.prototype.updateUniformBuffer=function(e,t,r,i){this.bindUniformBuffer(e),void 0===r&&(r=0),void 0===i?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,r,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,r,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(r,r+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(r,r+i)),this.bindUniformBuffer(null)},n.prototype._resetVertexBufferBinding=function(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null},n.prototype.createVertexBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create vertex buffer");return this.bindArrayBuffer(t),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.STATIC_DRAW),this._resetVertexBufferBinding(),t.references=1,t},n.prototype.createDynamicVertexBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic vertex buffer");return this.bindArrayBuffer(t),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),this._resetVertexBufferBinding(),t.references=1,t},n.prototype.updateDynamicIndexBuffer=function(e,t,r){void 0===r&&(r=0),this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e);var i;i=t instanceof Uint16Array||t instanceof Uint32Array?t:e.is32Bits?new Uint32Array(t):new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},n.prototype.updateDynamicVertexBuffer=function(e,t,r,i){this.bindArrayBuffer(e),void 0===r&&(r=0),void 0===i?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,r,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,r,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(r,r+i)):(t=t instanceof ArrayBuffer?new Uint8Array(t,r,i):new Uint8Array(t.buffer,t.byteOffset+r,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()},n.prototype._resetIndexBufferBinding=function(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null},n.prototype.createIndexBuffer=function(e,t){var r=this._gl.createBuffer();if(!r)throw new Error("Unable to create index buffer");this.bindIndexBuffer(r);var i,n=!1;if(e instanceof Uint16Array)i=e;else if(this._caps.uintIndices)if(e instanceof Uint32Array)i=e,n=!0;else{for(var s=0;s<e.length;s++)if(e[s]>65535){n=!0;break}i=n?new Uint32Array(e):new Uint16Array(e)}else i=new Uint16Array(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=n,r},n.prototype.bindArrayBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(e,this._gl.ARRAY_BUFFER)},n.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e)},n.prototype.bindUniformBufferBase=function(e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e)},n.prototype.bindUniformBlock=function(e,t,r){var i=this._gl.getUniformBlockIndex(e,t);this._gl.uniformBlockBinding(e,i,r)},n.prototype.bindIndexBuffer=function(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)},n.prototype.bindBuffer=function(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e),this._currentBoundBuffer[t]=e)},n.prototype.updateArrayBuffer=function(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)},n.prototype._vertexAttribPointer=function(e,t,r,i,n,s,o){var a=this._currentBufferPointers[t],h=!1;a.active?(a.buffer!==e&&(a.buffer=e,h=!0),a.size!==r&&(a.size=r,h=!0),a.type!==i&&(a.type=i,h=!0),a.normalized!==n&&(a.normalized=n,h=!0),a.stride!==s&&(a.stride=s,h=!0),a.offset!==o&&(a.offset=o,h=!0)):(h=!0,a.active=!0,a.index=t,a.size=r,a.type=i,a.normalized=n,a.stride=s,a.offset=o,a.buffer=e),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),this._gl.vertexAttribPointer(t,r,i,n,s,o))},n.prototype._bindIndexBufferWithCache=function(e){null!=e&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)},n.prototype._bindVertexBuffersAttributes=function(e,t){var r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var i=0;i<r.length;i++){var n=t.getAttributeLocation(i);if(n>=0){var s=e[r[i]];if(!s)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);var o=s.getBuffer();o&&(this._vertexAttribPointer(o,n,s.getSize(),s.type,s.normalized,s.byteStride,s.byteOffset),s.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,s.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(o))))}}},n.prototype.recordVertexArrayObject=function(e,t,r){var i=this._gl.createVertexArray();return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(i),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),i},n.prototype.bindVertexArrayObject=function(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=null!=t&&t.is32Bits,this._mustWipeVertexAttributes=!0)},n.prototype.bindBuffersDirectly=function(e,t,r,i,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n;var s=n.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();for(var o=0,a=0;a<s;a++)if(a<r.length){var h=n.getAttributeLocation(a);h>=0&&(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0,this._vertexAttribPointer(e,h,r[a],this._gl.FLOAT,!1,i,o)),o+=4*r[a]}}this._bindIndexBufferWithCache(t)},n.prototype._unbindVertexArrayObject=function(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))},n.prototype.bindBuffers=function(e,t,r){this._cachedVertexBuffers===e&&this._cachedEffectForVertexBuffers===r||(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r,this._bindVertexBuffersAttributes(e,r)),this._bindIndexBufferWithCache(t)},n.prototype.unbindInstanceAttributes=function(){for(var e,t=0,r=this._currentInstanceLocations.length;t<r;t++){var i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));var n=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(n,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0},n.prototype.releaseVertexArrayObject=function(e){this._gl.deleteVertexArray(e)},n.prototype._releaseBuffer=function(e){return 0===--e.references&&(this._gl.deleteBuffer(e),!0)},n.prototype.createInstancesBuffer=function(e){var t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");return t.capacity=e,this.bindArrayBuffer(t),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),t},n.prototype.deleteInstancesBuffer=function(e){this._gl.deleteBuffer(e)},n.prototype.updateAndBindInstancesBuffer=function(e,t,r){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),void 0!==r[0].index){for(var i=0,n=0;n<r.length;n++){var s=r[n];i+=4*s.attributeSize}for(var n=0;n<r.length;n++){var s=r[n];this._vertexAttribArraysEnabled[s.index]||(this._gl.enableVertexAttribArray(s.index),this._vertexAttribArraysEnabled[s.index]=!0),this._vertexAttribPointer(e,s.index,s.attributeSize,s.attribyteType||this._gl.FLOAT,s.normalized||!1,i,s.offset),this._gl.vertexAttribDivisor(s.index,1),this._currentInstanceLocations.push(s.index),this._currentInstanceBuffers.push(e)}}else for(var o=0;o<4;o++){var a=r[o];this._vertexAttribArraysEnabled[a]||(this._gl.enableVertexAttribArray(a),this._vertexAttribArraysEnabled[a]=!0),this._vertexAttribPointer(e,a,4,this._gl.FLOAT,!1,64,16*o),this._gl.vertexAttribDivisor(a,1),this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(e)}},n.prototype.applyStates=function(){this._depthCullingState.apply(this._gl),this._stencilState.apply(this._gl),this._alphaState.apply(this._gl)},n.prototype.draw=function(t,r,i,n){this.drawElementsType(t?e.Material.TriangleFillMode:e.Material.WireFrameFillMode,r,i,n)},n.prototype.drawPointClouds=function(t,r,i){this.drawArraysType(e.Material.PointFillMode,t,r,i)},n.prototype.drawUnIndexed=function(t,r,i,n){this.drawArraysType(t?e.Material.TriangleFillMode:e.Material.WireFrameFillMode,r,i,n)},n.prototype.drawElementsType=function(e,t,r,i){this.applyStates(),this._drawCalls.addCount(1,!1);var n=this._drawMode(e),s=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;i?this._gl.drawElementsInstanced(n,r,s,t*o,i):this._gl.drawElements(n,r,s,t*o)},n.prototype.drawArraysType=function(e,t,r,i){this.applyStates(),this._drawCalls.addCount(1,!1);var n=this._drawMode(e);i?this._gl.drawArraysInstanced(n,t,r,i):this._gl.drawArrays(n,t,r)},n.prototype._drawMode=function(t){switch(t){case e.Material.TriangleFillMode:return this._gl.TRIANGLES;case e.Material.PointFillMode:return this._gl.POINTS;case e.Material.WireFrameFillMode:return this._gl.LINES;case e.Material.PointListDrawMode:return this._gl.POINTS;case e.Material.LineListDrawMode:return this._gl.LINES;case e.Material.LineLoopDrawMode:return this._gl.LINE_LOOP;case e.Material.LineStripDrawMode:return this._gl.LINE_STRIP;case e.Material.TriangleStripDrawMode:return this._gl.TRIANGLE_STRIP;case e.Material.TriangleFanDrawMode:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}},n.prototype._releaseEffect=function(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deleteProgram(e.getProgram()))},n.prototype._deleteProgram=function(e){e&&(e.__SPECTOR_rebuildProgram=null,e.transformFeedback&&(this.deleteTransformFeedback(e.transformFeedback),e.transformFeedback=null),this._gl.deleteProgram(e))},n.prototype.createEffect=function(t,r,i,n,s,o,a,h,u){var l=t.vertexElement||t.vertex||t,c=t.fragmentElement||t.fragment||t,f=l+"+"+c+"@"+(s||r.defines);if(this._compiledEffects[f]){var d=this._compiledEffects[f];return a&&d.isReady()&&a(d),d}var p=new e.Effect(t,r,i,n,this,s,o,a,h,u);return p._key=f,this._compiledEffects[f]=p,p},n.prototype.createEffectForParticles=function(e,t,r,i,n,s,o){return void 0===t&&(t=[]),void 0===r&&(r=[]),void 0===i&&(i=""),this.createEffect({vertex:"particles",fragmentElement:e},["position","color","options"],["view","projection"].concat(t),["diffuseSampler"].concat(r),i,n,s,o)},n.prototype.createRawShaderProgram=function(e,t,i,n){void 0===n&&(n=null),i=i||this._gl;var s=r(i,e,"vertex"),o=r(i,t,"fragment");return this._createShaderProgram(s,o,i,n)},n.prototype.createShaderProgram=function(e,r,i,n,s){void 0===s&&(s=null),n=n||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);var o=this._webGLVersion>1?"#version 300 es\n#define WEBGL2 \n":"",a=t(n,e,"vertex",i,o),h=t(n,r,"fragment",i,o),u=this._createShaderProgram(a,h,n,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),u},n.prototype._createShaderProgram=function(e,t,r,i){void 0===i&&(i=null);var n=r.createProgram();if(!n)throw new Error("Unable to create program");if(r.attachShader(n,e),r.attachShader(n,t),this.webGLVersion>1&&i){var s=this.createTransformFeedback();this.bindTransformFeedback(s),this.setTranformFeedbackVaryings(n,i),n.transformFeedback=s}if(r.linkProgram(n),this.webGLVersion>1&&i&&this.bindTransformFeedback(null),!r.getProgramParameter(n,r.LINK_STATUS)){r.validateProgram(n);var o=r.getProgramInfoLog(n);if(o)throw new Error(o)}return r.deleteShader(e),r.deleteShader(t),n},n.prototype.getUniforms=function(e,t){for(var r=new Array,i=0;i<t.length;i++)r.push(this._gl.getUniformLocation(e,t[i]));return r},n.prototype.getAttributes=function(e,t){for(var r=[],i=0;i<t.length;i++)try{r.push(this._gl.getAttribLocation(e,t[i]))}catch(e){r.push(-1)}return r},n.prototype.enableEffect=function(e){e&&(this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e.onBindObservable.notifyObservers(e))},n.prototype.setIntArray=function(e,t){e&&this._gl.uniform1iv(e,t)},n.prototype.setIntArray2=function(e,t){e&&t.length%2==0&&this._gl.uniform2iv(e,t)},n.prototype.setIntArray3=function(e,t){e&&t.length%3==0&&this._gl.uniform3iv(e,t)},n.prototype.setIntArray4=function(e,t){e&&t.length%4==0&&this._gl.uniform4iv(e,t)},n.prototype.setFloatArray=function(e,t){e&&this._gl.uniform1fv(e,t)},n.prototype.setFloatArray2=function(e,t){e&&t.length%2==0&&this._gl.uniform2fv(e,t)},n.prototype.setFloatArray3=function(e,t){e&&t.length%3==0&&this._gl.uniform3fv(e,t)},n.prototype.setFloatArray4=function(e,t){e&&t.length%4==0&&this._gl.uniform4fv(e,t)},n.prototype.setArray=function(e,t){e&&this._gl.uniform1fv(e,t)},n.prototype.setArray2=function(e,t){e&&t.length%2==0&&this._gl.uniform2fv(e,t)},n.prototype.setArray3=function(e,t){e&&t.length%3==0&&this._gl.uniform3fv(e,t)},n.prototype.setArray4=function(e,t){e&&t.length%4==0&&this._gl.uniform4fv(e,t)},n.prototype.setMatrices=function(e,t){e&&this._gl.uniformMatrix4fv(e,!1,t)},n.prototype.setMatrix=function(e,t){e&&this._gl.uniformMatrix4fv(e,!1,t.toArray())},n.prototype.setMatrix3x3=function(e,t){e&&this._gl.uniformMatrix3fv(e,!1,t)},n.prototype.setMatrix2x2=function(e,t){e&&this._gl.uniformMatrix2fv(e,!1,t)},n.prototype.setInt=function(e,t){e&&this._gl.uniform1i(e,t)},n.prototype.setFloat=function(e,t){e&&this._gl.uniform1f(e,t)},n.prototype.setFloat2=function(e,t,r){e&&this._gl.uniform2f(e,t,r)},n.prototype.setFloat3=function(e,t,r,i){e&&this._gl.uniform3f(e,t,r,i)},n.prototype.setBool=function(e,t){e&&this._gl.uniform1i(e,t)},n.prototype.setFloat4=function(e,t,r,i,n){e&&this._gl.uniform4f(e,t,r,i,n)},n.prototype.setColor3=function(e,t){e&&this._gl.uniform3f(e,t.r,t.g,t.b)},n.prototype.setColor4=function(e,t,r){e&&this._gl.uniform4f(e,t.r,t.g,t.b,r)},n.prototype.setDirectColor4=function(e,t){e&&this._gl.uniform4f(e,t.r,t.g,t.b,t.a)},n.prototype.setState=function(e,t,r,i){void 0===t&&(t=0),void 0===i&&(i=!1),(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e);var n=this.cullBackFaces?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==n||r)&&(this._depthCullingState.cullFace=n),this.setZOffset(t);var s=i?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==s||r)&&(this._depthCullingState.frontFace=s)},n.prototype.setZOffset=function(e){this._depthCullingState.zOffset=e},n.prototype.getZOffset=function(){return this._depthCullingState.zOffset},n.prototype.setDepthBuffer=function(e){this._depthCullingState.depthTest=e},n.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask},n.prototype.setDepthWrite=function(e){this._depthCullingState.depthMask=e},n.prototype.setColorWrite=function(e){this._gl.colorMask(e,e,e,e),this._colorWrite=e},n.prototype.getColorWrite=function(){return this._colorWrite},n.prototype.setAlphaConstants=function(e,t,r,i){this._alphaState.setAlphaBlendConstants(e,t,r,i)},n.prototype.setAlphaMode=function(e,t){if(void 0===t&&(t=!1),this._alphaMode!==e){switch(e){case n.ALPHA_DISABLE:this._alphaState.alphaBlend=!1;break;case n.ALPHA_PREMULTIPLIED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case n.ALPHA_PREMULTIPLIED_PORTERDUFF:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case n.ALPHA_COMBINE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case n.ALPHA_ONEONE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case n.ALPHA_ADD:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case n.ALPHA_SUBTRACT:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case n.ALPHA_MULTIPLY:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case n.ALPHA_MAXIMIZED:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case n.ALPHA_INTERPOLATE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case n.ALPHA_SCREENMODE:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0}t||this.setDepthWrite(e===n.ALPHA_DISABLE),this._alphaMode=e}},n.prototype.getAlphaMode=function(){return this._alphaMode},n.prototype.wipeCaches=function(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,e&&(this.resetTextureCache(),this._currentProgram=null,this._stencilState.reset(),this._depthCullingState.reset(),this.setDepthFunctionToLessOrEqual(),this._alphaState.reset()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this._unbindVertexArrayObject(),this.bindIndexBuffer(null))},n.prototype.setTextureFormatToUse=function(e){for(var t=0,r=this.texturesSupported.length;t<r;t++)for(var i=0,n=e.length;i<n;i++)if(this._texturesSupported[t]===e[i].toLowerCase())return this._textureFormatInUse=this._texturesSupported[t];return this._textureFormatInUse=null,null},n.prototype._createTexture=function(){var e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e},n.prototype.createTexture=function(t,r,i,n,s,o,a,h,u,l){var c=this;void 0===s&&(s=e.Texture.TRILINEAR_SAMPLINGMODE),void 0===o&&(o=null),void 0===a&&(a=null),void 0===h&&(h=null),void 0===u&&(u=null),void 0===l&&(l=null);var f=String(t),d="data:"===f.substr(0,5),p="blob:"===f.substr(0,5),_=d&&-1!==f.indexOf("base64"),m=u||new e.InternalTexture(this,e.InternalTexture.DATASOURCE_URL),g=f.lastIndexOf("."),v=g>0?f.substring(g).toLowerCase():"",y=this.getCaps().s3tc&&0===v.indexOf(".dds"),b=0===v.indexOf(".tga"),T=!1;!this._textureFormatInUse||_||u||(f=f.substring(0,g)+this._textureFormatInUse,T=!0),n&&n._addPendingData(m),m.url=f,m.generateMipMaps=!r,m.samplingMode=s,m.invertY=i,this._doNotHandleContextLost||(m._buffer=h);var E=null;o&&!u&&(E=m.onLoadedObservable.add(o)),u||this._internalTexturesCache.push(m);var x=function(o,u){n&&n._removePendingData(m),E&&m.onLoadedObservable.remove(E),T?c.createTexture(t,r,i,n,s,null,a,h,m):e.Tools.UseFallbackTexture&&c.createTexture(e.Tools.fallbackTexture,r,i,n,s,null,a,h,m),a&&a(o||"Unknown error",u)},A=null;if(T||b||y)T?A=function(t){var o=new e.KhronosTextureContainer(t,1);c._prepareWebGLTexture(m,n,o.pixelWidth,o.pixelHeight,i,!1,!0,(function(){return o.uploadLevels(c._gl,!r),!1}),s)}:b?A=function(t){var o=new Uint8Array(t),a=e.TGATools.GetTGAHeader(o);c._prepareWebGLTexture(m,n,a.width,a.height,i,r,!1,(function(){return e.TGATools.UploadContent(c._gl,o),!1}),s)}:y&&(A=function(t){var o=e.DDSTools.GetDDSInfo(t),a=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&!r&&o.width>>o.mipmapCount-1==1;c._prepareWebGLTexture(m,n,o.width,o.height,i,!a,o.isFourCC,(function(){return e.DDSTools.UploadDDSLevels(c,c._gl,t,o,a,1),!1}),s)}),h?A&&A(h):this._loadFile(f,(function(e){A&&A(e)}),void 0,n?n.database:void 0,!0,(function(e,t){x("Unable to load "+(e&&e.responseURL,t))}));else{var M=function(t){p&&!c._doNotHandleContextLost&&(m._buffer=t),c._prepareWebGLTexture(m,n,t.width,t.height,i,r,!1,(function(r,i,s){var o=c._gl,a=t.width===r&&t.height===i,h=l?c._getInternalFormat(l):".jpg"===v?o.RGB:o.RGBA;if(a)return o.texImage2D(o.TEXTURE_2D,0,h,h,o.UNSIGNED_BYTE,t),!1;var u=new e.InternalTexture(c,e.InternalTexture.DATASOURCE_TEMP);return c._bindTextureDirectly(o.TEXTURE_2D,u,!0),o.texImage2D(o.TEXTURE_2D,0,h,h,o.UNSIGNED_BYTE,t),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),c._rescaleTexture(u,m,n,h,(function(){c._releaseTexture(u),c._bindTextureDirectly(o.TEXTURE_2D,m,!0),s()})),!0}),s)};!d||_?h instanceof HTMLImageElement?M(h):e.Tools.LoadImage(f,M,x,n?n.database:null):"string"==typeof h||h instanceof ArrayBuffer||h instanceof Blob?e.Tools.LoadImage(h,M,x,n?n.database:null):M(h)}return m},n.prototype._rescaleTexture=function(t,r,i,s,o){var a=this,h=this.createRenderTargetTexture({width:r.width,height:r.height},{generateMipMaps:!1,type:n.TEXTURETYPE_UNSIGNED_INT,samplingMode:e.Texture.BILINEAR_SAMPLINGMODE,generateDepthBuffer:!1,generateStencilBuffer:!1})
;this._rescalePostProcess||(this._rescalePostProcess=new e.PassPostProcess("rescale",1,null,e.Texture.BILINEAR_SAMPLINGMODE,this,!1,n.TEXTURETYPE_UNSIGNED_INT)),this._rescalePostProcess.getEffect().executeWhenCompiled((function(){a._rescalePostProcess.onApply=function(e){e._bindTexture("textureSampler",t)};var e=i;e||(e=a.scenes[a.scenes.length-1]),e.postProcessManager.directRender([a._rescalePostProcess],h,!0),a._bindTextureDirectly(a._gl.TEXTURE_2D,r,!0),a._gl.copyTexImage2D(a._gl.TEXTURE_2D,0,s,0,0,r.width,r.height,0),a.unBindFramebuffer(h),a._releaseTexture(h),o&&o()}))},n.prototype.updateRawTexture=function(e,t,r,i,s,o){if(void 0===s&&(s=null),void 0===o&&(o=n.TEXTURETYPE_UNSIGNED_INT),e){var a=this._getRGBABufferInternalSizedFormat(o,r),h=this._getInternalFormat(r),u=this._getWebGLTextureType(o);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,void 0===i?1:i?1:0),this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.type=o,e.invertY=i,e._compression=s),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[s],e.width,e.height,0,t):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,e.width,e.height,0,h,u,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}},n.prototype.createRawTexture=function(t,r,s,o,a,h,u,l,c){void 0===l&&(l=null),void 0===c&&(c=n.TEXTURETYPE_UNSIGNED_INT);var f=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RAW);f.baseWidth=r,f.baseHeight=s,f.width=r,f.height=s,f.format=o,f.generateMipMaps=a,f.samplingMode=u,f.invertY=h,f._compression=l,f.type=c,this._doNotHandleContextLost||(f._bufferView=t),this.updateRawTexture(f,t,o,h,l,c),this._bindTextureDirectly(this._gl.TEXTURE_2D,f,!0);var d=i(u,a,this._gl);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),a&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(f),f},n.prototype.createDynamicTexture=function(t,r,i,n){var s=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_DYNAMIC);return s.baseWidth=t,s.baseHeight=r,i&&(t=this.needPOTTextures?e.Tools.GetExponentOfTwo(t,this._caps.maxTextureSize):t,r=this.needPOTTextures?e.Tools.GetExponentOfTwo(r,this._caps.maxTextureSize):r),s.width=t,s.height=r,s.isReady=!1,s.generateMipMaps=i,s.samplingMode=n,this.updateTextureSamplingMode(n,s),this._internalTexturesCache.push(s),s},n.prototype.updateTextureSamplingMode=function(e,t){var r=i(e,t.generateMipMaps,this._gl);t.isCube?(this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_MIN_FILTER,r.min),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):t.is3D?(this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_MIN_FILTER,r.min),this._bindTextureDirectly(this._gl.TEXTURE_3D,null)):(this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,r.min),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t.samplingMode=e},n.prototype.updateDynamicTexture=function(e,t,r,i,n){if(void 0===i&&(i=!1),e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,r?1:0),i&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);var s=n?this._getInternalFormat(n):this._gl.RGBA;this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,s,this._gl.UNSIGNED_BYTE,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),i&&this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),e.isReady=!0}},n.prototype.updateVideoTexture=function(e,t,r){if(e&&!e._isDisabled){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,r?0:1);try{if(void 0===this._videoTextureSupported&&(this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,t);else{if(!e._workingCanvas){e._workingCanvas=document.createElement("canvas");var i=e._workingCanvas.getContext("2d");if(!i)throw new Error("Unable to get 2d context");e._workingContext=i,e._workingCanvas.width=e.width,e._workingCanvas.height=e.height}e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e._workingCanvas)}e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}catch(t){e._isDisabled=!0}}},n.prototype.updateTextureComparisonFunction=function(t,r){if(1===this.webGLVersion)return void e.Tools.Error("WebGL 1 does not support texture comparison.");var i=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),0===r?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,n.LEQUAL),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,r),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),0===r?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,n.LEQUAL),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=r},n.prototype._setupDepthStencilTexture=function(t,r,s,o,a){var h=r.width||r,u=r.height||r;t.baseWidth=h,t.baseHeight=u,t.width=h,t.height=u,t.isReady=!0,t.samples=1,t.generateMipMaps=!1,t._generateDepthBuffer=!0,t._generateStencilBuffer=s,t.samplingMode=o?e.Texture.BILINEAR_SAMPLINGMODE:e.Texture.NEAREST_SAMPLINGMODE,t.type=n.TEXTURETYPE_UNSIGNED_INT,t._comparisonFunction=a;var l=this._gl,c=t.isCube?l.TEXTURE_CUBE_MAP:l.TEXTURE_2D,f=i(t.samplingMode,!1,l);l.texParameteri(c,l.TEXTURE_MAG_FILTER,f.mag),l.texParameteri(c,l.TEXTURE_MIN_FILTER,f.min),l.texParameteri(c,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(c,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),0===a?(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,n.LEQUAL),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(c,l.TEXTURE_COMPARE_FUNC,a),l.texParameteri(c,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE))},n.prototype.createDepthStencilTexture=function(e,t){if(t.isCube){var r=e.width||e;return this._createDepthStencilCubeTexture(r,t)}return this._createDepthStencilTexture(e,t)},n.prototype._createDepthStencilTexture=function(t,r){var i=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_DEPTHTEXTURE);if(!this._caps.depthTextureExtension)return e.Tools.Error("Depth texture is not supported by your browser or hardware."),i;var n=o({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},r),s=this._gl;return this._bindTextureDirectly(s.TEXTURE_2D,i,!0),this._setupDepthStencilTexture(i,t,n.generateStencil,n.bilinearFiltering,n.comparisonFunction),this.webGLVersion>1?n.generateStencil?s.texImage2D(s.TEXTURE_2D,0,s.DEPTH24_STENCIL8,i.width,i.height,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT24,i.width,i.height,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null):n.generateStencil?s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_STENCIL,i.width,i.height,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT,i.width,i.height,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null),this._bindTextureDirectly(s.TEXTURE_2D,null),i},n.prototype._createDepthStencilCubeTexture=function(t,r){var i=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_UNKNOWN);if(i.isCube=!0,1===this.webGLVersion)return e.Tools.Error("Depth cube texture is not supported by WebGL 1."),i;var n=o({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},r),s=this._gl;this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,t,n.generateStencil,n.bilinearFiltering,n.comparisonFunction);for(var a=0;a<6;a++)n.generateStencil?s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,s.DEPTH24_STENCIL8,t,t,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,s.DEPTH_COMPONENT24,t,t,0,s.DEPTH_COMPONENT,s.UNSIGNED_INT,null);return this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),i},n.prototype.setFrameBufferDepthStencilTexture=function(e){var t=e.getInternalTexture();if(t&&t._framebuffer&&e.depthStencilTexture){var r=this._gl,i=e.depthStencilTexture;this.bindUnboundFramebuffer(t._framebuffer),i.isCube?i._generateStencilBuffer?r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.TEXTURE_CUBE_MAP_POSITIVE_X,i._webGLTexture,0):r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_CUBE_MAP_POSITIVE_X,i._webGLTexture,0):i._generateStencilBuffer?r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.TEXTURE_2D,i._webGLTexture,0):r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,i._webGLTexture,0),this.bindUnboundFramebuffer(null)}},n.prototype.createRenderTargetTexture=function(t,r){var s=new u;void 0!==r&&"object"==typeof r?(s.generateMipMaps=r.generateMipMaps,s.generateDepthBuffer=void 0===r.generateDepthBuffer||r.generateDepthBuffer,s.generateStencilBuffer=s.generateDepthBuffer&&r.generateStencilBuffer,s.type=void 0===r.type?n.TEXTURETYPE_UNSIGNED_INT:r.type,s.samplingMode=void 0===r.samplingMode?e.Texture.TRILINEAR_SAMPLINGMODE:r.samplingMode,s.format=void 0===r.format?n.TEXTUREFORMAT_RGBA:r.format):(s.generateMipMaps=r,s.generateDepthBuffer=!0,s.generateStencilBuffer=!1,s.type=n.TEXTURETYPE_UNSIGNED_INT,s.samplingMode=e.Texture.TRILINEAR_SAMPLINGMODE,s.format=n.TEXTUREFORMAT_RGBA),s.type!==n.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?s.type!==n.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(s.samplingMode=e.Texture.NEAREST_SAMPLINGMODE):s.samplingMode=e.Texture.NEAREST_SAMPLINGMODE;var o=this._gl,a=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RENDERTARGET);this._bindTextureDirectly(o.TEXTURE_2D,a,!0);var h=t.width||t,l=t.height||t,c=i(s.samplingMode,!!s.generateMipMaps,o);s.type!==n.TEXTURETYPE_FLOAT||this._caps.textureFloat||(s.type=n.TEXTURETYPE_UNSIGNED_INT,e.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,c.mag),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,c.min),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),h,l,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);var f=this._currentFramebuffer,d=o.createFramebuffer();return this.bindUnboundFramebuffer(d),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,a._webGLTexture,0),a._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!s.generateStencilBuffer,s.generateDepthBuffer,h,l),s.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(o.TEXTURE_2D,null),o.bindRenderbuffer(o.RENDERBUFFER,null),this.bindUnboundFramebuffer(f),a._framebuffer=d,a.baseWidth=h,a.baseHeight=l,a.width=h,a.height=l,a.isReady=!0,a.samples=1,a.generateMipMaps=!!s.generateMipMaps,a.samplingMode=s.samplingMode,a.type=s.type,a._generateDepthBuffer=s.generateDepthBuffer,a._generateStencilBuffer=!!s.generateStencilBuffer,this._internalTexturesCache.push(a),a},n.prototype.createMultipleRenderTarget=function(t,r){var s=!1,o=!0,a=!1,h=!1,u=1,l=n.TEXTURETYPE_UNSIGNED_INT,c=e.Texture.TRILINEAR_SAMPLINGMODE,f=new Array,d=new Array;void 0!==r&&(s=void 0!==r.generateMipMaps&&r.generateMipMaps,o=void 0===r.generateDepthBuffer||r.generateDepthBuffer,a=void 0!==r.generateStencilBuffer&&r.generateStencilBuffer,h=void 0!==r.generateDepthTexture&&r.generateDepthTexture,u=r.textureCount||1,r.types&&(f=r.types),r.samplingModes&&(d=r.samplingModes));var p=this._gl,_=p.createFramebuffer();this.bindUnboundFramebuffer(_);for(var m=t.width||t,g=t.height||t,v=[],y=[],b=this._setupFramebufferDepthAttachments(a,o,m,g),T=0;T<u;T++){var E=d[T]||c,x=f[T]||l;x!==n.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?x!==n.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(E=e.Texture.NEAREST_SAMPLINGMODE):E=e.Texture.NEAREST_SAMPLINGMODE;var A=i(E,s,p);x!==n.TEXTURETYPE_FLOAT||this._caps.textureFloat||(x=n.TEXTURETYPE_UNSIGNED_INT,e.Tools.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));var M=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_MULTIRENDERTARGET),P=p[this.webGLVersion>1?"COLOR_ATTACHMENT"+T:"COLOR_ATTACHMENT"+T+"_WEBGL"];v.push(M),y.push(P),p.activeTexture(p["TEXTURE"+T]),p.bindTexture(p.TEXTURE_2D,M._webGLTexture),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,A.mag),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,A.min),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texImage2D(p.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(x),m,g,0,p.RGBA,this._getWebGLTextureType(x),null),p.framebufferTexture2D(p.DRAW_FRAMEBUFFER,P,p.TEXTURE_2D,M._webGLTexture,0),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(p.TEXTURE_2D,null),M._framebuffer=_,M._depthStencilBuffer=b,M.baseWidth=m,M.baseHeight=g,M.width=m,M.height=g,M.isReady=!0,M.samples=1,M.generateMipMaps=s,M.samplingMode=E,M.type=x,M._generateDepthBuffer=o,M._generateStencilBuffer=a,M._attachments=y,this._internalTexturesCache.push(M)}if(h&&this._caps.depthTextureExtension){var R=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_MULTIRENDERTARGET);p.activeTexture(p.TEXTURE0),p.bindTexture(p.TEXTURE_2D,R._webGLTexture),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texImage2D(p.TEXTURE_2D,0,this.webGLVersion<2?p.DEPTH_COMPONENT:p.DEPTH_COMPONENT16,m,g,0,p.DEPTH_COMPONENT,p.UNSIGNED_SHORT,null),p.framebufferTexture2D(p.FRAMEBUFFER,p.DEPTH_ATTACHMENT,p.TEXTURE_2D,R._webGLTexture,0),R._framebuffer=_,R.baseWidth=m,R.baseHeight=g,R.width=m,R.height=g,R.isReady=!0,R.samples=1,R.generateMipMaps=s,R.samplingMode=p.NEAREST,R._generateDepthBuffer=o,R._generateStencilBuffer=a,v.push(R),this._internalTexturesCache.push(R)}return p.drawBuffers(y),p.bindRenderbuffer(p.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),this.resetTextureCache(),v},n.prototype._setupFramebufferDepthAttachments=function(e,t,r,i,n){void 0===n&&(n=1);var s=null,o=this._gl;return e?(s=o.createRenderbuffer(),o.bindRenderbuffer(o.RENDERBUFFER,s),n>1?o.renderbufferStorageMultisample(o.RENDERBUFFER,n,o.DEPTH24_STENCIL8,r,i):o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_STENCIL,r,i),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_STENCIL_ATTACHMENT,o.RENDERBUFFER,s)):t&&(s=o.createRenderbuffer(),o.bindRenderbuffer(o.RENDERBUFFER,s),n>1?o.renderbufferStorageMultisample(o.RENDERBUFFER,n,o.DEPTH_COMPONENT16,r,i):o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,r,i),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,s)),s},n.prototype.updateRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e)return 1;if(e.samples===t)return t;var r=this._gl;if(t=Math.min(t,r.getParameter(r.MAX_SAMPLES)),e._depthStencilBuffer&&(r.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(r.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),e._MSAARenderBuffer&&(r.deleteRenderbuffer(e._MSAARenderBuffer),e._MSAARenderBuffer=null),t>1){var i=r.createFramebuffer();if(!i)throw new Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=i,this.bindUnboundFramebuffer(e._MSAAFramebuffer);var n=r.createRenderbuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");r.bindRenderbuffer(r.RENDERBUFFER,n),r.renderbufferStorageMultisample(r.RENDERBUFFER,t,this._getRGBAMultiSampleBufferFormat(e.type),e.width,e.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,n),e._MSAARenderBuffer=n}else this.bindUnboundFramebuffer(e._framebuffer);return e.samples=t,e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.width,e.height,t),r.bindRenderbuffer(r.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),t},n.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(this.webGLVersion<2||!e||0==e.length)return 1;if(e[0].samples===t)return t;var r=this._gl;t=Math.min(t,r.getParameter(r.MAX_SAMPLES)),e[0]._depthStencilBuffer&&(r.deleteRenderbuffer(e[0]._depthStencilBuffer),e[0]._depthStencilBuffer=null),e[0]._MSAAFramebuffer&&(r.deleteFramebuffer(e[0]._MSAAFramebuffer),e[0]._MSAAFramebuffer=null);for(var i=0;i<e.length;i++)e[i]._MSAARenderBuffer&&(r.deleteRenderbuffer(e[i]._MSAARenderBuffer),e[i]._MSAARenderBuffer=null);if(t>1){var n=r.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");this.bindUnboundFramebuffer(n);for(var s=this._setupFramebufferDepthAttachments(e[0]._generateStencilBuffer,e[0]._generateDepthBuffer,e[0].width,e[0].height,t),o=[],i=0;i<e.length;i++){var a=e[i],h=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],u=r.createRenderbuffer();if(!u)throw new Error("Unable to create multi sampled framebuffer");r.bindRenderbuffer(r.RENDERBUFFER,u),r.renderbufferStorageMultisample(r.RENDERBUFFER,t,this._getRGBAMultiSampleBufferFormat(a.type),a.width,a.height),r.framebufferRenderbuffer(r.FRAMEBUFFER,h,r.RENDERBUFFER,u),a._MSAAFramebuffer=n,a._MSAARenderBuffer=u,a.samples=t,a._depthStencilBuffer=s,r.bindRenderbuffer(r.RENDERBUFFER,null),o.push(h)}r.drawBuffers(o)}else this.bindUnboundFramebuffer(e[0]._framebuffer);return this.bindUnboundFramebuffer(null),t},n.prototype._uploadDataToTexture=function(e,t,r,i,n,s,o,a){this._gl.texImage2D(e,t,r,i,n,0,s,o,a)},n.prototype._uploadCompressedDataToTexture=function(e,t,r,i,n,s){this._gl.compressedTexImage2D(e,t,r,i,n,0,s)},n.prototype._uploadImageToTexture=function(e,t,r,i){var n=this._gl,s=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),a=this._getRGBABufferInternalSizedFormat(e.type,o),h=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(h,e,!0),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,e.invertY?1:0);var u=n.TEXTURE_2D;if(e.isCube)var u=n.TEXTURE_CUBE_MAP_POSITIVE_X+t;n.texImage2D(u,r,a,o,s,i),this._bindTextureDirectly(h,null,!0)},n.prototype.createRenderTargetCubeTexture=function(t,r){var s=o({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:n.TEXTURETYPE_UNSIGNED_INT,samplingMode:e.Texture.TRILINEAR_SAMPLINGMODE,format:n.TEXTUREFORMAT_RGBA},r);s.generateStencilBuffer=s.generateDepthBuffer&&s.generateStencilBuffer,s.type!==n.TEXTURETYPE_FLOAT||this._caps.textureFloatLinearFiltering?s.type!==n.TEXTURETYPE_HALF_FLOAT||this._caps.textureHalfFloatLinearFiltering||(s.samplingMode=e.Texture.NEAREST_SAMPLINGMODE):s.samplingMode=e.Texture.NEAREST_SAMPLINGMODE;var a=this._gl,h=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RENDERTARGET);this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,h,!0);var u=i(s.samplingMode,s.generateMipMaps,a);s.type!==n.TEXTURETYPE_FLOAT||this._caps.textureFloat||(s.type=n.TEXTURETYPE_UNSIGNED_INT,e.Tools.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,u.mag),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,u.min),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);for(var l=0;l<6;l++)a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(s.type,s.format),t,t,0,this._getInternalFormat(s.format),this._getWebGLTextureType(s.type),null);var c=a.createFramebuffer();return this.bindUnboundFramebuffer(c),h._depthStencilBuffer=this._setupFramebufferDepthAttachments(s.generateStencilBuffer,s.generateDepthBuffer,t,t),s.generateMipMaps&&a.generateMipmap(a.TEXTURE_CUBE_MAP),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null),a.bindRenderbuffer(a.RENDERBUFFER,null),this.bindUnboundFramebuffer(null),h._framebuffer=c,h.width=t,h.height=t,h.isReady=!0,h.isCube=!0,h.samples=1,h.generateMipMaps=s.generateMipMaps,h.samplingMode=s.samplingMode,h.type=s.type,h._generateDepthBuffer=s.generateDepthBuffer,h._generateStencilBuffer=s.generateStencilBuffer,this._internalTexturesCache.push(h),h},n.prototype.createPrefilteredCubeTexture=function(t,r,i,n,s,o,a,h,u){var l=this;void 0===s&&(s=null),void 0===o&&(o=null),void 0===h&&(h=null),void 0===u&&(u=!0);var c=function(t){if(!t)return void(s&&s(null));var o=t.texture;if(u?t.info.sphericalPolynomial&&(o._sphericalPolynomial=t.info.sphericalPolynomial):o._sphericalPolynomial=new e.SphericalPolynomial,o._dataSource=e.InternalTexture.DATASOURCE_CUBEPREFILTERED,l._caps.textureLOD)return void(s&&s(o));var a=l._gl,h=t.width;if(h){for(var c=[],f=0;f<3;f++){var d=f/2,p=1-d,_=n,m=e.Scalar.Log2(h)*i+n,g=_+(m-_)*p,v=Math.round(Math.min(Math.max(g,0),m)),y=new e.InternalTexture(l,e.InternalTexture.DATASOURCE_TEMP);if(y.isCube=!0,l._bindTextureDirectly(a.TEXTURE_CUBE_MAP,y,!0),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),t.isDDS){var b=t.info,T=t.data;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,b.isCompressed?1:0),e.DDSTools.UploadDDSLevels(l,l._gl,T,b,!0,6,v)}else e.Tools.Warn("DDS is the only prefiltered cube map supported so far.");l._bindTextureDirectly(a.TEXTURE_CUBE_MAP,null);var E=new e.BaseTexture(r);E.isCube=!0,E._texture=y,y.isReady=!0,c.push(E)}o._lodTextureHigh=c[2],o._lodTextureMid=c[1],o._lodTextureLow=c[0],s&&s(o)}};return this.createCubeTexture(t,r,null,!1,c,o,a,h,u,i,n)},n.prototype.createCubeTexture=function(t,r,i,n,o,a,h,u,l,c,f){var d=this;void 0===o&&(o=null),void 0===a&&(a=null),void 0===u&&(u=null),void 0===l&&(l=!1),void 0===c&&(c=0),void 0===f&&(f=0);var p=this._gl,_=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_CUBE);_.isCube=!0,_.url=t,_.generateMipMaps=!n,_._lodGenerationScale=c,_._lodGenerationOffset=f,this._doNotHandleContextLost||(_._extension=u,_._files=i);var m=!1,g=!1,v=!1,y=t.lastIndexOf("."),b=u||(y>-1?t.substring(y).toLowerCase():"");this._textureFormatInUse?(b=this._textureFormatInUse,t=(y>-1?t.substring(0,y):t)+this._textureFormatInUse,m=!0):(g=".dds"===b,v=".env"===b);var T=function(e,t){a&&e&&a(e.status+" "+e.statusText,t)};if(m)this._loadFile(t,(function(t){var r=new e.KhronosTextureContainer(t,6),i=r.numberOfMipmapLevels>1&&!n;d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,1),r.uploadLevels(d._gl,!n),d.setCubeMapTextureParams(p,i),_.width=r.pixelWidth,_.height=r.pixelHeight,_.isReady=!0}),void 0,void 0,!0,T);else if(v)this._loadFile(t,(function(t){t=t;var r=e.EnvironmentTextureTools.GetEnvInfo(t);r?(_.width=r.width,_.height=r.width,e.EnvironmentTextureTools.UploadPolynomials(_,t,r),e.EnvironmentTextureTools.UploadLevelsAsync(_,t,r).then((function(){_.isReady=!0,o&&o()}))):a&&a("Can not parse the environment file",null)}),void 0,void 0,!0,T);else if(g)i&&6===i.length?this._cascadeLoadFiles(r,(function(t){for(var r,i=!1,s=0,a=0;a<t.length;a++){var h=t[a];r=e.DDSTools.GetDDSInfo(h),i=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&!n,d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,r.isCompressed?1:0),e.DDSTools.UploadDDSLevels(d,d._gl,h,r,i,6,-1,a),n||r.isFourCC||1!==r.mipmapCount||p.generateMipmap(p.TEXTURE_CUBE_MAP),_.width=r.width,_.height=r.height,_.type=r.textureType,s=r.width}d.setCubeMapTextureParams(p,i),_.isReady=!0,o&&o({isDDS:!0,width:s,info:r,imgs:t,texture:_})}),i,a):this._loadFile(t,(function(t){var r=e.DDSTools.GetDDSInfo(t);l&&(r.sphericalPolynomial=new e.SphericalPolynomial);var i=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&!n;d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,r.isCompressed?1:0),e.DDSTools.UploadDDSLevels(d,d._gl,t,r,i,6),n||r.isFourCC||1!==r.mipmapCount||p.generateMipmap(p.TEXTURE_CUBE_MAP),d.setCubeMapTextureParams(p,i),_.width=r.width,_.height=r.height,_.isReady=!0,_.type=r.textureType,o&&o({isDDS:!0,width:r.width,info:r,data:t,texture:_})}),void 0,void 0,!0,T);else{if(!i)throw new Error("Cannot load cubemap because files were not defined");s(0,r,(function(t){var r=d.needPOTTextures?e.Tools.GetExponentOfTwo(t[0].width,d._caps.maxCubemapTextureSize):t[0].width,i=r;if(d._prepareWorkingCanvas(),d._workingCanvas&&d._workingContext){d._workingCanvas.width=r,d._workingCanvas.height=i;var s=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,0);for(var a=h?d._getInternalFormat(h):d._gl.RGBA,u=0;u<s.length;u++)d._workingContext.drawImage(t[u],0,0,t[u].width,t[u].height,0,0,r,i),p.texImage2D(s[u],0,a,a,p.UNSIGNED_BYTE,d._workingCanvas);n||p.generateMipmap(p.TEXTURE_CUBE_MAP),d.setCubeMapTextureParams(p,!n),_.width=r,_.height=i,_.isReady=!0,h&&(_.format=h),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),o&&o()}}),i,a)}return this._internalTexturesCache.push(_),_},n.prototype.setCubeMapTextureParams=function(e,t){e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,t?e.LINEAR_MIPMAP_LINEAR:e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),this._bindTextureDirectly(e.TEXTURE_CUBE_MAP,null)},n.prototype.updateRawCubeTexture=function(t,r,i,n,s,o,a){void 0===o&&(o=null),void 0===a&&(a=0),t._bufferViewArray=r,t.format=i,t.type=n,t.invertY=s,t._compression=o;var h=this._gl,u=this._getWebGLTextureType(n),l=this._getInternalFormat(i),c=this._getRGBABufferInternalSizedFormat(n),f=!1;l===h.RGB&&(l=h.RGBA,f=!0),this._bindTextureDirectly(h.TEXTURE_CUBE_MAP,t,!0),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,void 0===s?1:s?1:0),t.width%4!=0&&h.pixelStorei(h.UNPACK_ALIGNMENT,1);for(var d=0;d<6;d++){var p=r[d];o?h.compressedTexImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,this.getCaps().s3tc[o],t.width,t.height,0,p):(f&&(p=this._convertRGBtoRGBATextureData(p,t.width,t.height,n)),h.texImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,c,t.width,t.height,0,l,u,p))}(!this.needPOTTextures||e.Tools.IsExponentOfTwo(t.width)&&e.Tools.IsExponentOfTwo(t.height))&&t.generateMipMaps&&0===a&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),t.isReady=!0},n.prototype.createRawCubeTexture=function(t,r,n,s,o,a,h,u){void 0===u&&(u=null);var l=this._gl,c=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_CUBERAW);c.isCube=!0,c.generateMipMaps=o,c.format=n,c.type=s,this._doNotHandleContextLost||(c._bufferViewArray=t);var f=this._getWebGLTextureType(s),d=this._getInternalFormat(n);d===l.RGB&&(d=l.RGBA);var p=r,_=p;if(c.width=p,c.height=_,!this.needPOTTextures||e.Tools.IsExponentOfTwo(c.width)&&e.Tools.IsExponentOfTwo(c.height)||(o=!1),t&&this.updateRawCubeTexture(c,t,n,s,a,u),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),t&&o&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),f!==l.FLOAT||this._caps.textureFloatLinearFiltering)if(f!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering){var m=i(h,o,l);l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,m.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,m.min)}else l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,l.NEAREST);else l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,l.NEAREST);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c},n.prototype.createRawCubeTextureFromUrl=function(t,r,i,n,s,o,a,h,u,l,c,f){var d=this;void 0===u&&(u=null),void 0===l&&(l=null),void 0===c&&(c=e.Texture.TRILINEAR_SAMPLINGMODE),void 0===f&&(f=!1);var p=this._gl,_=this.createRawCubeTexture(null,i,n,s,!o,f,c);r._addPendingData(_),_.url=t,this._internalTexturesCache.push(_);var m=function(e,t){r._removePendingData(_),l&&e&&l(e.status+" "+e.statusText,t)},g=function(e){var t=_.width,i=a(e);if(i){if(h){var l=d._getWebGLTextureType(s),c=d._getInternalFormat(n),m=d._getRGBABufferInternalSizedFormat(s),g=!1;c===p.RGB&&(c=p.RGBA,g=!0),d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,0);for(var v=h(i),y=0;y<v.length;y++)for(var b=t>>y,T=0;T<6;T++){var E=v[y][T];g&&(E=d._convertRGBtoRGBATextureData(E,b,b,s)),p.texImage2D(T,y,m,b,b,0,c,l,E)}d._bindTextureDirectly(p.TEXTURE_CUBE_MAP,null)}else _.generateMipMaps=!o,d.updateRawCubeTexture(_,i,n,s,f);_.isReady=!0,r._removePendingData(_),u&&u()}};return this._loadFile(t,(function(e){g(e)}),void 0,r.database,!0,m),_},n.prototype.updateRawTexture3D=function(e,t,r,i,s,o){void 0===s&&(s=null),void 0===o&&(o=n.TEXTURETYPE_UNSIGNED_INT);var a=this._getWebGLTextureType(o),h=this._getInternalFormat(r),u=this._getRGBABufferInternalSizedFormat(o,r);this._bindTextureDirectly(this._gl.TEXTURE_3D,e,!0),this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,void 0===i?1:i?1:0),this._doNotHandleContextLost||(e._bufferView=t,e.format=r,e.invertY=i,e._compression=s),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&t?this._gl.compressedTexImage3D(this._gl.TEXTURE_3D,0,this.getCaps().s3tc[s],e.width,e.height,e.depth,0,t):this._gl.texImage3D(this._gl.TEXTURE_3D,0,u,e.width,e.height,e.depth,0,h,a,t),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_3D),this._bindTextureDirectly(this._gl.TEXTURE_3D,null),e.isReady=!0},n.prototype.createRawTexture3D=function(t,r,s,o,a,h,u,l,c,f){void 0===c&&(c=null),void 0===f&&(f=n.TEXTURETYPE_UNSIGNED_INT);var d=new e.InternalTexture(this,e.InternalTexture.DATASOURCE_RAW3D);d.baseWidth=r,d.baseHeight=s,d.baseDepth=o,d.width=r,d.height=s,d.depth=o,d.format=a,d.type=f,d.generateMipMaps=h,d.samplingMode=l,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=t),this.updateRawTexture3D(d,t,a,u,c,f),this._bindTextureDirectly(this._gl.TEXTURE_3D,d,!0);var p=i(l,h,this._gl);return this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(this._gl.TEXTURE_3D,this._gl.TEXTURE_MIN_FILTER,p.min),h&&this._gl.generateMipmap(this._gl.TEXTURE_3D),this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._internalTexturesCache.push(d),d},
n.prototype._prepareWebGLTextureContinuation=function(e,t,r,n,s){var o=this._gl;if(o){var a=i(s,!r,o);o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,a.mag),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,a.min),r||n||o.generateMipmap(o.TEXTURE_2D),this._bindTextureDirectly(o.TEXTURE_2D,null),t&&t._removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}},n.prototype._prepareWebGLTexture=function(t,r,i,n,s,o,a,h,u){var l=this;void 0===u&&(u=e.Texture.TRILINEAR_SAMPLINGMODE);var c=this.needPOTTextures?e.Tools.GetExponentOfTwo(i,this.getCaps().maxTextureSize):i,f=this.needPOTTextures?e.Tools.GetExponentOfTwo(n,this.getCaps().maxTextureSize):n,d=this._gl;if(d){if(!t._webGLTexture)return void(r&&r._removePendingData(t));this._bindTextureDirectly(d.TEXTURE_2D,t,!0),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,void 0===s?1:s?1:0),t.baseWidth=i,t.baseHeight=n,t.width=c,t.height=f,t.isReady=!0,h(c,f,(function(){l._prepareWebGLTextureContinuation(t,r,o,a,u)}))||this._prepareWebGLTextureContinuation(t,r,o,a,u)}},n.prototype._convertRGBtoRGBATextureData=function(e,t,r,i){var s;s=i===n.TEXTURETYPE_FLOAT?new Float32Array(t*r*4):new Uint32Array(t*r*4);for(var o=0;o<t;o++)for(var a=0;a<r;a++){var h=3*(a*t+o),u=4*(a*t+o);s[u+0]=e[h+0],s[u+1]=e[h+1],s[u+2]=e[h+2],s[u+3]=1}return s},n.prototype._releaseFramebufferObjects=function(e){var t=this._gl;e._framebuffer&&(t.deleteFramebuffer(e._framebuffer),e._framebuffer=null),e._depthStencilBuffer&&(t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(t.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),e._MSAARenderBuffer&&(t.deleteRenderbuffer(e._MSAARenderBuffer),e._MSAARenderBuffer=null)},n.prototype._releaseTexture=function(e){var t=this._gl;this._releaseFramebufferObjects(e),t.deleteTexture(e._webGLTexture),this.unbindAllTextures();var r=this._internalTexturesCache.indexOf(e);-1!==r&&this._internalTexturesCache.splice(r,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),this.scenes.forEach((function(t){t.postProcesses.forEach((function(t){t._outputTexture==e&&(t._outputTexture=null)})),t.cameras.forEach((function(t){t._postProcesses.forEach((function(t){t&&t._outputTexture==e&&(t._outputTexture=null)}))}))}))},n.prototype.setProgram=function(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)},n.prototype.bindSamplers=function(e){this.setProgram(e.getProgram());for(var t=e.getSamplers(),r=0;r<t.length;r++){var i=e.getUniform(t[r]);i&&(this._boundUniforms[r]=i)}this._currentEffect=null},n.prototype._moveBoundTextureOnTop=function(e){this.disableTextureBindingOptimization||this._lastBoundInternalTextureTracker.previous===e||(this._linkTrackers(e.previous,e.next),this._linkTrackers(this._lastBoundInternalTextureTracker.previous,e),this._linkTrackers(e,this._lastBoundInternalTextureTracker))},n.prototype._getCorrectTextureChannel=function(e,t){if(!t)return-1;if(t._initialSlot=e,this.disableTextureBindingOptimization)e!==t._designatedSlot&&this._textureCollisions.addCount(1,!1);else if(e!==t._designatedSlot)return t._designatedSlot>-1?t._designatedSlot:this._nextFreeTextureSlots.length?this._nextFreeTextureSlots[0]:(this._textureCollisions.addCount(1,!1),this._removeDesignatedSlot(this._firstBoundInternalTextureTracker.next));return e},n.prototype._linkTrackers=function(e,t){e.next=t,t.previous=e},n.prototype._removeDesignatedSlot=function(e){var t=e._designatedSlot;return-1===t?-1:(e._designatedSlot=-1,this.disableTextureBindingOptimization?-1:(this._linkTrackers(e.previous,e.next),this._boundTexturesCache[t]=null,this._nextFreeTextureSlots.push(t),t))},n.prototype._activateCurrentTexture=function(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)},n.prototype._bindTextureDirectly=function(e,t,r,i){void 0===r&&(r=!1),void 0===i&&(i=!1),r&&t&&t._designatedSlot>-1&&(this._activeChannel=t._designatedSlot);var n=this._boundTexturesCache[this._activeChannel],s=t&&t._initialSlot>-1;if(n!==t||i){if(n&&this._removeDesignatedSlot(n),this._activateCurrentTexture(),this._gl.bindTexture(e,t?t._webGLTexture:null),this._boundTexturesCache[this._activeChannel]=t,t){if(!this.disableTextureBindingOptimization){var o=this._nextFreeTextureSlots.indexOf(this._activeChannel);o>-1&&this._nextFreeTextureSlots.splice(o,1),this._linkTrackers(this._lastBoundInternalTextureTracker.previous,t),this._linkTrackers(t,this._lastBoundInternalTextureTracker)}t._designatedSlot=this._activeChannel}}else r&&this._activateCurrentTexture();s&&!r&&this._bindSamplerUniformToChannel(t._initialSlot,this._activeChannel)},n.prototype._bindTexture=function(e,t){e<0||(t&&(e=this._getCorrectTextureChannel(e,t)),this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,t))},n.prototype.setTextureFromPostProcess=function(e,t){this._bindTexture(e,t?t._textures.data[t._currentRenderTextureInd]:null)},n.prototype.setTextureFromPostProcessOutput=function(e,t){this._bindTexture(e,t?t._outputTexture:null)},n.prototype.unbindAllTextures=function(){for(var e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&this._bindTextureDirectly(this._gl.TEXTURE_3D,null)},n.prototype.setTexture=function(e,t,r){e<0||(t&&(this._boundUniforms[e]=t),this._setTexture(e,r))},n.prototype.setDepthStencilTexture=function(e,t,r){e<0||(t&&(this._boundUniforms[e]=t),r&&r.depthStencilTexture?this._setTexture(e,r,!1,!0):this._setTexture(e,null))},n.prototype._bindSamplerUniformToChannel=function(e,t){var r=this._boundUniforms[e];r._currentState!==t&&(this._gl.uniform1i(r,t),r._currentState=t)},n.prototype._getTextureWrapMode=function(t){switch(t){case e.Texture.WRAP_ADDRESSMODE:return this._gl.REPEAT;case e.Texture.CLAMP_ADDRESSMODE:return this._gl.CLAMP_TO_EDGE;case e.Texture.MIRROR_ADDRESSMODE:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT},n.prototype._setTexture=function(t,r,i,s){if(void 0===i&&(i=!1),void 0===s&&(s=!1),!r)return null!=this._boundTexturesCache[t]&&(this._activeChannel=t,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&this._bindTextureDirectly(this._gl.TEXTURE_3D,null)),!1;if(r.video)this._activeChannel=t,r.update();else if(r.delayLoadState===n.DELAYLOADSTATE_NOTLOADED)return r.delayLoad(),!1;var o;o=s?r.depthStencilTexture:r.isReady()?r.getInternalTexture():r.isCube?this.emptyCubeTexture:r.is3D?this.emptyTexture3D:this.emptyTexture,i||(t=this._getCorrectTextureChannel(t,o));var a=!0;if(this._boundTexturesCache[t]===o&&(this._moveBoundTextureOnTop(o),i||this._bindSamplerUniformToChannel(o._initialSlot,t),a=!1),this._activeChannel=t,o&&o.is3D)a&&this._bindTextureDirectly(this._gl.TEXTURE_3D,o,i),o&&o._cachedWrapU!==r.wrapU&&(o._cachedWrapU=r.wrapU,this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(r.wrapU),o)),o&&o._cachedWrapV!==r.wrapV&&(o._cachedWrapV=r.wrapV,this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r.wrapV),o)),o&&o._cachedWrapR!==r.wrapR&&(o._cachedWrapR=r.wrapR,this._setTextureParameterInteger(this._gl.TEXTURE_3D,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r.wrapR),o)),this._setAnisotropicLevel(this._gl.TEXTURE_3D,r);else if(o&&o.isCube){if(a&&this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,o,i),o._cachedCoordinatesMode!==r.coordinatesMode){o._cachedCoordinatesMode=r.coordinatesMode;var h=r.coordinatesMode!==e.Texture.CUBIC_MODE&&r.coordinatesMode!==e.Texture.SKYBOX_MODE?this._gl.REPEAT:this._gl.CLAMP_TO_EDGE;this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_S,h,o),this._setTextureParameterInteger(this._gl.TEXTURE_CUBE_MAP,this._gl.TEXTURE_WRAP_T,h)}this._setAnisotropicLevel(this._gl.TEXTURE_CUBE_MAP,r)}else a&&this._bindTextureDirectly(this._gl.TEXTURE_2D,o,i),o&&o._cachedWrapU!==r.wrapU&&(o._cachedWrapU=r.wrapU,this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(r.wrapU),o)),o&&o._cachedWrapV!==r.wrapV&&(o._cachedWrapV=r.wrapV,this._setTextureParameterInteger(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r.wrapV),o)),this._setAnisotropicLevel(this._gl.TEXTURE_2D,r);return!0},n.prototype.setTextureArray=function(e,t,r){if(!(e<0)&&t){this._textureUnits&&this._textureUnits.length===r.length||(this._textureUnits=new Int32Array(r.length));for(var i=0;i<r.length;i++)this._textureUnits[i]=this._getCorrectTextureChannel(e+i,r[i].getInternalTexture());this._gl.uniform1iv(t,this._textureUnits);for(var n=0;n<r.length;n++)this._setTexture(this._textureUnits[n],r[n],!0)}},n.prototype._setAnisotropicLevel=function(t,r){var i=r.getInternalTexture();if(i){var n=this._caps.textureAnisotropicFilterExtension,s=r.anisotropicFilteringLevel;i.samplingMode!==e.Texture.LINEAR_LINEAR_MIPNEAREST&&i.samplingMode!==e.Texture.LINEAR_LINEAR_MIPLINEAR&&i.samplingMode!==e.Texture.LINEAR_LINEAR&&(s=1),n&&i._cachedAnisotropicFilteringLevel!==s&&(this._setTextureParameterFloat(t,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s,this._caps.maxAnisotropy),i),i._cachedAnisotropicFilteringLevel=s)}},n.prototype._setTextureParameterFloat=function(e,t,r,i){this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameterf(e,t,r)},n.prototype._setTextureParameterInteger=function(e,t,r,i){i&&this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameteri(e,t,r)},n.prototype.readPixels=function(e,t,r,i){var n=new Uint8Array(i*r*4);return this._gl.readPixels(e,t,r,i,this._gl.RGBA,this._gl.UNSIGNED_BYTE,n),n},n.prototype.addExternalData=function(t,r){return this._externalData||(this._externalData=new e.StringDictionary),this._externalData.add(t,r)},n.prototype.getExternalData=function(t){return this._externalData||(this._externalData=new e.StringDictionary),this._externalData.get(t)},n.prototype.getOrAddExternalDataWithFactory=function(t,r){return this._externalData||(this._externalData=new e.StringDictionary),this._externalData.getOrAddWithFactory(t,r)},n.prototype.removeExternalData=function(t){return this._externalData||(this._externalData=new e.StringDictionary),this._externalData.remove(t)},n.prototype.unbindAllAttributes=function(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(var e=0;e<this._caps.maxVertexAttribs;e++)this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}else for(var e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||(this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1)},n.prototype.releaseEffects=function(){for(var e in this._compiledEffects)this._deleteProgram(this._compiledEffects[e]._program);this._compiledEffects={}},n.prototype.dispose=function(){for(this.hideLoadingUI(),this.stopRenderLoop();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();n.audioEngine&&n.audioEngine.dispose(),this.releaseEffects(),this.unbindAllAttributes(),this._boundUniforms=[],this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.disableVR(),e.Tools.IsWindowObjectExist()&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null));var t=n.Instances.indexOf(this);t>=0&&n.Instances.splice(t,1),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers=[],this._renderingCanvas=null,this._currentProgram=null,this._bindedRenderFunction=null,this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear(),e.Effect.ResetCache();for(var r=0,i=this._activeRequests;r<i.length;r++){i[r].abort()}},n.prototype.displayLoadingUI=function(){if(e.Tools.IsWindowObjectExist()){var t=this.loadingScreen;t&&t.displayLoadingUI()}},n.prototype.hideLoadingUI=function(){if(e.Tools.IsWindowObjectExist()){var t=this.loadingScreen;t&&t.hideLoadingUI()}},Object.defineProperty(n.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&e.DefaultLoadingScreen&&this._renderingCanvas&&(this._loadingScreen=new e.DefaultLoadingScreen(this._renderingCanvas)),this._loadingScreen},set:function(e){this._loadingScreen=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"loadingUIText",{set:function(e){this.loadingScreen.loadingUIText=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"loadingUIBackgroundColor",{set:function(e){this.loadingScreen.loadingUIBackgroundColor=e},enumerable:!0,configurable:!0}),n.prototype.attachContextLostEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)},n.prototype.attachContextRestoredEvent=function(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)},n.prototype.getVertexShaderSource=function(e){var t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null},n.prototype.getFragmentShaderSource=function(e){var t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null},n.prototype.getError=function(){return this._gl.getError()},n.prototype.getFps=function(){return this._fps},n.prototype.getDeltaTime=function(){return this._deltaTime},n.prototype._measureFps=function(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0},n.prototype._readTexturePixels=function(e,t,r,i,n){void 0===i&&(i=-1),void 0===n&&(n=0);var s=this._gl;if(!this._dummyFramebuffer){var o=s.createFramebuffer();if(!o)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=o}s.bindFramebuffer(s.FRAMEBUFFER,this._dummyFramebuffer),i>-1?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._webGLTexture,n):s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e._webGLTexture,n);var a,h=void 0!==e.type?this._getWebGLTextureType(e.type):s.UNSIGNED_BYTE;switch(h){case s.UNSIGNED_BYTE:a=new Uint8Array(4*t*r),h=s.UNSIGNED_BYTE;break;default:a=new Float32Array(4*t*r),h=s.FLOAT}return s.readPixels(0,0,t,r,s.RGBA,h,a),s.bindFramebuffer(s.FRAMEBUFFER,this._currentFramebuffer),a},n.prototype._canRenderToFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(n.TEXTURETYPE_FLOAT)},n.prototype._canRenderToHalfFloatFramebuffer=function(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(n.TEXTURETYPE_HALF_FLOAT)},n.prototype._canRenderToFramebuffer=function(e){for(var t=this._gl;t.getError()!==t.NO_ERROR;);var r=!0,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);var n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0);var s=t.checkFramebufferStatus(t.FRAMEBUFFER);if(r=r&&s===t.FRAMEBUFFER_COMPLETE,r=r&&t.getError()===t.NO_ERROR,r&&(t.clear(t.COLOR_BUFFER_BIT),r=r&&t.getError()===t.NO_ERROR),r){t.bindFramebuffer(t.FRAMEBUFFER,null);var o=t.RGBA,a=t.UNSIGNED_BYTE,h=new Uint8Array(4);t.readPixels(0,0,1,1,o,a,h),r=r&&t.getError()===t.NO_ERROR}for(t.deleteTexture(i),t.deleteFramebuffer(n),t.bindFramebuffer(t.FRAMEBUFFER,null);!r&&t.getError()!==t.NO_ERROR;);return r},n.prototype._getWebGLTextureType=function(e){return e===n.TEXTURETYPE_FLOAT?this._gl.FLOAT:e===n.TEXTURETYPE_HALF_FLOAT?this._gl.HALF_FLOAT_OES:this._gl.UNSIGNED_BYTE},n.prototype._getInternalFormat=function(e){var t=this._gl.RGBA;switch(e){case n.TEXTUREFORMAT_ALPHA:t=this._gl.ALPHA;break;case n.TEXTUREFORMAT_LUMINANCE:t=this._gl.LUMINANCE;break;case n.TEXTUREFORMAT_LUMINANCE_ALPHA:t=this._gl.LUMINANCE_ALPHA;break;case n.TEXTUREFORMAT_RGB:t=this._gl.RGB;break;case n.TEXTUREFORMAT_RGBA:t=this._gl.RGBA;break;case n.TEXTUREFORMAT_R:t=this._gl.RED;break;case n.TEXTUREFORMAT_RG:t=this._gl.RG}return t},n.prototype._getRGBABufferInternalSizedFormat=function(e,t){if(1===this._webGLVersion){if(void 0!==t)switch(t){case n.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE;case n.TEXTUREFORMAT_ALPHA:return this._gl.ALPHA}return this._gl.RGBA}if(e===n.TEXTURETYPE_FLOAT){if(void 0!==t)switch(t){case n.TEXTUREFORMAT_R:return this._gl.R32F;case n.TEXTUREFORMAT_RG:return this._gl.RG32F;case n.TEXTUREFORMAT_RGB:return this._gl.RGB32F}return this._gl.RGBA32F}if(e===n.TEXTURETYPE_HALF_FLOAT){if(t)switch(t){case n.TEXTUREFORMAT_R:return this._gl.R16F;case n.TEXTUREFORMAT_RG:return this._gl.RG16F;case n.TEXTUREFORMAT_RGB:return this._gl.RGB16F}return this._gl.RGBA16F}if(void 0!==t)switch(t){case n.TEXTUREFORMAT_LUMINANCE:return this._gl.LUMINANCE;case n.TEXTUREFORMAT_RGB:return this._gl.RGB;case n.TEXTUREFORMAT_R:return this._gl.R8;case n.TEXTUREFORMAT_RG:return this._gl.RG8;case n.TEXTUREFORMAT_ALPHA:return this._gl.ALPHA}return this._gl.RGBA},n.prototype._getRGBAMultiSampleBufferFormat=function(e){return e===n.TEXTURETYPE_FLOAT?this._gl.RGBA32F:e===n.TEXTURETYPE_HALF_FLOAT?this._gl.RGBA16F:this._gl.RGBA8},n.prototype.createQuery=function(){return this._gl.createQuery()},n.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},n.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},n.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},n.prototype.beginOcclusionQuery=function(e,t){var r=this.getGlAlgorithmType(e);return this._gl.beginQuery(r,t),this},n.prototype.endOcclusionQuery=function(e){var t=this.getGlAlgorithmType(e);return this._gl.endQuery(t),this},n.prototype._createTimeQuery=function(){var e=this._caps.timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},n.prototype._deleteTimeQuery=function(e){var t=this._caps.timerQuery;if(t.deleteQueryEXT)return void t.deleteQueryEXT(e);this.deleteQuery(e)},n.prototype._getTimeQueryResult=function(e){var t=this._caps.timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},n.prototype._getTimeQueryAvailability=function(e){var t=this._caps.timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},n.prototype.startTimeQuery=function(){var t=this._caps.timerQuery;if(!t)return null;var r=new e._TimeToken;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),this._caps.canUseTimestampForTimerQuery)r._startTimeQuery=this._createTimeQuery(),t.queryCounterEXT(r._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;r._timeElapsedQuery=this._createTimeQuery(),t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,r._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,r._timeElapsedQuery),this._currentNonTimestampToken=r}return r},n.prototype.endTimeQuery=function(e){var t=this._caps.timerQuery;if(!t||!e)return-1;if(this._caps.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return-1;e._endTimeQuery||(e._endTimeQuery=this._createTimeQuery(),t.queryCounterEXT(e._endTimeQuery,t.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):this._gl.endQuery(t.TIME_ELAPSED_EXT),e._timeElapsedQueryEnded=!0}var r=this._gl.getParameter(t.GPU_DISJOINT_EXT),i=!1;if(e._endTimeQuery?i=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(i=this._getTimeQueryAvailability(e._timeElapsedQuery)),i&&!r){var n=0;if(this._caps.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return-1;var s=this._getTimeQueryResult(e._startTimeQuery);n=this._getTimeQueryResult(e._endTimeQuery)-s,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return-1;n=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1,this._currentNonTimestampToken=null}return n}return-1},n.prototype.getGlAlgorithmType=function(t){return t===e.AbstractMesh.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},n.prototype.createTransformFeedback=function(){return this._gl.createTransformFeedback()},n.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},n.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},n.prototype.beginTransformFeedback=function(e){void 0===e&&(e=!0),this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},n.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},n.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},n.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e)},n.prototype._loadFile=function(t,r,i,n,s,o){var a=this,h=e.Tools.LoadFile(t,r,i,n,s,o);return this._activeRequests.push(h),h.onCompleteObservable.add((function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)})),h},n.prototype._loadFileAsync=function(e,t,r){var i=this;return new Promise(function(n,s){i._loadFile(e,(function(e){n(e)}),void 0,t,r,(function(e,t){s(t)}))})},n.prototype._partialLoadFile=function(e,t,r,i,n,s){void 0===s&&(s=null);var o=function(e){r[t]=e,6===++r._internalCount&&n(r)},a=function(e,t){s&&e&&s(e.status+" "+e.statusText,t)};this._loadFile(e,o,void 0,void 0,!0,a)},n.prototype._cascadeLoadFiles=function(e,t,r,i){void 0===i&&(i=null);var n=[];n._internalCount=0;for(var s=0;s<6;s++)this._partialLoadFile(r[s],s,n,e,t,i)},n.isSupported=function(){try{var e=document.createElement("canvas");return null!=(e.getContext("webgl")||e.getContext("experimental-webgl"))&&!!window.WebGLRenderingContext}catch(e){return!1}},n.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Macintosh",capture:null,captureConstraint:null,targets:["textureBindingOptimization"]},{key:"iPhone",capture:null,captureConstraint:null,targets:["textureBindingOptimization"]},{key:"iPad",capture:null,captureConstraint:null,targets:["textureBindingOptimization"]}],n.Instances=new Array,n._ALPHA_DISABLE=0,n._ALPHA_ADD=1,n._ALPHA_COMBINE=2,n._ALPHA_SUBTRACT=3,n._ALPHA_MULTIPLY=4,n._ALPHA_MAXIMIZED=5,n._ALPHA_ONEONE=6,n._ALPHA_PREMULTIPLIED=7,n._ALPHA_PREMULTIPLIED_PORTERDUFF=8,n._ALPHA_INTERPOLATE=9,n._ALPHA_SCREENMODE=10,n._DELAYLOADSTATE_NONE=0,n._DELAYLOADSTATE_LOADED=1,n._DELAYLOADSTATE_LOADING=2,n._DELAYLOADSTATE_NOTLOADED=4,n._TEXTUREFORMAT_ALPHA=0,n._TEXTUREFORMAT_LUMINANCE=1,n._TEXTUREFORMAT_LUMINANCE_ALPHA=2,n._TEXTUREFORMAT_RGB=4,n._TEXTUREFORMAT_RGBA=5,n._TEXTUREFORMAT_R=6,n._TEXTUREFORMAT_RG=7,n._TEXTURETYPE_UNSIGNED_INT=0,n._TEXTURETYPE_FLOAT=1,n._TEXTURETYPE_HALF_FLOAT=2,n._NEVER=512,n._ALWAYS=519,n._LESS=513,n._EQUAL=514,n._LEQUAL=515,n._GREATER=516,n._GEQUAL=518,n._NOTEQUAL=517,n._KEEP=7680,n._REPLACE=7681,n._INCR=7682,n._DECR=7683,n._INVERT=5386,n._INCR_WRAP=34055,n._DECR_WRAP=34056,n._SCALEMODE_FLOOR=1,n._SCALEMODE_NEAREST=2,n._SCALEMODE_CEILING=3,n.CollisionsEpsilon=.001,n.CodeRepository="src/",n.ShadersRepository="src/Shaders/",n})();e.Engine=f})(i||(i={}));var i;!(function(e){var t=(function(){function t(t,r){void 0===r&&(r=null),this.state="",this.metadata=null,this.doNotSerialize=!1,this._isDisposed=!1,this.animations=new Array,this._ranges={},this._isEnabled=!0,this._isReady=!0,this._currentRenderId=-1,this._parentRenderId=-1,this._childRenderId=-1,this._animationPropertiesOverride=null,this.onDisposeObservable=new e.Observable,this._behaviors=new Array,this.name=t,this.id=t,this._scene=r||e.Engine.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}return t.prototype.isDisposed=function(){return this._isDisposed},Object.defineProperty(t.prototype,"parent",{get:function(){return this._parentNode},set:function(e){if(this._parentNode!==e){if(this._parentNode&&void 0!==this._parentNode._children&&null!==this._parentNode._children){var t=this._parentNode._children.indexOf(this);-1!==t&&this._parentNode._children.splice(t,1)}this._parentNode=e,this._parentNode&&(void 0!==this._parentNode._children&&null!==this._parentNode._children||(this._parentNode._children=new Array),this._parentNode._children.push(this))}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!0,configurable:!0}),t.prototype.getClassName=function(){return"Node"},Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getEngine=function(){return this._scene.getEngine()},t.prototype.addBehavior=function(e){var t=this;return-1!==this._behaviors.indexOf(e)?this:(e.init(),this._scene.isLoading?this._scene.onDataLoadedObservable.addOnce((function(){e.attach(t)})):e.attach(this),this._behaviors.push(e),this)},t.prototype.removeBehavior=function(e){var t=this._behaviors.indexOf(e);return-1===t?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)},Object.defineProperty(t.prototype,"behaviors",{get:function(){return this._behaviors},enumerable:!0,configurable:!0}),t.prototype.getBehaviorByName=function(e){for(var t=0,r=this._behaviors;t<r.length;t++){var i=r[t];if(i.name===e)return i}return null},t.prototype.getWorldMatrix=function(){return e.Matrix.Identity()},t.prototype._getWorldMatrixDeterminant=function(){return 1},t.prototype._initCache=function(){this._cache={},this._cache.parent=void 0},t.prototype.updateCache=function(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())},t.prototype._updateCache=function(e){},t.prototype._isSynchronized=function(){return!0},t.prototype._markSyncedWithParent=function(){this.parent&&(this._parentRenderId=this.parent._childRenderId)},t.prototype.isSynchronizedWithParent=function(){return!this.parent||this._parentRenderId===this.parent._childRenderId&&this.parent.isSynchronized()},t.prototype.isSynchronized=function(e){var t=this.hasNewParent();return t=t||!this.isSynchronizedWithParent(),t=t||!this._isSynchronized(),e&&this.updateCache(!0),!t},t.prototype.hasNewParent=function(e){return this._cache.parent!==this.parent&&(e&&(this._cache.parent=this.parent),!0)},t.prototype.isReady=function(e){return void 0===e&&(e=!1),this._isReady},t.prototype.isEnabled=function(e){return void 0===e&&(e=!0),!1===e?this._isEnabled:!1!==this._isEnabled&&(void 0===this.parent||null===this.parent||this.parent.isEnabled(e))},t.prototype.setEnabled=function(e){this._isEnabled=e},t.prototype.isDescendantOf=function(e){return!!this.parent&&(this.parent===e||this.parent.isDescendantOf(e))},t.prototype._getDescendants=function(e,t,r){if(void 0===t&&(t=!1),this._children)for(var i=0;i<this._children.length;i++){var n=this._children[i];r&&!r(n)||e.push(n),t||n._getDescendants(e,!1,r)}},t.prototype.getDescendants=function(e,t){var r=new Array;return this._getDescendants(r,e,t),r},t.prototype.getChildMeshes=function(t,r){var i=[];return this._getDescendants(i,t,(function(t){return(!r||r(t))&&t instanceof e.AbstractMesh})),i},t.prototype.getChildTransformNodes=function(t,r){var i=[];return this._getDescendants(i,t,(function(t){return(!r||r(t))&&t instanceof e.TransformNode})),i},t.prototype.getChildren=function(e){return this.getDescendants(!0,e)},t.prototype._setReady=function(e){if(e!==this._isReady){if(!e)return void(this._isReady=!1);this.onReady&&this.onReady(this),this._isReady=!0}},t.prototype.getAnimationByName=function(e){for(var t=0;t<this.animations.length;t++){var r=this.animations[t];if(r.name===e)return r}return null},t.prototype.createAnimationRange=function(t,r,i){if(!this._ranges[t]){this._ranges[t]=new e.AnimationRange(t,r,i);for(var n=0,s=this.animations.length;n<s;n++)this.animations[n]&&this.animations[n].createRange(t,r,i)}},t.prototype.deleteAnimationRange=function(e,t){void 0===t&&(t=!0);for(var r=0,i=this.animations.length;r<i;r++)this.animations[r]&&this.animations[r].deleteRange(e,t);this._ranges[e]=null},t.prototype.getAnimationRange=function(e){return this._ranges[e]},t.prototype.beginAnimation=function(e,t,r,i){var n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,r,i):null},t.prototype.serializeAnimationRanges=function(){var e=[];for(var t in this._ranges){var r=this._ranges[t];if(r){var i={};i.name=t,i.from=r.from,i.to=r.to,e.push(i)}}return e},t.prototype.computeWorldMatrix=function(t){return e.Matrix.Identity()},t.prototype.dispose=function(e,t){if(void 0===t&&(t=!1),e)for(var r=this.getChildTransformNodes(!0),i=0,n=r;i<n.length;i++){var s=n[i];s.parent=null,s.computeWorldMatrix(!0)}else for(var o=this.getDescendants(!0),a=0,h=o;a<h.length;a++){var u=h[a];u.dispose(e,t)}
this.parent=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear();for(var l=0,c=this._behaviors;l<c.length;l++){c[l].detach()}this._behaviors=[],this._isDisposed=!0},t.ParseAnimationRanges=function(e,t,r){if(t.ranges)for(var i=0;i<t.ranges.length;i++){var n=t.ranges[i];e.createAnimationRange(n.name,n.from,n.to)}},n([e.serialize()],t.prototype,"name",void 0),n([e.serialize()],t.prototype,"id",void 0),n([e.serialize()],t.prototype,"uniqueId",void 0),n([e.serialize()],t.prototype,"state",void 0),n([e.serialize()],t.prototype,"metadata",void 0),t})();e.Node=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(t,r){this._tempRadiusVector=e.Vector3.Zero(),this.reConstruct(t,r)}return t.prototype.reConstruct=function(t,r){this.minimum=t.clone(),this.maximum=r.clone();var i=e.Vector3.Distance(t,r);this.center=e.Vector3.Lerp(t,r,.5),this.radius=.5*i,this.centerWorld=e.Vector3.Zero(),this._update(e.Matrix.Identity())},t.prototype._update=function(t){e.Vector3.TransformCoordinatesToRef(this.center,t,this.centerWorld),e.Vector3.TransformNormalFromFloatsToRef(1,1,1,t,this._tempRadiusVector),this.radiusWorld=Math.max(Math.abs(this._tempRadiusVector.x),Math.abs(this._tempRadiusVector.y),Math.abs(this._tempRadiusVector.z))*this.radius},t.prototype.isInFrustum=function(e){for(var t=0;t<6;t++)if(e[t].dotCoordinate(this.centerWorld)<=-this.radiusWorld)return!1;return!0},t.prototype.intersectsPoint=function(t){var r=this.centerWorld.x-t.x,i=this.centerWorld.y-t.y,n=this.centerWorld.z-t.z,s=Math.sqrt(r*r+i*i+n*n);return!(Math.abs(this.radiusWorld-s)<e.Epsilon)},t.Intersects=function(e,t){var r=e.centerWorld.x-t.centerWorld.x,i=e.centerWorld.y-t.centerWorld.y,n=e.centerWorld.z-t.centerWorld.z,s=Math.sqrt(r*r+i*i+n*n);return!(e.radiusWorld+t.radiusWorld<s)},t})();e.BoundingSphere=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(e,t){this.vectorsWorld=new Array,this.reConstruct(e,t)}return t.prototype.reConstruct=function(t,r){this.minimum=t.clone(),this.maximum=r.clone(),this.vectors=new Array,this.vectors.push(this.minimum.clone()),this.vectors.push(this.maximum.clone()),this.vectors.push(this.minimum.clone()),this.vectors[2].x=this.maximum.x,this.vectors.push(this.minimum.clone()),this.vectors[3].y=this.maximum.y,this.vectors.push(this.minimum.clone()),this.vectors[4].z=this.maximum.z,this.vectors.push(this.maximum.clone()),this.vectors[5].z=this.minimum.z,this.vectors.push(this.maximum.clone()),this.vectors[6].x=this.minimum.x,this.vectors.push(this.maximum.clone()),this.vectors[7].y=this.minimum.y,this.center=this.maximum.add(this.minimum).scale(.5),this.extendSize=this.maximum.subtract(this.minimum).scale(.5),this.directions=[e.Vector3.Zero(),e.Vector3.Zero(),e.Vector3.Zero()];for(var i=0;i<this.vectors.length;i++)this.vectorsWorld[i]=e.Vector3.Zero();this.minimumWorld=e.Vector3.Zero(),this.maximumWorld=e.Vector3.Zero(),this.centerWorld=e.Vector3.Zero(),this.extendSizeWorld=e.Vector3.Zero(),this._update(this._worldMatrix||e.Matrix.Identity())},t.prototype.getWorldMatrix=function(){return this._worldMatrix},t.prototype.setWorldMatrix=function(e){return this._worldMatrix.copyFrom(e),this},t.prototype._update=function(t){e.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.minimumWorld),e.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.maximumWorld);for(var r=0;r<this.vectors.length;r++){var i=this.vectorsWorld[r];e.Vector3.TransformCoordinatesToRef(this.vectors[r],t,i),i.x<this.minimumWorld.x&&(this.minimumWorld.x=i.x),i.y<this.minimumWorld.y&&(this.minimumWorld.y=i.y),i.z<this.minimumWorld.z&&(this.minimumWorld.z=i.z),i.x>this.maximumWorld.x&&(this.maximumWorld.x=i.x),i.y>this.maximumWorld.y&&(this.maximumWorld.y=i.y),i.z>this.maximumWorld.z&&(this.maximumWorld.z=i.z)}this.maximumWorld.subtractToRef(this.minimumWorld,this.extendSizeWorld),this.extendSizeWorld.scaleInPlace(.5),this.maximumWorld.addToRef(this.minimumWorld,this.centerWorld),this.centerWorld.scaleInPlace(.5),e.Vector3.FromFloatArrayToRef(t.m,0,this.directions[0]),e.Vector3.FromFloatArrayToRef(t.m,4,this.directions[1]),e.Vector3.FromFloatArrayToRef(t.m,8,this.directions[2]),this._worldMatrix=t},t.prototype.isInFrustum=function(e){return t.IsInFrustum(this.vectorsWorld,e)},t.prototype.isCompletelyInFrustum=function(e){return t.IsCompletelyInFrustum(this.vectorsWorld,e)},t.prototype.intersectsPoint=function(t){var r=-e.Epsilon;return!(this.maximumWorld.x-t.x<r||r>t.x-this.minimumWorld.x)&&(!(this.maximumWorld.y-t.y<r||r>t.y-this.minimumWorld.y)&&!(this.maximumWorld.z-t.z<r||r>t.z-this.minimumWorld.z))},t.prototype.intersectsSphere=function(e){return t.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)},t.prototype.intersectsMinMax=function(e,t){return!(this.maximumWorld.x<e.x||this.minimumWorld.x>t.x)&&(!(this.maximumWorld.y<e.y||this.minimumWorld.y>t.y)&&!(this.maximumWorld.z<e.z||this.minimumWorld.z>t.z))},t.Intersects=function(e,t){return!(e.maximumWorld.x<t.minimumWorld.x||e.minimumWorld.x>t.maximumWorld.x)&&(!(e.maximumWorld.y<t.minimumWorld.y||e.minimumWorld.y>t.maximumWorld.y)&&!(e.maximumWorld.z<t.minimumWorld.z||e.minimumWorld.z>t.maximumWorld.z))},t.IntersectsSphere=function(t,r,i,n){var s=e.Vector3.Clamp(i,t,r);return e.Vector3.DistanceSquared(i,s)<=n*n},t.IsCompletelyInFrustum=function(e,t){for(var r=0;r<6;r++)for(var i=0;i<8;i++)if(t[r].dotCoordinate(e[i])<0)return!1;return!0},t.IsInFrustum=function(e,t){for(var r=0;r<6;r++){for(var i=8,n=0;n<8&&t[r].dotCoordinate(e[n])<0;n++)--i;if(0===i)return!1}return!0},t})();e.BoundingBox=t})(i||(i={}));var i;!(function(e){var t=function(t,r){var i=e.Vector3.Dot(r.centerWorld,t),n=Math.abs(e.Vector3.Dot(r.directions[0],t))*r.extendSize.x,s=Math.abs(e.Vector3.Dot(r.directions[1],t))*r.extendSize.y,o=Math.abs(e.Vector3.Dot(r.directions[2],t))*r.extendSize.z,a=n+s+o;return{min:i-a,max:i+a}},r=function(e,t,r,i){return!(e>i||r>t)},i=function(e,i,n){var s=t(e,i),o=t(e,n);return r(s.min,s.max,o.min,o.max)},n=(function(){function t(t,r){this.minimum=t,this.maximum=r,this._isLocked=!1,this.boundingBox=new e.BoundingBox(t,r),this.boundingSphere=new e.BoundingSphere(t,r)}return Object.defineProperty(t.prototype,"isLocked",{get:function(){return this._isLocked},set:function(e){this._isLocked=e},enumerable:!0,configurable:!0}),t.prototype.update=function(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))},t.prototype.centerOn=function(t,r){return this.minimum=t.subtract(r),this.maximum=t.add(r),this.boundingBox=new e.BoundingBox(this.minimum,this.maximum),this.boundingSphere=new e.BoundingSphere(this.minimum,this.maximum),this},t.prototype.isInFrustum=function(e){return!!this.boundingSphere.isInFrustum(e)&&this.boundingBox.isInFrustum(e)},Object.defineProperty(t.prototype,"diagonalLength",{get:function(){var e=this.boundingBox;return e.maximumWorld.subtract(e.minimumWorld).length()},enumerable:!0,configurable:!0}),t.prototype.isCompletelyInFrustum=function(e){return this.boundingBox.isCompletelyInFrustum(e)},t.prototype._checkCollision=function(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)},t.prototype.intersectsPoint=function(e){return!!this.boundingSphere.centerWorld&&(!!this.boundingSphere.intersectsPoint(e)&&!!this.boundingBox.intersectsPoint(e))},t.prototype.intersects=function(t,r){if(!this.boundingSphere.centerWorld||!t.boundingSphere.centerWorld)return!1;if(!e.BoundingSphere.Intersects(this.boundingSphere,t.boundingSphere))return!1;if(!e.BoundingBox.Intersects(this.boundingBox,t.boundingBox))return!1;if(!r)return!0;var n=this.boundingBox,s=t.boundingBox;return!!i(n.directions[0],n,s)&&(!!i(n.directions[1],n,s)&&(!!i(n.directions[2],n,s)&&(!!i(s.directions[0],n,s)&&(!!i(s.directions[1],n,s)&&(!!i(s.directions[2],n,s)&&(!!i(e.Vector3.Cross(n.directions[0],s.directions[0]),n,s)&&(!!i(e.Vector3.Cross(n.directions[0],s.directions[1]),n,s)&&(!!i(e.Vector3.Cross(n.directions[0],s.directions[2]),n,s)&&(!!i(e.Vector3.Cross(n.directions[1],s.directions[0]),n,s)&&(!!i(e.Vector3.Cross(n.directions[1],s.directions[1]),n,s)&&(!!i(e.Vector3.Cross(n.directions[1],s.directions[2]),n,s)&&(!!i(e.Vector3.Cross(n.directions[2],s.directions[0]),n,s)&&(!!i(e.Vector3.Cross(n.directions[2],s.directions[1]),n,s)&&!!i(e.Vector3.Cross(n.directions[2],s.directions[2]),n,s))))))))))))))},t})();e.BoundingInfo=n})(i||(i={}));var i;!(function(e){var t=(function(t){function r(i,n,s){void 0===n&&(n=null),void 0===s&&(s=!0);var o=t.call(this,i,n)||this;return o._forward=new e.Vector3(0,0,1),o._forwardInverted=new e.Vector3(0,0,-1),o._up=new e.Vector3(0,1,0),o._right=new e.Vector3(1,0,0),o._rightInverted=new e.Vector3(-1,0,0),o._rotation=e.Vector3.Zero(),o._scaling=e.Vector3.One(),o._isDirty=!1,o.billboardMode=r.BILLBOARDMODE_NONE,o.scalingDeterminant=1,o.infiniteDistance=!1,o.ignoreNonUniformScaling=!1,o.position=e.Vector3.Zero(),o._localWorld=e.Matrix.Zero(),o._worldMatrix=e.Matrix.Zero(),o._worldMatrixDeterminant=0,o._absolutePosition=e.Vector3.Zero(),o._pivotMatrix=e.Matrix.Identity(),o._postMultiplyPivotMatrix=!1,o._isWorldMatrixFrozen=!1,o.onAfterWorldMatrixUpdateObservable=new e.Observable,o._nonUniformScaling=!1,s&&o.getScene().addTransformNode(o),o}return s(r,t),r.prototype.getClassName=function(){return"TransformNode"},Object.defineProperty(r.prototype,"rotation",{get:function(){return this._rotation},set:function(e){this._rotation=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"scaling",{get:function(){return this._scaling},set:function(e){this._scaling=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rotationQuaternion",{get:function(){return this._rotationQuaternion},set:function(e){this._rotationQuaternion=e,e&&this.rotation.length()&&this.rotation.copyFromFloats(0,0,0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"forward",{get:function(){return e.Vector3.Normalize(e.Vector3.TransformNormal(this.getScene().useRightHandedSystem?this._forwardInverted:this._forward,this.getWorldMatrix()))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"up",{get:function(){return e.Vector3.Normalize(e.Vector3.TransformNormal(this._up,this.getWorldMatrix()))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"right",{get:function(){return e.Vector3.Normalize(e.Vector3.TransformNormal(this.getScene().useRightHandedSystem?this._rightInverted:this._right,this.getWorldMatrix()))},enumerable:!0,configurable:!0}),r.prototype.getWorldMatrix=function(){return this._currentRenderId!==this.getScene().getRenderId()&&this.computeWorldMatrix(),this._worldMatrix},r.prototype._getWorldMatrixDeterminant=function(){return this._worldMatrixDeterminant},Object.defineProperty(r.prototype,"worldMatrixFromCache",{get:function(){return this._worldMatrix},enumerable:!0,configurable:!0}),r.prototype.updatePoseMatrix=function(e){return this._poseMatrix.copyFrom(e),this},r.prototype.getPoseMatrix=function(){return this._poseMatrix},r.prototype._isSynchronized=function(){return!this._isDirty&&(this.billboardMode===this._cache.billboardMode&&this.billboardMode===r.BILLBOARDMODE_NONE&&(!this._cache.pivotMatrixUpdated&&(!this.infiniteDistance&&(!!this._cache.position.equals(this.position)&&(!(this.rotationQuaternion&&!this._cache.rotationQuaternion.equals(this.rotationQuaternion))&&(!!this._cache.rotation.equals(this.rotation)&&!!this._cache.scaling.equals(this.scaling)))))))},r.prototype._initCache=function(){t.prototype._initCache.call(this),this._cache.localMatrixUpdated=!1,this._cache.position=e.Vector3.Zero(),this._cache.scaling=e.Vector3.Zero(),this._cache.rotation=e.Vector3.Zero(),this._cache.rotationQuaternion=new e.Quaternion(0,0,0,0),this._cache.billboardMode=-1},r.prototype.markAsDirty=function(e){return"rotation"===e&&(this.rotationQuaternion=null),this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this},Object.defineProperty(r.prototype,"absolutePosition",{get:function(){return this._absolutePosition},enumerable:!0,configurable:!0}),r.prototype.setPreTransformMatrix=function(e){return this.setPivotMatrix(e,!1)},r.prototype.setPivotMatrix=function(t,r){return void 0===r&&(r=!0),this._pivotMatrix=t.clone(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=r,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=e.Matrix.Invert(this._pivotMatrix)),this},r.prototype.getPivotMatrix=function(){return this._pivotMatrix},r.prototype.freezeWorldMatrix=function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this._isWorldMatrixFrozen=!0,this},r.prototype.unfreezeWorldMatrix=function(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this},Object.defineProperty(r.prototype,"isWorldMatrixFrozen",{get:function(){return this._isWorldMatrixFrozen},enumerable:!0,configurable:!0}),r.prototype.getAbsolutePosition=function(){return this.computeWorldMatrix(),this._absolutePosition},r.prototype.setAbsolutePosition=function(t){if(!t)return this;var r,i,n;if(void 0===t.x){if(arguments.length<3)return this;r=arguments[0],i=arguments[1],n=arguments[2]}else r=t.x,i=t.y,n=t.z;if(this.parent){var s=this.parent.getWorldMatrix().clone();s.invert();var o=new e.Vector3(r,i,n);this.position=e.Vector3.TransformCoordinates(o,s)}else this.position.x=r,this.position.y=i,this.position.z=n;return this},r.prototype.setPositionWithLocalVector=function(t){return this.computeWorldMatrix(),this.position=e.Vector3.TransformNormal(t,this._localWorld),this},r.prototype.getPositionExpressedInLocalSpace=function(){this.computeWorldMatrix();var t=this._localWorld.clone();return t.invert(),e.Vector3.TransformNormal(this.position,t)},r.prototype.locallyTranslate=function(t){return this.computeWorldMatrix(!0),this.position=e.Vector3.TransformCoordinates(t,this._localWorld),this},r.prototype.lookAt=function(t,i,n,s,o){void 0===i&&(i=0),void 0===n&&(n=0),void 0===s&&(s=0),void 0===o&&(o=e.Space.LOCAL);var a=r._lookAtVectorCache,h=o===e.Space.LOCAL?this.position:this.getAbsolutePosition();t.subtractToRef(h,a);var u=-Math.atan2(a.z,a.x)-Math.PI/2,l=Math.sqrt(a.x*a.x+a.z*a.z),c=Math.atan2(a.y,l);return this.rotationQuaternion?e.Quaternion.RotationYawPitchRollToRef(u+i,c+n,s,this.rotationQuaternion):(this.rotation.x=c+n,this.rotation.y=u+i,this.rotation.z=s),this},r.prototype.getDirection=function(t){var r=e.Vector3.Zero();return this.getDirectionToRef(t,r),r},r.prototype.getDirectionToRef=function(t,r){return e.Vector3.TransformNormalToRef(t,this.getWorldMatrix(),r),this},r.prototype.setPivotPoint=function(t,r){void 0===r&&(r=e.Space.LOCAL),0==this.getScene().getRenderId()&&this.computeWorldMatrix(!0);var i=this.getWorldMatrix();if(r==e.Space.WORLD){var n=e.Tmp.Matrix[0];i.invertToRef(n),t=e.Vector3.TransformCoordinates(t,n)}return this.setPivotMatrix(e.Matrix.Translation(-t.x,-t.y,-t.z),!0)},r.prototype.getPivotPoint=function(){var t=e.Vector3.Zero();return this.getPivotPointToRef(t),t},r.prototype.getPivotPointToRef=function(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this},r.prototype.getAbsolutePivotPoint=function(){var t=e.Vector3.Zero();return this.getAbsolutePivotPointToRef(t),t},r.prototype.getAbsolutePivotPointToRef=function(t){return t.x=this._pivotMatrix.m[12],t.y=this._pivotMatrix.m[13],t.z=this._pivotMatrix.m[14],this.getPivotPointToRef(t),e.Vector3.TransformCoordinatesToRef(t,this.getWorldMatrix(),t),this},r.prototype.setParent=function(t){if(null===t){var r=e.Tmp.Quaternion[0],i=e.Tmp.Vector3[0],n=e.Tmp.Vector3[1];this.parent&&this.parent.computeWorldMatrix&&this.parent.computeWorldMatrix(!0),this.computeWorldMatrix(!0),this.getWorldMatrix().decompose(n,r,i),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.x=n.x,this.scaling.y=n.y,this.scaling.z=n.z,this.position.x=i.x,this.position.y=i.y,this.position.z=i.z}else{var r=e.Tmp.Quaternion[0],i=e.Tmp.Vector3[0],n=e.Tmp.Vector3[1],s=e.Tmp.Matrix[0],o=e.Tmp.Matrix[1];this.computeWorldMatrix(!0),t.computeWorldMatrix(!0),t.getWorldMatrix().invertToRef(o),this.getWorldMatrix().multiplyToRef(o,s),s.decompose(n,r,i),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.position.x=i.x,this.position.y=i.y,this.position.z=i.z,this.scaling.x=n.x,this.scaling.y=n.y,this.scaling.z=n.z}return this.parent=t,this},Object.defineProperty(r.prototype,"nonUniformScaling",{get:function(){return this._nonUniformScaling},enumerable:!0,configurable:!0}),r.prototype._updateNonUniformScalingState=function(e){return this._nonUniformScaling!==e&&(this._nonUniformScaling=e,!0)},r.prototype.attachToBone=function(e,t){return this._transformToBoneReferal=t,this.parent=e,e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this},r.prototype.detachFromBone=function(){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,this.parent=null,this):this},r.prototype.rotate=function(t,i,n){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation=e.Vector3.Zero());var s;if(n&&n!==e.Space.LOCAL){if(this.parent){var o=this.parent.getWorldMatrix().clone();o.invert(),t=e.Vector3.TransformNormal(t,o)}s=e.Quaternion.RotationAxisToRef(t,i,r._rotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}else s=e.Quaternion.RotationAxisToRef(t,i,r._rotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);return this},r.prototype.rotateAround=function(t,r,i){return r.normalize(),this.rotationQuaternion||(this.rotationQuaternion=e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.copyFromFloats(0,0,0)),t.subtractToRef(this.position,e.Tmp.Vector3[0]),e.Matrix.TranslationToRef(e.Tmp.Vector3[0].x,e.Tmp.Vector3[0].y,e.Tmp.Vector3[0].z,e.Tmp.Matrix[0]),e.Tmp.Matrix[0].invertToRef(e.Tmp.Matrix[2]),e.Matrix.RotationAxisToRef(r,i,e.Tmp.Matrix[1]),e.Tmp.Matrix[2].multiplyToRef(e.Tmp.Matrix[1],e.Tmp.Matrix[2]),e.Tmp.Matrix[2].multiplyToRef(e.Tmp.Matrix[0],e.Tmp.Matrix[2]),e.Tmp.Matrix[2].decompose(e.Tmp.Vector3[0],e.Tmp.Quaternion[0],e.Tmp.Vector3[1]),this.position.addInPlace(e.Tmp.Vector3[1]),e.Tmp.Quaternion[0].multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this},r.prototype.translate=function(t,r,i){var n=t.scale(r);if(i&&i!==e.Space.LOCAL)this.setAbsolutePosition(this.getAbsolutePosition().add(n));else{var s=this.getPositionExpressedInLocalSpace().add(n);this.setPositionWithLocalVector(s)}return this},r.prototype.addRotation=function(t,r,i){var n;this.rotationQuaternion?n=this.rotationQuaternion:(n=e.Tmp.Quaternion[1],e.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,n));var s=e.Tmp.Quaternion[0];return e.Quaternion.RotationYawPitchRollToRef(r,t,i,s),n.multiplyInPlace(s),this.rotationQuaternion||n.toEulerAnglesToRef(this.rotation),this},r.prototype.computeWorldMatrix=function(t){if(this._isWorldMatrixFrozen)return this._worldMatrix;if(!t&&this.isSynchronized(!0))return this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix;if(this._cache.position.copyFrom(this.position),this._cache.scaling.copyFrom(this.scaling),this._cache.pivotMatrixUpdated=!1,this._cache.billboardMode=this.billboardMode,this._currentRenderId=this.getScene().getRenderId(),this._childRenderId=this.getScene().getRenderId(),this._isDirty=!1,e.Matrix.ScalingToRef(this.scaling.x*this.scalingDeterminant,this.scaling.y*this.scalingDeterminant,this.scaling.z*this.scalingDeterminant,e.Tmp.Matrix[1]),this.rotationQuaternion){this.rotation.length()&&(this.rotationQuaternion.multiplyInPlace(e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)),this.rotation.copyFromFloats(0,0,0))}this.rotationQuaternion?(this.rotationQuaternion.toRotationMatrix(e.Tmp.Matrix[0]),this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,e.Tmp.Matrix[0]),this._cache.rotation.copyFrom(this.rotation));var i=this.getScene().activeCamera;if(this.infiniteDistance&&!this.parent&&i){var n=i.getWorldMatrix(),s=new e.Vector3(n.m[12],n.m[13],n.m[14]);e.Matrix.TranslationToRef(this.position.x+s.x,this.position.y+s.y,this.position.z+s.z,e.Tmp.Matrix[2])}else e.Matrix.TranslationToRef(this.position.x,this.position.y,this.position.z,e.Tmp.Matrix[2]);if(this._pivotMatrix.multiplyToRef(e.Tmp.Matrix[1],e.Tmp.Matrix[4]),e.Tmp.Matrix[4].multiplyToRef(e.Tmp.Matrix[0],e.Tmp.Matrix[5]),this.billboardMode!==r.BILLBOARDMODE_NONE&&i){if((this.billboardMode&r.BILLBOARDMODE_ALL)!==r.BILLBOARDMODE_ALL){var o=e.Tmp.Vector3[3];this.parent&&this.parent.getWorldMatrix?this._transformToBoneReferal?(this.parent.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),e.Tmp.Matrix[6]),e.Vector3.TransformCoordinatesToRef(this.position,e.Tmp.Matrix[6],o)):e.Vector3.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),o):o.copyFrom(this.position),o.subtractInPlace(i.globalPosition);var a=e.Tmp.Vector3[4].copyFromFloats(0,0,0);(this.billboardMode&r.BILLBOARDMODE_X)===r.BILLBOARDMODE_X&&(a.x=Math.atan2(-o.y,o.z)),(this.billboardMode&r.BILLBOARDMODE_Y)===r.BILLBOARDMODE_Y&&(a.y=Math.atan2(o.x,o.z)),(this.billboardMode&r.BILLBOARDMODE_Z)===r.BILLBOARDMODE_Z&&(a.z=Math.atan2(o.y,o.x)),e.Matrix.RotationYawPitchRollToRef(a.y,a.x,a.z,e.Tmp.Matrix[0])}else e.Tmp.Matrix[1].copyFrom(i.getViewMatrix()),e.Tmp.Matrix[1].setTranslationFromFloats(0,0,0),e.Tmp.Matrix[1].invertToRef(e.Tmp.Matrix[0]);e.Tmp.Matrix[1].copyFrom(e.Tmp.Matrix[5]),e.Tmp.Matrix[1].multiplyToRef(e.Tmp.Matrix[0],e.Tmp.Matrix[5])}return e.Tmp.Matrix[5].multiplyToRef(e.Tmp.Matrix[2],this._localWorld),this.parent&&this.parent.getWorldMatrix?(this.billboardMode!==r.BILLBOARDMODE_NONE?(this._transformToBoneReferal?(this.parent.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),e.Tmp.Matrix[6]),e.Tmp.Matrix[5].copyFrom(e.Tmp.Matrix[6])):e.Tmp.Matrix[5].copyFrom(this.parent.getWorldMatrix()),this._localWorld.getTranslationToRef(e.Tmp.Vector3[5]),e.Vector3.TransformCoordinatesToRef(e.Tmp.Vector3[5],e.Tmp.Matrix[5],e.Tmp.Vector3[5]),this._worldMatrix.copyFrom(this._localWorld),this._worldMatrix.setTranslation(e.Tmp.Vector3[5])):this._transformToBoneReferal?(this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),e.Tmp.Matrix[6]),e.Tmp.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localWorld.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()):this._worldMatrix.copyFrom(this._localWorld),this._postMultiplyPivotMatrix&&this._worldMatrix.multiplyToRef(this._pivotMatrixInverse,this._worldMatrix),this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this.scaling.isNonUniform?this._updateNonUniformScalingState(!0):this.parent&&this.parent._nonUniformScaling?this._updateNonUniformScalingState(this.parent._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=e.Matrix.Invert(this._worldMatrix)),this._worldMatrixDeterminant=this._worldMatrix.determinant(),this._worldMatrix},r.prototype._afterComputeWorldMatrix=function(){},r.prototype.registerAfterWorldMatrixUpdate=function(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this},r.prototype.unregisterAfterWorldMatrixUpdate=function(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this},r.prototype.clone=function(t,i,n){var s=this,o=e.SerializationHelper.Clone((function(){return new r(t,s.getScene())}),this);if(o.name=t,o.id=t,i&&(o.parent=i),!n)for(var a=this.getDescendants(!0),h=0;h<a.length;h++){var u=a[h];u.clone&&u.clone(t+"."+u.name,o)}return o},r.prototype.serialize=function(t){var r=e.SerializationHelper.Serialize(this,t);return r.type=this.getClassName(),this.parent&&(r.parentId=this.parent.id),e.Tags&&e.Tags.HasTags(this)&&(r.tags=e.Tags.GetTags(this)),r.localMatrix=this.getPivotMatrix().asArray(),r.isEnabled=this.isEnabled(),this.parent&&(r.parentId=this.parent.id),r},r.Parse=function(t,i,n){var s=e.SerializationHelper.Parse((function(){return new r(t.name,i)}),t,i,n);return e.Tags&&e.Tags.AddTagsTo(s,t.tags),t.localMatrix?s.setPreTransformMatrix(e.Matrix.FromArray(t.localMatrix)):t.pivotMatrix&&s.setPivotMatrix(e.Matrix.FromArray(t.pivotMatrix)),s.setEnabled(t.isEnabled),t.parentId&&(s._waitingParentId=t.parentId),s},r.prototype.dispose=function(e,r){void 0===r&&(r=!1),this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this.onAfterWorldMatrixUpdateObservable.clear(),t.prototype.dispose.call(this,e,r)},r.BILLBOARDMODE_NONE=0,r.BILLBOARDMODE_X=1,r.BILLBOARDMODE_Y=2,r.BILLBOARDMODE_Z=4,r.BILLBOARDMODE_ALL=7,r._lookAtVectorCache=new e.Vector3(0,0,0),r._rotationAxisCache=new e.Quaternion,n([e.serializeAsVector3()],r.prototype,"_rotation",void 0),n([e.serializeAsQuaternion()],r.prototype,"_rotationQuaternion",void 0),n([e.serializeAsVector3()],r.prototype,"_scaling",void 0),n([e.serialize()],r.prototype,"billboardMode",void 0),n([e.serialize()],r.prototype,"scalingDeterminant",void 0),n([e.serialize()],r.prototype,"infiniteDistance",void 0),n([e.serialize()],r.prototype,"ignoreNonUniformScaling",void 0),n([e.serializeAsVector3()],r.prototype,"position",void 0),r})(e.Node);e.TransformNode=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(i,n){void 0===n&&(n=null);var s=t.call(this,i,n,!1)||this;return s._facetNb=0,s._partitioningSubdivisions=10,s._partitioningBBoxRatio=1.01,s._facetDataEnabled=!1,s._facetParameters={},s._bbSize=e.Vector3.Zero(),s._subDiv={max:1,X:1,Y:1,Z:1},s._facetDepthSort=!1,s._facetDepthSortEnabled=!1,s.onCollideObservable=new e.Observable,s.onCollisionPositionChangeObservable=new e.Observable,s.onMaterialChangedObservable=new e.Observable,s.definedFacingForward=!0,s.occlusionQueryAlgorithmType=r.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,s.occlusionType=r.OCCLUSION_TYPE_NONE,s.occlusionRetryCount=-1,s._occlusionInternalRetryCounter=0,s._isOccluded=!1,s._isOcclusionQueryInProgress=!1,s._visibility=1,s.alphaIndex=Number.MAX_VALUE,s.isVisible=!0,s.isPickable=!0,s.showBoundingBox=!1,s.showSubMeshesBoundingBox=!1,s.isBlocker=!1,s.enablePointerMoveEvents=!1,s.renderingGroupId=0,s._receiveShadows=!1,s.renderOutline=!1,s.outlineColor=e.Color3.Red(),s.outlineWidth=.02,s.renderOverlay=!1,s.overlayColor=e.Color3.Red(),s.overlayAlpha=.5,s._hasVertexAlpha=!1,s._useVertexColors=!0,s._computeBonesUsingShaders=!0,s._numBoneInfluencers=4,s._applyFog=!0,s.useOctreeForRenderingSelection=!0,s.useOctreeForPicking=!0,s.useOctreeForCollisions=!0,s._layerMask=268435455,s.alwaysSelectAsActiveMesh=!1,s.actionManager=null,s.physicsImpostor=null,s._checkCollisions=!1,s._collisionMask=-1,s._collisionGroup=-1,s.ellipsoid=new e.Vector3(.5,1,.5),s.ellipsoidOffset=new e.Vector3(0,0,0),s._oldPositionForCollisions=new e.Vector3(0,0,0),s._diffPositionForCollisions=new e.Vector3(0,0,0),s.edgesWidth=1,s.edgesColor=new e.Color4(1,0,0,1),s._collisionsTransformMatrix=e.Matrix.Zero(),s._collisionsScalingMatrix=e.Matrix.Zero(),s._renderId=0,s._intersectionsInProgress=new Array,s._unIndexed=!1,s._lightSources=new Array,s._onCollisionPositionChange=function(t,r,i){void 0===i&&(i=null),s.getScene().workerCollisions&&r.multiplyInPlace(s._collider._radius),r.subtractToRef(s._oldPositionForCollisions,s._diffPositionForCollisions),s._diffPositionForCollisions.length()>e.Engine.CollisionsEpsilon&&s.position.addInPlace(s._diffPositionForCollisions),i&&s.onCollideObservable.notifyObservers(i),s.onCollisionPositionChangeObservable.notifyObservers(s.position)},s.getScene().addMesh(s),s._resyncLightSources(),s}return s(r,t),Object.defineProperty(r,"BILLBOARDMODE_NONE",{get:function(){return e.TransformNode.BILLBOARDMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"BILLBOARDMODE_X",{get:function(){return e.TransformNode.BILLBOARDMODE_X},enumerable:!0,configurable:!0}),Object.defineProperty(r,"BILLBOARDMODE_Y",{get:function(){return e.TransformNode.BILLBOARDMODE_Y},enumerable:!0,configurable:!0}),Object.defineProperty(r,"BILLBOARDMODE_Z",{get:function(){return e.TransformNode.BILLBOARDMODE_Z},enumerable:!0,configurable:!0}),Object.defineProperty(r,"BILLBOARDMODE_ALL",{get:function(){return e.TransformNode.BILLBOARDMODE_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"facetNb",{get:function(){return this._facetNb},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"partitioningSubdivisions",{get:function(){return this._partitioningSubdivisions},set:function(e){this._partitioningSubdivisions=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"partitioningBBoxRatio",{get:function(){return this._partitioningBBoxRatio},set:function(e){this._partitioningBBoxRatio=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mustDepthSortFacets",{get:function(){return this._facetDepthSort},set:function(e){this._facetDepthSort=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"facetDepthSortFrom",{get:function(){return this._facetDepthSortFrom},set:function(e){this._facetDepthSortFrom=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isFacetDataEnabled",{get:function(){return this._facetDataEnabled},enumerable:!0,configurable:!0}),r.prototype._updateNonUniformScalingState=function(e){return!!t.prototype._updateNonUniformScalingState.call(this,e)&&(this._markSubMeshesAsMiscDirty(),!0)},Object.defineProperty(r.prototype,"onCollide",{set:function(e){this._onCollideObserver&&this.onCollideObservable.remove(this._onCollideObserver),this._onCollideObserver=this.onCollideObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"onCollisionPositionChange",{set:function(e){this._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._onCollisionPositionChangeObserver),this._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isOccluded",{get:function(){return this._isOccluded},set:function(e){this._isOccluded=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isOcclusionQueryInProgress",{get:function(){return this._isOcclusionQueryInProgress},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"visibility",{get:function(){return this._visibility},set:function(e){this._visibility!==e&&(this._visibility=e,this._markSubMeshesAsMiscDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"material",{get:function(){return this._material},set:function(e){this._material!==e&&(this._material=e,this.onMaterialChangedObservable.hasObservers&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&this._unBindEffect())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(e){this._receiveShadows!==e&&(this._receiveShadows=e,this._markSubMeshesAsLightDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"hasVertexAlpha",{get:function(){return this._hasVertexAlpha},set:function(e){this._hasVertexAlpha!==e&&(this._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())},enumerable:!0,configurable:!0}),
Object.defineProperty(r.prototype,"useVertexColors",{get:function(){return this._useVertexColors},set:function(e){this._useVertexColors!==e&&(this._useVertexColors=e,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"computeBonesUsingShaders",{get:function(){return this._computeBonesUsingShaders},set:function(e){this._computeBonesUsingShaders!==e&&(this._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"numBoneInfluencers",{get:function(){return this._numBoneInfluencers},set:function(e){this._numBoneInfluencers!==e&&(this._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"applyFog",{get:function(){return this._applyFog},set:function(e){this._applyFog!==e&&(this._applyFog=e,this._markSubMeshesAsMiscDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"layerMask",{get:function(){return this._layerMask},set:function(e){e!==this._layerMask&&(this._layerMask=e,this._resyncLightSources())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=isNaN(e)?-1:e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"collisionGroup",{get:function(){return this._collisionGroup},set:function(e){this._collisionGroup=isNaN(e)?-1:e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"_positions",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"skeleton",{get:function(){return this._skeleton},set:function(e){this._skeleton&&this._skeleton.needInitialSkinMatrix&&this._skeleton._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._skeleton=e,this._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()},enumerable:!0,configurable:!0}),r.prototype.getClassName=function(){return"AbstractMesh"},r.prototype.toString=function(t){var r="Name: "+this.name+", isInstance: "+(this instanceof e.InstancedMesh?"YES":"NO");return r+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0),this._skeleton&&(r+=", skeleton: "+this._skeleton.name),t&&(r+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],r+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingFreezeWorldMatrix?"YES":"NO")),r},r.prototype._rebuild=function(){if(this._occlusionQuery&&(this._occlusionQuery=null),this._edgesRenderer&&this._edgesRenderer._rebuild(),this.subMeshes)for(var e=0,t=this.subMeshes;e<t.length;e++){var r=t[e];r._rebuild()}},r.prototype._resyncLightSources=function(){this._lightSources.length=0;for(var e=0,t=this.getScene().lights;e<t.length;e++){var r=t[e];r.isEnabled()&&(r.canAffectMesh(this)&&this._lightSources.push(r))}this._markSubMeshesAsLightDirty()},r.prototype._resyncLighSource=function(e){var t=e.isEnabled()&&e.canAffectMesh(this),r=this._lightSources.indexOf(e);if(-1===r){if(!t)return;this._lightSources.push(e)}else{if(t)return;this._lightSources.splice(r,1)}this._markSubMeshesAsLightDirty()},r.prototype._unBindEffect=function(){for(var e=0,t=this.subMeshes;e<t.length;e++){t[e].setEffect(null)}},r.prototype._removeLightSource=function(e){var t=this._lightSources.indexOf(e);-1!==t&&(this._lightSources.splice(t,1),this._markSubMeshesAsLightDirty())},r.prototype._markSubMeshesAsDirty=function(e){if(this.subMeshes)for(var t=0,r=this.subMeshes;t<r.length;t++){var i=r[t];i._materialDefines&&e(i._materialDefines)}},r.prototype._markSubMeshesAsLightDirty=function(){this._markSubMeshesAsDirty((function(e){return e.markAsLightDirty()}))},r.prototype._markSubMeshesAsAttributesDirty=function(){this._markSubMeshesAsDirty((function(e){return e.markAsAttributesDirty()}))},r.prototype._markSubMeshesAsMiscDirty=function(){if(this.subMeshes)for(var t=0,r=this.subMeshes;t<r.length;t++){var i=r[t],n=i.getMaterial();n&&n.markAsDirty(e.Material.MiscDirtyFlag)}},Object.defineProperty(r.prototype,"scaling",{get:function(){return this._scaling},set:function(e){this._scaling=e,this.physicsImpostor&&this.physicsImpostor.forceUpdate()},enumerable:!0,configurable:!0}),r.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},r.prototype.enableEdgesRendering=function(t,r){return void 0===t&&(t=.95),void 0===r&&(r=!1),this.disableEdgesRendering(),this._edgesRenderer=new e.EdgesRenderer(this,t,r),this},Object.defineProperty(r.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isBlocked",{get:function(){return!1},enumerable:!0,configurable:!0}),r.prototype.getLOD=function(e){return this},r.prototype.getTotalVertices=function(){return 0},r.prototype.getIndices=function(){return null},r.prototype.getVerticesData=function(e){return null},r.prototype.setVerticesData=function(e,t,r,i){return this},r.prototype.updateVerticesData=function(e,t,r,i){return this},r.prototype.setIndices=function(e,t){return this},r.prototype.isVerticesDataPresent=function(e){return!1},r.prototype.getBoundingInfo=function(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfo||this._updateBoundingInfo(),this._boundingInfo)},r.prototype.normalizeToUnitCube=function(e){void 0===e&&(e=!0);var t=this.getHierarchyBoundingVectors(e),r=t.max.subtract(t.min),i=Math.max(r.x,r.y,r.z);if(0===i)return this;var n=1/i;return this.scaling.scaleInPlace(n),this},r.prototype.setBoundingInfo=function(e){return this._boundingInfo=e,this},Object.defineProperty(r.prototype,"useBones",{get:function(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&this.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)},enumerable:!0,configurable:!0}),r.prototype._preActivate=function(){},r.prototype._preActivateForIntermediateRendering=function(e){},r.prototype._activate=function(e){this._renderId=e},r.prototype.getWorldMatrix=function(){return this._masterMesh?this._masterMesh.getWorldMatrix():t.prototype.getWorldMatrix.call(this)},r.prototype._getWorldMatrixDeterminant=function(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():t.prototype._getWorldMatrixDeterminant.call(this)},r.prototype.movePOV=function(e,t,r){return this.position.addInPlace(this.calcMovePOV(e,t,r)),this},r.prototype.calcMovePOV=function(t,r,i){var n=new e.Matrix;(this.rotationQuaternion?this.rotationQuaternion:e.Quaternion.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(n);var s=e.Vector3.Zero(),o=this.definedFacingForward?-1:1;return e.Vector3.TransformCoordinatesFromFloatsToRef(t*o,r,i*o,n,s),s},r.prototype.rotatePOV=function(e,t,r){return this.rotation.addInPlace(this.calcRotatePOV(e,t,r)),this},r.prototype.calcRotatePOV=function(t,r,i){var n=this.definedFacingForward?1:-1;return new e.Vector3(t*n,r,i*n)},r.prototype.getHierarchyBoundingVectors=function(t,r){void 0===t&&(t=!0),void 0===r&&(r=null),this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);var i,n,s=this.getBoundingInfo();if(this.subMeshes?(i=s.boundingBox.minimumWorld,n=s.boundingBox.maximumWorld):(i=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)),t)for(var o=this.getDescendants(!1),a=0,h=o;a<h.length;a++){var u=h[a],l=u;if(l.computeWorldMatrix(!0),(!r||r(l))&&l.getBoundingInfo&&0!==l.getTotalVertices()){var c=l.getBoundingInfo(),f=c.boundingBox,d=f.minimumWorld,p=f.maximumWorld;e.Tools.CheckExtends(d,i,n),e.Tools.CheckExtends(p,i,n)}}return{min:i,max:n}},r.prototype._updateBoundingInfo=function(){return this._boundingInfo=this._boundingInfo||new e.BoundingInfo(this.absolutePosition,this.absolutePosition),this._boundingInfo.update(this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this},r.prototype._updateSubMeshesBoundingInfo=function(e){if(!this.subMeshes)return this;for(var t=0;t<this.subMeshes.length;t++){var r=this.subMeshes[t];r.IsGlobal||r.updateBoundingInfo(e)}return this},r.prototype._afterComputeWorldMatrix=function(){this._updateBoundingInfo()},r.prototype.isInFrustum=function(e){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(e)},r.prototype.isCompletelyInFrustum=function(e){return null!==this._boundingInfo&&this._boundingInfo.isCompletelyInFrustum(e)},r.prototype.intersectsMesh=function(e,t,r){if(void 0===t&&(t=!1),!this._boundingInfo||!e._boundingInfo)return!1;if(this._boundingInfo.intersects(e._boundingInfo,t))return!0;if(r)for(var i=0,n=this.getChildMeshes();i<n.length;i++){var s=n[i];if(s.intersectsMesh(e,t,!0))return!0}return!1},r.prototype.intersectsPoint=function(e){return!!this._boundingInfo&&this._boundingInfo.intersectsPoint(e)},r.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},r.prototype.getPositionInCameraSpace=function(t){return void 0===t&&(t=null),t||(t=this.getScene().activeCamera),e.Vector3.TransformCoordinates(this.absolutePosition,t.getViewMatrix())},r.prototype.getDistanceToCamera=function(e){return void 0===e&&(e=null),e||(e=this.getScene().activeCamera),this.absolutePosition.subtract(e.position).length()},r.prototype.applyImpulse=function(e,t){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(e,t),this):this},r.prototype.setPhysicsLinkWith=function(t,r,i,n){return this.physicsImpostor&&t.physicsImpostor?(this.physicsImpostor.createJoint(t.physicsImpostor,e.PhysicsJoint.HingeJoint,{mainPivot:r,connectedPivot:i,nativeParams:n}),this):this},Object.defineProperty(r.prototype,"checkCollisions",{get:function(){return this._checkCollisions},set:function(e){this._checkCollisions=e,this.getScene().workerCollisions&&this.getScene().collisionCoordinator.onMeshUpdated(this)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"collider",{get:function(){return this._collider},enumerable:!0,configurable:!0}),r.prototype.moveWithCollisions=function(t){return this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._oldPositionForCollisions),this._collider||(this._collider=new e.Collider),this._collider._radius=this.ellipsoid,this.getScene().collisionCoordinator.getNewPosition(this._oldPositionForCollisions,t,this._collider,3,this,this._onCollisionPositionChange,this.uniqueId),this},r.prototype.createOrUpdateSubmeshesOctree=function(t,r){void 0===t&&(t=64),void 0===r&&(r=2),this._submeshesOctree||(this._submeshesOctree=new e.Octree(e.Octree.CreationFuncForSubMeshes,t,r)),this.computeWorldMatrix(!0);var i=this.getBoundingInfo(),n=i.boundingBox;return this._submeshesOctree.update(n.minimumWorld,n.maximumWorld,this.subMeshes),this._submeshesOctree},r.prototype._collideForSubMesh=function(t,r,i){if(this._generatePointsArray(),!this._positions)return this;if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(r)){t._lastColliderTransformMatrix=r.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];for(var n=t.verticesStart,s=t.verticesStart+t.verticesCount,o=n;o<s;o++)t._lastColliderWorldVertices.push(e.Vector3.TransformCoordinates(this._positions[o],r))}return i._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial()),i.collisionFound&&(i.collidedMesh=this),this},r.prototype._processCollisionsForSubMeshes=function(e,t){var r,i;if(this._submeshesOctree&&this.useOctreeForCollisions){var n=e._velocityWorldLength+Math.max(e._radius.x,e._radius.y,e._radius.z),s=this._submeshesOctree.intersects(e._basePointWorld,n);i=s.length,r=s.data}else r=this.subMeshes,i=r.length;for(var o=0;o<i;o++){var a=r[o];i>1&&!a._checkCollision(e)||this._collideForSubMesh(a,t,e)}return this},r.prototype._checkCollision=function(t){return this._boundingInfo&&this._boundingInfo._checkCollision(t)?(e.Matrix.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,this._collisionsScalingMatrix),this.worldMatrixFromCache.multiplyToRef(this._collisionsScalingMatrix,this._collisionsTransformMatrix),this._processCollisionsForSubMeshes(t,this._collisionsTransformMatrix),this):this},r.prototype._generatePointsArray=function(){return!1},r.prototype.intersects=function(t,r){var i=new e.PickingInfo;if(!(this.subMeshes&&this._boundingInfo&&t.intersectsSphere(this._boundingInfo.boundingSphere)&&t.intersectsBox(this._boundingInfo.boundingBox)))return i;if(!this._generatePointsArray())return i;var n,s,o=null;if(this._submeshesOctree&&this.useOctreeForPicking){var a=e.Ray.Transform(t,this.getWorldMatrix()),h=this._submeshesOctree.intersectsRay(a);s=h.length,n=h.data}else n=this.subMeshes,s=n.length;for(var u=0;u<s;u++){var l=n[u];if(!(s>1)||l.canIntersects(t)){var c=l.intersects(t,this._positions,this.getIndices(),r);if(c&&(r||!o||c.distance<o.distance)&&(o=c,o.subMeshId=u,r))break}}if(o){var f=this.getWorldMatrix(),d=e.Vector3.TransformCoordinates(t.origin,f),p=t.direction.clone();p=p.scale(o.distance);var _=e.Vector3.TransformNormal(p,f),m=d.add(_);return i.hit=!0,i.distance=e.Vector3.Distance(d,m),i.pickedPoint=m,i.pickedMesh=this,i.bu=o.bu||0,i.bv=o.bv||0,i.faceId=o.faceId,i.subMeshId=o.subMeshId,i}return i},r.prototype.clone=function(e,t,r){return null},r.prototype.releaseSubMeshes=function(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this},r.prototype.dispose=function(e,r){var i=this;void 0===r&&(r=!1);var n;for(this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),void 0!==this.actionManager&&null!==this.actionManager&&(this.actionManager.dispose(),this.actionManager=null),this._skeleton=null,this.physicsImpostor&&this.physicsImpostor.dispose(),n=0;n<this._intersectionsInProgress.length;n++){var s=this._intersectionsInProgress[n],o=s._intersectionsInProgress.indexOf(this);s._intersectionsInProgress.splice(o,1)}this._intersectionsInProgress=[],this.getScene().lights.forEach((function(e){var t=e.includedOnlyMeshes.indexOf(i);-1!==t&&e.includedOnlyMeshes.splice(t,1),-1!==(t=e.excludedMeshes.indexOf(i))&&e.excludedMeshes.splice(t,1);var r=e.getShadowGenerator();if(r){var n=r.getShadowMap();n&&n.renderList&&-1!==(t=n.renderList.indexOf(i))&&n.renderList.splice(t,1)}})),this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),"InstancedMesh"!==this.getClassName()&&this.releaseSubMeshes();var a=this.getScene().selectionOctree;if(void 0!==a&&null!==a){var n=a.dynamicContent.indexOf(this);-1!==n&&a.dynamicContent.splice(n,1)}var h=this.getScene().getEngine();if(this._occlusionQuery&&(this._isOcclusionQueryInProgress=!1,h.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),h.wipeCaches(),this.getScene().removeMesh(this),r&&this.material&&this.material.dispose(!1,!0),!e)for(n=0;n<this.getScene().particleSystems.length;n++)this.getScene().particleSystems[n].emitter===this&&(this.getScene().particleSystems[n].dispose(),n--);this._facetDataEnabled&&this.disableFacetData(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),t.prototype.dispose.call(this,e,r)},r.prototype.addChild=function(e){return e.setParent(this),this},r.prototype.removeChild=function(e){return e.setParent(null),this},r.prototype._initFacetData=function(){this._facetNormals||(this._facetNormals=new Array),this._facetPositions||(this._facetPositions=new Array),this._facetPartitioning||(this._facetPartitioning=new Array),this._facetNb=this.getIndices().length/3|0,this._partitioningSubdivisions=this._partitioningSubdivisions?this._partitioningSubdivisions:10,this._partitioningBBoxRatio=this._partitioningBBoxRatio?this._partitioningBBoxRatio:1.01;for(var t=0;t<this._facetNb;t++)this._facetNormals[t]=e.Vector3.Zero(),this._facetPositions[t]=e.Vector3.Zero();return this._facetDataEnabled=!0,this},r.prototype.updateFacetData=function(){this._facetDataEnabled||this._initFacetData();var t=this.getVerticesData(e.VertexBuffer.PositionKind),r=this.getIndices(),i=this.getVerticesData(e.VertexBuffer.NormalKind),n=this.getBoundingInfo();if(this._facetDepthSort&&!this._facetDepthSortEnabled){if(this._facetDepthSortEnabled=!0,r instanceof Uint16Array)this._depthSortedIndices=new Uint16Array(r);else if(r instanceof Uint32Array)this._depthSortedIndices=new Uint32Array(r);else{for(var s=!1,o=0;o<r.length;o++)if(r[o]>65535){s=!0;break}this._depthSortedIndices=s?new Uint32Array(r):new Uint16Array(r)}if(this._facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!this._facetDepthSortFrom){var a=this.getScene().activeCamera;this._facetDepthSortFrom=a?a.position:e.Vector3.Zero()}this._depthSortedFacets=[];for(var h=0;h<this._facetNb;h++){var u={ind:3*h,sqDistance:0};this._depthSortedFacets.push(u)}this._invertedMatrix=e.Matrix.Identity(),this._facetDepthSortOrigin=e.Vector3.Zero()}this._bbSize.x=n.maximum.x-n.minimum.x>e.Epsilon?n.maximum.x-n.minimum.x:e.Epsilon,this._bbSize.y=n.maximum.y-n.minimum.y>e.Epsilon?n.maximum.y-n.minimum.y:e.Epsilon,this._bbSize.z=n.maximum.z-n.minimum.z>e.Epsilon?n.maximum.z-n.minimum.z:e.Epsilon;var l=this._bbSize.x>this._bbSize.y?this._bbSize.x:this._bbSize.y;if(l=l>this._bbSize.z?l:this._bbSize.z,this._subDiv.max=this._partitioningSubdivisions,this._subDiv.X=Math.floor(this._subDiv.max*this._bbSize.x/l),this._subDiv.Y=Math.floor(this._subDiv.max*this._bbSize.y/l),this._subDiv.Z=Math.floor(this._subDiv.max*this._bbSize.z/l),this._subDiv.X=this._subDiv.X<1?1:this._subDiv.X,this._subDiv.Y=this._subDiv.Y<1?1:this._subDiv.Y,this._subDiv.Z=this._subDiv.Z<1?1:this._subDiv.Z,this._facetParameters.facetNormals=this.getFacetLocalNormals(),this._facetParameters.facetPositions=this.getFacetLocalPositions(),this._facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),this._facetParameters.bInfo=n,this._facetParameters.bbSize=this._bbSize,this._facetParameters.subDiv=this._subDiv,this._facetParameters.ratio=this.partitioningBBoxRatio,this._facetParameters.depthSort=this._facetDepthSort,this._facetDepthSort&&this._facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(this._invertedMatrix),e.Vector3.TransformCoordinatesToRef(this._facetDepthSortFrom,this._invertedMatrix,this._facetDepthSortOrigin),this._facetParameters.distanceTo=this._facetDepthSortOrigin),this._facetParameters.depthSortedFacets=this._depthSortedFacets,e.VertexData.ComputeNormals(t,r,i,this._facetParameters),this._facetDepthSort&&this._facetDepthSortEnabled){this._depthSortedFacets.sort(this._facetDepthSortFunction);for(var c=this._depthSortedIndices.length/3|0,h=0;h<c;h++){var f=this._depthSortedFacets[h].ind;this._depthSortedIndices[3*h]=r[f],this._depthSortedIndices[3*h+1]=r[f+1],this._depthSortedIndices[3*h+2]=r[f+2]}this.updateIndices(this._depthSortedIndices)}return this},r.prototype.getFacetLocalNormals=function(){return this._facetNormals||this.updateFacetData(),this._facetNormals},r.prototype.getFacetLocalPositions=function(){return this._facetPositions||this.updateFacetData(),this._facetPositions},r.prototype.getFacetLocalPartitioning=function(){return this._facetPartitioning||this.updateFacetData(),this._facetPartitioning},r.prototype.getFacetPosition=function(t){var r=e.Vector3.Zero();return this.getFacetPositionToRef(t,r),r},r.prototype.getFacetPositionToRef=function(t,r){var i=this.getFacetLocalPositions()[t],n=this.getWorldMatrix();return e.Vector3.TransformCoordinatesToRef(i,n,r),this},r.prototype.getFacetNormal=function(t){var r=e.Vector3.Zero();return this.getFacetNormalToRef(t,r),r},r.prototype.getFacetNormalToRef=function(t,r){var i=this.getFacetLocalNormals()[t];return e.Vector3.TransformNormalToRef(i,this.getWorldMatrix(),r),this},r.prototype.getFacetsAtLocalCoordinates=function(e,t,r){var i=this.getBoundingInfo(),n=Math.floor((e-i.minimum.x*this._partitioningBBoxRatio)*this._subDiv.X*this._partitioningBBoxRatio/this._bbSize.x),s=Math.floor((t-i.minimum.y*this._partitioningBBoxRatio)*this._subDiv.Y*this._partitioningBBoxRatio/this._bbSize.y),o=Math.floor((r-i.minimum.z*this._partitioningBBoxRatio)*this._subDiv.Z*this._partitioningBBoxRatio/this._bbSize.z);return n<0||n>this._subDiv.max||s<0||s>this._subDiv.max||o<0||o>this._subDiv.max?null:this._facetPartitioning[n+this._subDiv.max*s+this._subDiv.max*this._subDiv.max*o]},r.prototype.getClosestFacetAtCoordinates=function(t,r,i,n,s,o){void 0===s&&(s=!1),void 0===o&&(o=!0);var a=this.getWorldMatrix(),h=e.Tmp.Matrix[5];a.invertToRef(h);var u=e.Tmp.Vector3[8];e.Vector3.TransformCoordinatesFromFloatsToRef(t,r,i,h,u);var l=this.getClosestFacetAtLocalCoordinates(u.x,u.y,u.z,n,s,o);return n&&e.Vector3.TransformCoordinatesFromFloatsToRef(n.x,n.y,n.z,a,n),l},r.prototype.getClosestFacetAtLocalCoordinates=function(e,t,r,i,n,s){void 0===n&&(n=!1),void 0===s&&(s=!0);var o=null,a=0,h=0,u=0,l=0,c=0,f=0,d=0,p=0,_=this.getFacetLocalPositions(),m=this.getFacetLocalNormals(),g=this.getFacetsAtLocalCoordinates(e,t,r);if(!g)return null;for(var v,y,b,T=Number.MAX_VALUE,E=T,x=0;x<g.length;x++)v=g[x],y=m[v],b=_[v],l=(e-b.x)*y.x+(t-b.y)*y.y+(r-b.z)*y.z,(!n||n&&s&&l>=0||n&&!s&&l<=0)&&(l=y.x*b.x+y.y*b.y+y.z*b.z,c=-(y.x*e+y.y*t+y.z*r-l)/(y.x*y.x+y.y*y.y+y.z*y.z),f=e+y.x*c,d=t+y.y*c,p=r+y.z*c,a=f-e,h=d-t,u=p-r,(E=a*a+h*h+u*u)<T&&(T=E,o=v,i&&(i.x=f,i.y=d,i.z=p)));return o},r.prototype.getFacetDataParameters=function(){return this._facetParameters},r.prototype.disableFacetData=function(){return this._facetDataEnabled&&(this._facetDataEnabled=!1,this._facetPositions=new Array,this._facetNormals=new Array,this._facetPartitioning=new Array,this._facetParameters=null,this._depthSortedIndices=new Uint32Array(0)),this},r.prototype.updateIndices=function(e){return this},r.prototype.createNormals=function(t){var r,i=this.getVerticesData(e.VertexBuffer.PositionKind),n=this.getIndices();return r=this.isVerticesDataPresent(e.VertexBuffer.NormalKind)?this.getVerticesData(e.VertexBuffer.NormalKind):[],e.VertexData.ComputeNormals(i,n,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(e.VertexBuffer.NormalKind,r,t),this},r.prototype.alignWithNormal=function(t,r){r||(r=e.Axis.Y);var i=e.Tmp.Vector3[0],n=e.Tmp.Vector3[1];return e.Vector3.CrossToRef(r,t,n),e.Vector3.CrossToRef(t,n,i),this.rotationQuaternion?e.Quaternion.RotationQuaternionFromAxisToRef(i,t,n,this.rotationQuaternion):e.Vector3.RotationFromAxisToRef(i,t,n,this.rotation),this},r.prototype._checkOcclusionQuery=function(){var e=this.getEngine();if(e.webGLVersion<2||this.occlusionType===r.OCCLUSION_TYPE_NONE)return void(this._isOccluded=!1);if(this.isOcclusionQueryInProgress&&this._occlusionQuery){if(e.isQueryResultAvailable(this._occlusionQuery)){var t=e.getQueryResult(this._occlusionQuery);this._isOcclusionQueryInProgress=!1,this._occlusionInternalRetryCounter=0,this._isOccluded=1!==t}else{if(this._occlusionInternalRetryCounter++,!(-1!==this.occlusionRetryCount&&this._occlusionInternalRetryCounter>this.occlusionRetryCount))return;this._isOcclusionQueryInProgress=!1,this._occlusionInternalRetryCounter=0,this._isOccluded=this.occlusionType!==r.OCCLUSION_TYPE_OPTIMISTIC&&this._isOccluded}}var i=this.getScene(),n=i.getBoundingBoxRenderer();this._occlusionQuery||(this._occlusionQuery=e.createQuery()),e.beginOcclusionQuery(this.occlusionQueryAlgorithmType,this._occlusionQuery),n.renderOcclusionBoundingBox(this),e.endOcclusionQuery(this.occlusionQueryAlgorithmType),this._isOcclusionQueryInProgress=!0},r.OCCLUSION_TYPE_NONE=0,r.OCCLUSION_TYPE_OPTIMISTIC=1,r.OCCLUSION_TYPE_STRICT=2,r.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,r.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,r})(e.TransformNode);e.AbstractMesh=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(i,n){var s=t.call(this,i,n)||this;return s.diffuse=new e.Color3(1,1,1),s.specular=new e.Color3(1,1,1),s.intensity=1,s.range=Number.MAX_VALUE,s._photometricScale=1,s._intensityMode=r.INTENSITYMODE_AUTOMATIC,s._radius=1e-5,s.renderPriority=0,s._shadowEnabled=!0,s._excludeWithLayerMask=0,s._includeOnlyWithLayerMask=0,s._lightmapMode=0,s._excludedMeshesIds=new Array,s._includedOnlyMeshesIds=new Array,s.getScene().addLight(s),s._uniformBuffer=new e.UniformBuffer(s.getScene().getEngine()),s._buildUniformLayout(),s.includedOnlyMeshes=new Array,s.excludedMeshes=new Array,s._resyncMeshes(),s}return s(r,t),Object.defineProperty(r,"LIGHTMAP_DEFAULT",{get:function(){return r._LIGHTMAP_DEFAULT},enumerable:!0,configurable:!0}),Object.defineProperty(r,"LIGHTMAP_SPECULAR",{get:function(){return r._LIGHTMAP_SPECULAR},enumerable:!0,configurable:!0}),Object.defineProperty(r,"LIGHTMAP_SHADOWSONLY",{get:function(){return r._LIGHTMAP_SHADOWSONLY},enumerable:!0,configurable:!0}),Object.defineProperty(r,"INTENSITYMODE_AUTOMATIC",{get:function(){return r._INTENSITYMODE_AUTOMATIC},enumerable:!0,configurable:!0}),Object.defineProperty(r,"INTENSITYMODE_LUMINOUSPOWER",{get:function(){return r._INTENSITYMODE_LUMINOUSPOWER},enumerable:!0,configurable:!0}),Object.defineProperty(r,"INTENSITYMODE_LUMINOUSINTENSITY",{get:function(){return r._INTENSITYMODE_LUMINOUSINTENSITY},enumerable:!0,configurable:!0}),Object.defineProperty(r,"INTENSITYMODE_ILLUMINANCE",{get:function(){return r._INTENSITYMODE_ILLUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"INTENSITYMODE_LUMINANCE",{get:function(){return r._INTENSITYMODE_LUMINANCE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"LIGHTTYPEID_POINTLIGHT",{get:function(){return r._LIGHTTYPEID_POINTLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(r,"LIGHTTYPEID_DIRECTIONALLIGHT",{get:function(){return r._LIGHTTYPEID_DIRECTIONALLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(r,"LIGHTTYPEID_SPOTLIGHT",{get:function(){return r._LIGHTTYPEID_SPOTLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(r,"LIGHTTYPEID_HEMISPHERICLIGHT",{get:function(){return r._LIGHTTYPEID_HEMISPHERICLIGHT},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"intensityMode",{get:function(){return this._intensityMode},set:function(e){this._intensityMode=e,this._computePhotometricScale()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"radius",{get:function(){return this._radius},set:function(e){this._radius=e,this._computePhotometricScale()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shadowEnabled",{get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"includedOnlyMeshes",{get:function(){return this._includedOnlyMeshes},set:function(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"excludedMeshes",{get:function(){return this._excludedMeshes},set:function(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"excludeWithLayerMask",{get:function(){return this._excludeWithLayerMask},set:function(e){this._excludeWithLayerMask=e,this._resyncMeshes()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"includeOnlyWithLayerMask",{get:function(){return this._includeOnlyWithLayerMask},set:function(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"lightmapMode",{get:function(){return this._lightmapMode},set:function(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())},enumerable:!0,configurable:!0}),r.prototype.getClassName=function(){return"Light"},r.prototype.toString=function(e){var t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(var r=0;r<this.animations.length;r++)t+=", animation[0]: "+this.animations[r].toString(e);return t},r.prototype.setEnabled=function(e){t.prototype.setEnabled.call(this,e),this._resyncMeshes()},r.prototype.getShadowGenerator=function(){return this._shadowGenerator},r.prototype.getAbsolutePosition=function(){return e.Vector3.Zero()},r.prototype.canAffectMesh=function(e){return!e||!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&-1===this.includedOnlyMeshes.indexOf(e))&&(!(this.excludedMeshes&&this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e))&&((0===this.includeOnlyWithLayerMask||0!=(this.includeOnlyWithLayerMask&e.layerMask))&&!(0!==this.excludeWithLayerMask&&this.excludeWithLayerMask&e.layerMask)))},r.prototype.getWorldMatrix=function(){this._currentRenderId=this.getScene().getRenderId(),this._childRenderId=this._currentRenderId;var t=this._getWorldMatrix();return this.parent&&this.parent.getWorldMatrix?(this._parentedWorldMatrix||(this._parentedWorldMatrix=e.Matrix.Identity()),t.multiplyToRef(this.parent.getWorldMatrix(),this._parentedWorldMatrix),this._markSyncedWithParent(),this._parentedWorldMatrix):t},r.CompareLightsPriority=function(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority},r.prototype.dispose=function(e,r){void 0===r&&(r=!1),this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this);for(var i=0,n=this.getScene().meshes;i<n.length;i++){n[i]._removeLightSource(this)}this._uniformBuffer.dispose(),this.getScene().removeLight(this),t.prototype.dispose.call(this,e,r)},r.prototype.getTypeID=function(){return 0},r.prototype.getScaledIntensity=function(){return this._photometricScale*this.intensity},r.prototype.clone=function(t){var i=r.GetConstructorFromName(this.getTypeID(),t,this.getScene());return i?e.SerializationHelper.Clone(i,this):null},r.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);return t.type=this.getTypeID(),this.parent&&(t.parentId=this.parent.id),this.excludedMeshes.length>0&&(t.excludedMeshesIds=[],this.excludedMeshes.forEach((function(e){t.excludedMeshesIds.push(e.id)}))),this.includedOnlyMeshes.length>0&&(t.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach((function(e){t.includedOnlyMeshesIds.push(e.id)}))),e.Animation.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t},r.GetConstructorFromName=function(t,r,i){switch(t){case 0:return function(){return new e.PointLight(r,e.Vector3.Zero(),i)};case 1:return function(){return new e.DirectionalLight(r,e.Vector3.Zero(),i)};case 2:return function(){return new e.SpotLight(r,e.Vector3.Zero(),e.Vector3.Zero(),0,0,i)};case 3:return function(){return new e.HemisphericLight(r,e.Vector3.Zero(),i)}}return null},r.Parse=function(t,i){var n=r.GetConstructorFromName(t.type,t.name,i);if(!n)return null;var s=e.SerializationHelper.Parse(n,t,i);if(t.excludedMeshesIds&&(s._excludedMeshesIds=t.excludedMeshesIds),t.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=t.includedOnlyMeshesIds),t.parentId&&(s._waitingParentId=t.parentId),t.animations){for(var o=0;o<t.animations.length;o++){var a=t.animations[o];s.animations.push(e.Animation.Parse(a))}e.Node.ParseAnimationRanges(s,t,i)}return t.autoAnimate&&i.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),s},r.prototype._hookArrayForExcluded=function(e){var t=this,r=e.push;e.push=function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];for(var s=r.apply(e,i),o=0,a=i;o<a.length;o++){a[o]._resyncLighSource(t)}return s};var i=e.splice;e.splice=function(r,n){for(var s=i.apply(e,[r,n]),o=0,a=s;o<a.length;o++){a[o]._resyncLighSource(t)}return s};for(var n=0,s=e;n<s.length;n++){s[n]._resyncLighSource(this)}},r.prototype._hookArrayForIncludedOnly=function(e){var t=this,r=e.push;e.push=function(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n]
;var s=r.apply(e,i);return t._resyncMeshes(),s};var i=e.splice;e.splice=function(r,n){var s=i.apply(e,[r,n]);return t._resyncMeshes(),s},this._resyncMeshes()},r.prototype._resyncMeshes=function(){for(var e=0,t=this.getScene().meshes;e<t.length;e++){t[e]._resyncLighSource(this)}},r.prototype._markMeshesAsLightDirty=function(){for(var e=0,t=this.getScene().meshes;e<t.length;e++){var r=t[e];-1!==r._lightSources.indexOf(this)&&r._markSubMeshesAsLightDirty()}},r.prototype._computePhotometricScale=function(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()},r.prototype._getPhotometricScale=function(){var e=0,t=this.getTypeID(),i=this.intensityMode;switch(i===r.INTENSITYMODE_AUTOMATIC&&(i=t===r.LIGHTTYPEID_DIRECTIONALLIGHT?r.INTENSITYMODE_ILLUMINANCE:r.INTENSITYMODE_LUMINOUSINTENSITY),t){case r.LIGHTTYPEID_POINTLIGHT:case r.LIGHTTYPEID_SPOTLIGHT:switch(i){case r.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case r.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case r.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius}break;case r.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case r.INTENSITYMODE_ILLUMINANCE:e=1;break;case r.INTENSITYMODE_LUMINANCE:var n=this.radius;n=Math.max(n,.001);e=2*Math.PI*(1-Math.cos(n))}break;case r.LIGHTTYPEID_HEMISPHERICLIGHT:e=1}return e},r.prototype._reorderLightsInScene=function(){var e=this.getScene();0!=this._renderPriority&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()},r._LIGHTMAP_DEFAULT=0,r._LIGHTMAP_SPECULAR=1,r._LIGHTMAP_SHADOWSONLY=2,r._INTENSITYMODE_AUTOMATIC=0,r._INTENSITYMODE_LUMINOUSPOWER=1,r._INTENSITYMODE_LUMINOUSINTENSITY=2,r._INTENSITYMODE_ILLUMINANCE=3,r._INTENSITYMODE_LUMINANCE=4,r._LIGHTTYPEID_POINTLIGHT=0,r._LIGHTTYPEID_DIRECTIONALLIGHT=1,r._LIGHTTYPEID_SPOTLIGHT=2,r._LIGHTTYPEID_HEMISPHERICLIGHT=3,n([e.serializeAsColor3()],r.prototype,"diffuse",void 0),n([e.serializeAsColor3()],r.prototype,"specular",void 0),n([e.serialize()],r.prototype,"intensity",void 0),n([e.serialize()],r.prototype,"range",void 0),n([e.serialize()],r.prototype,"intensityMode",null),n([e.serialize()],r.prototype,"radius",null),n([e.serialize()],r.prototype,"_renderPriority",void 0),n([e.expandToProperty("_reorderLightsInScene")],r.prototype,"renderPriority",void 0),n([e.serialize("shadowEnabled")],r.prototype,"_shadowEnabled",void 0),n([e.serialize("excludeWithLayerMask")],r.prototype,"_excludeWithLayerMask",void 0),n([e.serialize("includeOnlyWithLayerMask")],r.prototype,"_includeOnlyWithLayerMask",void 0),n([e.serialize("lightmapMode")],r.prototype,"_lightmapMode",void 0),r})(e.Node);e.Light=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(i,n,s,o){void 0===o&&(o=!0);var a=t.call(this,i,s)||this;return a.upVector=e.Vector3.Up(),a.orthoLeft=null,a.orthoRight=null,a.orthoBottom=null,a.orthoTop=null,a.fov=.8,a.minZ=1,a.maxZ=1e4,a.inertia=.9,a.mode=r.PERSPECTIVE_CAMERA,a.isIntermediate=!1,a.viewport=new e.Viewport(0,0,1,1),a.layerMask=268435455,a.fovMode=r.FOVMODE_VERTICAL_FIXED,a.cameraRigMode=r.RIG_MODE_NONE,a._rigCameras=new Array,a._webvrViewMatrix=e.Matrix.Identity(),a._skipRendering=!1,a.customRenderTargets=new Array,a.onViewMatrixChangedObservable=new e.Observable,a.onProjectionMatrixChangedObservable=new e.Observable,a.onAfterCheckInputsObservable=new e.Observable,a.onRestoreStateObservable=new e.Observable,a._computedViewMatrix=e.Matrix.Identity(),a._projectionMatrix=new e.Matrix,a._doNotComputeProjectionMatrix=!1,a._worldMatrix=e.Matrix.Identity(),a._postProcesses=new Array,a._transformMatrix=e.Matrix.Zero(),a._activeMeshes=new e.SmartArray(256),a._globalPosition=e.Vector3.Zero(),a._refreshFrustumPlanes=!0,a.getScene().addCamera(a),o&&!a.getScene().activeCamera&&(a.getScene().activeCamera=a),a.position=n,a}return s(r,t),Object.defineProperty(r,"PERSPECTIVE_CAMERA",{get:function(){return r._PERSPECTIVE_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(r,"ORTHOGRAPHIC_CAMERA",{get:function(){return r._ORTHOGRAPHIC_CAMERA},enumerable:!0,configurable:!0}),Object.defineProperty(r,"FOVMODE_VERTICAL_FIXED",{get:function(){return r._FOVMODE_VERTICAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(r,"FOVMODE_HORIZONTAL_FIXED",{get:function(){return r._FOVMODE_HORIZONTAL_FIXED},enumerable:!0,configurable:!0}),Object.defineProperty(r,"RIG_MODE_NONE",{get:function(){return r._RIG_MODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"RIG_MODE_STEREOSCOPIC_ANAGLYPH",{get:function(){return r._RIG_MODE_STEREOSCOPIC_ANAGLYPH},enumerable:!0,configurable:!0}),Object.defineProperty(r,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL",{get:function(){return r._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL},enumerable:!0,configurable:!0}),Object.defineProperty(r,"RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED",{get:function(){return r._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED},enumerable:!0,configurable:!0}),Object.defineProperty(r,"RIG_MODE_STEREOSCOPIC_OVERUNDER",{get:function(){return r._RIG_MODE_STEREOSCOPIC_OVERUNDER},enumerable:!0,configurable:!0}),Object.defineProperty(r,"RIG_MODE_VR",{get:function(){return r._RIG_MODE_VR},enumerable:!0,configurable:!0}),Object.defineProperty(r,"RIG_MODE_WEBVR",{get:function(){return r._RIG_MODE_WEBVR},enumerable:!0,configurable:!0}),r.prototype.storeState=function(){return this._stateStored=!0,this._storedFov=this.fov,this},r.prototype._restoreStateValues=function(){return!!this._stateStored&&(this.fov=this._storedFov,!0)},r.prototype.restoreState=function(){return!!this._restoreStateValues()&&(this.onRestoreStateObservable.notifyObservers(this),!0)},r.prototype.getClassName=function(){return"Camera"},r.prototype.toString=function(e){var t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(var r=0;r<this.animations.length;r++)t+=", animation[0]: "+this.animations[r].toString(e);return t},Object.defineProperty(r.prototype,"globalPosition",{get:function(){return this._globalPosition},enumerable:!0,configurable:!0}),r.prototype.getActiveMeshes=function(){return this._activeMeshes},r.prototype.isActiveMesh=function(e){return-1!==this._activeMeshes.indexOf(e)},r.prototype.isReady=function(e){if(void 0===e&&(e=!1),e)for(var r=0,i=this._postProcesses;r<i.length;r++){var n=i[r];if(n&&!n.isReady())return!1}return t.prototype.isReady.call(this,e)},r.prototype._initCache=function(){t.prototype._initCache.call(this),this._cache.position=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0},r.prototype._updateCache=function(e){e||t.prototype._updateCache.call(this),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)},r.prototype._isSynchronized=function(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()},r.prototype._isSynchronizedViewMatrix=function(){return!!t.prototype._isSynchronized.call(this)&&(this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent())},r.prototype._isSynchronizedProjectionMatrix=function(){var e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;var t=this.getEngine();return e=this.mode===r.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this):this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight()},r.prototype.attachControl=function(e,t){},r.prototype.detachControl=function(e){},r.prototype.update=function(){this._checkInputs(),this.cameraRigMode!==r.RIG_MODE_NONE&&this._updateRigCameras()},r.prototype._checkInputs=function(){this.onAfterCheckInputsObservable.notifyObservers(this)},Object.defineProperty(r.prototype,"rigCameras",{get:function(){return this._rigCameras},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rigPostProcess",{get:function(){return this._rigPostProcess},enumerable:!0,configurable:!0}),r.prototype._getFirstPostProcess=function(){for(var e=0;e<this._postProcesses.length;e++)if(null!==this._postProcesses[e])return this._postProcesses[e];return null},r.prototype._cascadePostProcessesToRigCams=function(){var t=this._getFirstPostProcess();t&&t.markTextureDirty();for(var r=0,i=this._rigCameras.length;r<i;r++){var n=this._rigCameras[r],s=n._rigPostProcess;if(s){s instanceof e.PassPostProcess&&(n.isIntermediate=0===this._postProcesses.length),n._postProcesses=this._postProcesses.slice(0).concat(s),s.markTextureDirty()}else n._postProcesses=this._postProcesses.slice(0)}},r.prototype.attachPostProcess=function(t,r){return void 0===r&&(r=null),!t.isReusable()&&this._postProcesses.indexOf(t)>-1?(e.Tools.Error("You're trying to reuse a post process not defined as reusable."),0):(null==r||r<0?this._postProcesses.push(t):null===this._postProcesses[r]?this._postProcesses[r]=t:this._postProcesses.splice(r,0,t),this._cascadePostProcessesToRigCams(),this._postProcesses.indexOf(t))},r.prototype.detachPostProcess=function(e){var t=this._postProcesses.indexOf(e);-1!==t&&(this._postProcesses[t]=null),this._cascadePostProcessesToRigCams()},r.prototype.getWorldMatrix=function(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)},r.prototype._getViewMatrix=function(){return e.Matrix.Identity()},r.prototype.getViewMatrix=function(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childRenderId=this._currentRenderId,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)},r.prototype.freezeProjectionMatrix=function(e){this._doNotComputeProjectionMatrix=!0,void 0!==e&&(this._projectionMatrix=e)},r.prototype.unfreezeProjectionMatrix=function(){this._doNotComputeProjectionMatrix=!1},r.prototype.getProjectionMatrix=function(t){if(this._doNotComputeProjectionMatrix||!t&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;var i=this.getEngine(),n=this.getScene();if(this.mode===r.PERSPECTIVE_CAMERA)this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=i.getAspectRatio(this),this.minZ<=0&&(this.minZ=.1),n.useRightHandedSystem?e.Matrix.PerspectiveFovRHToRef(this.fov,i.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===r.FOVMODE_VERTICAL_FIXED):e.Matrix.PerspectiveFovLHToRef(this.fov,i.getAspectRatio(this),this.minZ,this.maxZ,this._projectionMatrix,this.fovMode===r.FOVMODE_VERTICAL_FIXED);else{var s=i.getRenderWidth()/2,o=i.getRenderHeight()/2;n.useRightHandedSystem?e.Matrix.OrthoOffCenterRHToRef(this.orthoLeft||-s,this.orthoRight||s,this.orthoBottom||-o,this.orthoTop||o,this.minZ,this.maxZ,this._projectionMatrix):e.Matrix.OrthoOffCenterLHToRef(this.orthoLeft||-s,this.orthoRight||s,this.orthoBottom||-o,this.orthoTop||o,this.minZ,this.maxZ,this._projectionMatrix),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=i.getRenderWidth(),this._cache.renderHeight=i.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix},r.prototype.getTranformationMatrix=function(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix},r.prototype.updateFrustumPlanes=function(){this._refreshFrustumPlanes&&(this.getTranformationMatrix(),this._frustumPlanes?e.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=e.Frustum.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)},r.prototype.isInFrustum=function(e){return this.updateFrustumPlanes(),e.isInFrustum(this._frustumPlanes)},r.prototype.isCompletelyInFrustum=function(e){return this.updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)},r.prototype.getForwardRay=function(t,r,i){void 0===t&&(t=100),r||(r=this.getWorldMatrix()),i||(i=this.position);var n=new e.Vector3(0,0,1),s=e.Vector3.TransformNormal(n,r),o=e.Vector3.Normalize(s);return new e.Ray(i,o,t)},r.prototype.dispose=function(e,i){for(void 0===i&&(i=!1),this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses=[];else if(this.cameraRigMode!==r.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses=[];else for(var s=this._postProcesses.length;--s>=0;){var o=this._postProcesses[s];o&&o.dispose(this)}for(var s=this.customRenderTargets.length;--s>=0;)this.customRenderTargets[s].dispose();this.customRenderTargets=[],this._activeMeshes.dispose(),t.prototype.dispose.call(this,e,i)},Object.defineProperty(r.prototype,"leftCamera",{get:function(){return this._rigCameras.length<1?null:this._rigCameras[0]},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"rightCamera",{get:function(){return this._rigCameras.length<2?null:this._rigCameras[1]},enumerable:!0,configurable:!0}),r.prototype.getLeftTarget=function(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()},r.prototype.getRightTarget=function(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()},r.prototype.setCameraRigMode=function(t,i){if(this.cameraRigMode!==t){for(;this._rigCameras.length>0;){var n=this._rigCameras.pop();n&&n.dispose()}if(this.cameraRigMode=t,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=i.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=e.Tools.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==r.RIG_MODE_NONE){var s=this.createRigCamera(this.name+"_L",0),o=this.createRigCamera(this.name+"_R",1);s&&o&&(this._rigCameras.push(s),this._rigCameras.push(o))}switch(this.cameraRigMode){case r.RIG_MODE_STEREOSCOPIC_ANAGLYPH:this._rigCameras[0]._rigPostProcess=new e.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]),this._rigCameras[1]._rigPostProcess=new e.AnaglyphPostProcess(this.name+"_anaglyph",1,this._rigCameras);break;case r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case r.RIG_MODE_STEREOSCOPIC_OVERUNDER:var a=this.cameraRigMode===r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||this.cameraRigMode===r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;this._rigCameras[0]._rigPostProcess=new e.PassPostProcess(this.name+"_passthru",1,this._rigCameras[0]),this._rigCameras[1]._rigPostProcess=new e.StereoscopicInterlacePostProcess(this.name+"_stereoInterlace",this._rigCameras,a);break;case r.RIG_MODE_VR:var h=i.vrCameraMetrics||e.VRCameraMetrics.GetDefault();this._rigCameras[0]._cameraRigParams.vrMetrics=h,this._rigCameras[0].viewport=new e.Viewport(0,0,.5,1),this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new e.Matrix,this._rigCameras[0]._cameraRigParams.vrHMatrix=h.leftHMatrix,this._rigCameras[0]._cameraRigParams.vrPreViewMatrix=h.leftPreViewMatrix,this._rigCameras[0].getProjectionMatrix=this._rigCameras[0]._getVRProjectionMatrix,this._rigCameras[1]._cameraRigParams.vrMetrics=h,this._rigCameras[1].viewport=new e.Viewport(.5,0,.5,1),this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new e.Matrix,this._rigCameras[1]._cameraRigParams.vrHMatrix=h.rightHMatrix,this._rigCameras[1]._cameraRigParams.vrPreViewMatrix=h.rightPreViewMatrix,this._rigCameras[1].getProjectionMatrix=this._rigCameras[1]._getVRProjectionMatrix,h.compensateDistortion&&(this._rigCameras[0]._rigPostProcess=new e.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Left",this._rigCameras[0],!1,h),this._rigCameras[1]._rigPostProcess=new e.VRDistortionCorrectionPostProcess("VR_Distort_Compensation_Right",this._rigCameras[1],!0,h));break;case r.RIG_MODE_WEBVR:if(i.vrDisplay){var u=i.vrDisplay.getEyeParameters("left"),l=i.vrDisplay.getEyeParameters("right");this._rigCameras[0].viewport=new e.Viewport(0,0,.5,1),this._rigCameras[0].setCameraRigParameter("left",!0),this._rigCameras[0].setCameraRigParameter("specs",i.specs),this._rigCameras[0].setCameraRigParameter("eyeParameters",u),this._rigCameras[0].setCameraRigParameter("frameData",i.frameData),this._rigCameras[0].setCameraRigParameter("parentCamera",i.parentCamera),this._rigCameras[0]._cameraRigParams.vrWorkMatrix=new e.Matrix,this._rigCameras[0].getProjectionMatrix=this._getWebVRProjectionMatrix,this._rigCameras[0].parent=this,this._rigCameras[0]._getViewMatrix=this._getWebVRViewMatrix,this._rigCameras[1].viewport=new e.Viewport(.5,0,.5,1),this._rigCameras[1].setCameraRigParameter("eyeParameters",l),this._rigCameras[1].setCameraRigParameter("specs",i.specs),this._rigCameras[1].setCameraRigParameter("frameData",i.frameData),this._rigCameras[1].setCameraRigParameter("parentCamera",i.parentCamera),this._rigCameras[1]._cameraRigParams.vrWorkMatrix=new e.Matrix,this._rigCameras[1].getProjectionMatrix=this._getWebVRProjectionMatrix,this._rigCameras[1].parent=this,this._rigCameras[1]._getViewMatrix=this._getWebVRViewMatrix,r.UseAlternateWebVRRendering&&(this._rigCameras[1]._skipRendering=!0,this._rigCameras[0]._alternateCamera=this._rigCameras[1])}}this._cascadePostProcessesToRigCams(),this.update()}},r.prototype._getVRProjectionMatrix=function(){return e.Matrix.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix},r.prototype._updateCameraRotationMatrix=function(){},r.prototype._updateWebVRCameraRotationMatrix=function(){},r.prototype._getWebVRProjectionMatrix=function(){return e.Matrix.Identity()},r.prototype._getWebVRViewMatrix=function(){return e.Matrix.Identity()},r.prototype.setCameraRigParameter=function(t,r){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[t]=r,"interaxialDistance"===t&&(this._cameraRigParams.stereoHalfAngle=e.Tools.ToRadians(r/.0637))},r.prototype.createRigCamera=function(e,t){return null},r.prototype._updateRigCameras=function(){for(var e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov;this.cameraRigMode===r.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)},r.prototype._setupInputs=function(){},r.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);return t.type=this.getClassName(),this.parent&&(t.parentId=this.parent.id),this.inputs&&this.inputs.serialize(t),e.Animation.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t},r.prototype.clone=function(t){return e.SerializationHelper.Clone(r.GetConstructorFromName(this.getClassName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this)},r.prototype.getDirection=function(t){var r=e.Vector3.Zero();return this.getDirectionToRef(t,r),r},r.prototype.getDirectionToRef=function(t,r){e.Vector3.TransformNormalToRef(t,this.getWorldMatrix(),r)},r.GetConstructorFromName=function(t,r,i,n,s){switch(void 0===n&&(n=0),void 0===s&&(s=!0),t){case"ArcRotateCamera":return function(){return new e.ArcRotateCamera(r,0,0,1,e.Vector3.Zero(),i)};case"DeviceOrientationCamera":return function(){return new e.DeviceOrientationCamera(r,e.Vector3.Zero(),i)};case"FollowCamera":return function(){return new e.FollowCamera(r,e.Vector3.Zero(),i)};case"ArcFollowCamera":return function(){return new e.ArcFollowCamera(r,0,0,1,null,i)};case"GamepadCamera":return function(){return new e.GamepadCamera(r,e.Vector3.Zero(),i)};case"TouchCamera":return function(){return new e.TouchCamera(r,e.Vector3.Zero(),i)};case"VirtualJoysticksCamera":return function(){return new e.VirtualJoysticksCamera(r,e.Vector3.Zero(),i)};case"WebVRFreeCamera":case"WebVRGamepadCamera":return function(){return new e.WebVRFreeCamera(r,e.Vector3.Zero(),i)};case"VRDeviceOrientationFreeCamera":return function(){return new e.VRDeviceOrientationFreeCamera(r,e.Vector3.Zero(),i)};case"VRDeviceOrientationGamepadCamera":return function(){return new e.VRDeviceOrientationGamepadCamera(r,e.Vector3.Zero(),i)};case"AnaglyphArcRotateCamera":return function(){return new e.AnaglyphArcRotateCamera(r,0,0,1,e.Vector3.Zero(),n,i)};case"AnaglyphFreeCamera":return function(){return new e.AnaglyphFreeCamera(r,e.Vector3.Zero(),n,i)};case"AnaglyphGamepadCamera":return function(){return new e.AnaglyphGamepadCamera(r,e.Vector3.Zero(),n,i)};case"AnaglyphUniversalCamera":return function(){return new e.AnaglyphUniversalCamera(r,e.Vector3.Zero(),n,i)};case"StereoscopicArcRotateCamera":return function(){return new e.StereoscopicArcRotateCamera(r,0,0,1,e.Vector3.Zero(),n,s,i)};case"StereoscopicFreeCamera":return function(){return new e.StereoscopicFreeCamera(r,e.Vector3.Zero(),n,s,i)};case"StereoscopicGamepadCamera":return function(){return new e.StereoscopicGamepadCamera(r,e.Vector3.Zero(),n,s,i)};case"StereoscopicUniversalCamera":return function(){return new e.StereoscopicUniversalCamera(r,e.Vector3.Zero(),n,s,i)};case"FreeCamera":default:return function(){return new e.UniversalCamera(r,e.Vector3.Zero(),i)}}},r.prototype.computeWorldMatrix=function(){return this.getWorldMatrix()},r.Parse=function(t,i){var n=t.type,s=r.GetConstructorFromName(n,t.name,i,t.interaxial_distance,t.isStereoscopicSideBySide),o=e.SerializationHelper.Parse(s,t,i);if(t.parentId&&(o._waitingParentId=t.parentId),o.inputs&&(o.inputs.parse(t),o._setupInputs()),o.setPosition&&(o.position.copyFromFloats(0,0,0),o.setPosition(e.Vector3.FromArray(t.position))),t.target&&o.setTarget&&o.setTarget(e.Vector3.FromArray(t.target)),t.cameraRigMode){var a=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{};o.setCameraRigMode(t.cameraRigMode,a)}if(t.animations){for(var h=0;h<t.animations.length;h++){var u=t.animations[h];o.animations.push(e.Animation.Parse(u))}e.Node.ParseAnimationRanges(o,t,i)}return t.autoAnimate&&i.beginAnimation(o,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),o},r._PERSPECTIVE_CAMERA=0,r._ORTHOGRAPHIC_CAMERA=1,r._FOVMODE_VERTICAL_FIXED=0,r._FOVMODE_HORIZONTAL_FIXED=1,r._RIG_MODE_NONE=0,r._RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r._RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r._RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r._RIG_MODE_VR=20,r._RIG_MODE_WEBVR=21,r.ForceAttachControlToAlwaysPreventDefault=!1,r.UseAlternateWebVRRendering=!1,n([e.serializeAsVector3()],r.prototype,"position",void 0),n([e.serializeAsVector3()],r.prototype,"upVector",void 0),n([e.serialize()],r.prototype,"orthoLeft",void 0),n([e.serialize()],r.prototype,"orthoRight",void 0),n([e.serialize()],r.prototype,"orthoBottom",void 0),n([e.serialize()],r.prototype,"orthoTop",void 0),n([e.serialize()],r.prototype,"fov",void 0),n([e.serialize()],r.prototype,"minZ",void 0),n([e.serialize()],r.prototype,"maxZ",void 0),n([e.serialize()],r.prototype,"inertia",void 0),n([e.serialize()],r.prototype,"mode",void 0),n([e.serialize()],r.prototype,"layerMask",void 0),n([e.serialize()],r.prototype,"fovMode",void 0),n([e.serialize()],r.prototype,"cameraRigMode",void 0),n([e.serialize()],r.prototype,"interaxialDistance",void 0),n([e.serialize()],r.prototype,"isStereoscopicSideBySide",void 0),r})(e.Node);e.Camera=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(e){this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderinGroupInfo=null,this._scene=e;for(var r=t.MIN_RENDERINGGROUPS;r<t.MAX_RENDERINGGROUPS;r++)this._autoClearDepthStencil[r]={autoClear:!0,depth:!0,stencil:!0}}return t.prototype._clearDepthStencilBuffer=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0),this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)},t.prototype.render=function(r,i,n,s){var o=this._scene.onRenderingGroupObservable.hasObservers()?this._scene.onRenderingGroupObservable:null,a=null;if(o&&(this._renderinGroupInfo||(this._renderinGroupInfo=new e.RenderingGroupInfo),a=this._renderinGroupInfo,a.scene=this._scene,a.camera=this._scene.activeCamera),s)for(var h=0;h<this._scene.spriteManagers.length;h++){var u=this._scene.spriteManagers[h];this.dispatchSprites(u)}for(var h=t.MIN_RENDERINGGROUPS;h<t.MAX_RENDERINGGROUPS;h++){this._depthStencilBufferAlreadyCleaned=h===t.MIN_RENDERINGGROUPS;var l=this._renderingGroups[h];if(l||o){var c=0;if(o&&a&&(c=Math.pow(2,h),a.renderStage=e.RenderingGroupInfo.STAGE_PRECLEAR,a.renderingGroupId=h,o.notifyObservers(a,c)),t.AUTOCLEAR){var f=this._autoClearDepthStencil[h];f&&f.autoClear&&this._clearDepthStencilBuffer(f.depth,f.stencil)}o&&a&&(a.renderStage=e.RenderingGroupInfo.STAGE_PREOPAQUE,o.notifyObservers(a,c),a.renderStage=e.RenderingGroupInfo.STAGE_PRETRANSPARENT,o.notifyObservers(a,c)),l&&l.render(r,s,n,i),o&&a&&(a.renderStage=e.RenderingGroupInfo.STAGE_POSTTRANSPARENT,o.notifyObservers(a,c))}}},t.prototype.reset=function(){for(var e=t.MIN_RENDERINGGROUPS;e<t.MAX_RENDERINGGROUPS;e++){var r=this._renderingGroups[e];r&&r.prepare()}},t.prototype.dispose=function(){this.freeRenderingGroups(),this._renderingGroups.length=0},t.prototype.freeRenderingGroups=function(){for(var e=t.MIN_RENDERINGGROUPS;e<t.MAX_RENDERINGGROUPS;e++){var r=this._renderingGroups[e];r&&r.dispose()}},t.prototype._prepareRenderingGroup=function(t){void 0===this._renderingGroups[t]&&(this._renderingGroups[t]=new e.RenderingGroup(t,this._scene,this._customOpaqueSortCompareFn[t],this._customAlphaTestSortCompareFn[t],this._customTransparentSortCompareFn[t]))},t.prototype.dispatchSprites=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchSprites(e)},t.prototype.dispatchParticles=function(e){var t=e.renderingGroupId||0;this._prepareRenderingGroup(t),this._renderingGroups[t].dispatchParticles(e)},t.prototype.dispatch=function(e,t,r){void 0===t&&(t=e.getMesh());var i=t.renderingGroupId||0;this._prepareRenderingGroup(i),this._renderingGroups[i].dispatch(e,t,r)},t.prototype.setRenderingOrder=function(e,t,r,i){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=r,this._customTransparentSortCompareFn[e]=i,this._renderingGroups[e]){var n=this._renderingGroups[e];n.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],n.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],n.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}},t.prototype.setRenderingAutoClearDepthStencil=function(e,t,r,i){void 0===r&&(r=!0),void 0===i&&(i=!0),this._autoClearDepthStencil[e]={autoClear:t,depth:r,stencil:i}},t.MAX_RENDERINGGROUPS=4,t.MIN_RENDERINGGROUPS=0,t.AUTOCLEAR=!0,t})();e.RenderingManager=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(t,r,i,n,s){void 0===i&&(i=null),void 0===n&&(n=null),void 0===s&&(s=null),this.index=t,this._opaqueSubMeshes=new e.SmartArray(256),this._transparentSubMeshes=new e.SmartArray(256),this._alphaTestSubMeshes=new e.SmartArray(256),this._depthOnlySubMeshes=new e.SmartArray(256),this._particleSystems=new e.SmartArray(256),this._spriteManagers=new e.SmartArray(256),this._edgesRenderers=new e.SmartArray(16),this._scene=r,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=n,this.transparentSortCompareFn=s}return Object.defineProperty(t.prototype,"opaqueSortCompareFn",{set:function(e){this._opaqueSortCompareFn=e,this._renderOpaque=e?this.renderOpaqueSorted:t.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alphaTestSortCompareFn",{set:function(e){this._alphaTestSortCompareFn=e,this._renderAlphaTest=e?this.renderAlphaTestSorted:t.renderUnsorted},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transparentSortCompareFn",{set:function(e){this._transparentSortCompareFn=e||t.defaultTransparentSortCompare,this._renderTransparent=this.renderTransparentSorted},enumerable:!0,configurable:!0}),t.prototype.render=function(t,r,i,n){if(t)return void t(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);var s=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(s.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),s.setColorWrite(!0)),0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes),0!==this._alphaTestSubMeshes.length&&this._renderAlphaTest(this._alphaTestSubMeshes);var o=s.getStencilBuffer();s.setStencilBuffer(!1),r&&this._renderSprites(),i&&this._renderParticles(n),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),0!==this._transparentSubMeshes.length&&(this._renderTransparent(this._transparentSubMeshes),s.setAlphaMode(e.Engine.ALPHA_DISABLE)),s.setStencilBuffer(!1);for(var a=0;a<this._edgesRenderers.length;a++)this._edgesRenderers.data[a].render();s.setStencilBuffer(o)},t.prototype.renderOpaqueSorted=function(e){return t.renderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)},t.prototype.renderAlphaTestSorted=function(e){return t.renderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)},t.prototype.renderTransparentSorted=function(e){return t.renderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)},t.renderSorted=function(t,r,i,n){for(var s,o=0,a=i?i.globalPosition:e.Vector3.Zero();o<t.length;o++)s=t.data[o],s._alphaIndex=s.getMesh().alphaIndex,s._distanceToCamera=s.getBoundingInfo().boundingSphere.centerWorld.subtract(a).length();var h=t.data.slice(0,t.length);for(r&&h.sort(r),o=0;o<h.length;o++){if(s=h[o],n){var u=s.getMaterial();if(u&&u.needDepthPrePass){var l=u.getScene().getEngine();l.setColorWrite(!1),l.setAlphaMode(e.Engine.ALPHA_DISABLE),s.render(!1),l.setColorWrite(!0)}}s.render(n)}},t.renderUnsorted=function(e){for(var t=0;t<e.length;t++){e.data[t].render(!1)}},t.defaultTransparentSortCompare=function(e,r){return e._alphaIndex>r._alphaIndex?1:e._alphaIndex<r._alphaIndex?-1:t.backToFrontSortCompare(e,r)},t.backToFrontSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0},t.frontToBackSortCompare=function(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0},t.prototype.prepare=function(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this._spriteManagers.reset(),this._edgesRenderers.reset()},t.prototype.dispose=function(){
this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()},t.prototype.dispatch=function(e,t,r){void 0===t&&(t=e.getMesh()),void 0===r&&(r=e.getMaterial()),null!==r&&void 0!==r&&(r.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):r.needAlphaTesting()?(r.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(r.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),null!==t._edgesRenderer&&void 0!==t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.push(t._edgesRenderer))},t.prototype.dispatchSprites=function(e){this._spriteManagers.push(e)},t.prototype.dispatchParticles=function(e){this._particleSystems.push(e)},t.prototype._renderParticles=function(e){if(0!==this._particleSystems.length){var t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(var r=0;r<this._particleSystems.length;r++){var i=this._particleSystems.data[r];if(0!==(t&&t.layerMask&i.layerMask)){var n=i.emitter;n.position&&e&&-1===e.indexOf(n)||this._scene._activeParticles.addCount(i.render(),!1)}}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}},t.prototype._renderSprites=function(){if(this._scene.spritesEnabled&&0!==this._spriteManagers.length){var e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(var t=0;t<this._spriteManagers.length;t++){var r=this._spriteManagers.data[t];0!==(e&&e.layerMask&r.layerMask)&&r.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}},t})();e.RenderingGroup=t})(i||(i={}));var i;!(function(e){var t=(function(){function e(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}return Object.defineProperty(e.prototype,"singleClick",{get:function(){return this._singleClick},set:function(e){this._singleClick=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"doubleClick",{get:function(){return this._doubleClick},set:function(e){this._doubleClick=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasSwiped",{get:function(){return this._hasSwiped},set:function(e){this._hasSwiped=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ignore",{get:function(){return this._ignore},set:function(e){this._ignore=e},enumerable:!0,configurable:!0}),e})(),r=(function(){function e(){}return e.STAGE_PRECLEAR=1,e.STAGE_PREOPAQUE=2,e.STAGE_PRETRANSPARENT=3,e.STAGE_POSTTRANSPARENT=4,e})();e.RenderingGroupInfo=r;var i=(function(){function r(t){this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new e.Color4(.2,.2,.3,1),this.ambientColor=new e.Color3(0,0,0),this._forceWireframe=!1,this._forcePointsCloud=!1,this.forceShowBoundingBoxes=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.preventDefaultOnPointerDown=!0,this.metadata=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new e.Observable,this._onDisposeObserver=null,this.onBeforeRenderObservable=new e.Observable,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new e.Observable,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new e.Observable,this.onAfterAnimationsObservable=new e.Observable,this.onBeforeDrawPhaseObservable=new e.Observable,this.onAfterDrawPhaseObservable=new e.Observable,this.onBeforePhysicsObservable=new e.Observable,this.onAfterPhysicsObservable=new e.Observable,this.onReadyObservable=new e.Observable,this.onBeforeCameraRenderObservable=new e.Observable,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new e.Observable,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new e.Observable,this.onAfterActiveMeshesEvaluationObservable=new e.Observable,this.onBeforeParticlesRenderingObservable=new e.Observable,this.onAfterParticlesRenderingObservable=new e.Observable,this.onBeforeSpritesRenderingObservable=new e.Observable,this.onAfterSpritesRenderingObservable=new e.Observable,this.onDataLoadedObservable=new e.Observable,this.onNewCameraAddedObservable=new e.Observable,this.onCameraRemovedObservable=new e.Observable,this.onNewLightAddedObservable=new e.Observable,this.onLightRemovedObservable=new e.Observable,this.onNewGeometryAddedObservable=new e.Observable,this.onGeometryRemovedObservable=new e.Observable,this.onNewTransformNodeAddedObservable=new e.Observable,this.onTransformNodeRemovedObservable=new e.Observable,this.onNewMeshAddedObservable=new e.Observable,this.onMeshRemovedObservable=new e.Observable,this.onBeforeRenderTargetsRenderObservable=new e.Observable,this.onAfterRenderTargetsRenderObservable=new e.Observable,this.onBeforeStepObservable=new e.Observable,this.onAfterStepObservable=new e.Observable,this.onRenderingGroupObservable=new e.Observable,this.animations=[],this._registeredForLateAnimationBindings=new e.SmartArrayNoDuplicate(256),this.onPrePointerObservable=new e.Observable,this.onPointerObservable=new e.Observable,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this.cameraToUseForPointers=null,this._startingPointerPosition=new e.Vector2(0,0),this._previousStartingPointerPosition=new e.Vector2(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this.onPreKeyboardObservable=new e.Observable,this.onKeyboardObservable=new e.Observable,this._useRightHandedSystem=!1,this._fogEnabled=!0,this._fogMode=r.FOGMODE_NONE,this.fogColor=new e.Color3(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this._shadowsEnabled=!0,this._lightsEnabled=!0,this.lights=new Array,this.cameras=new Array,this.activeCameras=new Array,this.transformNodes=new Array,this.meshes=new Array,this.animationGroups=new Array,this._geometries=new Array,this.materials=new Array,this.multiMaterials=new Array,this._texturesEnabled=!0,this.textures=new Array,this.particlesEnabled=!0,this.particleSystems=new Array,this.spritesEnabled=!0,this.spriteManagers=new Array,this.layers=new Array,this.effectLayers=new Array,this._skeletonsEnabled=!0,this.skeletons=new Array,this.morphTargetManagers=new Array,this.lensFlaresEnabled=!0,this.lensFlareSystems=new Array,this.collisionsEnabled=!0,this.gravity=new e.Vector3(0,-9.807,0),this.postProcessesEnabled=!0,this.postProcesses=new Array,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this.reflectionProbes=new Array,this._actionManagers=new Array,this._meshesForIntersections=new e.SmartArrayNoDuplicate(256),this.proceduralTexturesEnabled=!0,this.proceduralTextures=new Array,this.soundTracks=new Array,this._audioEnabled=!0,this._headphone=!1,this._totalVertices=new e.PerfCounter,this._activeIndices=new e.PerfCounter,this._activeParticles=new e.PerfCounter,this._activeBones=new e.PerfCounter,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._executeWhenReadyTimeoutId=-1,this._intermediateRendering=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._alternateViewUpdateFlag=-1,this._alternateProjectionUpdateFlag=-1,this._toBeDisposed=new e.SmartArray(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new e.SmartArray(256),this._processedMaterials=new e.SmartArray(256),this._renderTargets=new e.SmartArrayNoDuplicate(256),this._activeParticleSystems=new e.SmartArray(256),this._activeSkeletons=new e.SmartArrayNoDuplicate(32),this._softwareSkinnedMeshes=new e.SmartArrayNoDuplicate(32),this._activeAnimatables=new Array,this._transformMatrix=e.Matrix.Zero(),this._useAlternateCameraConfiguration=!1,this._alternateRendering=!1,this.requireLightSorting=!1,this._depthRenderer={},this._activeMeshesFrozen=!1,this._tempPickingRay=e.Ray?e.Ray.Zero():null,this._engine=t||e.Engine.LastCreatedEngine,this._engine.scenes.push(this),this._uid=null,this._renderingManager=new e.RenderingManager(this),e.PostProcessManager&&(this.postProcessManager=new e.PostProcessManager(this)),e.OutlineRenderer&&(this._outlineRenderer=new e.OutlineRenderer(this)),e.Tools.IsWindowObjectExist()&&this.attachControl(),e.SimplificationQueue&&(this.simplificationQueue=new e.SimplificationQueue),this.workerCollisions=!1,this._createUbo(),e.ImageProcessingConfiguration&&(this._imageProcessingConfiguration=new e.ImageProcessingConfiguration)}return Object.defineProperty(r,"FOGMODE_NONE",{get:function(){return r._FOGMODE_NONE},enumerable:!0,configurable:!0}),Object.defineProperty(r,"FOGMODE_EXP",{get:function(){return r._FOGMODE_EXP},enumerable:!0,configurable:!0}),Object.defineProperty(r,"FOGMODE_EXP2",{get:function(){return r._FOGMODE_EXP2},enumerable:!0,configurable:!0}),Object.defineProperty(r,"FOGMODE_LINEAR",{get:function(){return r._FOGMODE_LINEAR},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"environmentTexture",{get:function(){return this._environmentTexture},set:function(t){this._environmentTexture!==t&&(this._environmentTexture=t,this.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"forceWireframe",{get:function(){return this._forceWireframe},set:function(t){this._forceWireframe!==t&&(this._forceWireframe=t,this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"forcePointsCloud",{get:function(){return this._forcePointsCloud},set:function(t){this._forcePointsCloud!==t&&(this._forcePointsCloud=t,this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"beforeRender",{set:function(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"afterRender",{set:function(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"beforeCameraRender",{set:function(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"afterCameraRender",{set:function(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"gamepadManager",{get:function(){return this._gamepadManager||(this._gamepadManager=new e.GamepadManager(this)),this._gamepadManager},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"unTranslatedPointer",{get:function(){return new e.Vector2(this._unTranslatedPointerX,this._unTranslatedPointerY)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"useRightHandedSystem",{get:function(){return this._useRightHandedSystem},set:function(t){this._useRightHandedSystem!==t&&(this._useRightHandedSystem=t,this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),r.prototype.setStepId=function(e){this._currentStepId=e},r.prototype.getStepId=function(){return this._currentStepId},r.prototype.getInternalStep=function(){return this._currentInternalStep},Object.defineProperty(r.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fogMode",{get:function(){return this._fogMode},set:function(t){this._fogMode!==t&&(this._fogMode=t,this.markAllMaterialsAsDirty(e.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"shadowsEnabled",{get:function(){return this._shadowsEnabled},set:function(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this.markAllMaterialsAsDirty(e.Material.LightDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"lightsEnabled",{get:function(){return this._lightsEnabled},set:function(t){this._lightsEnabled!==t&&(this._lightsEnabled=t,this.markAllMaterialsAsDirty(e.Material.LightDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"defaultMaterial",{get:function(){return this._defaultMaterial||(this._defaultMaterial=new e.StandardMaterial("default material",this)),this._defaultMaterial},set:function(e){this._defaultMaterial=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"texturesEnabled",{get:function(){return this._texturesEnabled},set:function(t){this._texturesEnabled!==t&&(this._texturesEnabled=t,this.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"skeletonsEnabled",{get:function(){return this._skeletonsEnabled},set:function(t){this._skeletonsEnabled!==t&&(this._skeletonsEnabled=t,this.markAllMaterialsAsDirty(e.Material.AttributesDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"postProcessRenderPipelineManager",{get:function(){return this._postProcessRenderPipelineManager||(this._postProcessRenderPipelineManager=new e.PostProcessRenderPipelineManager),this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"mainSoundTrack",{get:function(){return this._mainSoundTrack||(this._mainSoundTrack=new e.SoundTrack(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"_isAlternateRenderingEnabled",{get:function(){return this._alternateRendering},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"frustumPlanes",{get:function(){return this._frustumPlanes},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new e.DebugLayer(this)),this._debugLayer},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"workerCollisions",{get:function(){return this._workerCollisions},set:function(t){e.CollisionCoordinatorLegacy&&(t=t&&!!Worker&&!!e.CollisionWorker,this._workerCollisions=t,this.collisionCoordinator&&this.collisionCoordinator.destroy(),this.collisionCoordinator=t?new e.CollisionCoordinatorWorker:new e.CollisionCoordinatorLegacy,this.collisionCoordinator.init(this))},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"meshUnderPointer",{get:function(){return this._pointerOverMesh},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointerX",{get:function(){return this._pointerX},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointerY",{get:function(){return this._pointerY},enumerable:!0,configurable:!0}),r.prototype.getCachedMaterial=function(){return this._cachedMaterial},r.prototype.getCachedEffect=function(){return this._cachedEffect},r.prototype.getCachedVisibility=function(){return this._cachedVisibility},r.prototype.isCachedMaterialInvalid=function(e,t,r){return void 0===r&&(r=1),this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==r},r.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new e.BoundingBoxRenderer(this)),this._boundingBoxRenderer},r.prototype.getOutlineRenderer=function(){return this._outlineRenderer},r.prototype.getEngine=function(){return this._engine},r.prototype.getTotalVertices=function(){return this._totalVertices.current},Object.defineProperty(r.prototype,"totalVerticesPerfCounter",{get:function(){return this._totalVertices},enumerable:!0,configurable:!0}),r.prototype.getActiveIndices=function(){return this._activeIndices.current},Object.defineProperty(r.prototype,"totalActiveIndicesPerfCounter",{get:function(){return this._activeIndices},enumerable:!0,configurable:!0}),r.prototype.getActiveParticles=function(){return this._activeParticles.current},Object.defineProperty(r.prototype,"activeParticlesPerfCounter",{get:function(){return this._activeParticles},enumerable:!0,configurable:!0}),r.prototype.getActiveBones=function(){return this._activeBones.current},Object.defineProperty(r.prototype,"activeBonesPerfCounter",{get:function(){return this._activeBones},enumerable:!0,configurable:!0}),r.prototype.getInterFramePerfCounter=function(){return e.Tools.Warn("getInterFramePerfCounter is deprecated. Please use SceneInstrumentation class"),0},Object.defineProperty(r.prototype,"interFramePerfCounter",{get:function(){return e.Tools.Warn("interFramePerfCounter is deprecated. Please use SceneInstrumentation class"),null},enumerable:!0,configurable:!0}),r.prototype.getLastFrameDuration=function(){return e.Tools.Warn("getLastFrameDuration is deprecated. Please use SceneInstrumentation class"),0},Object.defineProperty(r.prototype,"lastFramePerfCounter",{get:function(){return e.Tools.Warn("lastFramePerfCounter is deprecated. Please use SceneInstrumentation class"),null},enumerable:!0,configurable:!0}),r.prototype.getEvaluateActiveMeshesDuration=function(){return e.Tools.Warn("getEvaluateActiveMeshesDuration is deprecated. Please use SceneInstrumentation class"),0},Object.defineProperty(r.prototype,"evaluateActiveMeshesDurationPerfCounter",{get:function(){return e.Tools.Warn("evaluateActiveMeshesDurationPerfCounter is deprecated. Please use SceneInstrumentation class"),null},enumerable:!0,configurable:!0}),r.prototype.getActiveMeshes=function(){return this._activeMeshes},r.prototype.getRenderTargetsDuration=function(){return e.Tools.Warn("getRenderTargetsDuration is deprecated. Please use SceneInstrumentation class"),0},r.prototype.getRenderDuration=function(){return e.Tools.Warn("getRenderDuration is deprecated. Please use SceneInstrumentation class"),0},Object.defineProperty(r.prototype,"renderDurationPerfCounter",{get:function(){return e.Tools.Warn("renderDurationPerfCounter is deprecated. Please use SceneInstrumentation class"),null},enumerable:!0,configurable:!0}),r.prototype.getParticlesDuration=function(){return e.Tools.Warn("getParticlesDuration is deprecated. Please use SceneInstrumentation class"),0},Object.defineProperty(r.prototype,"particlesDurationPerfCounter",{get:function(){return e.Tools.Warn("particlesDurationPerfCounter is deprecated. Please use SceneInstrumentation class"),null},enumerable:!0,configurable:!0}),r.prototype.getSpritesDuration=function(){return e.Tools.Warn("getSpritesDuration is deprecated. Please use SceneInstrumentation class"),0},Object.defineProperty(r.prototype,"spriteDuractionPerfCounter",{get:function(){return e.Tools.Warn("spriteDuractionPerfCounter is deprecated. Please use SceneInstrumentation class"),null},enumerable:!0,configurable:!0}),r.prototype.getAnimationRatio=function(){return this._animationRatio},r.prototype.getRenderId=function(){return this._renderId},r.prototype.incrementRenderId=function(){this._renderId++},r.prototype._updatePointerPosition=function(e){var t=this._engine.getRenderingCanvasClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)},r.prototype._createUbo=function(){this._sceneUbo=new e.UniformBuffer(this._engine,void 0,!0),this._sceneUbo.addUniform("viewProjection",16),this._sceneUbo.addUniform("view",16)},r.prototype._createAlternateUbo=function(){this._alternateSceneUbo=new e.UniformBuffer(this._engine,void 0,!0),this._alternateSceneUbo.addUniform("viewProjection",16),this._alternateSceneUbo.addUniform("view",16)},r.prototype._pickSpriteButKeepRay=function(e,t,r,i,n,s){var o=this.pickSprite(t,r,i,n,s);return o&&(o.ray=e?e.ray:null),o},r.prototype._setRayOnPointerInfo=function(t){t.pickInfo&&(t.pickInfo.ray||(t.pickInfo.ray=this.createPickingRay(t.event.offsetX,t.event.offsetY,e.Matrix.Identity(),this.activeCamera)))},r.prototype.simulatePointerMove=function(t,r){var i=new PointerEvent("pointermove",r);return this._checkPrePointerObservable(t,i,e.PointerEventTypes.POINTERMOVE)?this:this._processPointerMove(t,i)},r.prototype._processPointerMove=function(t,r){var i=this._engine.getRenderingCanvas();if(!i)return this;if(t&&t.hit&&t.pickedMesh?(this.setPointerOverSprite(null),this.setPointerOverMesh(t.pickedMesh),this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.hasPointerTriggers?this._pointerOverMesh.actionManager.hoverCursor?i.style.cursor=this._pointerOverMesh.actionManager.hoverCursor:i.style.cursor=this.hoverCursor:i.style.cursor=this.defaultCursor):(this.setPointerOverMesh(null),t=this._pickSpriteButKeepRay(t,this._unTranslatedPointerX,this._unTranslatedPointerY,this._spritePredicate,!1,this.cameraToUseForPointers||void 0),t&&t.hit&&t.pickedSprite?(this.setPointerOverSprite(t.pickedSprite),this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.hoverCursor?i.style.cursor=this._pointerOverSprite.actionManager.hoverCursor:i.style.cursor=this.hoverCursor):(this.setPointerOverSprite(null),i.style.cursor=this.defaultCursor)),t){var n="mousewheel"===r.type||"DOMMouseScroll"===r.type?e.PointerEventTypes.POINTERWHEEL:e.PointerEventTypes.POINTERMOVE;if(this.onPointerMove&&this.onPointerMove(r,t,n),this.onPointerObservable.hasObservers()){var s=new e.PointerInfo(n,r,t);this._setRayOnPointerInfo(s),this.onPointerObservable.notifyObservers(s,n)}}return this},r.prototype._checkPrePointerObservable=function(t,r,i){var n=new e.PointerInfoPre(i,r,this._unTranslatedPointerX,this._unTranslatedPointerY);return t&&(n.ray=t.ray),this.onPrePointerObservable.notifyObservers(n,i),!!n.skipOnPointerObservable},r.prototype.simulatePointerDown=function(t,r){var i=new PointerEvent("pointerdown",r);return this._checkPrePointerObservable(t,i,e.PointerEventTypes.POINTERDOWN)?this:this._processPointerDown(t,i)},r.prototype._processPointerDown=function(t,i){var n=this;if(t&&t.hit&&t.pickedMesh){this._pickedDownMesh=t.pickedMesh;var s=t.pickedMesh.actionManager;if(s){if(s.hasPickTriggers)switch(s.processTrigger(e.ActionManager.OnPickDownTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i)),i.button){case 0:s.processTrigger(e.ActionManager.OnLeftPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i));break;case 1:s.processTrigger(e.ActionManager.OnCenterPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i));break;case 2:s.processTrigger(e.ActionManager.OnRightPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i))}s.hasSpecificTrigger(e.ActionManager.OnLongPressTrigger)&&window.setTimeout((function(){var t=n.pick(n._unTranslatedPointerX,n._unTranslatedPointerY,(function(t){return t.isPickable&&t.isVisible&&t.isReady()&&t.actionManager&&t.actionManager.hasSpecificTrigger(e.ActionManager.OnLongPressTrigger)&&t==n._pickedDownMesh}),!1,n.cameraToUseForPointers);t&&t.hit&&t.pickedMesh&&s&&0!==n._totalPointersPressed&&Date.now()-n._startingPointerTime>r.LongPressDelay&&Math.abs(n._startingPointerPosition.x-n._pointerX)<r.DragMovementThreshold&&Math.abs(n._startingPointerPosition.y-n._pointerY)<r.DragMovementThreshold&&(n._startingPointerTime=0,s.processTrigger(e.ActionManager.OnLongPressTrigger,e.ActionEvent.CreateNew(t.pickedMesh,i)))}),r.LongPressDelay)}}if(t){var o=e.PointerEventTypes.POINTERDOWN;if(this.onPointerDown&&this.onPointerDown(i,t,o),this.onPointerObservable.hasObservers()){var a=new e.PointerInfo(o,i,t);this._setRayOnPointerInfo(a),this.onPointerObservable.notifyObservers(a,o)}}return this},r.prototype.simulatePointerUp=function(r,i){var n=new PointerEvent("pointerup",i),s=new t;return s.singleClick=!0,s.ignore=!0,this._checkPrePointerObservable(r,n,e.PointerEventTypes.POINTERUP)?this:this._processPointerUp(r,n,s)},r.prototype._processPointerUp=function(t,r,i){if(t&&t&&t.pickedMesh){if(this._pickedUpMesh=t.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(this.onPointerPick&&this.onPointerPick(r,t),i.singleClick&&!i.ignore&&this.onPointerObservable.hasObservers())){var n=e.PointerEventTypes.POINTERPICK,s=new e.PointerInfo(n,r,t);this._setRayOnPointerInfo(s),this.onPointerObservable.notifyObservers(s,n)}t.pickedMesh.actionManager&&(i.ignore&&t.pickedMesh.actionManager.processTrigger(e.ActionManager.OnPickUpTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r)),i.hasSwiped||i.ignore||!i.singleClick||t.pickedMesh.actionManager.processTrigger(e.ActionManager.OnPickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r)),i.doubleClick&&!i.ignore&&t.pickedMesh.actionManager.hasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)&&t.pickedMesh.actionManager.processTrigger(e.ActionManager.OnDoublePickTrigger,e.ActionEvent.CreateNew(t.pickedMesh,r)))}this._pickedDownMesh&&this._pickedDownMesh.actionManager&&this._pickedDownMesh.actionManager.hasSpecificTrigger(e.ActionManager.OnPickOutTrigger)&&this._pickedDownMesh!==this._pickedUpMesh&&this._pickedDownMesh.actionManager.processTrigger(e.ActionManager.OnPickOutTrigger,e.ActionEvent.CreateNew(this._pickedDownMesh,r));var o=e.PointerEventTypes.POINTERUP;if(this.onPointerObservable.hasObservers())if(i.ignore){var s=new e.PointerInfo(o,r,t);this._setRayOnPointerInfo(s),this.onPointerObservable.notifyObservers(s,o)}else if(!i.hasSwiped){if(i.singleClick&&this.onPointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERTAP)){var a=e.PointerEventTypes.POINTERTAP,s=new e.PointerInfo(a,r,t);this._setRayOnPointerInfo(s),this.onPointerObservable.notifyObservers(s,a)}if(i.doubleClick&&this.onPointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)){var h=e.PointerEventTypes.POINTERDOUBLETAP,s=new e.PointerInfo(h,r,t);this._setRayOnPointerInfo(s),this.onPointerObservable.notifyObservers(s,h)}}return this.onPointerUp&&this.onPointerUp(r,t,o),this},r.prototype.isPointerCaptured=function(e){return void 0===e&&(e=0),this._pointerCaptures[e]},r.prototype.attachControl=function(i,n,s){var o=this;void 0===i&&(i=!0),void 0===n&&(n=!0),void 0===s&&(s=!0),this._initActionManager=function(e,t){if(!o._meshPickProceed){var r=o.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,o.pointerDownPredicate,!1,o.cameraToUseForPointers);o._currentPickResult=r,r&&(e=r.hit&&r.pickedMesh?r.pickedMesh.actionManager:null),o._meshPickProceed=!0}return e},this._delayedSimpleClick=function(e,t,i){(Date.now()-o._previousStartingPointerTime>r.DoubleClickDelay&&!o._doubleClickOccured||e!==o._previousButtonPressed)&&(o._doubleClickOccured=!1,t.singleClick=!0,t.ignore=!1,i(t,o._currentPickResult))},this._initClickEvent=function(i,n,s,a){var h=new t;o._currentPickResult=null;var u=null,l=i.hasSpecificMask(e.PointerEventTypes.POINTERPICK)||n.hasSpecificMask(e.PointerEventTypes.POINTERPICK)||i.hasSpecificMask(e.PointerEventTypes.POINTERTAP)||n.hasSpecificMask(e.PointerEventTypes.POINTERTAP)||i.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)||n.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP);if(!l&&e.ActionManager&&e.ActionManager.HasPickTriggers&&(u=o._initActionManager(u,h))&&(l=u.hasPickTriggers),l){var c=s.button;if(h.hasSwiped=Math.abs(o._startingPointerPosition.x-o._pointerX)>r.DragMovementThreshold||Math.abs(o._startingPointerPosition.y-o._pointerY)>r.DragMovementThreshold,!h.hasSwiped){var f=!r.ExclusiveDoubleClickMode;f||(f=!i.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)&&!n.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP))&&!e.ActionManager.HasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)&&(u=o._initActionManager(u,h))&&(f=!u.hasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)),f?(Date.now()-o._previousStartingPointerTime>r.DoubleClickDelay||c!==o._previousButtonPressed)&&(h.singleClick=!0,a(h,o._currentPickResult)):(o._previousDelayedSimpleClickTimeout=o._delayedSimpleClickTimeout,o._delayedSimpleClickTimeout=window.setTimeout(o._delayedSimpleClick.bind(o,c,h,a),r.DoubleClickDelay));var d=i.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)||n.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP);!d&&e.ActionManager.HasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)&&(u=o._initActionManager(u,h))&&(d=u.hasSpecificTrigger(e.ActionManager.OnDoublePickTrigger)),d&&(c===o._previousButtonPressed&&Date.now()-o._previousStartingPointerTime<r.DoubleClickDelay&&!o._doubleClickOccured?!h.hasSwiped&&Math.abs(o._previousStartingPointerPosition.x-o._startingPointerPosition.x)<r.DragMovementThreshold&&Math.abs(o._previousStartingPointerPosition.y-o._startingPointerPosition.y)<r.DragMovementThreshold?(o._previousStartingPointerTime=0,o._doubleClickOccured=!0,h.doubleClick=!0,h.ignore=!1,r.ExclusiveDoubleClickMode&&o._previousDelayedSimpleClickTimeout&&clearTimeout(o._previousDelayedSimpleClickTimeout),o._previousDelayedSimpleClickTimeout=o._delayedSimpleClickTimeout,a(h,o._currentPickResult)):(o._doubleClickOccured=!1,o._previousStartingPointerTime=o._startingPointerTime,o._previousStartingPointerPosition.x=o._startingPointerPosition.x,o._previousStartingPointerPosition.y=o._startingPointerPosition.y,o._previousButtonPressed=c,r.ExclusiveDoubleClickMode?(o._previousDelayedSimpleClickTimeout&&clearTimeout(o._previousDelayedSimpleClickTimeout),o._previousDelayedSimpleClickTimeout=o._delayedSimpleClickTimeout,a(h,o._previousPickResult)):a(h,o._currentPickResult)):(o._doubleClickOccured=!1,o._previousStartingPointerTime=o._startingPointerTime,o._previousStartingPointerPosition.x=o._startingPointerPosition.x,o._previousStartingPointerPosition.y=o._startingPointerPosition.y,o._previousButtonPressed=c))}}h.ignore=!0,a(h,o._currentPickResult)},this._spritePredicate=function(e){return e.isPickable&&e.actionManager&&e.actionManager.hasPointerTriggers},this._onPointerMove=function(t){if(o._updatePointerPosition(t),!o._checkPrePointerObservable(null,t,"mousewheel"===t.type||"DOMMouseScroll"===t.type?e.PointerEventTypes.POINTERWHEEL:e.PointerEventTypes.POINTERMOVE)&&(o.cameraToUseForPointers||o.activeCamera)){o.pointerMovePredicate||(o.pointerMovePredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||o.constantlyUpdateMeshUnderPointer||null!==e.actionManager&&void 0!==e.actionManager)});var r=o.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,o.pointerMovePredicate,!1,o.cameraToUseForPointers);o._processPointerMove(r,t)}},
this._onPointerDown=function(t){if(o._totalPointersPressed++,o._pickedDownMesh=null,o._meshPickProceed=!1,o._updatePointerPosition(t),o.preventDefaultOnPointerDown&&u&&(t.preventDefault(),u.focus()),!o._checkPrePointerObservable(null,t,e.PointerEventTypes.POINTERDOWN)&&(o.cameraToUseForPointers||o.activeCamera)){o._pointerCaptures[t.pointerId]=!0,o._startingPointerPosition.x=o._pointerX,o._startingPointerPosition.y=o._pointerY,o._startingPointerTime=Date.now(),o.pointerDownPredicate||(o.pointerDownPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()}),o._pickedDownMesh=null;var r=o.pick(o._unTranslatedPointerX,o._unTranslatedPointerY,o.pointerDownPredicate,!1,o.cameraToUseForPointers);if(o._processPointerDown(r,t),o._pickedDownSprite=null,o.spriteManagers.length>0&&(r=o.pickSprite(o._unTranslatedPointerX,o._unTranslatedPointerY,o._spritePredicate,!1,o.cameraToUseForPointers||void 0))&&r.hit&&r.pickedSprite&&r.pickedSprite.actionManager){switch(o._pickedDownSprite=r.pickedSprite,t.button){case 0:r.pickedSprite.actionManager.processTrigger(e.ActionManager.OnLeftPickTrigger,e.ActionEvent.CreateNewFromSprite(r.pickedSprite,o,t));break;case 1:r.pickedSprite.actionManager.processTrigger(e.ActionManager.OnCenterPickTrigger,e.ActionEvent.CreateNewFromSprite(r.pickedSprite,o,t));break;case 2:r.pickedSprite.actionManager.processTrigger(e.ActionManager.OnRightPickTrigger,e.ActionEvent.CreateNewFromSprite(r.pickedSprite,o,t))}r.pickedSprite.actionManager&&r.pickedSprite.actionManager.processTrigger(e.ActionManager.OnPickDownTrigger,e.ActionEvent.CreateNewFromSprite(r.pickedSprite,o,t))}}},this._onPointerUp=function(t){0!==o._totalPointersPressed&&(o._totalPointersPressed--,o._pickedUpMesh=null,o._meshPickProceed=!1,o._updatePointerPosition(t),o._initClickEvent(o.onPrePointerObservable,o.onPointerObservable,t,(function(i,n){if(o.onPrePointerObservable.hasObservers())if(i.ignore){if(o._checkPrePointerObservable(null,t,e.PointerEventTypes.POINTERUP))return}else if(!i.hasSwiped){if(i.singleClick&&o.onPrePointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERTAP)&&o._checkPrePointerObservable(null,t,e.PointerEventTypes.POINTERTAP))return;if(i.doubleClick&&o.onPrePointerObservable.hasSpecificMask(e.PointerEventTypes.POINTERDOUBLETAP)&&o._checkPrePointerObservable(null,t,e.PointerEventTypes.POINTERDOUBLETAP))return}if(o.cameraToUseForPointers||o.activeCamera){if(o._pointerCaptures[t.pointerId]=!1,o.pointerUpPredicate||(o.pointerUpPredicate=function(e){return e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()}),!o._meshPickProceed&&(e.ActionManager&&e.ActionManager.HasTriggers||o.onPointerObservable.hasObservers())&&o._initActionManager(null,i),n||(n=o._currentPickResult),o._processPointerUp(n,t,i),!i.ignore&&o.spriteManagers.length>0){var s=o.pickSprite(o._unTranslatedPointerX,o._unTranslatedPointerY,o._spritePredicate,!1,o.cameraToUseForPointers||void 0);s&&(s.hit&&s.pickedSprite&&s.pickedSprite.actionManager&&(s.pickedSprite.actionManager.processTrigger(e.ActionManager.OnPickUpTrigger,e.ActionEvent.CreateNewFromSprite(s.pickedSprite,o,t)),s.pickedSprite.actionManager&&Math.abs(o._startingPointerPosition.x-o._pointerX)<r.DragMovementThreshold&&Math.abs(o._startingPointerPosition.y-o._pointerY)<r.DragMovementThreshold&&s.pickedSprite.actionManager.processTrigger(e.ActionManager.OnPickTrigger,e.ActionEvent.CreateNewFromSprite(s.pickedSprite,o,t))),o._pickedDownSprite&&o._pickedDownSprite.actionManager&&o._pickedDownSprite!==s.pickedSprite&&o._pickedDownSprite.actionManager.processTrigger(e.ActionManager.OnPickOutTrigger,e.ActionEvent.CreateNewFromSprite(o._pickedDownSprite,o,t)))}o._previousPickResult=o._currentPickResult}})))},this._onKeyDown=function(t){var r=e.KeyboardEventTypes.KEYDOWN;if(o.onPreKeyboardObservable.hasObservers()){var i=new e.KeyboardInfoPre(r,t);if(o.onPreKeyboardObservable.notifyObservers(i,r),i.skipOnPointerObservable)return}if(o.onKeyboardObservable.hasObservers()){var i=new e.KeyboardInfo(r,t);o.onKeyboardObservable.notifyObservers(i,r)}o.actionManager&&o.actionManager.processTrigger(e.ActionManager.OnKeyDownTrigger,e.ActionEvent.CreateNewFromScene(o,t))},this._onKeyUp=function(t){var r=e.KeyboardEventTypes.KEYUP;if(o.onPreKeyboardObservable.hasObservers()){var i=new e.KeyboardInfoPre(r,t);if(o.onPreKeyboardObservable.notifyObservers(i,r),i.skipOnPointerObservable)return}if(o.onKeyboardObservable.hasObservers()){var i=new e.KeyboardInfo(r,t);o.onKeyboardObservable.notifyObservers(i,r)}o.actionManager&&o.actionManager.processTrigger(e.ActionManager.OnKeyUpTrigger,e.ActionEvent.CreateNewFromScene(o,t))};var a=this.getEngine();this._onCanvasFocusObserver=a.onCanvasFocusObservable.add((function(){u&&(u.addEventListener("keydown",o._onKeyDown,!1),u.addEventListener("keyup",o._onKeyUp,!1))})),this._onCanvasBlurObserver=a.onCanvasBlurObservable.add((function(){u&&(u.removeEventListener("keydown",o._onKeyDown),u.removeEventListener("keyup",o._onKeyUp))}));var h=e.Tools.GetPointerPrefix(),u=this._engine.getRenderingCanvas();u&&(s&&(u.addEventListener(h+"move",this._onPointerMove,!1),u.addEventListener("mousewheel",this._onPointerMove,!1),u.addEventListener("DOMMouseScroll",this._onPointerMove,!1)),n&&u.addEventListener(h+"down",this._onPointerDown,!1),i&&window.addEventListener(h+"up",this._onPointerUp,!1),u.tabIndex=1)},r.prototype.detachControl=function(){var t=this.getEngine(),r=e.Tools.GetPointerPrefix(),i=t.getRenderingCanvas();i&&(i.removeEventListener(r+"move",this._onPointerMove),i.removeEventListener(r+"down",this._onPointerDown),window.removeEventListener(r+"up",this._onPointerUp),this._onCanvasBlurObserver&&t.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onCanvasFocusObserver&&t.onCanvasFocusObservable.remove(this._onCanvasFocusObserver),i.removeEventListener("mousewheel",this._onPointerMove),i.removeEventListener("DOMMouseScroll",this._onPointerMove),i.removeEventListener("keydown",this._onKeyDown),i.removeEventListener("keyup",this._onKeyUp),this.onKeyboardObservable.clear(),this.onPreKeyboardObservable.clear(),this.onPointerObservable.clear(),this.onPrePointerObservable.clear())},r.prototype.isReady=function(){if(this._isDisposed)return!1;if(this._pendingData.length>0)return!1;var t,r=this.getEngine();for(t=0;t<this._geometries.length;t++){if(this._geometries[t].delayLoadState===e.Engine.DELAYLOADSTATE_LOADING)return!1}for(t=0;t<this.meshes.length;t++){var i=this.meshes[t];if(i.isEnabled()&&(i.subMeshes&&0!==i.subMeshes.length)){if(!i.isReady(!0))return!1;for(var n="InstancedMesh"===i.getClassName()||r.getCaps().instancedArrays&&i.instances.length>0,s=0,o=this.effectLayers;s<o.length;s++){var a=o[s];if(a.hasMesh(i))for(var h=0,u=i.subMeshes;h<u.length;h++){var l=u[h];if(!a.isReady(l,n))return!1}}}}if(this.activeCameras&&this.activeCameras.length>0)for(var c=0,f=this.activeCameras;c<f.length;c++){var d=f[c];if(!d.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(var p=0,_=this.particleSystems;p<_.length;p++){if(!_[p].isReady())return!1}return!0},r.prototype.resetCachedMaterial=function(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null},r.prototype.registerBeforeRender=function(e){this.onBeforeRenderObservable.add(e)},r.prototype.unregisterBeforeRender=function(e){this.onBeforeRenderObservable.removeCallback(e)},r.prototype.registerAfterRender=function(e){this.onAfterRenderObservable.add(e)},r.prototype.unregisterAfterRender=function(e){this.onAfterRenderObservable.removeCallback(e)},r.prototype._executeOnceBeforeRender=function(e){var t=this,r=function(){e(),setTimeout((function(){t.unregisterBeforeRender(r)}))};this.registerBeforeRender(r)},r.prototype.executeOnceBeforeRender=function(e,t){var r=this;void 0!==t?setTimeout((function(){r._executeOnceBeforeRender(e)}),t):this._executeOnceBeforeRender(e)},r.prototype._addPendingData=function(e){this._pendingData.push(e)},r.prototype._removePendingData=function(e){var t=this.isLoading,r=this._pendingData.indexOf(e);-1!==r&&this._pendingData.splice(r,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)},r.prototype.getWaitingItemsCount=function(){return this._pendingData.length},Object.defineProperty(r.prototype,"isLoading",{get:function(){return this._pendingData.length>0},enumerable:!0,configurable:!0}),r.prototype.executeWhenReady=function(e){var t=this;this.onReadyObservable.add(e),-1===this._executeWhenReadyTimeoutId&&(this._executeWhenReadyTimeoutId=setTimeout((function(){t._checkIsReady()}),150))},r.prototype.whenReadyAsync=function(){var e=this;return new Promise(function(t){e.executeWhenReady((function(){t()}))})},r.prototype._checkIsReady=function(){var e=this;if(this.isReady())return this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),void(this._executeWhenReadyTimeoutId=-1);this._executeWhenReadyTimeoutId=setTimeout((function(){e._checkIsReady()}),150)},r.prototype.beginWeightedAnimation=function(e,t,r,i,n,s,o,a){void 0===i&&(i=1),void 0===s&&(s=1);var h=this.beginAnimation(e,t,r,n,s,o,a,!1);return h.weight=i,h},r.prototype.beginAnimation=function(t,r,i,n,s,o,a,h){if(void 0===s&&(s=1),void 0===h&&(h=!0),r>i&&s>0&&(s*=-1),h&&this.stopAnimation(t),a||(a=new e.Animatable(this,t,r,i,n,s,o)),t.animations&&a.appendAnimations(t,t.animations),t.getAnimatables)for(var u=t.getAnimatables(),l=0;l<u.length;l++)this.beginAnimation(u[l],r,i,n,s,o,a,h);return a.reset(),a},r.prototype.beginDirectAnimation=function(t,r,i,n,s,o,a){return void 0===o&&(o=1),new e.Animatable(this,t,i,n,s,o,a,r)},r.prototype.beginDirectHierarchyAnimation=function(e,t,r,i,n,s,o,a){var h=e.getDescendants(t),u=[];u.push(this.beginDirectAnimation(e,r,i,n,s,o,a));for(var l=0,c=h;l<c.length;l++){var f=c[l];u.push(this.beginDirectAnimation(f,r,i,n,s,o,a))}return u},r.prototype.getAnimatableByTarget=function(e){for(var t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},r.prototype.getAllAnimatablesByTarget=function(e){for(var t=[],r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].target===e&&t.push(this._activeAnimatables[r]);return t},Object.defineProperty(r.prototype,"animatables",{get:function(){return this._activeAnimatables},enumerable:!0,configurable:!0}),r.prototype.stopAnimation=function(e,t){for(var r=this.getAllAnimatablesByTarget(e),i=0,n=r;i<n.length;i++){n[i].stop(t)}},r.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(var e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop();this._activeAnimatables=[]}for(var t=0,r=this.animationGroups;t<r.length;t++){r[t].stop()}},r.prototype._animate=function(){if(this.animationsEnabled&&0!==this._activeAnimatables.length){var t=e.Tools.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=t}var r=this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale;this._animationTime+=r,this._animationTimeLast=t;for(var i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i]._animate(this._animationTime);this._processLateAnimationBindings()}},r.prototype._registerTargetForLateAnimationBinding=function(e,t){var r=e.target;this._registeredForLateAnimationBindings.pushNoDuplicate(r),r._lateAnimationHolders||(r._lateAnimationHolders={}),r._lateAnimationHolders[e.targetPath]||(r._lateAnimationHolders[e.targetPath]={totalWeight:0,animations:[],originalValue:t}),r._lateAnimationHolders[e.targetPath].animations.push(e),r._lateAnimationHolders[e.targetPath].totalWeight+=e.weight},r.prototype._processLateAnimationBindingsForMatrices=function(t){var r=1,i=e.Tmp.Vector3[0],n=e.Tmp.Vector3[1],s=e.Tmp.Quaternion[0],o=0,a=t.animations[0],h=t.originalValue,u=1;if(t.totalWeight<1)h.decompose(n,s,i),u=1-t.totalWeight;else if(o=1,r=t.totalWeight,a.currentValue.decompose(n,s,i),1==(u=a.weight/r))return a.currentValue;n.scaleInPlace(u),i.scaleInPlace(u),s.scaleInPlace(u);for(var l=o;l<t.animations.length;l++){var c=t.animations[l],u=c.weight/r,f=e.Tmp.Vector3[2],d=e.Tmp.Vector3[3],p=e.Tmp.Quaternion[1];c.currentValue.decompose(d,p,f),d.scaleAndAddToRef(u,n),p.scaleAndAddToRef(u,s),f.scaleAndAddToRef(u,i)}return e.Matrix.ComposeToRef(n,s,i,a._workValue),a._workValue},r.prototype._processLateAnimationBindingsForQuaternions=function(t){var r=t.animations[0],i=t.originalValue;if(1===t.animations.length)return e.Quaternion.Slerp(i,r.currentValue,Math.min(1,t.totalWeight));var n,s,o=1;if(t.totalWeight<1){var a=1-t.totalWeight;n=[],s=[],n.push(i),s.push(a)}else{if(2===t.animations.length)return e.Quaternion.Slerp(t.animations[0].currentValue,t.animations[1].currentValue,t.animations[1].weight/t.totalWeight);n=[],s=[],o=t.totalWeight}for(var h=0;h<t.animations.length;h++){var u=t.animations[h];n.push(u.currentValue),s.push(u.weight/o)}for(var l=0,c=null,f=0;f<n.length;)c?(l+=s[f],e.Quaternion.SlerpToRef(c,n[f],s[f]/l,c),f++):(c=e.Quaternion.Slerp(n[f],n[f+1],s[f+1]/(s[f]+s[f+1])),l=s[f]+s[f+1],f+=2);return c},r.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(var t=0;t<this._registeredForLateAnimationBindings.length;t++){var r=this._registeredForLateAnimationBindings.data[t];for(var i in r._lateAnimationHolders){var n=r._lateAnimationHolders[i],s=n.animations[0],o=n.originalValue,a=e.Animation.AllowMatrixDecomposeForInterpolation&&o.m,h=void 0;if(a)h=this._processLateAnimationBindingsForMatrices(n);else{if(void 0!==o.w)h=this._processLateAnimationBindingsForQuaternions(n);else{var u=0,l=1;if(n.totalWeight<1)h=o.scale?o.scale(1-n.totalWeight):o*(1-n.totalWeight);else{l=n.totalWeight;var c=s.weight/l;h=1!==c?s.currentValue.scale?s.currentValue.scale(c):s.currentValue*c:s.currentValue,u=1}for(var f=u;f<n.animations.length;f++){var d=n.animations[f],p=d.weight/l;d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(p,h):h+=d.currentValue*p}}}r[i]=h}r._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},r.prototype._switchToAlternateCameraConfiguration=function(e){this._useAlternateCameraConfiguration=e},r.prototype.getViewMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateViewMatrix:this._viewMatrix},r.prototype.getProjectionMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateProjectionMatrix:this._projectionMatrix},r.prototype.getTransformMatrix=function(){return this._useAlternateCameraConfiguration?this._alternateTransformMatrix:this._transformMatrix},r.prototype.setTransformMatrix=function(t,r){if(this._viewUpdateFlag!==t.updateFlag||this._projectionUpdateFlag!==r.updateFlag){if(this._viewUpdateFlag=t.updateFlag,this._projectionUpdateFlag=r.updateFlag,this._viewMatrix=t,this._projectionMatrix=r,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?e.Frustum.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=e.Frustum.GetPlanes(this._transformMatrix),this.activeCamera&&this.activeCamera._alternateCamera){var i=this.activeCamera._alternateCamera;i.getViewMatrix().multiplyToRef(i.getProjectionMatrix(),e.Tmp.Matrix[0]),e.Frustum.GetRightPlaneToRef(e.Tmp.Matrix[0],this._frustumPlanes[3])}this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.update())}},r.prototype._setAlternateTransformMatrix=function(t,r){this._alternateViewUpdateFlag===t.updateFlag&&this._alternateProjectionUpdateFlag===r.updateFlag||(this._alternateViewUpdateFlag=t.updateFlag,this._alternateProjectionUpdateFlag=r.updateFlag,this._alternateViewMatrix=t,this._alternateProjectionMatrix=r,this._alternateTransformMatrix||(this._alternateTransformMatrix=e.Matrix.Zero()),this._alternateViewMatrix.multiplyToRef(this._alternateProjectionMatrix,this._alternateTransformMatrix),this._alternateSceneUbo||this._createAlternateUbo(),this._alternateSceneUbo.useUbo&&(this._alternateSceneUbo.updateMatrix("viewProjection",this._alternateTransformMatrix),this._alternateSceneUbo.updateMatrix("view",this._alternateViewMatrix),this._alternateSceneUbo.update()))},r.prototype.getSceneUniformBuffer=function(){return this._useAlternateCameraConfiguration?this._alternateSceneUbo:this._sceneUbo},r.prototype.getUniqueId=function(){var e=r._uniqueIdCounter;return r._uniqueIdCounter++,e},r.prototype.addMesh=function(e,t){var r=this;void 0===t&&(t=!1),this.meshes.push(e),this.collisionCoordinator&&this.collisionCoordinator.onMeshAdded(e),e._resyncLightSources(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((function(e){r.addMesh(e)}))},r.prototype.removeMesh=function(e,t){var r=this;void 0===t&&(t=!1);var i=this.meshes.indexOf(e);return-1!==i&&this.meshes.splice(i,1),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach((function(e){r.removeMesh(e)})),i},r.prototype.addTransformNode=function(e){this.transformNodes.push(e),this.onNewTransformNodeAddedObservable.notifyObservers(e)},r.prototype.removeTransformNode=function(e){var t=this.transformNodes.indexOf(e);return-1!==t&&this.transformNodes.splice(t,1),this.onTransformNodeRemovedObservable.notifyObservers(e),t},r.prototype.removeSkeleton=function(e){var t=this.skeletons.indexOf(e);return-1!==t&&this.skeletons.splice(t,1),t},r.prototype.removeMorphTargetManager=function(e){var t=this.morphTargetManagers.indexOf(e);return-1!==t&&this.morphTargetManagers.splice(t,1),t},r.prototype.removeLight=function(e){var t=this.lights.indexOf(e);if(-1!==t){for(var r=0,i=this.meshes;r<i.length;r++){i[r]._removeLightSource(e)}this.lights.splice(t,1),this.sortLightsByPriority()}return this.onLightRemovedObservable.notifyObservers(e),t},r.prototype.removeCamera=function(e){var t=this.cameras.indexOf(e);-1!==t&&this.cameras.splice(t,1);var r=this.activeCameras.indexOf(e);return-1!==r&&this.activeCameras.splice(r,1),this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t},r.prototype.removeParticleSystem=function(e){var t=this.particleSystems.indexOf(e);return-1!==t&&this.particleSystems.splice(t,1),t},r.prototype.removeAnimation=function(e){var t=this.animations.indexOf(e);return-1!==t&&this.animations.splice(t,1),t},r.prototype.removeAnimationGroup=function(e){var t=this.animationGroups.indexOf(e);return-1!==t&&this.animationGroups.splice(t,1),t},r.prototype.removeMultiMaterial=function(e){var t=this.multiMaterials.indexOf(e);return-1!==t&&this.multiMaterials.splice(t,1),t},r.prototype.removeMaterial=function(e){var t=this.materials.indexOf(e);return-1!==t&&this.materials.splice(t,1),t},r.prototype.removeLensFlareSystem=function(e){var t=this.lensFlareSystems.indexOf(e);return-1!==t&&this.lensFlareSystems.splice(t,1),t},r.prototype.removeActionManager=function(e){var t=this._actionManagers.indexOf(e);return-1!==t&&this._actionManagers.splice(t,1),t},r.prototype.removeEffectLayer=function(e){var t=this.effectLayers.indexOf(e);return-1!==t&&this.effectLayers.splice(t,1),t},r.prototype.removeTexture=function(e){var t=this.textures.indexOf(e);return-1!==t&&this.textures.splice(t,1),t},r.prototype.addLight=function(e){this.lights.push(e),this.sortLightsByPriority();for(var t=0,r=this.meshes;t<r.length;t++){var i=r[t];-1===i._lightSources.indexOf(e)&&(i._lightSources.push(e),i._resyncLightSources())}this.onNewLightAddedObservable.notifyObservers(e)},r.prototype.sortLightsByPriority=function(){this.requireLightSorting&&this.lights.sort(e.Light.CompareLightsPriority)},r.prototype.addCamera=function(e){this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e)},r.prototype.addSkeleton=function(e){this.skeletons.push(e)},r.prototype.addParticleSystem=function(e){this.particleSystems.push(e)},r.prototype.addAnimation=function(e){this.animations.push(e)},r.prototype.addAnimationGroup=function(e){this.animationGroups.push(e)},r.prototype.addMultiMaterial=function(e){this.multiMaterials.push(e)},r.prototype.addMaterial=function(e){this.materials.push(e)},r.prototype.addMorphTargetManager=function(e){this.morphTargetManagers.push(e)},r.prototype.addGeometry=function(e){this._geometries.push(e)},r.prototype.addLensFlareSystem=function(e){this.lensFlareSystems.push(e)},r.prototype.addEffectLayer=function(e){this.effectLayers.push(e)},r.prototype.addActionManager=function(e){this._actionManagers.push(e)},r.prototype.addTexture=function(e){this.textures.push(e)},r.prototype.switchActiveCamera=function(e,t){void 0===t&&(t=!0);var r=this._engine.getRenderingCanvas();r&&(this.activeCamera&&this.activeCamera.detachControl(r),this.activeCamera=e,t&&e.attachControl(r))},r.prototype.setActiveCameraByID=function(e){var t=this.getCameraByID(e);return t?(this.activeCamera=t,t):null},r.prototype.setActiveCameraByName=function(e){var t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null},r.prototype.getAnimationGroupByName=function(e){for(var t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null},r.prototype.getMaterialByID=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].id===e)return this.materials[t];return null},r.prototype.getMaterialByName=function(e){for(var t=0;t<this.materials.length;t++)if(this.materials[t].name===e)return this.materials[t];return null},r.prototype.getLensFlareSystemByName=function(e){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===e)return this.lensFlareSystems[t];return null},r.prototype.getLensFlareSystemByID=function(e){for(var t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===e)return this.lensFlareSystems[t];return null},r.prototype.getCameraByID=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null},r.prototype.getCameraByUniqueID=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null},r.prototype.getCameraByName=function(e){for(var t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null},r.prototype.getBoneByID=function(e){for(var t=0;t<this.skeletons.length;t++)for(var r=this.skeletons[t],i=0;i<r.bones.length;i++)if(r.bones[i].id===e)return r.bones[i];return null},r.prototype.getBoneByName=function(e){for(var t=0;t<this.skeletons.length;t++)for(var r=this.skeletons[t],i=0;i<r.bones.length;i++)if(r.bones[i].name===e)return r.bones[i];return null},r.prototype.getLightByName=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null},r.prototype.getLightByID=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null},r.prototype.getLightByUniqueID=function(e){for(var t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null},r.prototype.getParticleSystemByID=function(e){for(var t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null},r.prototype.getGeometryByID=function(e){for(var t=0;t<this._geometries.length;t++)if(this._geometries[t].id===e)return this._geometries[t];return null},r.prototype.pushGeometry=function(e,t){return!(!t&&this.getGeometryByID(e.id))&&(this._geometries.push(e),this.collisionCoordinator&&this.collisionCoordinator.onGeometryAdded(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)},r.prototype.removeGeometry=function(e){var t=this._geometries.indexOf(e);return t>-1&&(this._geometries.splice(t,1),this.collisionCoordinator&&this.collisionCoordinator.onGeometryDeleted(e),this.onGeometryRemovedObservable.notifyObservers(e),!0)},r.prototype.getGeometries=function(){return this._geometries},r.prototype.getMeshByID=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null},r.prototype.getMeshesByID=function(e){return this.meshes.filter((function(t){return t.id===e}))},r.prototype.getTransformNodeByID=function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null},r.prototype.getTransformNodesByID=function(e){return this.transformNodes.filter((function(t){return t.id===e}))},r.prototype.getMeshByUniqueID=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null},r.prototype.getLastMeshByID=function(e){for(var t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null},r.prototype.getLastEntryByID=function(e){var t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null},r.prototype.getNodeByID=function(e){var t=this.getMeshByID(e);if(t)return t;var r=this.getLightByID(e);if(r)return r;var i=this.getCameraByID(e);return i||this.getBoneByID(e)},r.prototype.getNodeByName=function(e){var t=this.getMeshByName(e);if(t)return t;var r=this.getLightByName(e);if(r)return r;var i=this.getCameraByName(e);return i||this.getBoneByName(e)},r.prototype.getMeshByName=function(e){for(var t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null},r.prototype.getTransformNodeByName=function(e){for(var t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null},r.prototype.getSoundByName=function(t){var r;if(e.AudioEngine){for(r=0;r<this.mainSoundTrack.soundCollection.length;r++)if(this.mainSoundTrack.soundCollection[r].name===t)return this.mainSoundTrack.soundCollection[r];for(var i=0;i<this.soundTracks.length;i++)for(r=0;r<this.soundTracks[i].soundCollection.length;r++)if(this.soundTracks[i].soundCollection[r].name===t)return this.soundTracks[i].soundCollection[r]}return null},r.prototype.getLastSkeletonByID=function(e){for(var t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null},r.prototype.getSkeletonById=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null},r.prototype.getSkeletonByName=function(e){for(var t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null},r.prototype.getMorphTargetManagerById=function(e){for(var t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null},r.prototype.isActiveMesh=function(e){return-1!==this._activeMeshes.indexOf(e)},r.prototype.getHighlightLayerByName=function(t){for(var r=0;r<this.effectLayers.length;r++)if(this.effectLayers[r].name===t&&this.effectLayers[r].getEffectName()===e.HighlightLayer.EffectName)return this.effectLayers[r];return null},r.prototype.getGlowLayerByName=function(t){for(var r=0;r<this.effectLayers.length;r++)if(this.effectLayers[r].name===t&&this.effectLayers[r].getEffectName()===e.GlowLayer.EffectName)return this.effectLayers[r];return null},Object.defineProperty(r.prototype,"uid",{get:function(){return this._uid||(this._uid=e.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),r.prototype.addExternalData=function(t,r){return this._externalData||(this._externalData=new e.StringDictionary),this._externalData.add(t,r)},r.prototype.getExternalData=function(e){return this._externalData?this._externalData.get(e):null},r.prototype.getOrAddExternalDataWithFactory=function(t,r){return this._externalData||(this._externalData=new e.StringDictionary),this._externalData.getOrAddWithFactory(t,r)},r.prototype.removeExternalData=function(e){return this._externalData.remove(e)},r.prototype._evaluateSubMesh=function(e,t){if(this.dispatchAllSubMeshesOfActiveMeshes||t.alwaysSelectAsActiveMesh||1===t.subMeshes.length||e.isInFrustum(this._frustumPlanes)){if(t.showSubMeshesBoundingBox){var r=e.getBoundingInfo();null!==r&&void 0!==r&&this.getBoundingBoxRenderer().renderList.push(r.boundingBox)}var i=e.getMaterial();null!==i&&void 0!==i&&(void 0!==i.getRenderTargetTextures&&-1===this._processedMaterials.indexOf(i)&&(this._processedMaterials.push(i),this._renderTargets.concatWithNoDuplicate(i.getRenderTargetTextures())),this._activeIndices.addCount(e.indexCount,!1),this._renderingManager.dispatch(e,t,i))}},r.prototype.freeProcessedMaterials=function(){this._processedMaterials.dispose()},r.prototype.freeActiveMeshes=function(){if(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras)for(var e=0;e<this.activeCameras.length;e++){var t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}},r.prototype.freeRenderingGroups=function(){if(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures)for(var e=0;e<this.textures.length;e++){var t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}},r.prototype._isInIntermediateRendering=function(){return this._intermediateRendering},r.prototype.setActiveMeshCandidateProvider=function(e){this._activeMeshCandidateProvider=e},r.prototype.getActiveMeshCandidateProvider=function(){return this._activeMeshCandidateProvider},r.prototype.freezeActiveMeshes=function(){return this.activeCamera?(this._frustumPlanes||this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix()),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this):this},r.prototype.unfreezeActiveMeshes=function(){return this._activeMeshesFrozen=!1,this},r.prototype._evaluateActiveMeshes=function(){if((!this._activeMeshesFrozen||!this._activeMeshes.length)&&this.activeCamera){this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._boundingBoxRenderer&&this._boundingBoxRenderer.reset();var t,r,i=!0;if(void 0!==this._activeMeshCandidateProvider)t=this._activeMeshCandidateProvider.getMeshes(this),i=!1===this._activeMeshCandidateProvider.checksIsEnabled,r=void 0!==t?t.length:0;else if(void 0!==this._selectionOctree){var n=this._selectionOctree.select(this._frustumPlanes);t=n.data,r=n.length}else r=this.meshes.length,t=this.meshes;for(var s,o,a=0;a<r;a++)s=t[a],s.isBlocked||(this._totalVertices.addCount(s.getTotalVertices(),!1),!s.isReady()||i&&!s.isEnabled()||(s.computeWorldMatrix(),s.actionManager&&s.actionManager.hasSpecificTriggers([e.ActionManager.OnIntersectionEnterTrigger,e.ActionManager.OnIntersectionExitTrigger])&&this._meshesForIntersections.pushNoDuplicate(s),void 0!==(o=s.getLOD(this.activeCamera))&&null!==o&&(s._preActivate(),(s.alwaysSelectAsActiveMesh||s.isVisible&&s.visibility>0&&0!=(s.layerMask&this.activeCamera.layerMask)&&s.isInFrustum(this._frustumPlanes))&&(this._activeMeshes.push(s),this.activeCamera._activeMeshes.push(s),s._activate(this._renderId),o!==s&&o._activate(this._renderId),this._activeMesh(s,o)))));if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(var h=0;h<this.particleSystems.length;h++){var u=this.particleSystems[h];if(u.isStarted()&&u.emitter){var l=u.emitter;l.position&&!l.isEnabled()||(this._activeParticleSystems.push(u),u.animate(),this._renderingManager.dispatchParticles(u))}}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}},r.prototype._activeMesh=function(e,t){
if(this.skeletonsEnabled&&null!==t.skeleton&&void 0!==t.skeleton&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&t.skeleton.prepare(),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t)),e.showBoundingBox||this.forceShowBoundingBoxes){var r=e.getBoundingInfo();this.getBoundingBoxRenderer().renderList.push(r.boundingBox)}if(void 0!==t&&null!==t&&void 0!==t.subMeshes&&null!==t.subMeshes&&t.subMeshes.length>0){var i,n;if(t.useOctreeForRenderingSelection&&void 0!==t._submeshesOctree&&null!==t._submeshesOctree){var s=t._submeshesOctree.select(this._frustumPlanes);i=s.length,n=s.data}else n=t.subMeshes,i=n.length;for(var o,a=0;a<i;a++)o=n[a],this._evaluateSubMesh(o,t)}},r.prototype.updateTransformMatrix=function(e){this.activeCamera&&this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))},r.prototype.updateAlternateTransformMatrix=function(e){this._setAlternateTransformMatrix(e.getViewMatrix(),e.getProjectionMatrix())},r.prototype._renderForCamera=function(t,r){if(!t||!t._skipRendering){var i=this._engine;if(this.activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");e.Tools.StartPerformanceCounter("Rendering camera "+this.activeCamera.name),i.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,this.updateTransformMatrix(),t._alternateCamera&&(this.updateAlternateTransformMatrix(t._alternateCamera),this._alternateRendering=!0),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(var n=0;n<this._softwareSkinnedMeshes.length;n++){var s=this._softwareSkinnedMeshes.data[n];s.applySkeleton(s.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var o=!1;if(t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),r&&r.customRenderTargets&&r.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(r.customRenderTargets),this.renderTargetsEnabled&&this._renderTargets.length>0){this._intermediateRendering=!0,e.Tools.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(var a=0;a<this._renderTargets.length;a++){var h=this._renderTargets.data[a];if(h._shouldRender()){this._renderId++;var u=h.activeCamera&&h.activeCamera!==this.activeCamera;h.render(u,this.dumpNextRenderTargets)}}e.Tools.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._intermediateRendering=!1,this._renderId++,o=!0}var l=this._engine.getStencilBuffer(),c=!1,f=!1;if(this.renderTargetsEnabled&&this.effectLayers&&this.effectLayers.length>0){this._intermediateRendering=!0;for(var d=0;d<this.effectLayers.length;d++){var p=this.effectLayers[d];if(p.shouldRender()&&(!p.camera||p.camera.cameraRigMode===e.Camera.RIG_MODE_NONE&&t===p.camera||p.camera.cameraRigMode!==e.Camera.RIG_MODE_NONE&&p.camera._rigCameras.indexOf(t)>-1)){c=!0,f=f||p.needStencil();var h=p._mainTexture;h._shouldRender()&&(this._renderId++,h.render(!1,!1),o=!0)}}this._intermediateRendering=!1,this._renderId++}o&&i.restoreDefaultFramebuffer(),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&this.postProcessManager._prepareFrame();var _,m;if(this.layers.length){for(i.setDepthBuffer(!1),_=0;_<this.layers.length;_++)m=this.layers[_],m.isBackground&&0!=(m.layerMask&this.activeCamera.layerMask)&&m.render();i.setDepthBuffer(!0)}if(f&&this._engine.setStencilBuffer(!0),this.onBeforeDrawPhaseObservable.notifyObservers(this),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this),f&&this._engine.setStencilBuffer(l),this._boundingBoxRenderer&&this._boundingBoxRenderer.render(),this.lensFlaresEnabled){e.Tools.StartPerformanceCounter("Lens flares",this.lensFlareSystems.length>0);for(var g=0;g<this.lensFlareSystems.length;g++){var v=this.lensFlareSystems[g];0!=(t.layerMask&v.layerMask)&&v.render()}e.Tools.EndPerformanceCounter("Lens flares",this.lensFlareSystems.length>0)}if(c){i.setDepthBuffer(!1);for(var d=0;d<this.effectLayers.length;d++)this.effectLayers[d].shouldRender()&&this.effectLayers[d].render();i.setDepthBuffer(!0)}if(this.layers.length){for(i.setDepthBuffer(!1),_=0;_<this.layers.length;_++)m=this.layers[_],m.isBackground||0==(m.layerMask&this.activeCamera.layerMask)||m.render();i.setDepthBuffer(!0)}this.postProcessManager&&this.postProcessManager._finalizeFrame(t.isIntermediate),this._renderTargets.reset(),this._alternateRendering=!1,this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera),e.Tools.EndPerformanceCounter("Rendering camera "+this.activeCamera.name)}},r.prototype._processSubCameras=function(t){if(t.cameraRigMode===e.Camera.RIG_MODE_NONE)return void this._renderForCamera(t);for(var r=0;r<t._rigCameras.length;r++)this._renderForCamera(t._rigCameras[r],t);this.activeCamera=t,this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix())},r.prototype._checkIntersections=function(){for(var t=0;t<this._meshesForIntersections.length;t++){var r=this._meshesForIntersections.data[t];if(r.actionManager)for(var i=0;i<r.actionManager.actions.length;i++){var n=r.actionManager.actions[i];if(n.trigger===e.ActionManager.OnIntersectionEnterTrigger||n.trigger===e.ActionManager.OnIntersectionExitTrigger){var s=n.getTriggerParameter(),o=s instanceof e.AbstractMesh?s:s.mesh,a=o.intersectsMesh(r,s.usePreciseIntersection),h=r._intersectionsInProgress.indexOf(o);a&&-1===h?n.trigger===e.ActionManager.OnIntersectionEnterTrigger?(n._executeCurrent(e.ActionEvent.CreateNew(r,void 0,o)),r._intersectionsInProgress.push(o)):n.trigger===e.ActionManager.OnIntersectionExitTrigger&&r._intersectionsInProgress.push(o):!a&&h>-1&&(n.trigger===e.ActionManager.OnIntersectionExitTrigger&&n._executeCurrent(e.ActionEvent.CreateNew(r,void 0,o)),r.actionManager.hasSpecificTrigger(e.ActionManager.OnIntersectionExitTrigger,(function(t){var r=t instanceof e.AbstractMesh?t:t.mesh;return o===r}))&&n.trigger!==e.ActionManager.OnIntersectionExitTrigger||r._intersectionsInProgress.splice(h,1))}}}},r.prototype.render=function(t){if(void 0===t&&(t=!0),!this.isDisposed){if(this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(e.ActionManager.OnEveryFrameTrigger),this.simplificationQueue&&!this.simplificationQueue.running&&this.simplificationQueue.executeNext(),this._engine.isDeterministicLockStep()){var i=Math.max(r.MinDeltaTime,Math.min(this._engine.getDeltaTime(),r.MaxDeltaTime))+this._timeAccumulator,n=1e3/60;this._physicsEngine&&(n=1e3*this._physicsEngine.getTimeStep());var s=0,o=this._engine.getLockstepMaxSteps(),a=Math.floor(i/60);a=Math.min(a,o);do{this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=.06*n,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this._physicsEngine&&(this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(n/1e3),this.onAfterPhysicsObservable.notifyObservers(this)),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,i-=n}while(i>0&&s<a);this._timeAccumulator=i<0?0:i}else{var i=this.useConstantAnimationDeltaTime?16:Math.max(r.MinDeltaTime,Math.min(this._engine.getDeltaTime(),r.MaxDeltaTime));this._animationRatio=.06*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this._physicsEngine&&(this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(i/1e3),this.onAfterPhysicsObservable.notifyObservers(this))}if(this._gamepadManager&&this._gamepadManager._isMonitoring&&this._gamepadManager._checkGamepadsStatus(),t)if(this.activeCameras.length>0)for(var h=0;h<this.activeCameras.length;h++){var u=this.activeCameras[h];if(u.update(),u.cameraRigMode!==e.Camera.RIG_MODE_NONE)for(var l=0;l<u._rigCameras.length;l++)u._rigCameras[l].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==e.Camera.RIG_MODE_NONE))for(var l=0;l<this.activeCamera._rigCameras.length;l++)this.activeCamera._rigCameras[l].update();this.onBeforeRenderObservable.notifyObservers(this),this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);var c=this.getEngine(),f=this.activeCamera;if(this.renderTargetsEnabled){e.Tools.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(var d=0;d<this.customRenderTargets.length;d++){var p=this.customRenderTargets[d];if(p._shouldRender()){if(this._renderId++,this.activeCamera=p.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");c.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),p.render(f!==this.activeCamera,this.dumpNextRenderTargets)}}e.Tools.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}if(this.customRenderTargets.length>0&&c.restoreDefaultFramebuffer(),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.activeCamera=f,this.proceduralTexturesEnabled){e.Tools.StartPerformanceCounter("Procedural textures",this.proceduralTextures.length>0);for(var _=0;_<this.proceduralTextures.length;_++){var m=this.proceduralTextures[_];m._shouldRender()&&m.render()}e.Tools.EndPerformanceCounter("Procedural textures",this.proceduralTextures.length>0)}if((this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil),this.shadowsEnabled)for(var g=0;g<this.lights.length;g++){var v=this.lights[g],y=v.getShadowGenerator();if(v.isEnabled()&&v.shadowEnabled&&y){var b=y.getShadowMap();-1!==this.textures.indexOf(b)&&this._renderTargets.push(b)}}for(var T in this._depthRenderer)this._renderTargets.push(this._depthRenderer[T].getDepthMap());if(this._geometryBufferRenderer&&this._renderTargets.push(this._geometryBufferRenderer.getGBuffer()),this._postProcessRenderPipelineManager&&this._postProcessRenderPipelineManager.update(),this.activeCameras.length>0)for(var h=0;h<this.activeCameras.length;h++)h>0&&this._engine.clear(null,!1,!0,!0),this._processSubCameras(this.activeCameras[h]);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera)}this._checkIntersections(),e.AudioEngine&&this._updateAudioParameters(),this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this);for(var l=0;l<this._toBeDisposed.length;l++){var E=this._toBeDisposed.data[l];E&&E.dispose(),this._toBeDisposed[l]=null}this._toBeDisposed.reset(),this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0)}},r.prototype._updateAudioParameters=function(){if(this.audioEnabled&&this._mainSoundTrack&&(0!==this._mainSoundTrack.soundCollection.length||1!==this.soundTracks.length)){var t,r=e.Engine.audioEngine;if((t=this.activeCameras.length>0?this.activeCameras[0]:this.activeCamera)&&r.canUseWebAudio&&r.audioContext){r.audioContext.listener.setPosition(t.position.x,t.position.y,t.position.z),t.rigCameras&&t.rigCameras.length>0&&(t=t.rigCameras[0]);var i=e.Matrix.Invert(t.getViewMatrix()),n=e.Vector3.TransformNormal(new e.Vector3(0,0,-1),i);n.normalize(),isNaN(n.x)||isNaN(n.y)||isNaN(n.z)||r.audioContext.listener.setOrientation(n.x,n.y,n.z,0,1,0);var s;for(s=0;s<this.mainSoundTrack.soundCollection.length;s++){var o=this.mainSoundTrack.soundCollection[s];o.useCustomAttenuation&&o.updateDistanceFromListener()}for(s=0;s<this.soundTracks.length;s++)for(var a=0;a<this.soundTracks[s].soundCollection.length;a++)o=this.soundTracks[s].soundCollection[a],o.useCustomAttenuation&&o.updateDistanceFromListener()}}},Object.defineProperty(r.prototype,"audioEnabled",{get:function(){return this._audioEnabled},set:function(t){this._audioEnabled=t,e.AudioEngine&&(this._audioEnabled?this._enableAudio():this._disableAudio())},enumerable:!0,configurable:!0}),r.prototype._disableAudio=function(){var e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)this.mainSoundTrack.soundCollection[e].pause();for(e=0;e<this.soundTracks.length;e++)for(var t=0;t<this.soundTracks[e].soundCollection.length;t++)this.soundTracks[e].soundCollection[t].pause()},r.prototype._enableAudio=function(){var e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)this.mainSoundTrack.soundCollection[e].isPaused&&this.mainSoundTrack.soundCollection[e].play();for(e=0;e<this.soundTracks.length;e++)for(var t=0;t<this.soundTracks[e].soundCollection.length;t++)this.soundTracks[e].soundCollection[t].isPaused&&this.soundTracks[e].soundCollection[t].play()},Object.defineProperty(r.prototype,"headphone",{get:function(){return this._headphone},set:function(t){this._headphone=t,e.AudioEngine&&(this._headphone?this._switchAudioModeForHeadphones():this._switchAudioModeForNormalSpeakers())},enumerable:!0,configurable:!0}),r.prototype._switchAudioModeForHeadphones=function(){this.mainSoundTrack.switchPanningModelToHRTF();for(var e=0;e<this.soundTracks.length;e++)this.soundTracks[e].switchPanningModelToHRTF()},r.prototype._switchAudioModeForNormalSpeakers=function(){this.mainSoundTrack.switchPanningModelToEqualPower();for(var e=0;e<this.soundTracks.length;e++)this.soundTracks[e].switchPanningModelToEqualPower()},r.prototype.enableDepthRenderer=function(t){if(!(t=t||this.activeCamera))throw"No camera available to enable depth renderer";if(!this._depthRenderer[t.id]){var r=0;if(this._engine.getCaps().textureHalfFloatRender)r=e.Engine.TEXTURETYPE_HALF_FLOAT;else{if(!this._engine.getCaps().textureFloatRender)throw"Depth renderer does not support int texture type";r=e.Engine.TEXTURETYPE_FLOAT}this._depthRenderer[t.id]=new e.DepthRenderer(this,r,t)}return this._depthRenderer[t.id]},r.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer[e.id]&&(this._depthRenderer[e.id].dispose(),delete this._depthRenderer[e.id])},r.prototype.enableGeometryBufferRenderer=function(t){return void 0===t&&(t=1),this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new e.GeometryBufferRenderer(this,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)},r.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)},r.prototype.freezeMaterials=function(){for(var e=0;e<this.materials.length;e++)this.materials[e].freeze()},r.prototype.unfreezeMaterials=function(){for(var e=0;e<this.materials.length;e++)this.materials[e].unfreeze()},r.prototype.dispose=function(){this.beforeRender=null,this.afterRender=null,this.skeletons=[],this.morphTargetManagers=[],this.importedMeshesFiles=new Array,this.stopAllAnimations(),this.resetCachedMaterial();for(var t in this._depthRenderer)this._depthRenderer[t].dispose();this._gamepadManager&&(this._gamepadManager.dispose(),this._gamepadManager=null),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._boundingBoxRenderer&&this._boundingBoxRenderer.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.dispose();for(var r=0,i=this._activeRequests;r<i.length;r++){i[r].abort()}this._debugLayer&&this._debugLayer.hide(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeSpritesRenderingObservable.clear(),this.onAfterSpritesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforePhysicsObservable.clear(),this.onAfterPhysicsObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.detachControl(),e.AudioEngine&&this.disposeSounds(),this.VRHelper&&this.VRHelper.dispose();var n=this._engine.getRenderingCanvas();if(n){var s;for(s=0;s<this.cameras.length;s++)this.cameras[s].detachControl(n)}for(;this.animationGroups.length;)this.animationGroups[0].dispose();for(;this.lights.length;)this.lights[0].dispose();for(;this.meshes.length;)this.meshes[0].dispose(!0);for(;this.transformNodes.length;)this.removeTransformNode(this.transformNodes[0]);for(;this.cameras.length;)this.cameras[0].dispose();for(this.defaultMaterial&&this.defaultMaterial.dispose();this.multiMaterials.length;)this.multiMaterials[0].dispose();for(;this.materials.length;)this.materials[0].dispose();for(;this.particleSystems.length;)this.particleSystems[0].dispose();for(;this.spriteManagers.length;)this.spriteManagers[0].dispose();for(;this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.layers.length;)this.layers[0].dispose();for(;this.effectLayers.length;)this.effectLayers[0].dispose();for(;this.textures.length;)this.textures[0].dispose();this._sceneUbo.dispose(),this._alternateSceneUbo&&this._alternateSceneUbo.dispose(),this.postProcessManager.dispose(),this._postProcessRenderPipelineManager&&this._postProcessRenderPipelineManager.dispose(),this._physicsEngine&&this.disablePhysicsEngine(),s=this._engine.scenes.indexOf(this),s>-1&&this._engine.scenes.splice(s,1),this._engine.wipeCaches(!0),this._isDisposed=!0},Object.defineProperty(r.prototype,"isDisposed",{get:function(){return this._isDisposed},enumerable:!0,configurable:!0}),r.prototype.disposeSounds=function(){if(this._mainSoundTrack){this.mainSoundTrack.dispose();for(var e=0;e<this.soundTracks.length;e++)this.soundTracks[e].dispose()}},r.prototype.clearCachedVertexData=function(){for(var e=0;e<this.meshes.length;e++){var t=this.meshes[e],r=t.geometry;if(r){r._indices=[];for(var i in r._vertexBuffers)r._vertexBuffers.hasOwnProperty(i)&&(r._vertexBuffers[i]._buffer._data=null)}}},r.prototype.cleanCachedTextureBuffer=function(){for(var e=0,t=this.textures;e<t.length;e++){var r=t[e];r._buffer&&(r._buffer=null)}},r.prototype.getWorldExtends=function(t){var r=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new e.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return t=t||function(){return!0},this.meshes.filter(t).forEach((function(t){if(t.computeWorldMatrix(!0),t.subMeshes&&0!==t.subMeshes.length&&!t.infiniteDistance){var n=t.getBoundingInfo(),s=n.boundingBox.minimumWorld,o=n.boundingBox.maximumWorld;e.Tools.CheckExtends(s,r,i),e.Tools.CheckExtends(o,r,i)}})),{min:r,max:i}},r.prototype.createOrUpdateSelectionOctree=function(t,r){void 0===t&&(t=64),void 0===r&&(r=2),this._selectionOctree||(this._selectionOctree=new e.Octree(e.Octree.CreationFuncForMeshes,t,r));var i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree},r.prototype.createPickingRay=function(t,r,i,n,s){void 0===s&&(s=!1);var o=e.Ray.Zero();return this.createPickingRayToRef(t,r,i,o,n,s),o},r.prototype.createPickingRayToRef=function(t,r,i,n,s,o){void 0===o&&(o=!1);var a=this._engine;if(!s){if(!this.activeCamera)throw new Error("Active camera not set");s=this.activeCamera}var h=s.viewport,u=h.toGlobal(a.getRenderWidth(),a.getRenderHeight());return t=t/this._engine.getHardwareScalingLevel()-u.x,r=r/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-u.y-u.height),n.update(t,r,u.width,u.height,i||e.Matrix.Identity(),o?e.Matrix.Identity():s.getViewMatrix(),s.getProjectionMatrix()),this},r.prototype.createPickingRayInCameraSpace=function(t,r,i){var n=e.Ray.Zero();return this.createPickingRayInCameraSpaceToRef(t,r,n,i),n},r.prototype.createPickingRayInCameraSpaceToRef=function(t,r,i,n){if(!e.PickingInfo)return this;var s=this._engine;if(!n){if(!this.activeCamera)throw new Error("Active camera not set");n=this.activeCamera}var o=n.viewport,a=o.toGlobal(s.getRenderWidth(),s.getRenderHeight()),h=e.Matrix.Identity();return t=t/this._engine.getHardwareScalingLevel()-a.x,r=r/this._engine.getHardwareScalingLevel()-(this._engine.getRenderHeight()-a.y-a.height),i.update(t,r,a.width,a.height,h,h,n.getProjectionMatrix()),this},r.prototype._internalPick=function(t,r,i){if(!e.PickingInfo)return null;for(var n=null,s=0;s<this.meshes.length;s++){var o=this.meshes[s];if(r){if(!r(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;var a=o.getWorldMatrix(),h=t(a),u=o.intersects(h,i);if(u&&u.hit&&((i||null==n||!(u.distance>=n.distance))&&(n=u,i)))break}return n||new e.PickingInfo},r.prototype._internalMultiPick=function(t,r){if(!e.PickingInfo)return null;for(var i=new Array,n=0;n<this.meshes.length;n++){var s=this.meshes[n];if(r){if(!r(s))continue}else if(!s.isEnabled()||!s.isVisible||!s.isPickable)continue;var o=s.getWorldMatrix(),a=t(o),h=s.intersects(a,!1);h&&h.hit&&i.push(h)}return i},r.prototype._internalPickSprites=function(t,r,i,n){if(!e.PickingInfo)return null;var s=null;if(!n){if(!this.activeCamera)return null;n=this.activeCamera}if(this.spriteManagers.length>0)for(var o=0;o<this.spriteManagers.length;o++){var a=this.spriteManagers[o];if(a.isPickable){var h=a.intersects(t,n,r,i);if(h&&h.hit&&(i||null==s||!(h.distance>=s.distance))&&(s=h,i))break}}return s||new e.PickingInfo},r.prototype.pick=function(t,r,i,n,s){var o=this;if(!e.PickingInfo)return null;var a=this._internalPick((function(e){return o.createPickingRayToRef(t,r,e,o._tempPickingRay,s||null),o._tempPickingRay}),i,n);return a&&(a.ray=this.createPickingRay(t,r,e.Matrix.Identity(),s||null)),a},r.prototype.pickSprite=function(e,t,r,i,n){return this.createPickingRayInCameraSpaceToRef(e,t,this._tempPickingRay,n),this._internalPickSprites(this._tempPickingRay,r,i,n)},r.prototype.pickWithRay=function(t,r,i){var n=this,s=this._internalPick((function(r){return n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=e.Matrix.Identity()),r.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=e.Ray.Zero()),e.Ray.TransformToRef(t,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform}),r,i);return s&&(s.ray=t),s},r.prototype.multiPick=function(e,t,r,i){var n=this;return this._internalMultiPick((function(r){return n.createPickingRay(e,t,r,i||null)}),r)},r.prototype.multiPickWithRay=function(t,r){var i=this;return this._internalMultiPick((function(r){return i._pickWithRayInverseMatrix||(i._pickWithRayInverseMatrix=e.Matrix.Identity()),r.invertToRef(i._pickWithRayInverseMatrix),i._cachedRayForTransform||(i._cachedRayForTransform=e.Ray.Zero()),e.Ray.TransformToRef(t,i._pickWithRayInverseMatrix,i._cachedRayForTransform),i._cachedRayForTransform}),r)},r.prototype.setPointerOverMesh=function(t){this._pointerOverMesh!==t&&(this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(e.ActionManager.OnPointerOutTrigger,e.ActionEvent.CreateNew(this._pointerOverMesh)),this._pointerOverMesh=t,this._pointerOverMesh&&this._pointerOverMesh.actionManager&&this._pointerOverMesh.actionManager.processTrigger(e.ActionManager.OnPointerOverTrigger,e.ActionEvent.CreateNew(this._pointerOverMesh)))},r.prototype.getPointerOverMesh=function(){return this._pointerOverMesh},r.prototype.setPointerOverSprite=function(t){this._pointerOverSprite!==t&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(e.ActionManager.OnPointerOutTrigger,e.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=t,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(e.ActionManager.OnPointerOverTrigger,e.ActionEvent.CreateNewFromSprite(this._pointerOverSprite,this)))},r.prototype.getPointerOverSprite=function(){return this._pointerOverSprite},r.prototype.getPhysicsEngine=function(){return this._physicsEngine},r.prototype.enablePhysics=function(t,r){if(void 0===t&&(t=null),this._physicsEngine)return!0;try{return this._physicsEngine=new e.PhysicsEngine(t,r),!0}catch(t){return e.Tools.Error(t.message),!1}},r.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},r.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},r.prototype.deleteCompoundImpostor=function(e){var t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},r.prototype._rebuildGeometries=function(){for(var e=0,t=this._geometries;e<t.length;e++){t[e]._rebuild()}for(var r=0,i=this.meshes;r<i.length;r++){i[r]._rebuild()}this.postProcessManager&&this.postProcessManager._rebuild();for(var n=0,s=this.layers;n<s.length;n++){s[n]._rebuild()}for(var o=0,a=this.effectLayers;o<a.length;o++){a[o]._rebuild()}this._boundingBoxRenderer&&this._boundingBoxRenderer._rebuild();for(var h=0,u=this.particleSystems;h<u.length;h++){u[h].rebuild()}this._postProcessRenderPipelineManager&&this._postProcessRenderPipelineManager._rebuild()},r.prototype._rebuildTextures=function(){for(var t=0,r=this.textures;t<r.length;t++){r[t]._rebuild()}this.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag)},r.prototype.createDefaultLight=function(t){if(void 0===t&&(t=!1),t&&this.lights)for(var r=0;r<this.lights.length;r++)this.lights[r].dispose();0===this.lights.length&&new e.HemisphericLight("default light",e.Vector3.Up(),this)},r.prototype.createDefaultCamera=function(t,r,i){if(void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!1),r&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){var n,s=this.getWorldExtends(),o=s.max.subtract(s.min),a=s.min.add(o.scale(.5)),h=1.5*o.length();if(isFinite(h)||(h=1,a.copyFromFloats(0,0,0)),t){var u=new e.ArcRotateCamera("default camera",-Math.PI/2,Math.PI/2,h,a,this);u.lowerRadiusLimit=.01*h,u.wheelPrecision=100/h,n=u}else{var l=new e.FreeCamera("default camera",new e.Vector3(a.x,a.y,-h),this);l.setTarget(a),n=l}n.minZ=.01*h,n.maxZ=1e3*h,n.speed=.2*h,this.activeCamera=n;var c=this.getEngine().getRenderingCanvas();i&&c&&n.attachControl(c)}},r.prototype.createDefaultCameraOrLight=function(e,t,r){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===r&&(r=!1),this.createDefaultLight(t),this.createDefaultCamera(e,t,r)},r.prototype.createDefaultSkybox=function(t,r,i,n,s){if(void 0===r&&(r=!1),void 0===i&&(i=1e3),void 0===n&&(n=0),void 0===s&&(s=!0),!t)return e.Tools.Warn("Can not create default skybox without environment texture."),null;s&&t&&(this.environmentTexture=t);var o=e.Mesh.CreateBox("hdrSkyBox",i,this);if(r){var a=new e.PBRMaterial("skyBox",this);a.backFaceCulling=!1,a.reflectionTexture=t.clone(),a.reflectionTexture&&(a.reflectionTexture.coordinatesMode=e.Texture.SKYBOX_MODE),a.microSurface=1-n,a.disableLighting=!0,a.twoSidedLighting=!0,o.infiniteDistance=!0,o.material=a}else{var h=new e.StandardMaterial("skyBox",this);h.backFaceCulling=!1,h.reflectionTexture=t.clone(),h.reflectionTexture&&(h.reflectionTexture.coordinatesMode=e.Texture.SKYBOX_MODE),h.disableLighting=!0,o.infiniteDistance=!0,o.material=h}return o},r.prototype.createDefaultEnvironment=function(t){return e.EnvironmentHelper?new e.EnvironmentHelper(t,this):null},r.prototype.createDefaultVRExperience=function(t){return void 0===t&&(t={}),new e.VRExperienceHelper(this,t)},r.prototype._getByTags=function(t,r,i){if(void 0===r)return t;var n=[];i=i||function(e){};for(var s in t){var o=t[s];e.Tags&&e.Tags.MatchesQuery(o,r)&&(n.push(o),i(o))}return n},r.prototype.getMeshesByTags=function(e,t){return this._getByTags(this.meshes,e,t)},r.prototype.getCamerasByTags=function(e,t){return this._getByTags(this.cameras,e,t)},r.prototype.getLightsByTags=function(e,t){return this._getByTags(this.lights,e,t)},r.prototype.getMaterialByTags=function(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))},r.prototype.setRenderingOrder=function(e,t,r,i){void 0===t&&(t=null),void 0===r&&(r=null),void 0===i&&(i=null),this._renderingManager.setRenderingOrder(e,t,r,i)},r.prototype.setRenderingAutoClearDepthStencil=function(e,t,r,i){void 0===r&&(r=!0),void 0===i&&(i=!0),this._renderingManager.setRenderingAutoClearDepthStencil(e,t,r,i)},r.prototype.markAllMaterialsAsDirty=function(e,t){for(var r=0,i=this.materials;r<i.length;r++){var n=i[r];t&&!t(n)||n.markAsDirty(e)}},r.prototype._loadFile=function(t,r,i,n,s,o){var a=this,h=e.Tools.LoadFile(t,r,i,n?this.database:void 0,s,o);return this._activeRequests.push(h),h.onCompleteObservable.add((function(e){a._activeRequests.splice(a._activeRequests.indexOf(e),1)})),h},r.prototype._loadFileAsync=function(e,t,r){var i=this;return new Promise(function(n,s){i._loadFile(e,(function(e){n(e)}),void 0,t,r,(function(e,t){s(t)}))})},r._FOGMODE_NONE=0,r._FOGMODE_EXP=1,r._FOGMODE_EXP2=2,r._FOGMODE_LINEAR=3,r._uniqueIdCounter=0,r.MinDeltaTime=1,r.MaxDeltaTime=1e3,r.DragMovementThreshold=10,r.LongPressDelay=500,r.DoubleClickDelay=300,r.ExclusiveDoubleClickMode=!1,r})();e.Scene=i})(i||(i={}));var i;!(function(e){var t=(function(){function e(){this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=new Array,this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.lensFlareSystems=new Array,this.shadowGenerators=new Array,this.actionManagers=new Array,this.sounds=new Array,this.textures=new Array,this.effectLayers=new Array}return e})();e.KeepAssets=t;var r=(function(){function r(e){this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=new Array,this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.lensFlareSystems=new Array,this.shadowGenerators=new Array,this.actionManagers=new Array,this.sounds=new Array,this.textures=new Array,this.effectLayers=new Array,this.scene=e}return r.prototype.addAllToScene=function(){var e=this;this.cameras.forEach((function(t){e.scene.addCamera(t)})),this.lights.forEach((function(t){e.scene.addLight(t)})),this.meshes.forEach((function(t){e.scene.addMesh(t)})),this.skeletons.forEach((function(t){e.scene.addSkeleton(t)})),this.particleSystems.forEach((function(t){e.scene.addParticleSystem(t)})),this.animations.forEach((function(t){e.scene.addAnimation(t)})),this.animationGroups.forEach((function(t){e.scene.addAnimationGroup(t)})),this.multiMaterials.forEach((function(t){e.scene.addMultiMaterial(t)})),this.materials.forEach((function(t){e.scene.addMaterial(t)})),this.morphTargetManagers.forEach((function(t){e.scene.addMorphTargetManager(t)})),this.geometries.forEach((function(t){e.scene.addGeometry(t)})),this.transformNodes.forEach((function(t){e.scene.addTransformNode(t)})),this.lensFlareSystems.forEach((function(t){e.scene.addLensFlareSystem(t)})),this.actionManagers.forEach((function(t){e.scene.addActionManager(t)})),this.sounds.forEach((function(t){
t.play(),t.autoplay=!0,e.scene.mainSoundTrack.AddSound(t)})),this.textures.forEach((function(t){e.scene.addTexture(t)})),this.effectLayers.forEach((function(t){e.scene.addEffectLayer(t)}))},r.prototype.removeAllFromScene=function(){var e=this;this.cameras.forEach((function(t){e.scene.removeCamera(t)})),this.lights.forEach((function(t){e.scene.removeLight(t)})),this.meshes.forEach((function(t){e.scene.removeMesh(t)})),this.skeletons.forEach((function(t){e.scene.removeSkeleton(t)})),this.particleSystems.forEach((function(t){e.scene.removeParticleSystem(t)})),this.animations.forEach((function(t){e.scene.removeAnimation(t)})),this.animationGroups.forEach((function(t){e.scene.removeAnimationGroup(t)})),this.multiMaterials.forEach((function(t){e.scene.removeMultiMaterial(t)})),this.materials.forEach((function(t){e.scene.removeMaterial(t)})),this.morphTargetManagers.forEach((function(t){e.scene.removeMorphTargetManager(t)})),this.geometries.forEach((function(t){e.scene.removeGeometry(t)})),this.transformNodes.forEach((function(t){e.scene.removeTransformNode(t)})),this.lensFlareSystems.forEach((function(t){e.scene.removeLensFlareSystem(t)})),this.actionManagers.forEach((function(t){e.scene.removeActionManager(t)})),this.sounds.forEach((function(t){t.stop(),t.autoplay=!1,e.scene.mainSoundTrack.RemoveSound(t)})),this.textures.forEach((function(t){e.scene.removeTexture(t)})),this.effectLayers.forEach((function(t){e.scene.removeEffectLayer(t)}))},r.prototype._moveAssets=function(e,t,r){for(var i=0,n=e;i<n.length;i++){for(var s=n[i],o=!0,a=0,h=r;a<h.length;a++){if(s===h[a]){o=!1;break}}o&&t.push(s)}},r.prototype.moveAllFromScene=function(e){void 0===e&&(e=new t),this._moveAssets(this.scene.cameras,this.cameras,e.cameras),this._moveAssets(this.scene.meshes,this.meshes,e.meshes),this._moveAssets(this.scene.getGeometries(),this.geometries,e.geometries),this._moveAssets(this.scene.materials,this.materials,e.materials),this._moveAssets(this.scene._actionManagers,this.actionManagers,e.actionManagers),this._moveAssets(this.scene.animations,this.animations,e.animations),this._moveAssets(this.scene.animationGroups,this.animationGroups,e.animationGroups),this._moveAssets(this.scene.lensFlareSystems,this.lensFlareSystems,e.lensFlareSystems),this._moveAssets(this.scene.lights,this.lights,e.lights),this._moveAssets(this.scene.morphTargetManagers,this.morphTargetManagers,e.morphTargetManagers),this._moveAssets(this.scene.multiMaterials,this.multiMaterials,e.multiMaterials),this._moveAssets(this.scene.skeletons,this.skeletons,e.skeletons),this._moveAssets(this.scene.particleSystems,this.particleSystems,e.particleSystems),this._moveAssets(this.scene.mainSoundTrack.soundCollection,this.sounds,e.sounds),this._moveAssets(this.scene.transformNodes,this.transformNodes,e.transformNodes),this._moveAssets(this.scene.textures,this.textures,e.textures),this._moveAssets(this.scene.effectLayers,this.effectLayers,e.effectLayers),this.removeAllFromScene()},r.prototype.createRootMesh=function(){var t=new e.Mesh("assetContainerRootMesh",this.scene);return this.meshes.forEach((function(e){e.parent||t.addChild(e)})),this.meshes.unshift(t),t},r})();e.AssetContainer=r})(i||(i={}));var i;!(function(e){var t=(function(){function t(t,r,i,n,s,o,a){void 0===n&&(n=0),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),t instanceof e.Mesh?this._engine=t.getScene().getEngine():this._engine=t,this._updatable=i,this._instanced=o,this._data=r,this.byteStride=a?n:n*Float32Array.BYTES_PER_ELEMENT,s||this.create()}return t.prototype.createVertexBuffer=function(t,r,i,n,s,o){void 0===o&&(o=!1);var a=o?r:r*Float32Array.BYTES_PER_ELEMENT,h=n?o?n:n*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new e.VertexBuffer(this._engine,this,t,this._updatable,!0,h,void 0===s?this._instanced:s,a,i,void 0,void 0,!0)},t.prototype.isUpdatable=function(){return this._updatable},t.prototype.getData=function(){return this._data},t.prototype.getBuffer=function(){return this._buffer},t.prototype.getStrideSize=function(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT},t.prototype.create=function(e){void 0===e&&(e=null),!e&&this._buffer||(e=e||this._data)&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e))},t.prototype._rebuild=function(){this._buffer=null,this.create(this._data)},t.prototype.update=function(e){this.create(e)},t.prototype.updateDirectly=function(e,t,r,i){void 0===i&&(i=!1),this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,i?t:t*Float32Array.BYTES_PER_ELEMENT,r?r*this.byteStride:void 0),this._data=null)},t.prototype.dispose=function(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)},t})();e.Buffer=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(r,i,n,s,o,a,h,u,l,c,f,d){if(void 0===f&&(f=!1),void 0===d&&(d=!1),i instanceof e.Buffer?(this._buffer=i,this._ownsBuffer=!1):(this._buffer=new e.Buffer(r,i,s,a,o,h,d),this._ownsBuffer=!0),this._kind=n,void 0==c){var p=this.getData();this.type=t.FLOAT,p instanceof Int8Array?this.type=t.BYTE:p instanceof Uint8Array?this.type=t.UNSIGNED_BYTE:p instanceof Int16Array?this.type=t.SHORT:p instanceof Uint16Array?this.type=t.UNSIGNED_SHORT:p instanceof Int32Array?this.type=t.INT:p instanceof Uint32Array&&(this.type=t.UNSIGNED_INT)}else this.type=c;var _=t.GetTypeByteLength(this.type);d?(this._size=l||(a?a/_:t.DeduceStride(n)),this.byteStride=a||this._buffer.byteStride||this._size*_,this.byteOffset=u||0):(this._size=l||a||t.DeduceStride(n),this.byteStride=a?a*_:this._buffer.byteStride||this._size*_,this.byteOffset=(u||0)*_),this.normalized=f,this._instanced=void 0!==h&&h,this._instanceDivisor=h?1:0}return Object.defineProperty(t.prototype,"instanceDivisor",{get:function(){return this._instanceDivisor},set:function(e){this._instanceDivisor=e,this._instanced=0!=e},enumerable:!0,configurable:!0}),t.prototype._rebuild=function(){this._buffer&&this._buffer._rebuild()},t.prototype.getKind=function(){return this._kind},t.prototype.isUpdatable=function(){return this._buffer.isUpdatable()},t.prototype.getData=function(){return this._buffer.getData()},t.prototype.getBuffer=function(){return this._buffer.getBuffer()},t.prototype.getStrideSize=function(){return this.byteStride/t.GetTypeByteLength(this.type)},t.prototype.getOffset=function(){return this.byteOffset/t.GetTypeByteLength(this.type)},t.prototype.getSize=function(){return this._size},t.prototype.getIsInstanced=function(){return this._instanced},t.prototype.getInstanceDivisor=function(){return this._instanceDivisor},t.prototype.create=function(e){return this._buffer.create(e)},t.prototype.update=function(e){return this._buffer.update(e)},t.prototype.updateDirectly=function(e,t,r){void 0===r&&(r=!1),this._buffer.updateDirectly(e,t,void 0,r)},t.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose()},t.prototype.forEach=function(e,r){t.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,r)},Object.defineProperty(t,"PositionKind",{get:function(){return t._PositionKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"NormalKind",{get:function(){return t._NormalKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"TangentKind",{get:function(){return t._TangentKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UVKind",{get:function(){return t._UVKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV2Kind",{get:function(){return t._UV2Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV3Kind",{get:function(){return t._UV3Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV4Kind",{get:function(){return t._UV4Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV5Kind",{get:function(){return t._UV5Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"UV6Kind",{get:function(){return t._UV6Kind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ColorKind",{get:function(){return t._ColorKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesIndicesKind",{get:function(){return t._MatricesIndicesKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesWeightsKind",{get:function(){return t._MatricesWeightsKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesIndicesExtraKind",{get:function(){return t._MatricesIndicesExtraKind},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MatricesWeightsExtraKind",{get:function(){return t._MatricesWeightsExtraKind},enumerable:!0,configurable:!0}),t.DeduceStride=function(e){switch(e){case t.UVKind:case t.UV2Kind:case t.UV3Kind:case t.UV4Kind:case t.UV5Kind:case t.UV6Kind:return 2;case t.NormalKind:case t.PositionKind:return 3;case t.ColorKind:case t.MatricesIndicesKind:case t.MatricesIndicesExtraKind:case t.MatricesWeightsKind:case t.MatricesWeightsExtraKind:case t.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}},t.GetTypeByteLength=function(e){switch(e){case t.BYTE:case t.UNSIGNED_BYTE:return 1;case t.SHORT:case t.UNSIGNED_SHORT:return 2;case t.INT:case t.FLOAT:return 4;default:throw new Error("Invalid type '"+e+"'")}},t.ForEach=function(e,r,i,n,s,o,a,h){if(e instanceof Array)for(var u=r/4,l=i/4,c=0;c<o;c+=n){for(var f=0;f<n;f++)h(e[u+f],c+f);u+=l}else for(var d=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),p=t.GetTypeByteLength(s),c=0;c<o;c+=n){for(var _=r,f=0;f<n;f++){var m=t._GetFloatValue(d,s,_,a);h(m,c+f),_+=p}r+=i}},t._GetFloatValue=function(e,r,i,n){switch(r){case t.BYTE:var s=e.getInt8(i);return n&&(s=Math.max(s/127,-1)),s;case t.UNSIGNED_BYTE:var s=e.getUint8(i);return n&&(s/=255),s;case t.SHORT:var s=e.getInt16(i,!0);return n&&(s=Math.max(s/16383,-1)),s;case t.UNSIGNED_SHORT:var s=e.getUint16(i,!0);return n&&(s/=65535),s;case t.FLOAT:return e.getFloat32(i,!0);default:throw new Error("Invalid component type "+r)}},t.BYTE=5120,t.UNSIGNED_BYTE=5121,t.SHORT=5122,t.UNSIGNED_SHORT=5123,t.INT=5124,t.UNSIGNED_INT=5125,t.FLOAT=5126,t._PositionKind="position",t._NormalKind="normal",t._TangentKind="tangent",t._UVKind="uv",t._UV2Kind="uv2",t._UV3Kind="uv3",t._UV4Kind="uv4",t._UV5Kind="uv5",t._UV6Kind="uv6",t._ColorKind="color",t._MatricesIndicesKind="matricesIndices",t._MatricesWeightsKind="matricesWeights",t._MatricesIndicesExtraKind="matricesIndicesExtra",t._MatricesWeightsExtraKind="matricesWeightsExtra",t})();e.VertexBuffer=t})(i||(i={}));var i;!(function(e){var t=(function(){function e(){this.previous=null,this.next=null}return e})();e.DummyInternalTextureTracker=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(r,i){this.onLoadedObservable=new e.Observable,this.previous=null,this.next=null,this._initialSlot=-1,this._designatedSlot=-1,this._dataSource=t.DATASOURCE_UNKNOWN,this._comparisonFunction=0,this._isRGBD=!1,this._references=1,this._engine=r,this._dataSource=i,this._webGLTexture=r._createTexture()}return t.prototype.getEngine=function(){return this._engine},Object.defineProperty(t.prototype,"dataSource",{get:function(){return this._dataSource},enumerable:!0,configurable:!0}),t.prototype.incrementReferences=function(){this._references++},t.prototype.updateSize=function(e,t,r){void 0===r&&(r=1),this.width=e,this.height=t,this.depth=r,this.baseWidth=e,this.baseHeight=t,this.baseDepth=r,this._size=e*t*r},t.prototype._rebuild=function(){var r,i=this;switch(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedAnisotropicFilteringLevel=null,this._dataSource){case t.DATASOURCE_TEMP:return;case t.DATASOURCE_URL:return r=this._engine.createTexture(this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,(function(){i.isReady=!0}),null,this._buffer,void 0,this.format),void r._swapAndDie(this);case t.DATASOURCE_RAW:return r=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),r._swapAndDie(this),void(this.isReady=!0);case t.DATASOURCE_RAW3D:return r=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),r._swapAndDie(this),void(this.isReady=!0);case t.DATASOURCE_DYNAMIC:return r=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),void r._swapAndDie(this);case t.DATASOURCE_RENDERTARGET:var n=new e.RenderTargetCreationOptions;if(n.generateDepthBuffer=this._generateDepthBuffer,n.generateMipMaps=this.generateMipMaps,n.generateStencilBuffer=this._generateStencilBuffer,n.samplingMode=this.samplingMode,n.type=this.type,this.isCube)r=this._engine.createRenderTargetCubeTexture(this.width,n);else{var s={width:this.width,height:this.height};r=this._engine.createRenderTargetTexture(s,n)}return r._swapAndDie(this),void(this.isReady=!0);case t.DATASOURCE_DEPTHTEXTURE:var o={bilinearFiltering:this.samplingMode!==e.Texture.BILINEAR_SAMPLINGMODE,comparisonFunction:this._comparisonFunction,generateStencil:this._generateStencilBuffer,isCube:this.isCube};return r=this._engine.createDepthStencilTexture({width:this.width,height:this.height},o),r._swapAndDie(this),void(this.isReady=!0);case t.DATASOURCE_CUBE:return r=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,(function(){i.isReady=!0}),null,this.format,this._extension),void r._swapAndDie(this);case t.DATASOURCE_CUBERAW:return r=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),r._swapAndDie(this),void(this.isReady=!0);case t.DATASOURCE_CUBEPREFILTERED:return r=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,(function(e){e&&e._swapAndDie(i),i.isReady=!0}),null,this.format,this._extension),void(r._sphericalPolynomial=this._sphericalPolynomial)}},t.prototype._swapAndDie=function(e){e._webGLTexture=this._webGLTexture,this._framebuffer&&(e._framebuffer=this._framebuffer),this._depthStencilBuffer&&(e._depthStencilBuffer=this._depthStencilBuffer),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow);var t=this._engine.getLoadedTexturesCache(),r=t.indexOf(this);-1!==r&&t.splice(r,1)},t.prototype.dispose=function(){this._webGLTexture&&0===--this._references&&(this._engine._releaseTexture(this),this._webGLTexture=null,this.previous=null,this.next=null)},t.DATASOURCE_UNKNOWN=0,t.DATASOURCE_URL=1,t.DATASOURCE_TEMP=2,t.DATASOURCE_RAW=3,t.DATASOURCE_DYNAMIC=4,t.DATASOURCE_RENDERTARGET=5,t.DATASOURCE_MULTIRENDERTARGET=6,t.DATASOURCE_CUBE=7,t.DATASOURCE_CUBERAW=8,t.DATASOURCE_CUBEPREFILTERED=9,t.DATASOURCE_RAW3D=10,t.DATASOURCE_DEPTHTEXTURE=11,t})();e.InternalTexture=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(r){this._hasAlpha=!1,this.getAlphaFromRGB=!1,this.level=1,this.coordinatesIndex=0,this._coordinatesMode=e.Texture.EXPLICIT_MODE,this.wrapU=e.Texture.WRAP_ADDRESSMODE,this.wrapV=e.Texture.WRAP_ADDRESSMODE,this.wrapR=e.Texture.WRAP_ADDRESSMODE,this.anisotropicFilteringLevel=t.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this.isCube=!1,this.is3D=!1,this.gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this.animations=new Array,this.onDisposeObservable=new e.Observable,this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,this._scene=r||e.Engine.LastCreatedScene,this._scene&&this._scene.textures.push(this),this._uid=null}return Object.defineProperty(t.prototype,"hasAlpha",{get:function(){return this._hasAlpha},set:function(t){this._hasAlpha!==t&&(this._hasAlpha=t,this._scene&&this._scene.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag|e.Material.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"coordinatesMode",{get:function(){return this._coordinatesMode},set:function(t){this._coordinatesMode!==t&&(this._coordinatesMode=t,this._scene&&this._scene.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isRGBD",{get:function(){return null!=this._texture&&this._texture._isRGBD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodGenerationOffset",{get:function(){return this._texture?this._texture._lodGenerationOffset:0},set:function(e){this._texture&&(this._texture._lodGenerationOffset=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodGenerationScale",{get:function(){return this._texture?this._texture._lodGenerationScale:0},set:function(e){this._texture&&(this._texture._lodGenerationScale=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uid",{get:function(){return this._uid||(this._uid=e.Tools.RandomId()),this._uid},enumerable:!0,configurable:!0}),t.prototype.toString=function(){return this.name},t.prototype.getClassName=function(){return"BaseTexture"},Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isBlocking",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getTextureMatrix=function(){return e.Matrix.IdentityReadOnly},t.prototype.getReflectionTextureMatrix=function(){return e.Matrix.IdentityReadOnly},t.prototype.getInternalTexture=function(){return this._texture},t.prototype.isReadyOrNotBlocking=function(){return!this.isBlocking||this.isReady()},t.prototype.isReady=function(){return this.delayLoadState===e.Engine.DELAYLOADSTATE_NOTLOADED?(this.delayLoad(),!1):!!this._texture&&this._texture.isReady},t.prototype.getSize=function(){return this._texture&&this._texture.width?new e.Size(this._texture.width,this._texture.height):this._texture&&this._texture._size?new e.Size(this._texture._size,this._texture._size):e.Size.Zero()},t.prototype.getBaseSize=function(){return this.isReady()&&this._texture?this._texture._size?new e.Size(this._texture._size,this._texture._size):new e.Size(this._texture.baseWidth,this._texture.baseHeight):e.Size.Zero()},t.prototype.scale=function(e){},Object.defineProperty(t.prototype,"canRescale",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype._getFromCache=function(e,t,r){if(!this._scene)return null;for(var i=this._scene.getEngine().getLoadedTexturesCache(),n=0;n<i.length;n++){var s=i[n];if(s.url===e&&s.generateMipMaps===!t&&(!r||r===s.samplingMode))return s.incrementReferences(),s}return null},t.prototype._rebuild=function(){},t.prototype.delayLoad=function(){},t.prototype.clone=function(){return null},Object.defineProperty(t.prototype,"textureType",{get:function(){return this._texture&&void 0!==this._texture.type?this._texture.type:e.Engine.TEXTURETYPE_UNSIGNED_INT},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureFormat",{get:function(){return this._texture&&void 0!==this._texture.format?this._texture.format:e.Engine.TEXTUREFORMAT_RGBA},enumerable:!0,configurable:!0}),t.prototype.readPixels=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=0),!this._texture)return null;var r=this.getSize(),i=r.width,n=r.height,s=this.getScene();if(!s)return null;var o=s.getEngine();return 0!=t&&(i/=Math.pow(2,t),n/=Math.pow(2,t),i=Math.round(i),n=Math.round(n)),this._texture.isCube?o._readTexturePixels(this._texture,i,n,e,t):o._readTexturePixels(this._texture,i,n,-1,t)},t.prototype.releaseInternalTexture=function(){this._texture&&(this._texture.dispose(),this._texture=null)},Object.defineProperty(t.prototype,"sphericalPolynomial",{get:function(){return this._texture&&e.CubeMapToSphericalPolynomialTools&&this.isReady()?(this._texture._sphericalPolynomial||(this._texture._sphericalPolynomial=e.CubeMapToSphericalPolynomialTools.ConvertCubeMapTextureToSphericalPolynomial(this)),this._texture._sphericalPolynomial):null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_lodTextureHigh",{get:function(){return this._texture?this._texture._lodTextureHigh:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_lodTextureMid",{get:function(){return this._texture?this._texture._lodTextureMid:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_lodTextureLow",{get:function(){return this._texture?this._texture._lodTextureLow:null},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){if(this._scene){this._scene.stopAnimation(this),this._scene._removePendingData(this);var e=this._scene.textures.indexOf(this);e>=0&&this._scene.textures.splice(e,1),void 0!==this._texture&&(this.releaseInternalTexture(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear())}},t.prototype.serialize=function(){if(!this.name)return null;var t=e.SerializationHelper.Serialize(this);return e.Animation.AppendSerializedAnimations(this,t),t},t.WhenAllReady=function(e,t){var r=e.length;if(0===r)return void t();for(var i,n,s=0;s<e.length;s++)!(function(){if(i=e[s],i.isReady())0==--r&&t();else{n=i.onLoadObservable;var o=function(){n.removeCallback(o),0==--r&&t()};n.add(o)}})()},t.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4,n([e.serialize()],t.prototype,"name",void 0),n([e.serialize("hasAlpha")],t.prototype,"_hasAlpha",void 0),n([e.serialize()],t.prototype,"getAlphaFromRGB",void 0),n([e.serialize()],t.prototype,"level",void 0),n([e.serialize()],t.prototype,"coordinatesIndex",void 0),n([e.serialize("coordinatesMode")],t.prototype,"_coordinatesMode",void 0),n([e.serialize()],t.prototype,"wrapU",void 0),n([e.serialize()],t.prototype,"wrapV",void 0),n([e.serialize()],t.prototype,"wrapR",void 0),n([e.serialize()],t.prototype,"anisotropicFilteringLevel",void 0),n([e.serialize()],t.prototype,"isCube",void 0),n([e.serialize()],t.prototype,"is3D",void 0),n([e.serialize()],t.prototype,"gammaSpace",void 0),n([e.serialize()],t.prototype,"invertZ",void 0),n([e.serialize()],t.prototype,"lodLevelInAlpha",void 0),n([e.serialize()],t.prototype,"lodGenerationOffset",null),n([e.serialize()],t.prototype,"lodGenerationScale",null),n([e.serialize()],t.prototype,"isRenderTarget",void 0),t})();e.BaseTexture=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(i,n,s,o,a,h,u,l,c,f){void 0===s&&(s=!1),void 0===o&&(o=!0),void 0===a&&(a=r.TRILINEAR_SAMPLINGMODE),void 0===h&&(h=null),void 0===u&&(u=null),void 0===l&&(l=null),void 0===c&&(c=!1);var d=t.call(this,n)||this;if(d.uOffset=0,d.vOffset=0,d.uScale=1,d.vScale=1,d.uAng=0,d.vAng=0,d.wAng=0,d.uRotationCenter=.5,d.vRotationCenter=.5,d.wRotationCenter=.5,d._isBlocking=!0,d.name=i||"",d.url=i,d._noMipmap=s,d._invertY=o,d._samplingMode=a,d._buffer=l,d._deleteBuffer=c,f&&(d._format=f),!(n=d.getScene()))return d;n.getEngine().onBeforeTextureInitObservable.notifyObservers(d);var p=function(){d._onLoadObservable&&d._onLoadObservable.hasObservers()&&d.onLoadObservable.notifyObservers(d),h&&h(),!d.isBlocking&&n&&n.resetCachedMaterial()};return d.url?(d._texture=d._getFromCache(d.url,s,a),d._texture?d._texture.isReady?e.Tools.SetImmediate((function(){return p()})):d._texture.onLoadedObservable.add(p):n.useDelayedTextureLoading?(d.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED,d._delayedOnLoad=p,d._delayedOnError=u):(d._texture=n.getEngine().createTexture(d.url,s,o,n,d._samplingMode,p,u,d._buffer,void 0,d._format),c&&delete d._buffer),d):(d._delayedOnLoad=p,d._delayedOnError=u,d)}return s(r,t),Object.defineProperty(r.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"isBlocking",{get:function(){return this._isBlocking},set:function(e){this._isBlocking=e},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"samplingMode",{get:function(){return this._samplingMode},enumerable:!0,configurable:!0}),r.prototype.updateURL=function(t,r){if(void 0===r&&(r=null),this.url)throw new Error("URL is already set");this.url=t,this._buffer=r,this.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED,this.delayLoad()},r.prototype.delayLoad=function(){if(this.delayLoadState===e.Engine.DELAYLOADSTATE_NOTLOADED){var t=this.getScene();t&&(this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED,this._texture=this._getFromCache(this.url,this._noMipmap,this._samplingMode),this._texture?this._delayedOnLoad&&(this._texture.isReady?e.Tools.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=t.getEngine().createTexture(this.url,this._noMipmap,this._invertY,t,this._samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format),this._deleteBuffer&&delete this._buffer),this._delayedOnLoad=null,this._delayedOnError=null)}},r.prototype.updateSamplingMode=function(e){if(this._texture){var t=this.getScene();t&&(this._samplingMode=e,t.getEngine().updateTextureSamplingMode(e,this._texture))}},r.prototype._prepareRowForTextureGeneration=function(t,r,i,n){t*=this.uScale,r*=this.vScale,t-=this.uRotationCenter*this.uScale,r-=this.vRotationCenter*this.vScale,i-=this.wRotationCenter,e.Vector3.TransformCoordinatesFromFloatsToRef(t,r,i,this._rowGenerationMatrix,n),n.x+=this.uRotationCenter*this.uScale+this.uOffset,n.y+=this.vRotationCenter*this.vScale+this.vOffset,n.z+=this.wRotationCenter},r.prototype.getTextureMatrix=function(){var t=this;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedTextureMatrix||(this._cachedTextureMatrix=e.Matrix.Zero(),this._rowGenerationMatrix=new e.Matrix,this._t0=e.Vector3.Zero(),this._t1=e.Vector3.Zero(),this._t2=e.Vector3.Zero()),e.Matrix.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),e.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix.m[0]=this._t1.x,this._cachedTextureMatrix.m[1]=this._t1.y,this._cachedTextureMatrix.m[2]=this._t1.z,this._cachedTextureMatrix.m[4]=this._t2.x,this._cachedTextureMatrix.m[5]=this._t2.y,this._cachedTextureMatrix.m[6]=this._t2.z,this._cachedTextureMatrix.m[8]=this._t0.x,this._cachedTextureMatrix.m[9]=this._t0.y,this._cachedTextureMatrix.m[10]=this._t0.z;var r=this.getScene();return r?(r.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag,(function(e){return e.hasTexture(t)})),this._cachedTextureMatrix):this._cachedTextureMatrix},r.prototype.getReflectionTextureMatrix=function(){var t=this,i=this.getScene();if(!i)return this._cachedTextureMatrix;if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale===this._cachedUScale&&this.vScale===this._cachedVScale&&this.coordinatesMode===this._cachedCoordinatesMode){if(this.coordinatesMode!==r.PROJECTION_MODE)return this._cachedTextureMatrix;if(this._cachedProjectionMatrixId===i.getProjectionMatrix().updateFlag)return this._cachedTextureMatrix}switch(this._cachedTextureMatrix||(this._cachedTextureMatrix=e.Matrix.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=e.Matrix.Zero()),this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale,this._cachedVScale=this.vScale,this._cachedCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case r.PLANAR_MODE:e.Matrix.IdentityToRef(this._cachedTextureMatrix),this._cachedTextureMatrix[0]=this.uScale,this._cachedTextureMatrix[5]=this.vScale,this._cachedTextureMatrix[12]=this.uOffset,this._cachedTextureMatrix[13]=this.vOffset;break;case r.PROJECTION_MODE:e.Matrix.IdentityToRef(this._projectionModeMatrix),this._projectionModeMatrix.m[0]=.5,this._projectionModeMatrix.m[5]=-.5,this._projectionModeMatrix.m[10]=0,this._projectionModeMatrix.m[12]=.5,this._projectionModeMatrix.m[13]=.5,this._projectionModeMatrix.m[14]=1,this._projectionModeMatrix.m[15]=1;var n=i.getProjectionMatrix();this._cachedProjectionMatrixId=n.updateFlag,n.multiplyToRef(this._projectionModeMatrix,this._cachedTextureMatrix);break;default:e.Matrix.IdentityToRef(this._cachedTextureMatrix)}return i.markAllMaterialsAsDirty(e.Material.TextureDirtyFlag,(function(e){return-1!==e.getActiveTextures().indexOf(t)})),this._cachedTextureMatrix},r.prototype.clone=function(){var t=this;return e.SerializationHelper.Clone((function(){return new r(t._texture?t._texture.url:null,t.getScene(),t._noMipmap,t._invertY,t._samplingMode)}),this)},Object.defineProperty(r.prototype,"onLoadObservable",{get:function(){return this._onLoadObservable||(this._onLoadObservable=new e.Observable),this._onLoadObservable},enumerable:!0,configurable:!0}),r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return"string"==typeof this._buffer&&"data:"===this._buffer.substr(0,5)&&(e.base64String=this._buffer,e.name=e.name.replace("data:","")),e.invertY=this._invertY,e.samplingMode=this.samplingMode,e},r.prototype.getClassName=function(){return"Texture"},r.prototype.dispose=function(){t.prototype.dispose.call(this),this.onLoadObservable&&(this.onLoadObservable.clear(),this._onLoadObservable=null),this._delayedOnLoad=null,this._delayedOnError=null},r.CreateFromBase64String=function(t,i,n,s,o,a,h,u,l){return void 0===a&&(a=r.TRILINEAR_SAMPLINGMODE),void 0===h&&(h=null),void 0===u&&(u=null),void 0===l&&(l=e.Engine.TEXTUREFORMAT_RGBA),new r("data:"+i,n,s,o,a,h,u,t,!1,l)},r.Parse=function(t,i,n){if(t.customType){var s=e.Tools.Instantiate(t.customType),o=s.Parse(t,i,n);return t.samplingMode&&o.updateSamplingMode&&o._samplingMode&&o._samplingMode!==t.samplingMode&&o.updateSamplingMode(t.samplingMode),o}if(t.isCube)return e.CubeTexture.Parse(t,i,n);if(!t.name&&!t.isRenderTarget)return null;var a=e.SerializationHelper.Parse((function(){var s=!0;if(t.noMipmap&&(s=!1),t.mirrorPlane){var o=new e.MirrorTexture(t.name,t.renderTargetSize,i,s);return o._waitingRenderList=t.renderList,o.mirrorPlane=e.Plane.FromArray(t.mirrorPlane),o}if(t.isRenderTarget){var a=new e.RenderTargetTexture(t.name,t.renderTargetSize,i,s);return a._waitingRenderList=t.renderList,a}var h;if(t.base64String)h=r.CreateFromBase64String(t.base64String,t.name,i,!s);else{var u=n+t.name;r.UseSerializedUrlIfAny&&t.url&&(u=t.url),h=new r(u,i,!s,t.invertY)}return h}),t,i);if(t.samplingMode){var h=t.samplingMode;a._samplingMode!==h&&a.updateSamplingMode(h)}if(t.animations)for(var u=0;u<t.animations.length;u++){var l=t.animations[u];a.animations.push(e.Animation.Parse(l))}return a},r.LoadFromDataString=function(t,i,n,s,o,a,h,u,l,c){return void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===a&&(a=!0),void 0===h&&(h=r.TRILINEAR_SAMPLINGMODE),void 0===u&&(u=null),void 0===l&&(l=null),void 0===c&&(c=e.Engine.TEXTUREFORMAT_RGBA),"data:"!==t.substr(0,5)&&(t="data:"+t),new r(t,n,o,a,h,u,l,i,s,c)},r.NEAREST_SAMPLINGMODE=1,r.NEAREST_NEAREST_MIPLINEAR=1,r.BILINEAR_SAMPLINGMODE=2,r.LINEAR_LINEAR_MIPNEAREST=2,r.TRILINEAR_SAMPLINGMODE=3,r.LINEAR_LINEAR_MIPLINEAR=3,r.NEAREST_NEAREST_MIPNEAREST=4,r.NEAREST_LINEAR_MIPNEAREST=5,r.NEAREST_LINEAR_MIPLINEAR=6,
r.NEAREST_LINEAR=7,r.NEAREST_NEAREST=8,r.LINEAR_NEAREST_MIPNEAREST=9,r.LINEAR_NEAREST_MIPLINEAR=10,r.LINEAR_LINEAR=11,r.LINEAR_NEAREST=12,r.EXPLICIT_MODE=0,r.SPHERICAL_MODE=1,r.PLANAR_MODE=2,r.CUBIC_MODE=3,r.PROJECTION_MODE=4,r.SKYBOX_MODE=5,r.INVCUBIC_MODE=6,r.EQUIRECTANGULAR_MODE=7,r.FIXED_EQUIRECTANGULAR_MODE=8,r.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.CLAMP_ADDRESSMODE=0,r.WRAP_ADDRESSMODE=1,r.MIRROR_ADDRESSMODE=2,r.UseSerializedUrlIfAny=!1,n([e.serialize()],r.prototype,"url",void 0),n([e.serialize()],r.prototype,"uOffset",void 0),n([e.serialize()],r.prototype,"vOffset",void 0),n([e.serialize()],r.prototype,"uScale",void 0),n([e.serialize()],r.prototype,"vScale",void 0),n([e.serialize()],r.prototype,"uAng",void 0),n([e.serialize()],r.prototype,"vAng",void 0),n([e.serialize()],r.prototype,"wAng",void 0),n([e.serialize()],r.prototype,"uRotationCenter",void 0),n([e.serialize()],r.prototype,"vRotationCenter",void 0),n([e.serialize()],r.prototype,"wRotationCenter",void 0),n([e.serialize()],r.prototype,"isBlocking",null),r})(e.BaseTexture);e.Texture=t})(i||(i={}));var i;!(function(e){var t=(function(){function e(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array}return e})();e._InstancesBatch=t;var r=(function(r){function i(n,s,o,a,h,u){void 0===s&&(s=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===u&&(u=!0);var l=r.call(this,n,s)||this;if(l.onBeforeRenderObservable=new e.Observable,l.onAfterRenderObservable=new e.Observable,l.onBeforeDrawObservable=new e.Observable,l.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,l.instances=new Array,l._LODLevels=new Array,l._visibleInstances={},l._renderIdForInstances=new Array,l._batchCache=new t,l._instancesBufferSize=2048,l._originalBuilderSideOrientation=i._DEFAULTSIDE,l.overrideMaterialSideOrientation=null,l._areNormalsFrozen=!1,l._source=null,s=l.getScene(),a){a._geometry&&a._geometry.applyToMesh(l),e.Tools.DeepCopy(a,l,["name","material","skeleton","instances","parent","uniqueId","source","metadata","hasLODLevels","geometry","isBlocked","areNormalsFrozen"],["_poseMatrix"]),l._source=a,a.metadata&&a.metadata.clone?l.metadata=a.metadata.clone():l.metadata=a.metadata,e.Tags&&e.Tags.HasTags(a)&&e.Tags.AddTagsTo(l,e.Tags.GetTags(a,!0)),l.parent=a.parent,l.setPivotMatrix(a.getPivotMatrix()),l.id=n+"."+a.id,l.material=a.material;var c;if(!h)for(var f=a.getDescendants(!0),d=0;d<f.length;d++){var p=f[d];p.clone&&p.clone(n+"."+p.name,l)}var _=l.getScene().getPhysicsEngine();if(u&&_){var m=_.getImpostorForPhysicsObject(a);m&&(l.physicsImpostor=m.clone(l))}for(c=0;c<s.particleSystems.length;c++){var g=s.particleSystems[c];g.emitter===a&&g.clone(g.name,l)}l.computeWorldMatrix(!0)}return null!==o&&(l.parent=o),l}return s(i,r),Object.defineProperty(i,"FRONTSIDE",{get:function(){return i._FRONTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BACKSIDE",{get:function(){return i._BACKSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DOUBLESIDE",{get:function(){return i._DOUBLESIDE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"DEFAULTSIDE",{get:function(){return i._DEFAULTSIDE},enumerable:!0,configurable:!0}),Object.defineProperty(i,"NO_CAP",{get:function(){return i._NO_CAP},enumerable:!0,configurable:!0}),Object.defineProperty(i,"CAP_START",{get:function(){return i._CAP_START},enumerable:!0,configurable:!0}),Object.defineProperty(i,"CAP_END",{get:function(){return i._CAP_END},enumerable:!0,configurable:!0}),Object.defineProperty(i,"CAP_ALL",{get:function(){return i._CAP_ALL},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onBeforeDraw",{set:function(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"morphTargetManager",{get:function(){return this._morphTargetManager},set:function(e){this._morphTargetManager!==e&&(this._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"source",{get:function(){return this._source},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isUnIndexed",{get:function(){return this._unIndexed},set:function(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())},enumerable:!0,configurable:!0}),i.prototype.getClassName=function(){return"Mesh"},i.prototype.toString=function(t){var i=r.prototype.toString.call(this,t);if(i+=", n vertices: "+this.getTotalVertices(),i+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(var n=0;n<this.animations.length;n++)i+=", animation[0]: "+this.animations[n].toString(t);if(t)if(this._geometry){var s=this.getIndices(),o=this.getVerticesData(e.VertexBuffer.PositionKind);o&&s&&(i+=", flat shading: "+(o.length/3===s.length?"YES":"NO"))}else i+=", flat shading: UNKNOWN";return i},i.prototype._unBindEffect=function(){r.prototype._unBindEffect.call(this);for(var e=0,t=this.instances;e<t.length;e++){t[e]._unBindEffect()}},Object.defineProperty(i.prototype,"hasLODLevels",{get:function(){return this._LODLevels.length>0},enumerable:!0,configurable:!0}),i.prototype.getLODLevels=function(){return this._LODLevels},i.prototype._sortLODLevels=function(){this._LODLevels.sort((function(e,t){return e.distance<t.distance?1:e.distance>t.distance?-1:0}))},i.prototype.addLODLevel=function(t,r){if(r&&r._masterMesh)return e.Tools.Warn("You cannot use a mesh as LOD level twice"),this;var i=new e.MeshLODLevel(t,r);return this._LODLevels.push(i),r&&(r._masterMesh=this),this._sortLODLevels(),this},i.prototype.getLODLevelAtDistance=function(e){for(var t=0;t<this._LODLevels.length;t++){var r=this._LODLevels[t];if(r.distance===e)return r.mesh}return null},i.prototype.removeLODLevel=function(e){for(var t=0;t<this._LODLevels.length;t++)this._LODLevels[t].mesh===e&&(this._LODLevels.splice(t,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this},i.prototype.getLOD=function(e,t){if(!this._LODLevels||0===this._LODLevels.length)return this;var r;if(t)r=t;else{r=this.getBoundingInfo().boundingSphere}var i=r.centerWorld.subtract(e.globalPosition).length();if(this._LODLevels[this._LODLevels.length-1].distance>i)return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this._LODLevels[this._LODLevels.length-1].mesh),this;for(var n=0;n<this._LODLevels.length;n++){var s=this._LODLevels[n];if(s.distance<i)return s.mesh&&(s.mesh._preActivate(),s.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)),this.onLODLevelSelection&&this.onLODLevelSelection(i,this,s.mesh),s.mesh}return this.onLODLevelSelection&&this.onLODLevelSelection(i,this,this),this},Object.defineProperty(i.prototype,"geometry",{get:function(){return this._geometry},enumerable:!0,configurable:!0}),i.prototype.getTotalVertices=function(){return null===this._geometry||void 0===this._geometry?0:this._geometry.getTotalVertices()},i.prototype.getVerticesData=function(e,t,r){return this._geometry?this._geometry.getVerticesData(e,t,r):null},i.prototype.getVertexBuffer=function(e){return this._geometry?this._geometry.getVertexBuffer(e):null},i.prototype.isVerticesDataPresent=function(e){return this._geometry?this._geometry.isVerticesDataPresent(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)},i.prototype.isVertexBufferUpdatable=function(e){return this._geometry?this._geometry.isVertexBufferUpdatable(e):!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)},i.prototype.getVerticesDataKinds=function(){if(!this._geometry){var e=new Array;return this._delayInfo&&this._delayInfo.forEach((function(t,r,i){e.push(t)})),e}return this._geometry.getVerticesDataKinds()},i.prototype.getTotalIndices=function(){return this._geometry?this._geometry.getTotalIndices():0},i.prototype.getIndices=function(e){return this._geometry?this._geometry.getIndices(e):[]},Object.defineProperty(i.prototype,"isBlocked",{get:function(){return null!==this._masterMesh&&void 0!==this._masterMesh},enumerable:!0,configurable:!0}),i.prototype.isReady=function(t,i){if(void 0===t&&(t=!1),void 0===i&&(i=!1),this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADING)return!1;if(!r.prototype.isReady.call(this,t))return!1;if(!this.subMeshes||0===this.subMeshes.length)return!0;if(!t)return!0;var n=this.getEngine(),s=this.getScene(),o=i||n.getCaps().instancedArrays&&this.instances.length>0;this.computeWorldMatrix();var a=this.material||s.defaultMaterial;if(a)if(a.storeEffectOnSubMeshes)for(var h=0,u=this.subMeshes;h<u.length;h++){var l=u[h],c=l.getMaterial();if(c)if(c.storeEffectOnSubMeshes){if(!c.isReadyForSubMesh(this,l,o))return!1}else if(!c.isReady(this,o))return!1}else if(!a.isReady(this,o))return!1;for(var f=0,d=this._lightSources;f<d.length;f++){var p=d[f],_=p.getShadowGenerator();if(_)for(var m=0,g=this.subMeshes;m<g.length;m++){var l=g[m];if(!_.isReady(l,o))return!1}}for(var v=0,y=this._LODLevels;v<y.length;v++){var b=y[v];if(b.mesh&&!b.mesh.isReady(o))return!1}return!0},Object.defineProperty(i.prototype,"areNormalsFrozen",{get:function(){return this._areNormalsFrozen},enumerable:!0,configurable:!0}),i.prototype.freezeNormals=function(){return this._areNormalsFrozen=!0,this},i.prototype.unfreezeNormals=function(){return this._areNormalsFrozen=!1,this},Object.defineProperty(i.prototype,"overridenInstanceCount",{set:function(e){this._overridenInstanceCount=e},enumerable:!0,configurable:!0}),i.prototype._preActivate=function(){var e=this.getScene().getRenderId();return this._preActivateId===e?this:(this._preActivateId=e,this._visibleInstances=null,this)},i.prototype._preActivateForIntermediateRendering=function(e){return this._visibleInstances&&(this._visibleInstances.intermediateDefaultRenderId=e),this},i.prototype._registerInstanceForRenderId=function(e,t){return this._visibleInstances||(this._visibleInstances={},this._visibleInstances.defaultRenderId=t,this._visibleInstances.selfDefaultRenderId=this._renderId),this._visibleInstances[t]||(this._visibleInstances[t]=new Array),this._visibleInstances[t].push(e),this},i.prototype.refreshBoundingInfo=function(){return this._refreshBoundingInfo(!1)},i.prototype._refreshBoundingInfo=function(t){if(this._boundingInfo&&this._boundingInfo.isLocked)return this;var r=this._getPositionData(t);if(r){var i=e.Tools.ExtractMinAndMax(r,0,this.getTotalVertices());this._boundingInfo=new e.BoundingInfo(i.minimum,i.maximum)}if(this.subMeshes)for(var n=0;n<this.subMeshes.length;n++)this.subMeshes[n].refreshBoundingInfo();return this._updateBoundingInfo(),this},i.prototype._getPositionData=function(t){var r=this.getVerticesData(e.VertexBuffer.PositionKind);if(r&&t&&this.skeleton){r=e.Tools.Slice(r);var i=this.getVerticesData(e.VertexBuffer.MatricesIndicesKind),n=this.getVerticesData(e.VertexBuffer.MatricesWeightsKind);if(n&&i)for(var s=this.numBoneInfluencers>4,o=s?this.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind):null,a=s?this.getVerticesData(e.VertexBuffer.MatricesWeightsExtraKind):null,h=this.skeleton.getTransformMatrices(this),u=e.Tmp.Vector3[0],l=e.Tmp.Matrix[0],c=e.Tmp.Matrix[1],f=0,d=0;d<r.length;d+=3,f+=4){l.reset();var p,_;for(p=0;p<4&&!((_=n[f+p])<=0);p++)e.Matrix.FromFloat32ArrayToRefScaled(h,Math.floor(16*i[f+p]),_,c),l.addToSelf(c);if(s)for(p=0;p<4&&!((_=a[f+p])<=0);p++)e.Matrix.FromFloat32ArrayToRefScaled(h,Math.floor(16*o[f+p]),_,c),l.addToSelf(c);e.Vector3.TransformCoordinatesFromFloatsToRef(r[d],r[d+1],r[d+2],l,u),u.toArray(r,d)}}return r},i.prototype._createGlobalSubMesh=function(t){var r=this.getTotalVertices();if(!r||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){var i=this.getIndices();if(!i)return null;var n=i.length,s=!1;if(t)s=!0;else for(var o=0,a=this.subMeshes;o<a.length;o++){var h=a[o];if(h.indexStart+h.indexCount>=n){s=!0;break}if(h.verticesStart+h.verticesCount>=r){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new e.SubMesh(0,0,r,0,this.getTotalIndices(),this)},i.prototype.subdivide=function(t){if(!(t<1)){for(var r=this.getTotalIndices(),i=r/t|0,n=0;i%3!=0;)i++;this.releaseSubMeshes();for(var s=0;s<t&&!(n>=r);s++)e.SubMesh.CreateFromIndices(0,n,Math.min(i,r-n),this),n+=i;this.synchronizeInstances()}},i.prototype.setVerticesData=function(t,r,i,n){if(void 0===i&&(i=!1),this._geometry)this._geometry.setVerticesData(t,r,i,n);else{var s=new e.VertexData;s.set(r,t);var o=this.getScene();new e.Geometry(e.Geometry.RandomId(),o,s,i,this)}return this},i.prototype.markVerticesDataAsUpdatable=function(e,t){void 0===t&&(t=!0);var r=this.getVertexBuffer(e);r&&r.isUpdatable()!==t&&this.setVerticesData(e,this.getVerticesData(e),t)},i.prototype.setVerticesBuffer=function(t){return this._geometry||(this._geometry=e.Geometry.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(t),this},i.prototype.updateVerticesData=function(e,t,r,i){return this._geometry?(i?(this.makeGeometryUnique(),this.updateVerticesData(e,t,r,!1)):this._geometry.updateVerticesData(e,t,r),this):this},i.prototype.updateMeshPositions=function(t,r){void 0===r&&(r=!0);var i=this.getVerticesData(e.VertexBuffer.PositionKind);if(!i)return this;if(t(i),this.updateVerticesData(e.VertexBuffer.PositionKind,i,!1,!1),r){var n=this.getIndices(),s=this.getVerticesData(e.VertexBuffer.NormalKind);if(!s)return this;e.VertexData.ComputeNormals(i,n,s),this.updateVerticesData(e.VertexBuffer.NormalKind,s,!1,!1)}return this},i.prototype.makeGeometryUnique=function(){if(!this._geometry)return this;var t=this._geometry,r=this._geometry.copy(e.Geometry.RandomId());return t.releaseForMesh(this,!0),r.applyToMesh(this),this},i.prototype.setIndices=function(t,r,i){if(void 0===r&&(r=null),void 0===i&&(i=!1),this._geometry)this._geometry.setIndices(t,r,i);else{var n=new e.VertexData;n.indices=t;var s=this.getScene();new e.Geometry(e.Geometry.RandomId(),s,n,i,this)}return this},i.prototype.updateIndices=function(e,t){return this._geometry?(this._geometry.updateIndices(e,t),this):this},i.prototype.toLeftHanded=function(){return this._geometry?(this._geometry.toLeftHanded(),this):this},i.prototype._bind=function(t,r,i){if(!this._geometry)return this;var n,s=this.getScene().getEngine();if(this._unIndexed)n=null;else switch(i){case e.Material.PointFillMode:n=null;break;case e.Material.WireFrameFillMode:n=t.getLinesIndexBuffer(this.getIndices(),s);break;default:case e.Material.TriangleFillMode:n=this._unIndexed?null:this._geometry.getIndexBuffer()}return this._geometry._bind(r,n),this},i.prototype._draw=function(t,r,i,n){if(void 0===n&&(n=!1),!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this.onBeforeDrawObservable.notifyObservers(this);var s=this.getScene(),o=s.getEngine();if(this._unIndexed||r==e.Material.PointFillMode?o.drawArraysType(r,t.verticesStart,t.verticesCount,i):r==e.Material.WireFrameFillMode?o.drawElementsType(r,0,t.linesIndexCount,i):o.drawElementsType(r,t.indexStart,t.indexCount,i),s._isAlternateRenderingEnabled&&!n){var a=t.effect||this._effectiveMaterial.getEffect();if(!a||!s.activeCamera)return this;s._switchToAlternateCameraConfiguration(!0),this._effectiveMaterial.bindView(a),this._effectiveMaterial.bindViewProjection(a),o.setViewport(s.activeCamera._alternateCamera.viewport),this._draw(t,r,i,!0),o.setViewport(s.activeCamera.viewport),s._switchToAlternateCameraConfiguration(!1),this._effectiveMaterial.bindView(a),this._effectiveMaterial.bindViewProjection(a)}return this},i.prototype.registerBeforeRender=function(e){return this.onBeforeRenderObservable.add(e),this},i.prototype.unregisterBeforeRender=function(e){return this.onBeforeRenderObservable.removeCallback(e),this},i.prototype.registerAfterRender=function(e){return this.onAfterRenderObservable.add(e),this},i.prototype.unregisterAfterRender=function(e){return this.onAfterRenderObservable.removeCallback(e),this},i.prototype._getInstancesRenderList=function(e){var t=this.getScene();if(this._batchCache.mustReturn=!1,this._batchCache.renderSelf[e]=this.isEnabled()&&this.isVisible,this._batchCache.visibleInstances[e]=null,this._visibleInstances){var r=t.getRenderId(),i=t._isInIntermediateRendering()?this._visibleInstances.intermediateDefaultRenderId:this._visibleInstances.defaultRenderId;this._batchCache.visibleInstances[e]=this._visibleInstances[r];var n=this._renderId;!this._batchCache.visibleInstances[e]&&i&&(this._batchCache.visibleInstances[e]=this._visibleInstances[i],r=Math.max(i,r),n=Math.max(this._visibleInstances.selfDefaultRenderId,r));var s=this._batchCache.visibleInstances[e];if(s&&s.length){if(this._renderIdForInstances[e]===r)return this._batchCache.mustReturn=!0,this._batchCache;r!==n&&(this._batchCache.renderSelf[e]=!1)}this._renderIdForInstances[e]=r}return this._batchCache},i.prototype._renderWithInstances=function(t,r,i,n,s){var o=i.visibleInstances[t._id];if(!o)return this;for(var a=o.length+1,h=16*a*4,u=this._instancesBufferSize,l=this._instancesBuffer;this._instancesBufferSize<h;)this._instancesBufferSize*=2;this._instancesData&&u==this._instancesBufferSize||(this._instancesData=new Float32Array(this._instancesBufferSize/4));var c=0,f=0,d=this.getWorldMatrix();if(i.renderSelf[t._id]&&(d.copyToArray(this._instancesData,c),c+=16,f++),o)for(var p=0;p<o.length;p++){var _=o[p];_.getWorldMatrix().copyToArray(this._instancesData,c),c+=16,f++}return l&&u==this._instancesBufferSize?l.updateDirectly(this._instancesData,0,f):(l&&l.dispose(),l=new e.Buffer(s,this._instancesData,!0,16,!1,!0),this._instancesBuffer=l,this.setVerticesBuffer(l.createVertexBuffer("world0",0,4)),this.setVerticesBuffer(l.createVertexBuffer("world1",4,4)),this.setVerticesBuffer(l.createVertexBuffer("world2",8,4)),this.setVerticesBuffer(l.createVertexBuffer("world3",12,4))),this._bind(t,n,r),this._draw(t,r,f),s.unbindInstanceAttributes(),this},i.prototype._processRendering=function(e,t,r,i,n,s,o){var a=this.getScene(),h=a.getEngine();if(n)this._renderWithInstances(e,r,i,t,h);else{i.renderSelf[e._id]&&(s&&s(!1,this.getWorldMatrix(),o),this._draw(e,r,this._overridenInstanceCount));var u=i.visibleInstances[e._id];if(u)for(var l=0;l<u.length;l++){var c=u[l],f=c.getWorldMatrix();s&&s(!0,f,o),this._draw(e,r)}}return this},i.prototype.render=function(t,r){if(this._checkOcclusionQuery(),this._isOccluded)return this;var i=this.getScene(),n=this._getInstancesRenderList(t._id);if(n.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this.onBeforeRenderObservable.notifyObservers(this);var s=i.getEngine(),o=s.getCaps().instancedArrays&&null!==n.visibleInstances[t._id]&&void 0!==n.visibleInstances[t._id],a=t.getMaterial();if(!a)return this;if(this._effectiveMaterial=a,this._effectiveMaterial.storeEffectOnSubMeshes){if(!this._effectiveMaterial.isReadyForSubMesh(this,t,o))return this}else if(!this._effectiveMaterial.isReady(this,o))return this;r&&s.setAlphaMode(this._effectiveMaterial.alphaMode);var h=s.getDepthWrite();this.renderOutline&&(s.setDepthWrite(!1),i.getOutlineRenderer().render(t,n),s.setDepthWrite(h));var u;if(!(u=this._effectiveMaterial.storeEffectOnSubMeshes?t.effect:this._effectiveMaterial.getEffect()))return this;var l=this.overrideMaterialSideOrientation;null==l&&(l=this._effectiveMaterial.sideOrientation,this._getWorldMatrixDeterminant()<0&&(l=l===e.Material.ClockWiseSideOrientation?e.Material.CounterClockWiseSideOrientation:e.Material.ClockWiseSideOrientation));var c=this._effectiveMaterial._preBind(u,l);this._effectiveMaterial.forceDepthWrite&&s.setDepthWrite(!0);var f=i.forcePointsCloud?e.Material.PointFillMode:i.forceWireframe?e.Material.WireFrameFillMode:this._effectiveMaterial.fillMode;o||this._bind(t,u,f);var d=this.getWorldMatrix();if(this._effectiveMaterial.storeEffectOnSubMeshes?this._effectiveMaterial.bindForSubMesh(d,this,t):this._effectiveMaterial.bind(d,this),!this._effectiveMaterial.backFaceCulling&&this._effectiveMaterial.separateCullingPass&&(s.setState(!0,this._effectiveMaterial.zOffset,!1,!c),this._processRendering(t,u,f,n,o,this._onBeforeDraw,this._effectiveMaterial),s.setState(!0,this._effectiveMaterial.zOffset,!1,c)),this._processRendering(t,u,f,n,o,this._onBeforeDraw,this._effectiveMaterial),this._effectiveMaterial.unbind(),this.renderOutline&&h&&(s.setDepthWrite(!0),s.setColorWrite(!1),i.getOutlineRenderer().render(t,n),s.setColorWrite(!0)),this.renderOverlay){var p=s.getAlphaMode();s.setAlphaMode(e.Engine.ALPHA_COMBINE),i.getOutlineRenderer().render(t,n,!0),s.setAlphaMode(p)}return this.onAfterRenderObservable.notifyObservers(this),this},i.prototype._onBeforeDraw=function(e,t,r){e&&r&&r.bindOnlyWorldMatrix(t)},i.prototype.getEmittedParticleSystems=function(){for(var e=new Array,t=0;t<this.getScene().particleSystems.length;t++){var r=this.getScene().particleSystems[t];r.emitter===this&&e.push(r)}return e},i.prototype.getHierarchyEmittedParticleSystems=function(){var e=new Array,t=this.getDescendants();t.push(this);for(var r=0;r<this.getScene().particleSystems.length;r++){var i=this.getScene().particleSystems[r],n=i.emitter;n.position&&-1!==t.indexOf(n)&&e.push(i)}return e},i.prototype.cleanMatrixWeights=function(){var t=0;if(this.skeleton){t=this.skeleton.bones.length;for(var r=this.getVerticesData(e.VertexBuffer.MatricesIndicesKind),i=this.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind),n=this.getVerticesData(e.VertexBuffer.MatricesWeightsKind),s=this.getVerticesData(e.VertexBuffer.MatricesWeightsExtraKind),o=this.numBoneInfluencers,a=n.length,h=0;h<a;h+=4){for(var u=0,l=-1,c=0;c<4;c++){var f=n[h+c];u+=f,f<.001&&l<0&&(l=c)}if(s)for(var c=0;c<4;c++){var f=s[h+c];u+=f,f<.001&&l<0&&(l=c+4)}if((l<0||l>o-1)&&(l=o-1),u>.001){for(var d=1/u,c=0;c<4;c++)n[h+c]*=d;if(s)for(var c=0;c<4;c++)s[h+c]*=d}else l>=4?(s[h+l-4]=1-u,i[h+l-4]=t):(n[h+l]=1-u,r[h+l]=t)}this.setVerticesData(e.VertexBuffer.MatricesIndicesKind,r),i&&this.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,i),this.setVerticesData(e.VertexBuffer.MatricesWeightsKind,n),s&&this.setVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,s)}},i.prototype._checkDelayState=function(){var t=this.getScene();return this._geometry?this._geometry.load(t):this.delayLoadState===e.Engine.DELAYLOADSTATE_NOTLOADED&&(this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADING,this._queueLoad(t)),this},i.prototype._queueLoad=function(t){var r=this;t._addPendingData(this);var i=-1!==this.delayLoadingFile.indexOf(".babylonbinarymeshdata");return e.Tools.LoadFile(this.delayLoadingFile,(function(i){i instanceof ArrayBuffer?r._delayLoadingFunction(i,r):r._delayLoadingFunction(JSON.parse(i),r),r.instances.forEach((function(e){e._syncSubMeshes()})),r.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED,t._removePendingData(r)}),(function(){}),t.database,i),this},i.prototype.isInFrustum=function(t){return this.delayLoadState!==e.Engine.DELAYLOADSTATE_LOADING&&(!!r.prototype.isInFrustum.call(this,t)&&(this._checkDelayState(),!0))},i.prototype.setMaterialByID=function(e){var t,r=this.getScene().materials;for(t=r.length-1;t>-1;t--)if(r[t].id===e)return this.material=r[t],this;var i=this.getScene().multiMaterials;for(t=i.length-1;t>-1;t--)if(i[t].id===e)return this.material=i[t],this;return this},i.prototype.getAnimatables=function(){var e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e},i.prototype.bakeTransformIntoVertices=function(t){if(!this.isVerticesDataPresent(e.VertexBuffer.PositionKind))return this;var r=this.subMeshes.splice(0);this._resetPointsArrayCache();var i,n=this.getVerticesData(e.VertexBuffer.PositionKind),s=new Array;for(i=0;i<n.length;i+=3)e.Vector3.TransformCoordinates(e.Vector3.FromArray(n,i),t).toArray(s,i);if(this.setVerticesData(e.VertexBuffer.PositionKind,s,this.getVertexBuffer(e.VertexBuffer.PositionKind).isUpdatable()),!this.isVerticesDataPresent(e.VertexBuffer.NormalKind))return this;for(n=this.getVerticesData(e.VertexBuffer.NormalKind),s=[],i=0;i<n.length;i+=3)e.Vector3.TransformNormal(e.Vector3.FromArray(n,i),t).normalize().toArray(s,i);return this.setVerticesData(e.VertexBuffer.NormalKind,s,this.getVertexBuffer(e.VertexBuffer.NormalKind).isUpdatable()),t.m[0]*t.m[5]*t.m[10]<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=r,this},i.prototype.bakeCurrentTransformIntoVertices=function(){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=e.Quaternion.Identity()),this._worldMatrix=e.Matrix.Identity(),this},Object.defineProperty(i.prototype,"_positions",{get:function(){return this._geometry?this._geometry._positions:null},enumerable:!0,configurable:!0}),i.prototype._resetPointsArrayCache=function(){return this._geometry&&this._geometry._resetPointsArrayCache(),this},i.prototype._generatePointsArray=function(){return!!this._geometry&&this._geometry._generatePointsArray()},i.prototype.clone=function(e,t,r,n){return void 0===n&&(n=!0),new i(e,this.getScene(),t,this,r,n)},i.prototype.dispose=function(e,t){var i=this;void 0===t&&(t=!1),this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);var n=this.getScene().meshes;for(n.forEach((function(e){var t=e;t._source&&t._source===i&&(t._source=null)})),this._source=null,this._instancesBuffer&&(this._instancesBuffer.dispose(),this._instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(var s=this.getScene().effectLayers,o=0;o<s.length;o++){var a=s[o];a&&a._disposeMesh(this)}r.prototype.dispose.call(this,e,t)},i.prototype.applyDisplacementMap=function(t,r,i,n,s,o){var a=this,h=this.getScene(),u=function(e){var t=document.createElement("canvas"),h=t.getContext("2d"),u=e.width,l=e.height;t.width=u,t.height=l,h.drawImage(e,0,0);var c=h.getImageData(0,0,u,l).data;a.applyDisplacementMapFromBuffer(c,u,l,r,i,s,o),n&&n(a)};return e.Tools.LoadImage(t,u,(function(){}),h.database),this},i.prototype.applyDisplacementMapFromBuffer=function(t,r,i,n,s,o,a){if(!this.isVerticesDataPresent(e.VertexBuffer.PositionKind)||!this.isVerticesDataPresent(e.VertexBuffer.NormalKind)||!this.isVerticesDataPresent(e.VertexBuffer.UVKind))return e.Tools.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;var h=this.getVerticesData(e.VertexBuffer.PositionKind),u=this.getVerticesData(e.VertexBuffer.NormalKind),l=this.getVerticesData(e.VertexBuffer.UVKind),c=e.Vector3.Zero(),f=e.Vector3.Zero(),d=e.Vector2.Zero();o=o||e.Vector2.Zero(),a=a||new e.Vector2(1,1);for(var p=0;p<h.length;p+=3){e.Vector3.FromArrayToRef(h,p,c),e.Vector3.FromArrayToRef(u,p,f),e.Vector2.FromArrayToRef(l,p/3*2,d);var _=Math.abs(d.x*a.x+o.x)*r%r|0,m=Math.abs(d.y*a.y+o.y)*i%i|0,g=4*(_+m*r),v=t[g]/255,y=t[g+1]/255,b=t[g+2]/255,T=.3*v+.59*y+.11*b;f.normalize(),f.scaleInPlace(n+(s-n)*T),c=c.add(f),c.toArray(h,p)}return e.VertexData.ComputeNormals(h,this.getIndices(),u),this.updateVerticesData(e.VertexBuffer.PositionKind,h),this.updateVerticesData(e.VertexBuffer.NormalKind,u),this},i.prototype.convertToFlatShadedMesh=function(){var t,r,i=this.getVerticesDataKinds(),n={},s={},o={},a=!1;for(t=0;t<i.length;t++){r=i[t];var h=this.getVertexBuffer(r);r!==e.VertexBuffer.NormalKind?(n[r]=h,s[r]=n[r].getData(),o[r]=[]):(a=h.isUpdatable(),i.splice(t,1),t--)}var u,l=this.subMeshes.slice(0),c=this.getIndices(),f=this.getTotalIndices();for(u=0;u<f;u++){var d=c[u];for(t=0;t<i.length;t++){r=i[t];for(var p=n[r].getStrideSize(),_=0;_<p;_++)o[r].push(s[r][d*p+_])}}var m=[],g=o[e.VertexBuffer.PositionKind];for(u=0;u<f;u+=3){c[u]=u,c[u+1]=u+1,c[u+2]=u+2;for(var v=e.Vector3.FromArray(g,3*u),y=e.Vector3.FromArray(g,3*(u+1)),b=e.Vector3.FromArray(g,3*(u+2)),T=v.subtract(y),E=b.subtract(y),x=e.Vector3.Normalize(e.Vector3.Cross(T,E)),A=0;A<3;A++)m.push(x.x),m.push(x.y),m.push(x.z)}for(this.setIndices(c),this.setVerticesData(e.VertexBuffer.NormalKind,m,a),t=0;t<i.length;t++)r=i[t],this.setVerticesData(r,o[r],n[r].isUpdatable());this.releaseSubMeshes();for(var M=0;M<l.length;M++){var P=l[M];e.SubMesh.AddToMesh(P.materialIndex,P.indexStart,P.indexCount,P.indexStart,P.indexCount,this)}return this.synchronizeInstances(),this},i.prototype.convertToUnIndexedMesh=function(){var t,r,i=this.getVerticesDataKinds(),n={},s={},o={};for(t=0;t<i.length;t++){r=i[t];var a=this.getVertexBuffer(r);n[r]=a,s[r]=n[r].getData(),o[r]=[]}var h,u=this.subMeshes.slice(0),l=this.getIndices(),c=this.getTotalIndices();for(h=0;h<c;h++){var f=l[h];for(t=0;t<i.length;t++){r=i[t];for(var d=n[r].getStrideSize(),p=0;p<d;p++)o[r].push(s[r][f*d+p])}}for(h=0;h<c;h+=3)l[h]=h,l[h+1]=h+1,l[h+2]=h+2;for(this.setIndices(l),t=0;t<i.length;t++)r=i[t],this.setVerticesData(r,o[r],n[r].isUpdatable());this.releaseSubMeshes();for(var _=0;_<u.length;_++){var m=u[_];e.SubMesh.AddToMesh(m.materialIndex,m.indexStart,m.indexCount,m.indexStart,m.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this},i.prototype.flipFaces=function(t){void 0===t&&(t=!1);var r,i=e.VertexData.ExtractFromMesh(this);if(t&&this.isVerticesDataPresent(e.VertexBuffer.NormalKind)&&i.normals)for(r=0;r<i.normals.length;r++)i.normals[r]*=-1;if(i.indices){var n;for(r=0;r<i.indices.length;r+=3)n=i.indices[r+1],i.indices[r+1]=i.indices[r+2],i.indices[r+2]=n}return i.applyToMesh(this),this},i.prototype.createInstance=function(t){return new e.InstancedMesh(t,this)},i.prototype.synchronizeInstances=function(){for(var e=0;e<this.instances.length;e++){this.instances[e]._syncSubMeshes()}return this},i.prototype.simplify=function(t,r,i,n){return void 0===r&&(r=!0),void 0===i&&(i=e.SimplificationType.QUADRATIC),this.getScene().simplificationQueue.addTask({settings:t,parallelProcessing:r,mesh:this,simplificationType:i,successCallback:n}),this},i.prototype.optimizeIndices=function(t){var r=this,i=this.getIndices(),n=this.getVerticesData(e.VertexBuffer.PositionKind);if(!n||!i)return this;for(var s=new Array,o=0;o<n.length;o+=3)s.push(e.Vector3.FromArray(n,o));var a=new Array;return e.AsyncLoop.SyncAsyncForLoop(s.length,40,(function(e){for(var t=s.length-1-e,r=s[t],i=0;i<t;++i){var n=s[i];if(r.equals(n)){a[t]=i;break}}}),(function(){for(var e=0;e<i.length;++e)i[e]=a[i[e]]||i[e];var n=r.subMeshes.slice(0);r.setIndices(i),r.subMeshes=n,t&&t(r)})),this},i.prototype.serialize=function(t){t.name=this.name,t.id=this.id,t.type=this.getClassName(),e.Tags&&e.Tags.HasTags(this)&&(t.tags=e.Tags.GetTags(this)),t.position=this.position.asArray(),this.rotationQuaternion?t.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(t.rotation=this.rotation.asArray()),t.scaling=this.scaling.asArray(),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(!1),t.isVisible=this.isVisible,t.infiniteDistance=this.infiniteDistance,t.pickable=this.isPickable,t.receiveShadows=this.receiveShadows,t.billboardMode=this.billboardMode,t.visibility=this.visibility,t.checkCollisions=this.checkCollisions,t.isBlocker=this.isBlocker,this.parent&&(t.parentId=this.parent.id),t.isUnIndexed=this.isUnIndexed;var r=this._geometry;if(r){var i=r.id;t.geometryId=i,t.subMeshes=[];for(var n=0;n<this.subMeshes.length;n++){var s=this.subMeshes[n];t.subMeshes.push({materialIndex:s.materialIndex,verticesStart:s.verticesStart,verticesCount:s.verticesCount,indexStart:s.indexStart,indexCount:s.indexCount})}}this.material?t.materialId=this.material.id:this.material=null,this.morphTargetManager&&(t.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(t.skeletonId=this.skeleton.id);var o=this.getPhysicsImpostor();o&&(t.physicsMass=o.getParam("mass"),t.physicsFriction=o.getParam("friction"),t.physicsRestitution=o.getParam("mass"),t.physicsImpostor=o.type),this.metadata&&(t.metadata=this.metadata),t.instances=[];for(var a=0;a<this.instances.length;a++){var h=this.instances[a],u={name:h.name,id:h.id,position:h.position.asArray(),scaling:h.scaling.asArray()}
;h.rotationQuaternion?u.rotationQuaternion=h.rotationQuaternion.asArray():h.rotation&&(u.rotation=h.rotation.asArray()),t.instances.push(u),e.Animation.AppendSerializedAnimations(h,u),u.ranges=h.serializeAnimationRanges()}e.Animation.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t.layerMask=this.layerMask,t.alphaIndex=this.alphaIndex,t.hasVertexAlpha=this.hasVertexAlpha,t.overlayAlpha=this.overlayAlpha,t.overlayColor=this.overlayColor.asArray(),t.renderOverlay=this.renderOverlay,t.applyFog=this.applyFog,this.actionManager&&(t.actions=this.actionManager.serialize(this.name))},i.prototype._syncGeometryWithMorphTargetManager=function(){if(this.geometry){this._markSubMeshesAsAttributesDirty();var t=this._morphTargetManager;if(t&&t.vertexCount){if(t.vertexCount!==this.getTotalVertices())return e.Tools.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),void(this.morphTargetManager=null);for(var r=0;r<t.numInfluencers;r++){var i=t.getActiveTarget(r),n=i.getPositions();if(!n)return void e.Tools.Error("Invalid morph target. Target must have positions.");this.geometry.setVerticesData(e.VertexBuffer.PositionKind+r,n,!1,3);var s=i.getNormals();s&&this.geometry.setVerticesData(e.VertexBuffer.NormalKind+r,s,!1,3);var o=i.getTangents();o&&this.geometry.setVerticesData(e.VertexBuffer.TangentKind+r,o,!1,3)}}else for(var r=0;this.geometry.isVerticesDataPresent(e.VertexBuffer.PositionKind+r);)this.geometry.removeVerticesData(e.VertexBuffer.PositionKind+r),this.geometry.isVerticesDataPresent(e.VertexBuffer.NormalKind+r)&&this.geometry.removeVerticesData(e.VertexBuffer.NormalKind+r),this.geometry.isVerticesDataPresent(e.VertexBuffer.TangentKind+r)&&this.geometry.removeVerticesData(e.VertexBuffer.TangentKind+r),r++}},i.Parse=function(t,r,n){var s;if(s=t.type&&"GroundMesh"===t.type?e.GroundMesh.Parse(t,r):new i(t.name,r),s.id=t.id,e.Tags&&e.Tags.AddTagsTo(s,t.tags),s.position=e.Vector3.FromArray(t.position),void 0!==t.metadata&&(s.metadata=t.metadata),t.rotationQuaternion?s.rotationQuaternion=e.Quaternion.FromArray(t.rotationQuaternion):t.rotation&&(s.rotation=e.Vector3.FromArray(t.rotation)),s.scaling=e.Vector3.FromArray(t.scaling),t.localMatrix?s.setPreTransformMatrix(e.Matrix.FromArray(t.localMatrix)):t.pivotMatrix&&s.setPivotMatrix(e.Matrix.FromArray(t.pivotMatrix)),s.setEnabled(t.isEnabled),s.isVisible=t.isVisible,s.infiniteDistance=t.infiniteDistance,s.showBoundingBox=t.showBoundingBox,s.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox,void 0!==t.applyFog&&(s.applyFog=t.applyFog),void 0!==t.pickable&&(s.isPickable=t.pickable),void 0!==t.alphaIndex&&(s.alphaIndex=t.alphaIndex),s.receiveShadows=t.receiveShadows,s.billboardMode=t.billboardMode,void 0!==t.visibility&&(s.visibility=t.visibility),s.checkCollisions=t.checkCollisions,void 0!==t.isBlocker&&(s.isBlocker=t.isBlocker),s._shouldGenerateFlatShading=t.useFlatShading,t.freezeWorldMatrix&&(s._waitingFreezeWorldMatrix=t.freezeWorldMatrix),t.parentId&&(s._waitingParentId=t.parentId),void 0!==t.actions&&(s._waitingActions=t.actions),void 0!==t.overlayAlpha&&(s.overlayAlpha=t.overlayAlpha),void 0!==t.overlayColor&&(s.overlayColor=e.Color3.FromArray(t.overlayColor)),void 0!==t.renderOverlay&&(s.renderOverlay=t.renderOverlay),s.isUnIndexed=!!t.isUnIndexed,s.hasVertexAlpha=t.hasVertexAlpha,t.delayLoadingFile?(s.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED,s.delayLoadingFile=n+t.delayLoadingFile,s._boundingInfo=new e.BoundingInfo(e.Vector3.FromArray(t.boundingBoxMinimum),e.Vector3.FromArray(t.boundingBoxMaximum)),t._binaryInfo&&(s._binaryInfo=t._binaryInfo),s._delayInfo=[],t.hasUVs&&s._delayInfo.push(e.VertexBuffer.UVKind),t.hasUVs2&&s._delayInfo.push(e.VertexBuffer.UV2Kind),t.hasUVs3&&s._delayInfo.push(e.VertexBuffer.UV3Kind),t.hasUVs4&&s._delayInfo.push(e.VertexBuffer.UV4Kind),t.hasUVs5&&s._delayInfo.push(e.VertexBuffer.UV5Kind),t.hasUVs6&&s._delayInfo.push(e.VertexBuffer.UV6Kind),t.hasColors&&s._delayInfo.push(e.VertexBuffer.ColorKind),t.hasMatricesIndices&&s._delayInfo.push(e.VertexBuffer.MatricesIndicesKind),t.hasMatricesWeights&&s._delayInfo.push(e.VertexBuffer.MatricesWeightsKind),s._delayLoadingFunction=e.Geometry._ImportGeometry,e.SceneLoader.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):e.Geometry._ImportGeometry(t,s),t.materialId?s.setMaterialByID(t.materialId):s.material=null,t.morphTargetManagerId>-1&&(s.morphTargetManager=r.getMorphTargetManagerById(t.morphTargetManagerId)),t.skeletonId>-1&&(s.skeleton=r.getLastSkeletonByID(t.skeletonId),t.numBoneInfluencers&&(s.numBoneInfluencers=t.numBoneInfluencers)),t.animations){for(var o=0;o<t.animations.length;o++){var a=t.animations[o];s.animations.push(e.Animation.Parse(a))}e.Node.ParseAnimationRanges(s,t,r)}if(t.autoAnimate&&r.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.layerMask&&!isNaN(t.layerMask)?s.layerMask=Math.abs(parseInt(t.layerMask)):s.layerMask=268435455,t.physicsImpostor&&(s.physicsImpostor=new e.PhysicsImpostor(s,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},r)),t.instances)for(var h=0;h<t.instances.length;h++){var u=t.instances[h],l=s.createInstance(u.name);if(u.id&&(l.id=u.id),e.Tags&&e.Tags.AddTagsTo(l,u.tags),l.position=e.Vector3.FromArray(u.position),u.parentId&&(l._waitingParentId=u.parentId),u.rotationQuaternion?l.rotationQuaternion=e.Quaternion.FromArray(u.rotationQuaternion):u.rotation&&(l.rotation=e.Vector3.FromArray(u.rotation)),l.scaling=e.Vector3.FromArray(u.scaling),l.checkCollisions=s.checkCollisions,t.animations){for(o=0;o<t.animations.length;o++)a=t.animations[o],l.animations.push(e.Animation.Parse(a));e.Node.ParseAnimationRanges(l,t,r),t.autoAnimate&&r.beginAnimation(l,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1)}}return s},i.CreateRibbon=function(t,r,i,n,s,o,a,h,u){return void 0===i&&(i=!1),void 0===a&&(a=!1),e.MeshBuilder.CreateRibbon(t,{pathArray:r,closeArray:i,closePath:n,offset:s,updatable:a,sideOrientation:h,instance:u},o)},i.CreateDisc=function(t,r,i,n,s,o){void 0===n&&(n=null);var a={radius:r,tessellation:i,sideOrientation:o,updatable:s};return e.MeshBuilder.CreateDisc(t,a,n)},i.CreateBox=function(t,r,i,n,s){void 0===i&&(i=null);var o={size:r,sideOrientation:s,updatable:n};return e.MeshBuilder.CreateBox(t,o,i)},i.CreateSphere=function(t,r,i,n,s,o){var a={segments:r,diameterX:i,diameterY:i,diameterZ:i,sideOrientation:o,updatable:s};return e.MeshBuilder.CreateSphere(t,a,n)},i.CreateCylinder=function(t,r,n,s,o,a,h,u,l){void 0!==h&&h instanceof e.Scene||(void 0!==h&&(l=u||i.DEFAULTSIDE,u=h),h=a,a=1);var c={height:r,diameterTop:n,diameterBottom:s,tessellation:o,subdivisions:a,sideOrientation:l,updatable:u};return e.MeshBuilder.CreateCylinder(t,c,h)},i.CreateTorus=function(t,r,i,n,s,o,a){var h={diameter:r,thickness:i,tessellation:n,sideOrientation:a,updatable:o};return e.MeshBuilder.CreateTorus(t,h,s)},i.CreateTorusKnot=function(t,r,i,n,s,o,a,h,u,l){var c={radius:r,tube:i,radialSegments:n,tubularSegments:s,p:o,q:a,sideOrientation:l,updatable:u};return e.MeshBuilder.CreateTorusKnot(t,c,h)},i.CreateLines=function(t,r,i,n,s){void 0===i&&(i=null),void 0===n&&(n=!1),void 0===s&&(s=null);var o={points:r,updatable:n,instance:s};return e.MeshBuilder.CreateLines(t,o,i)},i.CreateDashedLines=function(t,r,i,n,s,o,a,h){void 0===o&&(o=null);var u={points:r,dashSize:i,gapSize:n,dashNb:s,updatable:a,instance:h};return e.MeshBuilder.CreateDashedLines(t,u,o)},i.CreatePolygon=function(t,r,i,n,s,o){var a={shape:r,holes:n,updatable:s,sideOrientation:o};return e.MeshBuilder.CreatePolygon(t,a,i)},i.ExtrudePolygon=function(t,r,i,n,s,o,a){var h={shape:r,holes:s,depth:i,updatable:o,sideOrientation:a};return e.MeshBuilder.ExtrudePolygon(t,h,n)},i.ExtrudeShape=function(t,r,n,s,o,a,h,u,l,c){void 0===h&&(h=null);var f={shape:r,path:n,scale:s,rotation:o,cap:0===a?0:a||i.NO_CAP,sideOrientation:l,instance:c,updatable:u};return e.MeshBuilder.ExtrudeShape(t,f,h)},i.ExtrudeShapeCustom=function(t,r,n,s,o,a,h,u,l,c,f,d){var p={shape:r,path:n,scaleFunction:s,rotationFunction:o,ribbonCloseArray:a,ribbonClosePath:h,cap:0===u?0:u||i.NO_CAP,sideOrientation:f,instance:d,updatable:c};return e.MeshBuilder.ExtrudeShapeCustom(t,p,l)},i.CreateLathe=function(t,r,i,n,s,o,a){var h={shape:r,radius:i,tessellation:n,sideOrientation:a,updatable:o};return e.MeshBuilder.CreateLathe(t,h,s)},i.CreatePlane=function(t,r,i,n,s){var o={size:r,width:r,height:r,sideOrientation:s,updatable:n};return e.MeshBuilder.CreatePlane(t,o,i)},i.CreateGround=function(t,r,i,n,s,o){var a={width:r,height:i,subdivisions:n,updatable:o};return e.MeshBuilder.CreateGround(t,a,s)},i.CreateTiledGround=function(t,r,i,n,s,o,a,h,u){var l={xmin:r,zmin:i,xmax:n,zmax:s,subdivisions:o,precision:a,updatable:u};return e.MeshBuilder.CreateTiledGround(t,l,h)},i.CreateGroundFromHeightMap=function(t,r,i,n,s,o,a,h,u,l){var c={width:i,height:n,subdivisions:s,minHeight:o,maxHeight:a,updatable:u,onReady:l};return e.MeshBuilder.CreateGroundFromHeightMap(t,r,c,h)},i.CreateTube=function(t,r,i,n,s,o,a,h,u,l){var c={path:r,radius:i,tessellation:n,radiusFunction:s,arc:1,cap:o,updatable:h,sideOrientation:u,instance:l};return e.MeshBuilder.CreateTube(t,c,a)},i.CreatePolyhedron=function(t,r,i){return e.MeshBuilder.CreatePolyhedron(t,r,i)},i.CreateIcoSphere=function(t,r,i){return e.MeshBuilder.CreateIcoSphere(t,r,i)},i.CreateDecal=function(t,r,i,n,s,o){var a={position:i,normal:n,size:s,angle:o};return e.MeshBuilder.CreateDecal(t,r,a)},i.prototype.setPositionsForCPUSkinning=function(){if(!this._sourcePositions){var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(!t)return this._sourcePositions;this._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(e.VertexBuffer.PositionKind)||this.setVerticesData(e.VertexBuffer.PositionKind,t,!0)}return this._sourcePositions},i.prototype.setNormalsForCPUSkinning=function(){if(!this._sourceNormals){var t=this.getVerticesData(e.VertexBuffer.NormalKind);if(!t)return this._sourceNormals;this._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(e.VertexBuffer.NormalKind)||this.setVerticesData(e.VertexBuffer.NormalKind,t,!0)}return this._sourceNormals},i.prototype.applySkeleton=function(t){if(!this.geometry)return this;if(this.geometry._softwareSkinningRenderId==this.getScene().getRenderId())return this;if(this.geometry._softwareSkinningRenderId=this.getScene().getRenderId(),!this.isVerticesDataPresent(e.VertexBuffer.PositionKind))return this;if(!this.isVerticesDataPresent(e.VertexBuffer.NormalKind))return this;if(!this.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind))return this;if(!this._sourcePositions){var r=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=r}this._sourceNormals||this.setNormalsForCPUSkinning();var i=this.getVerticesData(e.VertexBuffer.PositionKind);if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i));var n=this.getVerticesData(e.VertexBuffer.NormalKind);if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n));var s=this.getVerticesData(e.VertexBuffer.MatricesIndicesKind),o=this.getVerticesData(e.VertexBuffer.MatricesWeightsKind);if(!o||!s)return this;for(var a,h=this.numBoneInfluencers>4,u=h?this.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind):null,l=h?this.getVerticesData(e.VertexBuffer.MatricesWeightsExtraKind):null,c=t.getTransformMatrices(this),f=e.Vector3.Zero(),d=new e.Matrix,p=new e.Matrix,_=0,m=0;m<i.length;m+=3,_+=4){var g;for(a=0;a<4&&(g=o[_+a])>0;a++)e.Matrix.FromFloat32ArrayToRefScaled(c,Math.floor(16*s[_+a]),g,p),d.addToSelf(p);if(h)for(a=0;a<4&&(g=l[_+a])>0;a++)e.Matrix.FromFloat32ArrayToRefScaled(c,Math.floor(16*u[_+a]),g,p),d.addToSelf(p);e.Vector3.TransformCoordinatesFromFloatsToRef(this._sourcePositions[m],this._sourcePositions[m+1],this._sourcePositions[m+2],d,f),f.toArray(i,m),e.Vector3.TransformNormalFromFloatsToRef(this._sourceNormals[m],this._sourceNormals[m+1],this._sourceNormals[m+2],d,f),f.toArray(n,m),d.reset()}return this.updateVerticesData(e.VertexBuffer.PositionKind,i),this.updateVerticesData(e.VertexBuffer.NormalKind,n),this},i.MinMax=function(t){var r=null,i=null;return t.forEach((function(e,t,n){var s=e.getBoundingInfo(),o=s.boundingBox;r&&i?(r.minimizeInPlace(o.minimumWorld),i.maximizeInPlace(o.maximumWorld)):(r=o.minimumWorld,i=o.maximumWorld)})),r&&i?{min:r,max:i}:{min:e.Vector3.Zero(),max:e.Vector3.Zero()}},i.Center=function(t){var r=t instanceof Array?i.MinMax(t):t;return e.Vector3.Center(r.min,r.max)},i.MergeMeshes=function(t,r,n,s,o){void 0===r&&(r=!0);var a;if(!n){var h=0;for(a=0;a<t.length;a++)if(t[a]&&(h+=t[a].getTotalVertices())>65536)return e.Tools.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}var u,l=null,c=new Array,f=null;for(a=0;a<t.length;a++)t[a]&&(t[a].computeWorldMatrix(!0),u=e.VertexData.ExtractFromMesh(t[a],!0,!0),u.transform(t[a].getWorldMatrix()),l?l.merge(u):(l=u,f=t[a]),o&&c.push(t[a].getTotalIndices()));if(f=f,s||(s=new i(f.name+"_merged",f.getScene())),l.applyToMesh(s),s.material=f.material,s.checkCollisions=f.checkCollisions,r)for(a=0;a<t.length;a++)t[a]&&t[a].dispose();if(o){s.releaseSubMeshes(),a=0;for(var d=0;a<c.length;)e.SubMesh.CreateFromIndices(0,d,c[a],s),d+=c[a],a++}return s},i._FRONTSIDE=0,i._BACKSIDE=1,i._DOUBLESIDE=2,i._DEFAULTSIDE=0,i._NO_CAP=0,i._CAP_START=1,i._CAP_END=2,i._CAP_ALL=3,i})(e.AbstractMesh);e.Mesh=r})(i||(i={}));var i;!(function(e){var t=(function(){function e(){}return Object.defineProperty(e.prototype,"effect",{get:function(){return this._materialEffect},enumerable:!0,configurable:!0}),e.prototype.setEffect=function(e,t){if(void 0===t&&(t=null),this._materialEffect===e)return void(e||(this._materialDefines=null));this._materialDefines=t,this._materialEffect=e},e})();e.BaseSubMesh=t;var r=(function(t){function r(e,r,i,n,s,o,a,h){void 0===h&&(h=!0);var u=t.call(this)||this;return u.materialIndex=e,u.verticesStart=r,u.verticesCount=i,u.indexStart=n,u.indexCount=s,u._renderId=0,u._mesh=o,u._renderingMesh=a||o,o.subMeshes.push(u),u._trianglePlanes=[],u._id=o.subMeshes.length-1,h&&(u.refreshBoundingInfo(),o.computeWorldMatrix(!0)),u}return s(r,t),r.AddToMesh=function(e,t,i,n,s,o,a,h){return void 0===h&&(h=!0),new r(e,t,i,n,s,o,a,h)},Object.defineProperty(r.prototype,"IsGlobal",{get:function(){return 0===this.verticesStart&&this.verticesCount==this._mesh.getTotalVertices()},enumerable:!0,configurable:!0}),r.prototype.getBoundingInfo=function(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo},r.prototype.setBoundingInfo=function(e){return this._boundingInfo=e,this},r.prototype.getMesh=function(){return this._mesh},r.prototype.getRenderingMesh=function(){return this._renderingMesh},r.prototype.getMaterial=function(){var e=this._renderingMesh.material;if(null===e||void 0===e)return this._mesh.getScene().defaultMaterial;if(e.getSubMaterial){var t=e,r=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==r&&(this._currentMaterial=r,this._materialDefines=null),r}return e},r.prototype.refreshBoundingInfo=function(){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;var t=this._renderingMesh.getVerticesData(e.VertexBuffer.PositionKind);if(!t)return this._boundingInfo=this._mesh.getBoundingInfo(),this;var r,i=this._renderingMesh.getIndices();if(0===this.indexStart&&this.indexCount===i.length){var n=this._renderingMesh.getBoundingInfo();r={minimum:n.minimum.clone(),maximum:n.maximum.clone()}}else r=e.Tools.ExtractMinAndMaxIndexed(t,i,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo=new e.BoundingInfo(r.minimum,r.maximum),this},r.prototype._checkCollision=function(e){return this.getBoundingInfo()._checkCollision(e)},r.prototype.updateBoundingInfo=function(e){var t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t.update(e),this},r.prototype.isInFrustum=function(e){var t=this.getBoundingInfo();return!!t&&t.isInFrustum(e)},r.prototype.isCompletelyInFrustum=function(e){var t=this.getBoundingInfo();return!!t&&t.isCompletelyInFrustum(e)},r.prototype.render=function(e){return this._renderingMesh.render(this,e),this},r.prototype.getLinesIndexBuffer=function(e,t){if(!this._linesIndexBuffer){for(var r=[],i=this.indexStart;i<this.indexStart+this.indexCount;i+=3)r.push(e[i],e[i+1],e[i+1],e[i+2],e[i+2],e[i]);this._linesIndexBuffer=t.createIndexBuffer(r),this.linesIndexCount=r.length}return this._linesIndexBuffer},r.prototype.canIntersects=function(e){var t=this.getBoundingInfo();return!!t&&e.intersectsBox(t.boundingBox)},r.prototype.intersects=function(t,r,i,n){var s=null,o=this.getMaterial();if(!o)return null;switch(o.fillMode){case e.Material.PointListDrawMode:case e.Material.LineListDrawMode:case e.Material.LineLoopDrawMode:case e.Material.LineStripDrawMode:case e.Material.TriangleFanDrawMode:case e.Material.TriangleStripDrawMode:return null}if(e.LinesMesh&&this._mesh instanceof e.LinesMesh)for(var a=this._mesh,h=this.indexStart;h<this.indexStart+this.indexCount;h+=2){var u=r[i[h]],l=r[i[h+1]],c=t.intersectionSegment(u,l,a.intersectionThreshold);if(!(c<0)&&((n||!s||c<s.distance)&&(s=new e.IntersectionInfo(null,null,c),n)))break}else for(var h=this.indexStart;h<this.indexStart+this.indexCount;h+=3){var u=r[i[h]],l=r[i[h+1]],f=r[i[h+2]],d=t.intersectsTriangle(u,l,f);if(d){if(d.distance<0)continue;if((n||!s||d.distance<s.distance)&&(s=d,s.faceId=h/3,n))break}}return s},r.prototype._rebuild=function(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)},r.prototype.clone=function(t,i){var n=new r(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,t,i,!1);if(!this.IsGlobal){var s=this.getBoundingInfo();if(!s)return n;n._boundingInfo=new e.BoundingInfo(s.minimum,s.maximum)}return n},r.prototype.dispose=function(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);var e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1)},r.CreateFromIndices=function(e,t,i,n,s){var o=Number.MAX_VALUE,a=-Number.MAX_VALUE;s=s||n;for(var h=s.getIndices(),u=t;u<t+i;u++){var l=h[u];l<o&&(o=l),l>a&&(a=l)}return new r(e,o,a-o+1,t,i,n,s)},r})(t);e.SubMesh=r})(i||(i={}));var i,o=this&&this.__assign||Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++){t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e};!(function(e){var t=(function(){function e(){this._isDirty=!0,this._areLightsDirty=!0,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1}return Object.defineProperty(e.prototype,"isDirty",{get:function(){return this._isDirty},enumerable:!0,configurable:!0}),e.prototype.markAsProcessed=function(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areMiscDirty=!1,this._areImageProcessingDirty=!1},e.prototype.markAsUnprocessed=function(){this._isDirty=!0},e.prototype.markAllAsDirty=function(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0},e.prototype.markAsImageProcessingDirty=function(){this._areImageProcessingDirty=!0,this._isDirty=!0},e.prototype.markAsLightDirty=function(){this._areLightsDirty=!0,this._isDirty=!0},e.prototype.markAsAttributesDirty=function(){this._areAttributesDirty=!0,this._isDirty=!0},e.prototype.markAsTexturesDirty=function(){this._areTexturesDirty=!0,this._isDirty=!0},e.prototype.markAsFresnelDirty=function(){this._areFresnelDirty=!0,this._isDirty=!0},e.prototype.markAsMiscDirty=function(){this._areMiscDirty=!0,this._isDirty=!0},e.prototype.rebuild=function(){this._keys&&delete this._keys,this._keys=[];for(var e=0,t=Object.keys(this);e<t.length;e++){var r=t[e];"_"!==r[0]&&this._keys.push(r)}},e.prototype.isEqual=function(e){if(this._keys.length!==e._keys.length)return!1;for(var t=0;t<this._keys.length;t++){var r=this._keys[t];if(this[r]!==e[r])return!1}return!0},e.prototype.cloneTo=function(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(var t=0;t<this._keys.length;t++){var r=this._keys[t];e[r]=this[r]}},e.prototype.reset=function(){for(var e=0;e<this._keys.length;e++){var t=this._keys[e];switch(typeof this[t]){case"number":this[t]=0;break;case"string":this[t]="";break;default:this[t]=!1}}},e.prototype.toString=function(){for(var e="",t=0;t<this._keys.length;t++){var r=this._keys[t],i=this[r];switch(typeof i){case"number":case"string":e+="#define "+r+" "+i+"\n";break;default:i&&(e+="#define "+r+"\n")}}return e},e})();e.MaterialDefines=t;var r=(function(){function t(r,i,n){this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this.doNotSerialize=!1,this.storeEffectOnSubMeshes=!1,this.onDisposeObservable=new e.Observable,this.onBindObservable=new e.Observable,this.onUnBindObservable=new e.Observable,this._alphaMode=e.Engine.ALPHA_COMBINE,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.forceDepthWrite=!1,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this._wasPreviouslyReady=!1,this._fillMode=t.TriangleFillMode,this.name=r,this.id=r||e.Tools.RandomId(),this._scene=i||e.Engine.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.useRightHandedSystem?this.sideOrientation=t.ClockWiseSideOrientation:this.sideOrientation=t.CounterClockWiseSideOrientation,this._uniformBuffer=new e.UniformBuffer(this._scene.getEngine()),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,n||this._scene.materials.push(this)}return Object.defineProperty(t,"TriangleFillMode",{get:function(){return t._TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"WireFrameFillMode",{get:function(){return t._WireFrameFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"PointFillMode",{get:function(){return t._PointFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"PointListDrawMode",{get:function(){return t._PointListDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"LineListDrawMode",{get:function(){return t._LineListDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"LineLoopDrawMode",{get:function(){return t._LineLoopDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"LineStripDrawMode",{get:function(){return t._LineStripDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"TriangleStripDrawMode",{get:function(){return t._TriangleStripDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"TriangleFanDrawMode",{get:function(){return t._TriangleFanDrawMode},enumerable:!0,configurable:!0}),Object.defineProperty(t,"ClockWiseSideOrientation",{get:function(){return t._ClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(t,"CounterClockWiseSideOrientation",{get:function(){return t._CounterClockWiseSideOrientation},enumerable:!0,configurable:!0}),Object.defineProperty(t,"TextureDirtyFlag",{get:function(){return t._TextureDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(t,"LightDirtyFlag",{get:function(){return t._LightDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(t,"FresnelDirtyFlag",{get:function(){return t._FresnelDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(t,"AttributesDirtyFlag",{get:function(){return t._AttributesDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(t,"MiscDirtyFlag",{get:function(){return t._MiscDirtyFlag},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(e){this._alpha!==e&&(this._alpha=e,this.markAsDirty(t.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"backFaceCulling",{get:function(){return this._backFaceCulling},set:function(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(t.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onBind",{set:function(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alphaMode",{get:function(){return this._alphaMode},set:function(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(t.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"needDepthPrePass",{get:function(){return this._needDepthPrePass},set:function(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fogEnabled",{get:function(){return this._fogEnabled},set:function(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(t.MiscDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wireframe",{get:function(){switch(this._fillMode){case t.WireFrameFillMode:case t.LineListDrawMode:case t.LineLoopDrawMode:case t.LineStripDrawMode:return!0}return this._scene.forceWireframe},set:function(e){this.fillMode=e?t.WireFrameFillMode:t.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointsCloud",{get:function(){switch(this._fillMode){case t.PointFillMode:case t.PointListDrawMode:return!0}return this._scene.forcePointsCloud},set:function(e){this.fillMode=e?t.PointFillMode:t.TriangleFillMode},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fillMode",{get:function(){return this._fillMode},set:function(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(t.MiscDirtyFlag))},enumerable:!0,configurable:!0}),t.prototype.toString=function(e){return"Name: "+this.name},t.prototype.getClassName=function(){return"Material"},Object.defineProperty(t.prototype,"isFrozen",{get:function(){return this.checkReadyOnlyOnce},enumerable:!0,configurable:!0}),t.prototype.freeze=function(){this.checkReadyOnlyOnce=!0},t.prototype.unfreeze=function(){this.checkReadyOnlyOnce=!1},t.prototype.isReady=function(e,t){return!0},t.prototype.isReadyForSubMesh=function(e,t,r){return!1},t.prototype.getEffect=function(){return this._effect},t.prototype.getScene=function(){return this._scene},t.prototype.needAlphaBlending=function(){return this.alpha<1},t.prototype.needAlphaBlendingForMesh=function(e){return this.needAlphaBlending()||e.visibility<1||e.hasVertexAlpha},t.prototype.needAlphaTesting=function(){return!1},t.prototype.getAlphaTestTexture=function(){return null},t.prototype.markDirty=function(){this._wasPreviouslyReady=!1},t.prototype._preBind=function(e,r){void 0===r&&(r=null);var i=this._scene.getEngine(),n=null==r?this.sideOrientation:r,s=n===t.ClockWiseSideOrientation;return i.enableEffect(e||this._effect),i.setState(this.backFaceCulling,this.zOffset,!1,s),s},t.prototype.bind=function(e,t){},t.prototype.bindForSubMesh=function(e,t,r){},t.prototype.bindOnlyWorldMatrix=function(e){},t.prototype.bindSceneUniformBuffer=function(e,t){t.bindToEffect(e,"Scene")},t.prototype.bindView=function(e){this._useUBO?this.bindSceneUniformBuffer(e,this.getScene().getSceneUniformBuffer()):e.setMatrix("view",this.getScene().getViewMatrix())},t.prototype.bindViewProjection=function(e){this._useUBO?this.bindSceneUniformBuffer(e,this.getScene().getSceneUniformBuffer()):e.setMatrix("viewProjection",this.getScene().getTransformMatrix())},t.prototype._shouldTurnAlphaTestOn=function(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()},t.prototype._afterBind=function(e){if(this._scene._cachedMaterial=this,this._scene._cachedVisibility=e?e.visibility:1,e&&this.onBindObservable.notifyObservers(e),this.disableDepthWrite){var t=this._scene.getEngine();this._cachedDepthWriteState=t.getDepthWrite(),t.setDepthWrite(!1)}},t.prototype.unbind=function(){if(this.onUnBindObservable.notifyObservers(this),this.disableDepthWrite){this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState)}},t.prototype.getActiveTextures=function(){return[]},t.prototype.hasTexture=function(e){return!1},t.prototype.clone=function(e){return null},t.prototype.getBindedMeshes=function(){for(var e=new Array,t=0;t<this._scene.meshes.length;t++){var r=this._scene.meshes[t];r.material===this&&e.push(r)}return e},t.prototype.forceCompilation=function(t,r,i){var n=this,s=o({clipPlane:!1},i),a=new e.BaseSubMesh,h=this.getScene(),u=function(){if(n._scene&&n._scene.getEngine()){a._materialDefines&&(a._materialDefines._renderId=-1);var i=h.clipPlane;s.clipPlane&&(h.clipPlane=new e.Plane(0,0,0,1)),n.storeEffectOnSubMeshes?n.isReadyForSubMesh(t,a)?r&&r(n):setTimeout(u,16):n.isReady(t)?r&&r(n):setTimeout(u,16),s.clipPlane&&(h.clipPlane=i)}};u()},t.prototype.forceCompilationAsync=function(e,t){var r=this;return new Promise(function(i){r.forceCompilation(e,(function(){i()}),t)})},t.prototype.markAsDirty=function(e){e&t.TextureDirtyFlag&&this._markAllSubMeshesAsTexturesDirty(),e&t.LightDirtyFlag&&this._markAllSubMeshesAsLightsDirty(),e&t.FresnelDirtyFlag&&this._markAllSubMeshesAsFresnelDirty(),e&t.AttributesDirtyFlag&&this._markAllSubMeshesAsAttributesDirty(),e&t.MiscDirtyFlag&&this._markAllSubMeshesAsMiscDirty(),this.getScene().resetCachedMaterial()},t.prototype._markAllSubMeshesAsDirty=function(e){for(var t=0,r=this.getScene().meshes;t<r.length;t++){var i=r[t];if(i.subMeshes)for(var n=0,s=i.subMeshes;n<s.length;n++){var o=s[n];o.getMaterial()===this&&(o._materialDefines&&e(o._materialDefines))}}},t.prototype._markAllSubMeshesAsImageProcessingDirty=function(){this._markAllSubMeshesAsDirty((function(e){return e.markAsImageProcessingDirty()}))},t.prototype._markAllSubMeshesAsTexturesDirty=function(){this._markAllSubMeshesAsDirty((function(e){return e.markAsTexturesDirty()}))},t.prototype._markAllSubMeshesAsFresnelDirty=function(){this._markAllSubMeshesAsDirty((function(e){return e.markAsFresnelDirty()}))},t.prototype._markAllSubMeshesAsFresnelAndMiscDirty=function(){this._markAllSubMeshesAsDirty((function(e){e.markAsFresnelDirty(),e.markAsMiscDirty()}))},t.prototype._markAllSubMeshesAsLightsDirty=function(){this._markAllSubMeshesAsDirty((function(e){return e.markAsLightDirty()}))},t.prototype._markAllSubMeshesAsAttributesDirty=function(){this._markAllSubMeshesAsDirty((function(e){return e.markAsAttributesDirty()}))},t.prototype._markAllSubMeshesAsMiscDirty=function(){this._markAllSubMeshesAsDirty((function(e){return e.markAsMiscDirty()}))},t.prototype._markAllSubMeshesAsTexturesAndMiscDirty=function(){this._markAllSubMeshesAsDirty((function(e){e.markAsTexturesDirty(),e.markAsMiscDirty()}))},t.prototype.dispose=function(e,t){this.getScene().stopAnimation(this),this.getScene().freeProcessedMaterials();var r=this._scene.materials.indexOf(this);for(r>=0&&this._scene.materials.splice(r,1),r=0;r<this._scene.meshes.length;r++){var i=this._scene.meshes[r];if(i.material===this&&(i.material=null,i.geometry)){var n=i.geometry;if(this.storeEffectOnSubMeshes)for(var s=0,o=i.subMeshes;s<o.length;s++){var a=o[s];n._releaseVertexArrayObject(a._materialEffect),e&&a._materialEffect&&this._scene.getEngine()._releaseEffect(a._materialEffect)}else n._releaseVertexArrayObject(this._effect)}}this._uniformBuffer.dispose(),
e&&this._effect&&(this.storeEffectOnSubMeshes||this._scene.getEngine()._releaseEffect(this._effect),this._effect=null),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBindObservable.clear(),this.onUnBindObservable.clear()},t.prototype.serialize=function(){return e.SerializationHelper.Serialize(this)},t.ParseMultiMaterial=function(t,r){var i=new e.MultiMaterial(t.name,r);i.id=t.id,e.Tags&&e.Tags.AddTagsTo(i,t.tags);for(var n=0;n<t.materials.length;n++){var s=t.materials[n];s?i.subMaterials.push(r.getMaterialByID(s)):i.subMaterials.push(null)}return i},t.Parse=function(t,r,i){return t.customType&&"BABYLON.StandardMaterial"!==t.customType?"BABYLON.PBRMaterial"===t.customType&&t.overloadedAlbedo&&(t.customType="BABYLON.LegacyPBRMaterial",!e.LegacyPBRMaterial)?void e.Tools.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."):e.Tools.Instantiate(t.customType).Parse(t,r,i):e.StandardMaterial.Parse(t,r,i)},t._TriangleFillMode=0,t._WireFrameFillMode=1,t._PointFillMode=2,t._PointListDrawMode=3,t._LineListDrawMode=4,t._LineLoopDrawMode=5,t._LineStripDrawMode=6,t._TriangleStripDrawMode=7,t._TriangleFanDrawMode=8,t._ClockWiseSideOrientation=0,t._CounterClockWiseSideOrientation=1,t._TextureDirtyFlag=1,t._LightDirtyFlag=2,t._FresnelDirtyFlag=4,t._AttributesDirtyFlag=8,t._MiscDirtyFlag=16,n([e.serialize()],t.prototype,"id",void 0),n([e.serialize()],t.prototype,"uniqueId",void 0),n([e.serialize()],t.prototype,"name",void 0),n([e.serialize()],t.prototype,"checkReadyOnEveryCall",void 0),n([e.serialize()],t.prototype,"checkReadyOnlyOnce",void 0),n([e.serialize()],t.prototype,"state",void 0),n([e.serialize("alpha")],t.prototype,"_alpha",void 0),n([e.serialize("backFaceCulling")],t.prototype,"_backFaceCulling",void 0),n([e.serialize()],t.prototype,"sideOrientation",void 0),n([e.serialize("alphaMode")],t.prototype,"_alphaMode",void 0),n([e.serialize()],t.prototype,"_needDepthPrePass",void 0),n([e.serialize()],t.prototype,"disableDepthWrite",void 0),n([e.serialize()],t.prototype,"forceDepthWrite",void 0),n([e.serialize()],t.prototype,"separateCullingPass",void 0),n([e.serialize("fogEnabled")],t.prototype,"_fogEnabled",void 0),n([e.serialize()],t.prototype,"pointSize",void 0),n([e.serialize()],t.prototype,"zOffset",void 0),n([e.serialize()],t.prototype,"wireframe",null),n([e.serialize()],t.prototype,"pointsCloud",null),n([e.serialize()],t.prototype,"fillMode",null),t})();e.Material=r})(i||(i={}));var i;!(function(e){var t=(function(){function t(e,t,r){this._engine=e,this._noUBO=!e.supportsUniformBuffers,this._dynamic=r,this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformLocationPointer=0,this._needSync=!1,this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform)}return Object.defineProperty(t.prototype,"useUbo",{get:function(){return!this._noUBO},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSync",{get:function(){return!this._needSync},enumerable:!0,configurable:!0}),t.prototype.isDynamic=function(){return void 0!==this._dynamic},t.prototype.getData=function(){return this._bufferData},t.prototype.getBuffer=function(){return this._buffer},t.prototype._fillAlignment=function(e){var t;if(t=e<=2?e:4,this._uniformLocationPointer%t!=0){var r=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;for(var i=this._uniformLocationPointer-r,n=0;n<i;n++)this._data.push(0)}},t.prototype.addUniform=function(e,t){if(!this._noUBO&&void 0===this._uniformLocations[e]){var r;if(t instanceof Array)r=t,t=r.length;else{t=t,r=[];for(var i=0;i<t;i++)r.push(0)}this._fillAlignment(t),this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(var i=0;i<t;i++)this._data.push(r[i]);this._needSync=!0}},t.prototype.addMatrix=function(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))},t.prototype.addFloat2=function(e,t,r){var i=[t,r];this.addUniform(e,i)},t.prototype.addFloat3=function(e,t,r,i){var n=[t,r,i];this.addUniform(e,n)},t.prototype.addColor3=function(e,t){var r=new Array;t.toArray(r),this.addUniform(e,r)},t.prototype.addColor4=function(e,t,r){var i=new Array;t.toArray(i),i.push(r),this.addUniform(e,i)},t.prototype.addVector3=function(e,t){var r=new Array;t.toArray(r),this.addUniform(e,r)},t.prototype.addMatrix3x3=function(e){this.addUniform(e,12)},t.prototype.addMatrix2x2=function(e){this.addUniform(e,8)},t.prototype.create=function(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)},t.prototype._rebuild=function(){this._noUBO||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData))},t.prototype.update=function(){if(!this._buffer)return void this.create();(this._dynamic||this._needSync)&&(this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._needSync=!1)},t.prototype.updateUniform=function(t,r,i){var n=this._uniformLocations[t];if(void 0===n){if(this._buffer)return void e.Tools.Error("Cannot add an uniform after UBO has been created.");this.addUniform(t,i),n=this._uniformLocations[t]}if(this._buffer||this.create(),this._dynamic)for(var s=0;s<i;s++)this._bufferData[n+s]=r[s];else{for(var o=!1,s=0;s<i;s++)this._bufferData[n+s]!==r[s]&&(o=!0,this._bufferData[n+s]=r[s]);this._needSync=this._needSync||o}},t.prototype._updateMatrix3x3ForUniform=function(e,r){for(var i=0;i<3;i++)t._tempBuffer[4*i]=r[3*i],t._tempBuffer[4*i+1]=r[3*i+1],t._tempBuffer[4*i+2]=r[3*i+2],t._tempBuffer[4*i+3]=0;this.updateUniform(e,t._tempBuffer,12)},t.prototype._updateMatrix3x3ForEffect=function(e,t){this._currentEffect.setMatrix3x3(e,t)},t.prototype._updateMatrix2x2ForEffect=function(e,t){this._currentEffect.setMatrix2x2(e,t)},t.prototype._updateMatrix2x2ForUniform=function(e,r){for(var i=0;i<2;i++)t._tempBuffer[4*i]=r[2*i],t._tempBuffer[4*i+1]=r[2*i+1],t._tempBuffer[4*i+2]=0,t._tempBuffer[4*i+3]=0;this.updateUniform(e,t._tempBuffer,8)},t.prototype._updateFloatForEffect=function(e,t){this._currentEffect.setFloat(e,t)},t.prototype._updateFloatForUniform=function(e,r){t._tempBuffer[0]=r,this.updateUniform(e,t._tempBuffer,1)},t.prototype._updateFloat2ForEffect=function(e,t,r,i){void 0===i&&(i=""),this._currentEffect.setFloat2(e+i,t,r)},t.prototype._updateFloat2ForUniform=function(e,r,i,n){void 0===n&&(n=""),t._tempBuffer[0]=r,t._tempBuffer[1]=i,this.updateUniform(e,t._tempBuffer,2)},t.prototype._updateFloat3ForEffect=function(e,t,r,i,n){void 0===n&&(n=""),this._currentEffect.setFloat3(e+n,t,r,i)},t.prototype._updateFloat3ForUniform=function(e,r,i,n,s){void 0===s&&(s=""),t._tempBuffer[0]=r,t._tempBuffer[1]=i,t._tempBuffer[2]=n,this.updateUniform(e,t._tempBuffer,3)},t.prototype._updateFloat4ForEffect=function(e,t,r,i,n,s){void 0===s&&(s=""),this._currentEffect.setFloat4(e+s,t,r,i,n)},t.prototype._updateFloat4ForUniform=function(e,r,i,n,s,o){void 0===o&&(o=""),t._tempBuffer[0]=r,t._tempBuffer[1]=i,t._tempBuffer[2]=n,t._tempBuffer[3]=s,this.updateUniform(e,t._tempBuffer,4)},t.prototype._updateMatrixForEffect=function(e,t){this._currentEffect.setMatrix(e,t)},t.prototype._updateMatrixForUniform=function(e,t){this.updateUniform(e,t.toArray(),16)},t.prototype._updateVector3ForEffect=function(e,t){this._currentEffect.setVector3(e,t)},t.prototype._updateVector3ForUniform=function(e,r){r.toArray(t._tempBuffer),this.updateUniform(e,t._tempBuffer,3)},t.prototype._updateVector4ForEffect=function(e,t){this._currentEffect.setVector4(e,t)},t.prototype._updateVector4ForUniform=function(e,r){r.toArray(t._tempBuffer),this.updateUniform(e,t._tempBuffer,4)},t.prototype._updateColor3ForEffect=function(e,t,r){void 0===r&&(r=""),this._currentEffect.setColor3(e+r,t)},t.prototype._updateColor3ForUniform=function(e,r,i){void 0===i&&(i=""),r.toArray(t._tempBuffer),this.updateUniform(e,t._tempBuffer,3)},t.prototype._updateColor4ForEffect=function(e,t,r,i){void 0===i&&(i=""),this._currentEffect.setColor4(e+i,t,r)},t.prototype._updateColor4ForUniform=function(e,r,i,n){void 0===n&&(n=""),r.toArray(t._tempBuffer),t._tempBuffer[3]=i,this.updateUniform(e,t._tempBuffer,4)},t.prototype.setTexture=function(e,t){this._currentEffect.setTexture(e,t)},t.prototype.updateUniformDirectly=function(e,t){this.updateUniform(e,t,t.length),this.update()},t.prototype.bindToEffect=function(e,t){this._currentEffect=e,!this._noUBO&&this._buffer&&e.bindUniformBuffer(this._buffer,t)},t.prototype.dispose=function(){if(!this._noUBO){var e=this._engine._uniformBuffers.indexOf(this);-1!==e&&this._engine._uniformBuffers.splice(e,1),this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}},t._MAX_UNIFORM_SIZE=256,t._tempBuffer=new Float32Array(t._MAX_UNIFORM_SIZE),t})();e.UniformBuffer=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(){}return t.prototype.set=function(t,r){switch(r){case e.VertexBuffer.PositionKind:this.positions=t;break;case e.VertexBuffer.NormalKind:this.normals=t;break;case e.VertexBuffer.TangentKind:this.tangents=t;break;case e.VertexBuffer.UVKind:this.uvs=t;break;case e.VertexBuffer.UV2Kind:this.uvs2=t;break;case e.VertexBuffer.UV3Kind:this.uvs3=t;break;case e.VertexBuffer.UV4Kind:this.uvs4=t;break;case e.VertexBuffer.UV5Kind:this.uvs5=t;break;case e.VertexBuffer.UV6Kind:this.uvs6=t;break;case e.VertexBuffer.ColorKind:this.colors=t;break;case e.VertexBuffer.MatricesIndicesKind:this.matricesIndices=t;break;case e.VertexBuffer.MatricesWeightsKind:this.matricesWeights=t;break;case e.VertexBuffer.MatricesIndicesExtraKind:this.matricesIndicesExtra=t;break;case e.VertexBuffer.MatricesWeightsExtraKind:this.matricesWeightsExtra=t}},t.prototype.applyToMesh=function(e,t){return this._applyTo(e,t),this},t.prototype.applyToGeometry=function(e,t){return this._applyTo(e,t),this},t.prototype.updateMesh=function(e,t,r){return this._update(e),this},t.prototype.updateGeometry=function(e,t,r){return this._update(e),this},t.prototype._applyTo=function(t,r){return void 0===r&&(r=!1),this.positions&&t.setVerticesData(e.VertexBuffer.PositionKind,this.positions,r),this.normals&&t.setVerticesData(e.VertexBuffer.NormalKind,this.normals,r),this.tangents&&t.setVerticesData(e.VertexBuffer.TangentKind,this.tangents,r),this.uvs&&t.setVerticesData(e.VertexBuffer.UVKind,this.uvs,r),this.uvs2&&t.setVerticesData(e.VertexBuffer.UV2Kind,this.uvs2,r),this.uvs3&&t.setVerticesData(e.VertexBuffer.UV3Kind,this.uvs3,r),this.uvs4&&t.setVerticesData(e.VertexBuffer.UV4Kind,this.uvs4,r),this.uvs5&&t.setVerticesData(e.VertexBuffer.UV5Kind,this.uvs5,r),this.uvs6&&t.setVerticesData(e.VertexBuffer.UV6Kind,this.uvs6,r),this.colors&&t.setVerticesData(e.VertexBuffer.ColorKind,this.colors,r),this.matricesIndices&&t.setVerticesData(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices,r),this.matricesWeights&&t.setVerticesData(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights,r),this.matricesIndicesExtra&&t.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,r),this.matricesWeightsExtra&&t.setVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,r),this.indices?t.setIndices(this.indices,null,r):t.setIndices([],null),this},t.prototype._update=function(t,r,i){return this.positions&&t.updateVerticesData(e.VertexBuffer.PositionKind,this.positions,r,i),this.normals&&t.updateVerticesData(e.VertexBuffer.NormalKind,this.normals,r,i),this.tangents&&t.updateVerticesData(e.VertexBuffer.TangentKind,this.tangents,r,i),this.uvs&&t.updateVerticesData(e.VertexBuffer.UVKind,this.uvs,r,i),this.uvs2&&t.updateVerticesData(e.VertexBuffer.UV2Kind,this.uvs2,r,i),this.uvs3&&t.updateVerticesData(e.VertexBuffer.UV3Kind,this.uvs3,r,i),this.uvs4&&t.updateVerticesData(e.VertexBuffer.UV4Kind,this.uvs4,r,i),this.uvs5&&t.updateVerticesData(e.VertexBuffer.UV5Kind,this.uvs5,r,i),this.uvs6&&t.updateVerticesData(e.VertexBuffer.UV6Kind,this.uvs6,r,i),this.colors&&t.updateVerticesData(e.VertexBuffer.ColorKind,this.colors,r,i),this.matricesIndices&&t.updateVerticesData(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices,r,i),this.matricesWeights&&t.updateVerticesData(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights,r,i),this.matricesIndicesExtra&&t.updateVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra,r,i),this.matricesWeightsExtra&&t.updateVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra,r,i),this.indices&&t.setIndices(this.indices,null),this},t.prototype.transform=function(t){var r,i=e.Vector3.Zero();if(this.positions){var n=e.Vector3.Zero();for(r=0;r<this.positions.length;r+=3)e.Vector3.FromArrayToRef(this.positions,r,n),e.Vector3.TransformCoordinatesToRef(n,t,i),this.positions[r]=i.x,this.positions[r+1]=i.y,this.positions[r+2]=i.z}if(this.normals){var s=e.Vector3.Zero();for(r=0;r<this.normals.length;r+=3)e.Vector3.FromArrayToRef(this.normals,r,s),e.Vector3.TransformNormalToRef(s,t,i),this.normals[r]=i.x,this.normals[r+1]=i.y,this.normals[r+2]=i.z}if(this.tangents){var o=e.Vector4.Zero(),a=e.Vector4.Zero();for(r=0;r<this.tangents.length;r+=4)e.Vector4.FromArrayToRef(this.tangents,r,o),e.Vector4.TransformNormalToRef(o,t,a),this.tangents[r]=a.x,this.tangents[r+1]=a.y,this.tangents[r+2]=a.z,this.tangents[r+3]=a.w}return this},t.prototype.merge=function(e){if(this._validate(),e._validate(),!this.normals!=!e.normals||!this.tangents!=!e.tangents||!this.uvs!=!e.uvs||!this.uvs2!=!e.uvs2||!this.uvs3!=!e.uvs3||!this.uvs4!=!e.uvs4||!this.uvs5!=!e.uvs5||!this.uvs6!=!e.uvs6||!this.colors!=!e.colors||!this.matricesIndices!=!e.matricesIndices||!this.matricesWeights!=!e.matricesWeights||!this.matricesIndicesExtra!=!e.matricesIndicesExtra||!this.matricesWeightsExtra!=!e.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");if(e.indices){this.indices||(this.indices=[]);for(var t=this.positions?this.positions.length/3:0,r=0;r<e.indices.length;r++)this.indices.push(e.indices[r]+t)}return this.positions=this._mergeElement(this.positions,e.positions),this.normals=this._mergeElement(this.normals,e.normals),this.tangents=this._mergeElement(this.tangents,e.tangents),this.uvs=this._mergeElement(this.uvs,e.uvs),this.uvs2=this._mergeElement(this.uvs2,e.uvs2),this.uvs3=this._mergeElement(this.uvs3,e.uvs3),this.uvs4=this._mergeElement(this.uvs4,e.uvs4),this.uvs5=this._mergeElement(this.uvs5,e.uvs5),this.uvs6=this._mergeElement(this.uvs6,e.uvs6),this.colors=this._mergeElement(this.colors,e.colors),this.matricesIndices=this._mergeElement(this.matricesIndices,e.matricesIndices),this.matricesWeights=this._mergeElement(this.matricesWeights,e.matricesWeights),this.matricesIndicesExtra=this._mergeElement(this.matricesIndicesExtra,e.matricesIndicesExtra),this.matricesWeightsExtra=this._mergeElement(this.matricesWeightsExtra,e.matricesWeightsExtra),this},t.prototype._mergeElement=function(e,t){if(!e)return t;if(!t)return e;var r=t.length+e.length,i=e instanceof Float32Array,n=t instanceof Float32Array;if(i){var s=new Float32Array(r);return s.set(e),s.set(t,e.length),s}if(n){for(var o=e.slice(0),a=0,r=t.length;a<r;a++)o.push(t[a]);return o}return e.concat(t)},t.prototype._validate=function(){if(!this.positions)throw new Error("Positions are required");var t=function(t,r){var i=e.VertexBuffer.DeduceStride(t);if(r.length%i!=0)throw new Error("The "+t+"s array count must be a multiple of "+i);return r.length/i},r=t(e.VertexBuffer.PositionKind,this.positions),i=function(e,i){var n=t(e,i);if(n!==r)throw new Error("The "+e+"s element count ("+n+") does not match the positions count ("+r+")")};this.normals&&i(e.VertexBuffer.NormalKind,this.normals),this.tangents&&i(e.VertexBuffer.TangentKind,this.tangents),this.uvs&&i(e.VertexBuffer.UVKind,this.uvs),this.uvs2&&i(e.VertexBuffer.UV2Kind,this.uvs2),this.uvs3&&i(e.VertexBuffer.UV3Kind,this.uvs3),this.uvs4&&i(e.VertexBuffer.UV4Kind,this.uvs4),this.uvs5&&i(e.VertexBuffer.UV5Kind,this.uvs5),this.uvs6&&i(e.VertexBuffer.UV6Kind,this.uvs6),this.colors&&i(e.VertexBuffer.ColorKind,this.colors),this.matricesIndices&&i(e.VertexBuffer.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(e.VertexBuffer.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(e.VertexBuffer.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(e.VertexBuffer.MatricesWeightsExtraKind,this.matricesWeightsExtra)},t.prototype.serialize=function(){var e=this.serialize();return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e},t.ExtractFromMesh=function(e,r,i){return t._ExtractFrom(e,r,i)},t.ExtractFromGeometry=function(e,r,i){return t._ExtractFrom(e,r,i)},t._ExtractFrom=function(r,i,n){var s=new t;return r.isVerticesDataPresent(e.VertexBuffer.PositionKind)&&(s.positions=r.getVerticesData(e.VertexBuffer.PositionKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.NormalKind)&&(s.normals=r.getVerticesData(e.VertexBuffer.NormalKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.TangentKind)&&(s.tangents=r.getVerticesData(e.VertexBuffer.TangentKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.UVKind)&&(s.uvs=r.getVerticesData(e.VertexBuffer.UVKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&(s.uvs2=r.getVerticesData(e.VertexBuffer.UV2Kind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.UV3Kind)&&(s.uvs3=r.getVerticesData(e.VertexBuffer.UV3Kind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.UV4Kind)&&(s.uvs4=r.getVerticesData(e.VertexBuffer.UV4Kind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.UV5Kind)&&(s.uvs5=r.getVerticesData(e.VertexBuffer.UV5Kind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.UV6Kind)&&(s.uvs6=r.getVerticesData(e.VertexBuffer.UV6Kind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.ColorKind)&&(s.colors=r.getVerticesData(e.VertexBuffer.ColorKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&(s.matricesIndices=r.getVerticesData(e.VertexBuffer.MatricesIndicesKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)&&(s.matricesWeights=r.getVerticesData(e.VertexBuffer.MatricesWeightsKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=r.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,i,n)),r.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=r.getVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,i,n)),s.indices=r.getIndices(i),s},t.CreateRibbon=function(r){var i=r.pathArray,n=r.closeArray||!1,s=r.closePath||!1,o=r.invertUV||!1,a=Math.floor(i[0].length/2),h=r.offset||a;h=h>a?a:Math.floor(h);var u,l,c,f,d=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,p=r.uvs,_=r.colors,m=[],g=[],v=[],y=[],b=[],T=[],E=[],x=[],A=[],M=[];if(i.length<2){var P=[],R=[];for(c=0;c<i[0].length-h;c++)P.push(i[0][c]),R.push(i[0][c+h]);i=[P,R]}var S,C,O=0,D=s?1:0;u=i[0].length;var I,F;for(l=0;l<i.length;l++){for(E[l]=0,b[l]=[0],S=i[l],C=S.length,u=u<C?u:C,f=0;f<C;)m.push(S[f].x,S[f].y,S[f].z),f>0&&(I=S[f].subtract(S[f-1]).length(),F=I+E[l],b[l].push(F),E[l]=F),f++;s&&(f--,m.push(S[0].x,S[0].y,S[0].z),I=S[f].subtract(S[0]).length(),F=I+E[l],b[l].push(F),E[l]=F),A[l]=C+D,M[l]=O,O+=C+D}var L,w,B=null,U=null;for(c=0;c<u+D;c++){for(x[c]=0,T[c]=[0],l=0;l<i.length-1;l++)L=i[l],w=i[l+1],c===u?(B=L[0],U=w[0]):(B=L[c],U=w[c]),I=U.subtract(B).length(),F=I+x[c],T[c].push(F),x[c]=F;n&&U&&B&&(L=i[l],w=i[0],c===u&&(U=w[0]),I=U.subtract(B).length(),F=I+x[c],x[c]=F)}var V,N;if(p)for(l=0;l<p.length;l++)y.push(p[l].x,p[l].y);else for(l=0;l<i.length;l++)for(c=0;c<u+D;c++)V=0!=E[l]?b[l][c]/E[l]:0,N=0!=x[c]?T[c][l]/x[c]:0,o?y.push(N,V):y.push(V,N);l=0;for(var k=0,z=A[l]-1,G=A[l+1]-1,W=z<G?z:G,X=M[1]-M[0],H=n?A.length:A.length-1;k<=W&&l<H;)g.push(k,k+X,k+1),g.push(k+X+1,k+1,k+X),(k+=1)===W&&(l++,l===A.length-1?(X=M[0]-M[l],z=A[l]-1,G=A[0]-1):(X=M[l+1]-M[l],z=A[l]-1,G=A[l+1]-1),k=M[l],W=z<G?z+k:G+k);if(t.ComputeNormals(m,g,v),s){var K=0,j=0;for(l=0;l<i.length;l++)K=3*M[l],j=l+1<i.length?3*(M[l+1]-1):v.length-3,v[K]=.5*(v[K]+v[j]),v[K+1]=.5*(v[K+1]+v[j+1]),v[K+2]=.5*(v[K+2]+v[j+2]),v[j]=v[K],v[j+1]=v[K+1],v[j+2]=v[K+2]}t._ComputeSides(d,m,g,v,y,r.frontUVs,r.backUVs);var Y=null;if(_){Y=new Float32Array(4*_.length);for(var Q=0;Q<_.length;Q++)Y[4*Q]=_[Q].r,Y[4*Q+1]=_[Q].g,Y[4*Q+2]=_[Q].b,Y[4*Q+3]=_[Q].a}var Z=new t,q=new Float32Array(m),J=new Float32Array(v),$=new Float32Array(y);return Z.indices=g,Z.positions=q,Z.normals=J,Z.uvs=$,Y&&Z.set(Y,e.VertexBuffer.ColorKind),s&&(Z._idx=M),Z},t.CreateBox=function(r){for(var i=[new e.Vector3(0,0,1),new e.Vector3(0,0,-1),new e.Vector3(1,0,0),new e.Vector3(-1,0,0),new e.Vector3(0,1,0),new e.Vector3(0,-1,0)],n=[],s=[],o=[],a=[],h=r.width||r.size||1,u=r.height||r.size||1,l=r.depth||r.size||1,c=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,f=r.faceUV||new Array(6),d=r.faceColors,p=[],_=0;_<6;_++)void 0===f[_]&&(f[_]=new e.Vector4(0,0,1,1)),d&&void 0===d[_]&&(d[_]=new e.Color4(1,1,1,1));for(var m=new e.Vector3(h/2,u/2,l/2),g=0;g<i.length;g++){var v=i[g],y=new e.Vector3(v.y,v.z,v.x),b=e.Vector3.Cross(v,y),T=s.length/3;n.push(T),n.push(T+1),n.push(T+2),n.push(T),n.push(T+2),n.push(T+3);var E=v.subtract(y).subtract(b).multiply(m);s.push(E.x,E.y,E.z),o.push(v.x,v.y,v.z),a.push(f[g].z,f[g].w),d&&p.push(d[g].r,d[g].g,d[g].b,d[g].a),E=v.subtract(y).add(b).multiply(m),s.push(E.x,E.y,E.z),o.push(v.x,v.y,v.z),a.push(f[g].x,f[g].w),d&&p.push(d[g].r,d[g].g,d[g].b,d[g].a),E=v.add(y).add(b).multiply(m),s.push(E.x,E.y,E.z),o.push(v.x,v.y,v.z),a.push(f[g].x,f[g].y),d&&p.push(d[g].r,d[g].g,d[g].b,d[g].a),E=v.add(y).subtract(b).multiply(m),s.push(E.x,E.y,E.z),o.push(v.x,v.y,v.z),a.push(f[g].z,f[g].y),d&&p.push(d[g].r,d[g].g,d[g].b,d[g].a)}t._ComputeSides(c,s,n,o,a,r.frontUVs,r.backUVs);var x=new t;if(x.indices=n,x.positions=s,x.normals=o,x.uvs=a,d){var A=c===e.Mesh.DOUBLESIDE?p.concat(p):p;x.colors=A}return x},t.CreateSphere=function(r){for(var i=r.segments||32,n=r.diameterX||r.diameter||1,s=r.diameterY||r.diameter||1,o=r.diameterZ||r.diameter||1,a=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,h=r.slice&&r.slice<=0?1:r.slice||1,u=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,l=new e.Vector3(n/2,s/2,o/2),c=2+i,f=2*c,d=[],p=[],_=[],m=[],g=0;g<=c;g++){for(var v=g/c,y=v*Math.PI*h,b=0;b<=f;b++){var T=b/f,E=T*Math.PI*2*a,x=e.Matrix.RotationZ(-y),A=e.Matrix.RotationY(E),M=e.Vector3.TransformCoordinates(e.Vector3.Up(),x),P=e.Vector3.TransformCoordinates(M,A),R=P.multiply(l),S=P.divide(l).normalize();p.push(R.x,R.y,R.z),_.push(S.x,S.y,S.z),m.push(T,v)}if(g>0)for(var C=p.length/3,O=C-2*(f+1);O+f+2<C;O++)d.push(O),d.push(O+1),d.push(O+f+1),d.push(O+f+1),d.push(O+1),d.push(O+f+2)}t._ComputeSides(u,p,d,_,m,r.frontUVs,r.backUVs);var D=new t;return D.indices=d,D.positions=p,D.normals=_,D.uvs=m,D},t.CreateCylinder=function(r){var i,n=r.height||2,s=0===r.diameterTop?0:r.diameterTop||r.diameter||1,o=0===r.diameterBottom?0:r.diameterBottom||r.diameter||1,a=r.tessellation||24,h=r.subdivisions||1,u=!!r.hasRings,l=!!r.enclose,c=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,f=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,d=r.faceUV||new Array(3),p=r.faceColors,_=1!==c&&l?2:0,m=u?h:1,g=2+(1+_)*m;for(i=0;i<g;i++)p&&void 0===p[i]&&(p[i]=new e.Color4(1,1,1,1));for(i=0;i<g;i++)d&&void 0===d[i]&&(d[i]=new e.Vector4(0,0,1,1));var v,y,b,T,E,x,A=new Array,M=new Array,P=new Array,R=new Array,S=new Array,C=2*Math.PI*c/a,O=(o-s)/2/n,D=e.Vector3.Zero(),I=e.Vector3.Zero(),F=e.Vector3.Zero(),L=e.Vector3.Zero(),w=e.Vector3.Zero(),B=e.Axis.Y,U=1,V=1,N=0,k=0;for(T=0;T<=h;T++)for(y=T/h,b=(y*(s-o)+o)/2,U=u&&0!==T&&T!==h?2:1,x=0;x<U;x++){for(u&&(V+=x),l&&(V+=2*x),E=0;E<=a;E++)v=E*C,D.x=Math.cos(-v)*b,D.y=-n/2+y*n,D.z=Math.sin(-v)*b,0===s&&T===h?(I.x=P[P.length-3*(a+1)],I.y=P[P.length-3*(a+1)+1],I.z=P[P.length-3*(a+1)+2]):(I.x=D.x,I.z=D.z,I.y=Math.sqrt(I.x*I.x+I.z*I.z)*O,I.normalize()),0===E&&(F.copyFrom(D),L.copyFrom(I)),M.push(D.x,D.y,D.z),P.push(I.x,I.y,I.z),k=u?N!==V?d[V].y:d[V].w:d[V].y+(d[V].w-d[V].y)*y,R.push(d[V].x+(d[V].z-d[V].x)*E/a,k),p&&S.push(p[V].r,p[V].g,p[V].b,p[V].a);1!==c&&l&&(M.push(D.x,D.y,D.z),M.push(0,D.y,0),M.push(0,D.y,0),M.push(F.x,F.y,F.z),e.Vector3.CrossToRef(B,I,w),w.normalize(),P.push(w.x,w.y,w.z,w.x,w.y,w.z),e.Vector3.CrossToRef(L,B,w),w.normalize(),P.push(w.x,w.y,w.z,w.x,w.y,w.z),k=u?N!==V?d[V+1].y:d[V+1].w:d[V+1].y+(d[V+1].w-d[V+1].y)*y,R.push(d[V+1].x,k),R.push(d[V+1].z,k),k=u?N!==V?d[V+2].y:d[V+2].w:d[V+2].y+(d[V+2].w-d[V+2].y)*y,R.push(d[V+2].x,k),R.push(d[V+2].z,k),p&&(S.push(p[V+1].r,p[V+1].g,p[V+1].b,p[V+1].a),S.push(p[V+1].r,p[V+1].g,p[V+1].b,p[V+1].a),S.push(p[V+2].r,p[V+2].g,p[V+2].b,p[V+2].a),S.push(p[V+2].r,p[V+2].g,p[V+2].b,p[V+2].a))),N!==V&&(N=V)}var V,z=1!==c&&l?a+4:a;for(T=0,V=0;V<h;V++){var G=0,W=0,X=0,H=0;for(E=0;E<a;E++)G=T*(z+1)+E,W=(T+1)*(z+1)+E,X=T*(z+1)+(E+1),H=(T+1)*(z+1)+(E+1),A.push(G,W,X),A.push(H,X,W);1!==c&&l&&(A.push(G+2,W+2,X+2),A.push(H+2,X+2,W+2),A.push(G+4,W+4,X+4),A.push(H+4,X+4,W+4)),T=u?T+2:T+1}var K=function(t){var r=t?s/2:o/2;if(0!==r){var i,h,u,l=t?d[g-1]:d[0],f=null;p&&(f=t?p[g-1]:p[0]);var _=M.length/3,m=t?n/2:-n/2,v=new e.Vector3(0,m,0);M.push(v.x,v.y,v.z),P.push(0,t?1:-1,0),R.push(l.x+.5*(l.z-l.x),l.y+.5*(l.w-l.y)),f&&S.push(f.r,f.g,f.b,f.a);var y=new e.Vector2(.5,.5);for(u=0;u<=a;u++){i=2*Math.PI*u*c/a;var b=Math.cos(-i),T=Math.sin(-i);h=new e.Vector3(b*r,m,T*r);var E=new e.Vector2(b*y.x+.5,T*y.y+.5);M.push(h.x,h.y,h.z),P.push(0,t?1:-1,0),R.push(l.x+(l.z-l.x)*E.x,l.y+(l.w-l.y)*E.y),f&&S.push(f.r,f.g,f.b,f.a)}for(u=0;u<a;u++)t?(A.push(_),A.push(_+(u+2)),A.push(_+(u+1))):(A.push(_),A.push(_+(u+1)),A.push(_+(u+2)))}};K(!1),K(!0),t._ComputeSides(f,M,A,P,R,r.frontUVs,r.backUVs);var j=new t;return j.indices=A,j.positions=M,j.normals=P,j.uvs=R,p&&(j.colors=S),j},t.CreateTorus=function(r){for(var i=[],n=[],s=[],o=[],a=r.diameter||1,h=r.thickness||.5,u=r.tessellation||16,l=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,c=u+1,f=0;f<=u;f++)for(var d=f/u,p=f*Math.PI*2/u-Math.PI/2,_=e.Matrix.Translation(a/2,0,0).multiply(e.Matrix.RotationY(p)),m=0;m<=u;m++){var g=1-m/u,v=m*Math.PI*2/u+Math.PI,y=Math.cos(v),b=Math.sin(v),T=new e.Vector3(y,b,0),E=T.scale(h/2),x=new e.Vector2(d,g);E=e.Vector3.TransformCoordinates(E,_),T=e.Vector3.TransformNormal(T,_),n.push(E.x,E.y,E.z),s.push(T.x,T.y,T.z),o.push(x.x,x.y);var A=(f+1)%c,M=(m+1)%c;i.push(f*c+m),i.push(f*c+M),i.push(A*c+m),i.push(f*c+M),i.push(A*c+M),i.push(A*c+m)}t._ComputeSides(l,n,i,s,o,r.frontUVs,r.backUVs);var P=new t;return P.indices=i,P.positions=n,P.normals=s,P.uvs=o,P},t.CreateLineSystem=function(e){for(var r=[],i=[],n=e.lines,s=e.colors,o=[],a=0,h=0;h<n.length;h++)for(var u=n[h],l=0;l<u.length;l++){if(i.push(u[l].x,u[l].y,u[l].z),s){var c=s[h];o.push(c[l].r,c[l].g,c[l].b,c[l].a)}l>0&&(r.push(a-1),r.push(a)),a++}var f=new t;return f.indices=r,f.positions=i,s&&(f.colors=o),f},t.CreateDashedLines=function(r){var i=r.dashSize||3,n=r.gapSize||1,s=r.dashNb||200,o=r.points,a=new Array,h=new Array,u=e.Vector3.Zero(),l=0,c=0,f=0,d=0,p=0,_=0,m=0;for(m=0;m<o.length-1;m++)o[m+1].subtractToRef(o[m],u),l+=u.length();for(f=l/s,d=i*f/(i+n),m=0;m<o.length-1;m++){o[m+1].subtractToRef(o[m],u),c=Math.floor(u.length()/f),u.normalize();for(var g=0;g<c;g++)p=f*g,a.push(o[m].x+p*u.x,o[m].y+p*u.y,o[m].z+p*u.z),a.push(o[m].x+(p+d)*u.x,o[m].y+(p+d)*u.y,o[m].z+(p+d)*u.z),h.push(_,_+1),_+=2}var v=new t;return v.positions=a,v.indices=h,v},t.CreateGround=function(r){var i,n,s=[],o=[],a=[],h=[],u=r.width||1,l=r.height||1,c=r.subdivisionsX||r.subdivisions||1,f=r.subdivisionsY||r.subdivisions||1;for(i=0;i<=f;i++)for(n=0;n<=c;n++){var d=new e.Vector3(n*u/c-u/2,0,(f-i)*l/f-l/2),p=new e.Vector3(0,1,0);o.push(d.x,d.y,d.z),a.push(p.x,p.y,p.z),h.push(n/c,1-i/f)}for(i=0;i<f;i++)for(n=0;n<c;n++)s.push(n+1+(i+1)*(c+1)),s.push(n+1+i*(c+1)),s.push(n+i*(c+1)),s.push(n+(i+1)*(c+1)),s.push(n+1+(i+1)*(c+1)),s.push(n+i*(c+1));var _=new t;return _.indices=s,_.positions=o,_.normals=a,_.uvs=h,_},t.CreateTiledGround=function(r){var i,n,s,o,a=void 0!==r.xmin&&null!==r.xmin?r.xmin:-1,h=void 0!==r.zmin&&null!==r.zmin?r.zmin:-1,u=void 0!==r.xmax&&null!==r.xmax?r.xmax:1,l=void 0!==r.zmax&&null!==r.zmax?r.zmax:1,c=r.subdivisions||{w:1,h:1},f=r.precision||{w:1,h:1},d=new Array,p=new Array,_=new Array,m=new Array;c.h=c.h<1?1:c.h,c.w=c.w<1?1:c.w,f.w=f.w<1?1:f.w,f.h=f.h<1?1:f.h;var g={w:(u-a)/c.w,h:(l-h)/c.h};for(s=0;s<c.h;s++)for(o=0;o<c.w;o++)!(function(t,r,s,o){var a=p.length/3,h=f.w+1;for(i=0;i<f.h;i++)for(n=0;n<f.w;n++){var u=[a+n+i*h,a+(n+1)+i*h,a+(n+1)+(i+1)*h,a+n+(i+1)*h];d.push(u[1]),d.push(u[2]),d.push(u[3]),d.push(u[0]),d.push(u[1]),d.push(u[3])}var l=e.Vector3.Zero(),c=new e.Vector3(0,1,0);for(i=0;i<=f.h;i++)for(l.z=i*(o-r)/f.h+r,n=0;n<=f.w;n++)l.x=n*(s-t)/f.w+t,l.y=0,p.push(l.x,l.y,l.z),_.push(c.x,c.y,c.z),m.push(n/f.w,i/f.h)})(a+o*g.w,h+s*g.h,a+(o+1)*g.w,h+(s+1)*g.h);var v=new t;return v.indices=d,v.positions=p,v.normals=_,v.uvs=m,v},t.CreateGroundFromHeightMap=function(r){var i,n,s=[],o=[],a=[],h=[],u=r.colorFilter||new e.Color3(.3,.59,.11);for(i=0;i<=r.subdivisions;i++)for(n=0;n<=r.subdivisions;n++){var l=new e.Vector3(n*r.width/r.subdivisions-r.width/2,0,(r.subdivisions-i)*r.height/r.subdivisions-r.height/2),c=(l.x+r.width/2)/r.width*(r.bufferWidth-1)|0,f=(1-(l.z+r.height/2)/r.height)*(r.bufferHeight-1)|0,d=4*(c+f*r.bufferWidth),p=r.buffer[d]/255,_=r.buffer[d+1]/255,m=r.buffer[d+2]/255,g=p*u.r+_*u.g+m*u.b;l.y=r.minHeight+(r.maxHeight-r.minHeight)*g,o.push(l.x,l.y,l.z),a.push(0,0,0),h.push(n/r.subdivisions,1-i/r.subdivisions)}for(i=0;i<r.subdivisions;i++)for(n=0;n<r.subdivisions;n++)s.push(n+1+(i+1)*(r.subdivisions+1)),s.push(n+1+i*(r.subdivisions+1)),s.push(n+i*(r.subdivisions+1)),s.push(n+(i+1)*(r.subdivisions+1)),s.push(n+1+(i+1)*(r.subdivisions+1)),s.push(n+i*(r.subdivisions+1));t.ComputeNormals(o,s,a);var v=new t;return v.indices=s,v.positions=o,v.normals=a,v.uvs=h,v},t.CreatePlane=function(r){var i=[],n=[],s=[],o=[],a=r.width||r.size||1,h=r.height||r.size||1,u=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,l=a/2,c=h/2;n.push(-l,-c,0),s.push(0,0,-1),o.push(0,0),n.push(l,-c,0),s.push(0,0,-1),o.push(1,0),n.push(l,c,0),s.push(0,0,-1),o.push(1,1),n.push(-l,c,0),s.push(0,0,-1),o.push(0,1),i.push(0),i.push(1),i.push(2),i.push(0),
i.push(2),i.push(3),t._ComputeSides(u,n,i,s,o,r.frontUVs,r.backUVs);var f=new t;return f.indices=i,f.positions=n,f.normals=s,f.uvs=o,f},t.CreateDisc=function(r){var i=new Array,n=new Array,s=new Array,o=new Array,a=r.radius||.5,h=r.tessellation||64,u=r.arc&&(r.arc<=0||r.arc>1)?1:r.arc||1,l=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE;i.push(0,0,0),o.push(.5,.5);for(var c=2*Math.PI*u,f=c/h,d=0;d<c;d+=f){var p=Math.cos(d),_=Math.sin(d),m=(p+1)/2,g=(1-_)/2;i.push(a*p,a*_,0),o.push(m,g)}1===u&&(i.push(i[3],i[4],i[5]),o.push(o[2],o[3]));for(var v=i.length/3,y=1;y<v-1;y++)n.push(y+1,0,y);t.ComputeNormals(i,n,s),t._ComputeSides(l,i,n,s,o,r.frontUVs,r.backUVs);var b=new t;return b.indices=n,b.positions=i,b.normals=s,b.uvs=o,b},t.CreatePolygon=function(r,i,n,s,o,a){for(var h=n||new Array(3),u=s,l=[],c=0;c<3;c++)void 0===h[c]&&(h[c]=new e.Vector4(0,0,1,1)),u&&void 0===u[c]&&(u[c]=new e.Color4(1,1,1,1));for(var f=r.getVerticesData(e.VertexBuffer.PositionKind),d=r.getVerticesData(e.VertexBuffer.NormalKind),p=r.getVerticesData(e.VertexBuffer.UVKind),_=r.getIndices(),m=0,g=0,v=0;v<d.length;v+=3)Math.abs(d[v+1])<.001&&(g=1),Math.abs(d[v+1]-1)<.001&&(g=0),Math.abs(d[v+1]+1)<.001&&(g=2),m=v/3,p[2*m]=(1-p[2*m])*h[g].x+p[2*m]*h[g].z,p[2*m+1]=(1-p[2*m+1])*h[g].y+p[2*m+1]*h[g].w,u&&l.push(u[g].r,u[g].g,u[g].b,u[g].a);t._ComputeSides(i,f,_,d,p,o,a);var y=new t;if(y.indices=_,y.positions=f,y.normals=d,y.uvs=p,u){var b=i===e.Mesh.DOUBLESIDE?l.concat(l):l;y.colors=b}return y},t.CreateIcoSphere=function(r){var i,n=r.sideOrientation||e.Mesh.DEFAULTSIDE,s=r.radius||1,o=void 0===r.flat||r.flat,a=r.subdivisions||4,h=r.radiusX||s,u=r.radiusY||s,l=r.radiusZ||s,c=(1+Math.sqrt(5))/2,f=[-1,c,-0,1,c,0,-1,-c,0,1,-c,0,0,-1,-c,0,1,-c,0,-1,c,0,1,c,c,0,1,c,0,-1,-c,0,1,-c,0,-1],d=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],p=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],_=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],m=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],g=new Array,v=new Array,y=new Array,b=new Array,T=0,E=new Array(3),x=new Array(3);for(i=0;i<3;i++)E[i]=e.Vector3.Zero(),x[i]=e.Vector2.Zero();for(var A=0;A<20;A++){for(i=0;i<3;i++){var M=d[3*A+i];E[i].copyFromFloats(f[3*p[M]],f[3*p[M]+1],f[3*p[M]+2]),E[i].normalize().scaleInPlace(s),x[i].copyFromFloats(_[2*M]*(138/1024)+60/1024+m[A]*(-40/1024),_[2*M+1]*(239/1024)+26/1024+m[A]*(20/1024))}for(var P=function(t,r,i,n){var s=e.Vector3.Lerp(E[0],E[2],r/a),c=e.Vector3.Lerp(E[1],E[2],r/a),f=a===r?E[2]:e.Vector3.Lerp(s,c,t/(a-r));f.normalize();var d;if(o){var p=e.Vector3.Lerp(E[0],E[2],n/a),_=e.Vector3.Lerp(E[1],E[2],n/a);d=e.Vector3.Lerp(p,_,i/(a-n))}else d=new e.Vector3(f.x,f.y,f.z);d.x/=h,d.y/=u,d.z/=l,d.normalize();var m=e.Vector2.Lerp(x[0],x[2],r/a),A=e.Vector2.Lerp(x[1],x[2],r/a),M=a===r?x[2]:e.Vector2.Lerp(m,A,t/(a-r));v.push(f.x*h,f.y*u,f.z*l),y.push(d.x,d.y,d.z),b.push(M.x,M.y),g.push(T),T++},R=0;R<a;R++)for(var S=0;S+R<a;S++)P(S,R,S+1/3,R+1/3),P(S+1,R,S+1/3,R+1/3),P(S,R+1,S+1/3,R+1/3),S+R+1<a&&(P(S+1,R,S+2/3,R+2/3),P(S+1,R+1,S+2/3,R+2/3),P(S,R+1,S+2/3,R+2/3))}t._ComputeSides(n,v,g,y,b,r.frontUVs,r.backUVs);var C=new t;return C.indices=g,C.positions=v,C.normals=y,C.uvs=b,C},t.CreatePolyhedron=function(r){var i=[];i[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},i[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},i[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},i[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},i[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},i[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},i[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},i[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},i[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},i[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},i[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},i[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},i[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},i[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},i[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};var n,s,o,a,h,u,l=r.type&&(r.type<0||r.type>=i.length)?0:r.type||0,c=r.size,f=r.sizeX||c||1,d=r.sizeY||c||1,p=r.sizeZ||c||1,_=r.custom||i[l],m=_.face.length,g=r.faceUV||new Array(m),v=r.faceColors,y=void 0===r.flat||r.flat,b=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,T=new Array,E=new Array,x=new Array,A=new Array,M=new Array,P=0,R=0,S=new Array,C=0,O=0;if(y)for(O=0;O<m;O++)v&&void 0===v[O]&&(v[O]=new e.Color4(1,1,1,1)),g&&void 0===g[O]&&(g[O]=new e.Vector4(0,0,1,1));if(y)for(O=0;O<m;O++){var D=_.face[O].length;for(o=2*Math.PI/D,a=.5*Math.tan(o/2),h=.5,C=0;C<D;C++)T.push(_.vertex[_.face[O][C]][0]*f,_.vertex[_.face[O][C]][1]*d,_.vertex[_.face[O][C]][2]*p),S.push(P),P++,n=g[O].x+(g[O].z-g[O].x)*(.5+a),s=g[O].y+(g[O].w-g[O].y)*(h-.5),A.push(n,s),u=a*Math.cos(o)-h*Math.sin(o),h=a*Math.sin(o)+h*Math.cos(o),a=u,v&&M.push(v[O].r,v[O].g,v[O].b,v[O].a);for(C=0;C<D-2;C++)E.push(S[0+R],S[C+2+R],S[C+1+R]);R+=D}else{for(C=0;C<_.vertex.length;C++)T.push(_.vertex[C][0]*f,_.vertex[C][1]*d,_.vertex[C][2]*p),A.push(0,0);for(O=0;O<m;O++)for(C=0;C<_.face[O].length-2;C++)E.push(_.face[O][0],_.face[O][C+2],_.face[O][C+1])}t.ComputeNormals(T,E,x),t._ComputeSides(b,T,E,x,A,r.frontUVs,r.backUVs);var I=new t;return I.positions=T,I.indices=E,I.normals=x,I.uvs=A,v&&y&&(I.colors=M),I},t.CreateTorusKnot=function(r){var i,n,s=new Array,o=new Array,a=new Array,h=new Array,u=r.radius||2,l=r.tube||.5,c=r.radialSegments||32,f=r.tubularSegments||32,d=r.p||2,p=r.q||3,_=0===r.sideOrientation?0:r.sideOrientation||e.Mesh.DEFAULTSIDE,m=function(t){var r=Math.cos(t),i=Math.sin(t),n=p/d*t,s=Math.cos(n),o=u*(2+s)*.5*r,a=u*(2+s)*i*.5,h=u*Math.sin(n)*.5;return new e.Vector3(o,a,h)};for(i=0;i<=c;i++){var g=i%c,v=g/c*2*d*Math.PI,y=m(v),b=m(v+.01),T=b.subtract(y),E=b.add(y),x=e.Vector3.Cross(T,E);for(E=e.Vector3.Cross(x,T),x.normalize(),E.normalize(),n=0;n<f;n++){var A=n%f,M=A/f*2*Math.PI,P=-l*Math.cos(M),R=l*Math.sin(M);o.push(y.x+P*E.x+R*x.x),o.push(y.y+P*E.y+R*x.y),o.push(y.z+P*E.z+R*x.z),h.push(i/c),h.push(n/f)}}for(i=0;i<c;i++)for(n=0;n<f;n++){var S=(n+1)%f,C=i*f+n,O=(i+1)*f+n,D=(i+1)*f+S,I=i*f+S;s.push(I),s.push(O),s.push(C),s.push(I),s.push(D),s.push(O)}t.ComputeNormals(o,s,a),t._ComputeSides(_,o,s,a,h,r.frontUVs,r.backUVs);var F=new t;return F.indices=s,F.positions=o,F.normals=a,F.uvs=h,F},t.ComputeNormals=function(t,r,i,n){var s=0,o=0,a=0,h=0,u=0,l=0,c=0,f=0,d=0,p=0,_=0,m=0,g=0,v=0,y=0,b=0,T=0,E=0,x=0,A=0,M=!1,P=!1,R=!1,S=!1,C=1,O=0,D=null;if(n&&(M=!!n.facetNormals,P=!!n.facetPositions,R=!!n.facetPartitioning,C=!0===n.useRightHandedSystem?-1:1,O=n.ratio||0,S=!!n.depthSort,D=n.distanceTo,S)){void 0===D&&(D=e.Vector3.Zero());var I=n.depthSortedFacets}var F=0,L=0,w=0,B=0;if(R&&n&&n.bbSize){var U=0,V=0,N=0,k=0,z=0,G=0,W=0,X=0,H=0,K=0,j=0,Y=0,Q=0,Z=0,q=0,J=0,$=n.bbSize.x>n.bbSize.y?n.bbSize.x:n.bbSize.y;$=$>n.bbSize.z?$:n.bbSize.z,F=n.subDiv.X*O/n.bbSize.x,L=n.subDiv.Y*O/n.bbSize.y,w=n.subDiv.Z*O/n.bbSize.z,B=n.subDiv.max*n.subDiv.max,n.facetPartitioning.length=0}for(s=0;s<t.length;s++)i[s]=0;var ee=r.length/3|0;for(s=0;s<ee;s++){if(m=3*r[3*s],g=m+1,v=m+2,y=3*r[3*s+1],b=y+1,T=y+2,E=3*r[3*s+2],x=E+1,A=E+2,o=t[m]-t[y],a=t[g]-t[b],h=t[v]-t[T],u=t[E]-t[y],l=t[x]-t[b],c=t[A]-t[T],f=C*(a*c-h*l),d=C*(h*u-o*c),p=C*(o*l-a*u),_=Math.sqrt(f*f+d*d+p*p),_=0===_?1:_,f/=_,d/=_,p/=_,M&&n&&(n.facetNormals[s].x=f,n.facetNormals[s].y=d,n.facetNormals[s].z=p),P&&n&&(n.facetPositions[s].x=(t[m]+t[y]+t[E])/3,n.facetPositions[s].y=(t[g]+t[b]+t[x])/3,n.facetPositions[s].z=(t[v]+t[T]+t[A])/3),R&&n&&(U=Math.floor((n.facetPositions[s].x-n.bInfo.minimum.x*O)*F),V=Math.floor((n.facetPositions[s].y-n.bInfo.minimum.y*O)*L),N=Math.floor((n.facetPositions[s].z-n.bInfo.minimum.z*O)*w),k=Math.floor((t[m]-n.bInfo.minimum.x*O)*F),z=Math.floor((t[g]-n.bInfo.minimum.y*O)*L),G=Math.floor((t[v]-n.bInfo.minimum.z*O)*w),W=Math.floor((t[y]-n.bInfo.minimum.x*O)*F),X=Math.floor((t[b]-n.bInfo.minimum.y*O)*L),H=Math.floor((t[T]-n.bInfo.minimum.z*O)*w),K=Math.floor((t[E]-n.bInfo.minimum.x*O)*F),j=Math.floor((t[x]-n.bInfo.minimum.y*O)*L),Y=Math.floor((t[A]-n.bInfo.minimum.z*O)*w),Z=k+n.subDiv.max*z+B*G,q=W+n.subDiv.max*X+B*H,J=K+n.subDiv.max*j+B*Y,Q=U+n.subDiv.max*V+B*N,n.facetPartitioning[Q]=n.facetPartitioning[Q]?n.facetPartitioning[Q]:new Array,n.facetPartitioning[Z]=n.facetPartitioning[Z]?n.facetPartitioning[Z]:new Array,n.facetPartitioning[q]=n.facetPartitioning[q]?n.facetPartitioning[q]:new Array,n.facetPartitioning[J]=n.facetPartitioning[J]?n.facetPartitioning[J]:new Array,n.facetPartitioning[Z].push(s),q!=Z&&n.facetPartitioning[q].push(s),J!=q&&J!=Z&&n.facetPartitioning[J].push(s),Q!=Z&&Q!=q&&Q!=J&&n.facetPartitioning[Q].push(s)),S&&n&&n.facetPositions){var te=I[s];te.ind=3*s,te.sqDistance=e.Vector3.DistanceSquared(n.facetPositions[s],D)}i[m]+=f,i[g]+=d,i[v]+=p,i[y]+=f,i[b]+=d,i[T]+=p,i[E]+=f,i[x]+=d,i[A]+=p}for(s=0;s<i.length/3;s++)f=i[3*s],d=i[3*s+1],p=i[3*s+2],_=Math.sqrt(f*f+d*d+p*p),_=0===_?1:_,f/=_,d/=_,p/=_,i[3*s]=f,i[3*s+1]=d,i[3*s+2]=p},t._ComputeSides=function(t,r,i,n,s,o,a){var h,u,l=i.length,c=n.length;switch(t=t||e.Mesh.DEFAULTSIDE){case e.Mesh.FRONTSIDE:break;case e.Mesh.BACKSIDE:var f;for(h=0;h<l;h+=3)f=i[h],i[h]=i[h+2],i[h+2]=f;for(u=0;u<c;u++)n[u]=-n[u];break;case e.Mesh.DOUBLESIDE:for(var d=r.length,p=d/3,_=0;_<d;_++)r[d+_]=r[_];for(h=0;h<l;h+=3)i[h+l]=i[h+2]+p,i[h+1+l]=i[h+1]+p,i[h+2+l]=i[h]+p;for(u=0;u<c;u++)n[c+u]=-n[u];var m=s.length,g=0;for(g=0;g<m;g++)s[g+m]=s[g];for(o=o||new e.Vector4(0,0,1,1),a=a||new e.Vector4(0,0,1,1),g=0,h=0;h<m/2;h++)s[g]=o.x+(o.z-o.x)*s[g],s[g+1]=o.y+(o.w-o.y)*s[g+1],s[g+m]=a.x+(a.z-a.x)*s[g+m],s[g+m+1]=a.y+(a.w-a.y)*s[g+m+1],g+=2}},t.ImportVertexData=function(r,i){var n=new t,s=r.positions;s&&n.set(s,e.VertexBuffer.PositionKind);var o=r.normals;o&&n.set(o,e.VertexBuffer.NormalKind);var a=r.tangents;a&&n.set(a,e.VertexBuffer.TangentKind);var h=r.uvs;h&&n.set(h,e.VertexBuffer.UVKind);var u=r.uv2s;u&&n.set(u,e.VertexBuffer.UV2Kind);var l=r.uv3s;l&&n.set(l,e.VertexBuffer.UV3Kind);var c=r.uv4s;c&&n.set(c,e.VertexBuffer.UV4Kind);var f=r.uv5s;f&&n.set(f,e.VertexBuffer.UV5Kind);var d=r.uv6s;d&&n.set(d,e.VertexBuffer.UV6Kind);var p=r.colors;p&&n.set(e.Color4.CheckColors4(p,s.length/3),e.VertexBuffer.ColorKind);var _=r.matricesIndices;_&&n.set(_,e.VertexBuffer.MatricesIndicesKind);var m=r.matricesWeights;m&&n.set(m,e.VertexBuffer.MatricesWeightsKind);var g=r.indices;g&&(n.indices=g),i.setAllVerticesData(n,r.updatable)},t})();e.VertexData=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(t,r,i,n,s){void 0===n&&(n=!1),void 0===s&&(s=null),this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this.id=t,this._engine=r.getEngine(),this._meshes=[],this._scene=r,this._vertexBuffers={},this._indices=[],this._updatable=n,i?this.setAllVerticesData(i,n):(this._totalVertices=0,this._indices=[]),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&("LinesMesh"===s.getClassName()&&(this.boundingBias=new e.Vector2(0,s.intersectionThreshold),this._updateExtend()),this.applyToMesh(s),s.computeWorldMatrix(!0))}return Object.defineProperty(t.prototype,"boundingBias",{get:function(){return this._boundingBias},set:function(e){this._boundingBias&&this._boundingBias.equals(e)||(this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null))},enumerable:!0,configurable:!0}),t.CreateGeometryForMesh=function(e){var r=new t(t.RandomId(),e.getScene());return r.applyToMesh(e),r},Object.defineProperty(t.prototype,"extend",{get:function(){return this._extend},enumerable:!0,configurable:!0}),t.prototype.getScene=function(){return this._scene},t.prototype.getEngine=function(){return this._engine},t.prototype.isReady=function(){return this.delayLoadState===e.Engine.DELAYLOADSTATE_LOADED||this.delayLoadState===e.Engine.DELAYLOADSTATE_NONE},Object.defineProperty(t.prototype,"doNotSerialize",{get:function(){for(var e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0},enumerable:!0,configurable:!0}),t.prototype._rebuild=function(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices));for(var e in this._vertexBuffers){this._vertexBuffers[e]._rebuild()}},t.prototype.setAllVerticesData=function(e,t){e.applyToGeometry(this,t),this.notifyUpdate()},t.prototype.setVerticesData=function(t,r,i,n){void 0===i&&(i=!1);var s=new e.VertexBuffer(this._engine,r,t,i,0===this._meshes.length,n);this.setVerticesBuffer(s)},t.prototype.removeVerticesData=function(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e])},t.prototype.setVerticesBuffer=function(t,r){void 0===r&&(r=null);var i=t.getKind();if(this._vertexBuffers[i]&&this._vertexBuffers[i].dispose(),this._vertexBuffers[i]=t,i===e.VertexBuffer.PositionKind){var n=t.getData();null!=r?this._totalVertices=r:null!=n&&(this._totalVertices=n.length/(t.byteStride/4)),this._updateExtend(n),this._resetPointsArrayCache();for(var s=this._meshes,o=s.length,a=0;a<o;a++){var h=s[a];h._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum),h._createGlobalSubMesh(!1),h.computeWorldMatrix(!0)}}this.notifyUpdate(i),this._vertexArrayObjects&&(this._disposeVertexArrayObjects(),this._vertexArrayObjects={})},t.prototype.updateVerticesDataDirectly=function(e,t,r,i){void 0===i&&(i=!1);var n=this.getVertexBuffer(e);n&&(n.updateDirectly(t,r,i),this.notifyUpdate(e))},t.prototype.updateVerticesData=function(t,r,i){void 0===i&&(i=!1);var n=this.getVertexBuffer(t);n&&(n.update(r),t===e.VertexBuffer.PositionKind&&this._updateBoundingInfo(i,r),this.notifyUpdate(t))},t.prototype._updateBoundingInfo=function(t,r){t&&this._updateExtend(r);var i=this._meshes,n=i.length;this._resetPointsArrayCache();for(var s=0;s<n;s++){var o=i[s];if(t){o._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum);for(var a=0;a<o.subMeshes.length;a++){o.subMeshes[a].refreshBoundingInfo()}}}},t.prototype._bind=function(e,t){if(e){void 0===t&&(t=this._indexBuffer);var r=this.getVertexBuffers();if(r){if(t!=this._indexBuffer||!this._vertexArrayObjects)return void this._engine.bindBuffers(r,t,e);this._vertexArrayObjects[e.key]||(this._vertexArrayObjects[e.key]=this._engine.recordVertexArrayObject(r,t,e)),this._engine.bindVertexArrayObject(this._vertexArrayObjects[e.key],t)}}},t.prototype.getTotalVertices=function(){return this.isReady()?this._totalVertices:0},t.prototype.getVerticesData=function(t,r,i){var n=this.getVertexBuffer(t);if(!n)return null;var s=n.getData();if(!s)return null;var o=n.getSize()*e.VertexBuffer.GetTypeByteLength(n.type),a=this._totalVertices*n.getSize();if(n.type!==e.VertexBuffer.FLOAT||n.byteStride!==o){var h=new Array(a);return n.forEach(a,(function(e,t){h[t]=e})),h}if(!(s instanceof Array||s instanceof Float32Array)||0!==n.byteOffset||s.length!==a){if(s instanceof Array){var u=n.byteOffset/4;return e.Tools.Slice(s,u,u+a)}return s instanceof ArrayBuffer?new Float32Array(s,n.byteOffset,a):new Float32Array(s.buffer,s.byteOffset+n.byteOffset,a)}return i||r&&1!==this._meshes.length?e.Tools.Slice(s):s},t.prototype.isVertexBufferUpdatable=function(e){var t=this._vertexBuffers[e];return!!t&&t.isUpdatable()},t.prototype.getVertexBuffer=function(e){return this.isReady()?this._vertexBuffers[e]:null},t.prototype.getVertexBuffers=function(){return this.isReady()?this._vertexBuffers:null},t.prototype.isVerticesDataPresent=function(e){return this._vertexBuffers?void 0!==this._vertexBuffers[e]:!!this._delayInfo&&-1!==this._delayInfo.indexOf(e)},t.prototype.getVerticesDataKinds=function(){var e,t=[];if(!this._vertexBuffers&&this._delayInfo)for(e in this._delayInfo)t.push(e);else for(e in this._vertexBuffers)t.push(e);return t},t.prototype.updateIndices=function(e,t){this._indexBuffer&&(this._indexBufferIsUpdatable?this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t):this.setIndices(e,null,!0))},t.prototype.setIndices=function(e,t,r){void 0===t&&(t=null),void 0===r&&(r=!1),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._disposeVertexArrayObjects(),this._indices=e,this._indexBufferIsUpdatable=r,0!==this._meshes.length&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,r)),void 0!=t&&(this._totalVertices=t);for(var i=this._meshes,n=i.length,s=0;s<n;s++)i[s]._createGlobalSubMesh(!0);this.notifyUpdate()},t.prototype.getTotalIndices=function(){return this.isReady()?this._indices.length:0},t.prototype.getIndices=function(e){if(!this.isReady())return null;var t=this._indices;if(e&&1!==this._meshes.length){for(var r=t.length,i=[],n=0;n<r;n++)i.push(t[n]);return i}return t},t.prototype.getIndexBuffer=function(){return this.isReady()?this._indexBuffer:null},t.prototype._releaseVertexArrayObject=function(e){void 0===e&&(e=null),e&&this._vertexArrayObjects&&this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])},t.prototype.releaseForMesh=function(e,t){var r=this._meshes,i=r.indexOf(e);-1!==i&&(r.splice(i,1),e._geometry=null,0===r.length&&t&&this.dispose())},t.prototype.applyToMesh=function(e){if(e._geometry!==this){var t=e._geometry;t&&t.releaseForMesh(e);var r=this._meshes;e._geometry=this,this._scene.pushGeometry(this),r.push(e),this.isReady()?this._applyToMesh(e):e._boundingInfo=this._boundingInfo}},t.prototype._updateExtend=function(t){void 0===t&&(t=null),t||(t=this.getVerticesData(e.VertexBuffer.PositionKind)),this._extend=e.Tools.ExtractMinAndMax(t,0,this._totalVertices,this.boundingBias,3)},t.prototype._applyToMesh=function(t){var r=this._meshes.length;for(var i in this._vertexBuffers){1===r&&this._vertexBuffers[i].create();var n=this._vertexBuffers[i].getBuffer();n&&(n.references=r),i===e.VertexBuffer.PositionKind&&(this._extend||this._updateExtend(),t._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum),t._createGlobalSubMesh(!1),t._updateBoundingInfo())}1===r&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices)),this._indexBuffer&&(this._indexBuffer.references=r)},t.prototype.notifyUpdate=function(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e);for(var t=0,r=this._meshes;t<r.length;t++){r[t]._markSubMeshesAsAttributesDirty()}},t.prototype.load=function(t,r){if(this.delayLoadState!==e.Engine.DELAYLOADSTATE_LOADING){if(this.isReady())return void(r&&r());this.delayLoadState=e.Engine.DELAYLOADSTATE_LOADING,this._queueLoad(t,r)}},t.prototype._queueLoad=function(t,r){var i=this;this.delayLoadingFile&&(t._addPendingData(this),t._loadFile(this.delayLoadingFile,(function(n){if(i._delayLoadingFunction){i._delayLoadingFunction(JSON.parse(n),i),i.delayLoadState=e.Engine.DELAYLOADSTATE_LOADED,i._delayInfo=[],t._removePendingData(i);for(var s=i._meshes,o=s.length,a=0;a<o;a++)i._applyToMesh(s[a]);r&&r()}}),void 0,!0))},t.prototype.toLeftHanded=function(){var t=this.getIndices(!1);if(null!=t&&t.length>0){for(var r=0;r<t.length;r+=3){var i=t[r+0];t[r+0]=t[r+2],t[r+2]=i}this.setIndices(t)}var n=this.getVerticesData(e.VertexBuffer.PositionKind,!1);if(null!=n&&n.length>0){for(var r=0;r<n.length;r+=3)n[r+2]=-n[r+2];this.setVerticesData(e.VertexBuffer.PositionKind,n,!1)}var s=this.getVerticesData(e.VertexBuffer.NormalKind,!1);if(null!=s&&s.length>0){for(var r=0;r<s.length;r+=3)s[r+2]=-s[r+2];this.setVerticesData(e.VertexBuffer.NormalKind,s,!1)}},t.prototype._resetPointsArrayCache=function(){this._positions=null},t.prototype._generatePointsArray=function(){if(this._positions)return!0;var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(!t||0===t.length)return!1;this._positions=[];for(var r=0;r<t.length;r+=3)this._positions.push(e.Vector3.FromArray(t,r));return!0},t.prototype.isDisposed=function(){return this._isDisposed},t.prototype._disposeVertexArrayObjects=function(){if(this._vertexArrayObjects){for(var e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={}}},t.prototype.dispose=function(){var t,r=this._meshes,i=r.length;for(t=0;t<i;t++)this.releaseForMesh(r[t]);this._meshes=[],this._disposeVertexArrayObjects();for(var n in this._vertexBuffers)this._vertexBuffers[n].dispose();this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=e.Engine.DELAYLOADSTATE_NONE,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._isDisposed=!0},t.prototype.copy=function(r){var i=new e.VertexData;i.indices=[];var n=this.getIndices();if(n)for(var s=0;s<n.length;s++)i.indices.push(n[s]);var o,a=!1,h=!1;for(o in this._vertexBuffers){var u=this.getVerticesData(o);if(u instanceof Float32Array?i.set(new Float32Array(u),o):i.set(u.slice(0),o),!h){var l=this.getVertexBuffer(o);l&&(a=l.isUpdatable(),h=!a)}}var c=new t(r,this._scene,i,a);c.delayLoadState=this.delayLoadState,c.delayLoadingFile=this.delayLoadingFile,c._delayLoadingFunction=this._delayLoadingFunction;for(o in this._delayInfo)c._delayInfo=c._delayInfo||[],c._delayInfo.push(o);return c._boundingInfo=new e.BoundingInfo(this._extend.minimum,this._extend.maximum),c},t.prototype.serialize=function(){var t={};return t.id=this.id,t.updatable=this._updatable,e.Tags&&e.Tags.HasTags(this)&&(t.tags=e.Tags.GetTags(this)),t},t.prototype.toNumberArray=function(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)},t.prototype.serializeVerticeData=function(){var t=this.serialize();return this.isVerticesDataPresent(e.VertexBuffer.PositionKind)&&(t.positions=this.toNumberArray(this.getVerticesData(e.VertexBuffer.PositionKind)),this.isVertexBufferUpdatable(e.VertexBuffer.PositionKind)&&(t.positions._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.NormalKind)&&(t.normals=this.toNumberArray(this.getVerticesData(e.VertexBuffer.NormalKind)),this.isVertexBufferUpdatable(e.VertexBuffer.NormalKind)&&(t.normals._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.TangentKind)&&(t.tangets=this.toNumberArray(this.getVerticesData(e.VertexBuffer.TangentKind)),this.isVertexBufferUpdatable(e.VertexBuffer.TangentKind)&&(t.tangets._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.UVKind)&&(t.uvs=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UVKind)),this.isVertexBufferUpdatable(e.VertexBuffer.UVKind)&&(t.uvs._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.UV2Kind)&&(t.uv2s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV2Kind)),this.isVertexBufferUpdatable(e.VertexBuffer.UV2Kind)&&(t.uv2s._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.UV3Kind)&&(t.uv3s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV3Kind)),this.isVertexBufferUpdatable(e.VertexBuffer.UV3Kind)&&(t.uv3s._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.UV4Kind)&&(t.uv4s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV4Kind)),this.isVertexBufferUpdatable(e.VertexBuffer.UV4Kind)&&(t.uv4s._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.UV5Kind)&&(t.uv5s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV5Kind)),this.isVertexBufferUpdatable(e.VertexBuffer.UV5Kind)&&(t.uv5s._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.UV6Kind)&&(t.uv6s=this.toNumberArray(this.getVerticesData(e.VertexBuffer.UV6Kind)),this.isVertexBufferUpdatable(e.VertexBuffer.UV6Kind)&&(t.uv6s._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.ColorKind)&&(t.colors=this.toNumberArray(this.getVerticesData(e.VertexBuffer.ColorKind)),this.isVertexBufferUpdatable(e.VertexBuffer.ColorKind)&&(t.colors._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.MatricesIndicesKind)&&(t.matricesIndices=this.toNumberArray(this.getVerticesData(e.VertexBuffer.MatricesIndicesKind)),t.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(e.VertexBuffer.MatricesIndicesKind)&&(t.matricesIndices._updatable=!0)),this.isVerticesDataPresent(e.VertexBuffer.MatricesWeightsKind)&&(t.matricesWeights=this.toNumberArray(this.getVerticesData(e.VertexBuffer.MatricesWeightsKind)),this.isVertexBufferUpdatable(e.VertexBuffer.MatricesWeightsKind)&&(t.matricesWeights._updatable=!0)),t.indices=this.toNumberArray(this.getIndices()),t},t.ExtractFromMesh=function(e,t){var r=e._geometry;return r?r.copy(t):null},t.RandomId=function(){return e.Tools.RandomId()},t._ImportGeometry=function(r,i){var n=i.getScene(),s=r.geometryId;if(s){var o=n.getGeometryByID(s);o&&o.applyToMesh(i)}else if(r instanceof ArrayBuffer){var a=i._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){var h=new Float32Array(r,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);i.setVerticesData(e.VertexBuffer.PositionKind,h,!1)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){var u=new Float32Array(r,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);i.setVerticesData(e.VertexBuffer.NormalKind,u,!1)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){var l=new Float32Array(r,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);i.setVerticesData(e.VertexBuffer.TangentKind,l,!1)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){var c=new Float32Array(r,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);i.setVerticesData(e.VertexBuffer.UVKind,c,!1)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){var f=new Float32Array(r,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);i.setVerticesData(e.VertexBuffer.UV2Kind,f,!1)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){var d=new Float32Array(r,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);i.setVerticesData(e.VertexBuffer.UV3Kind,d,!1)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){var p=new Float32Array(r,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);i.setVerticesData(e.VertexBuffer.UV4Kind,p,!1)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){var _=new Float32Array(r,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);i.setVerticesData(e.VertexBuffer.UV5Kind,_,!1)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){var m=new Float32Array(r,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);i.setVerticesData(e.VertexBuffer.UV6Kind,m,!1)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){var g=new Float32Array(r,a.colorsAttrDesc.offset,a.colorsAttrDesc.count)
;i.setVerticesData(e.VertexBuffer.ColorKind,g,!1,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){var v=new Int32Array(r,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count);i.setVerticesData(e.VertexBuffer.MatricesIndicesKind,v,!1)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){var y=new Float32Array(r,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);i.setVerticesData(e.VertexBuffer.MatricesWeightsKind,y,!1)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){var b=new Int32Array(r,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);i.setIndices(b,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){var T=new Int32Array(r,a.subMeshesAttrDesc.offset,5*a.subMeshesAttrDesc.count);i.subMeshes=[];for(var E=0;E<a.subMeshesAttrDesc.count;E++){var x=T[5*E+0],A=T[5*E+1],M=T[5*E+2],P=T[5*E+3],R=T[5*E+4];e.SubMesh.AddToMesh(x,A,M,P,R,i)}}}else if(r.positions&&r.normals&&r.indices){if(i.setVerticesData(e.VertexBuffer.PositionKind,r.positions,r.positions._updatable),i.setVerticesData(e.VertexBuffer.NormalKind,r.normals,r.normals._updatable),r.tangents&&i.setVerticesData(e.VertexBuffer.TangentKind,r.tangents,r.tangents._updatable),r.uvs&&i.setVerticesData(e.VertexBuffer.UVKind,r.uvs,r.uvs._updatable),r.uvs2&&i.setVerticesData(e.VertexBuffer.UV2Kind,r.uvs2,r.uvs2._updatable),r.uvs3&&i.setVerticesData(e.VertexBuffer.UV3Kind,r.uvs3,r.uvs3._updatable),r.uvs4&&i.setVerticesData(e.VertexBuffer.UV4Kind,r.uvs4,r.uvs4._updatable),r.uvs5&&i.setVerticesData(e.VertexBuffer.UV5Kind,r.uvs5,r.uvs5._updatable),r.uvs6&&i.setVerticesData(e.VertexBuffer.UV6Kind,r.uvs6,r.uvs6._updatable),r.colors&&i.setVerticesData(e.VertexBuffer.ColorKind,e.Color4.CheckColors4(r.colors,r.positions.length/3),r.colors._updatable),r.matricesIndices)if(r.matricesIndices._isExpanded)delete r.matricesIndices._isExpanded,i.setVerticesData(e.VertexBuffer.MatricesIndicesKind,r.matricesIndices,r.matricesIndices._updatable);else{for(var S=[],E=0;E<r.matricesIndices.length;E++){var C=r.matricesIndices[E];S.push(255&C),S.push((65280&C)>>8),S.push((16711680&C)>>16),S.push(C>>24)}i.setVerticesData(e.VertexBuffer.MatricesIndicesKind,S,r.matricesIndices._updatable)}if(r.matricesIndicesExtra)if(r.matricesIndicesExtra._isExpanded)delete r.matricesIndices._isExpanded,i.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,r.matricesIndicesExtra,r.matricesIndicesExtra._updatable);else{for(var S=[],E=0;E<r.matricesIndicesExtra.length;E++){var C=r.matricesIndicesExtra[E];S.push(255&C),S.push((65280&C)>>8),S.push((16711680&C)>>16),S.push(C>>24)}i.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,S,r.matricesIndicesExtra._updatable)}r.matricesWeights&&(t._CleanMatricesWeights(r,i),i.setVerticesData(e.VertexBuffer.MatricesWeightsKind,r.matricesWeights,r.matricesWeights._updatable)),r.matricesWeightsExtra&&i.setVerticesData(e.VertexBuffer.MatricesWeightsExtraKind,r.matricesWeightsExtra,r.matricesWeights._updatable),i.setIndices(r.indices,null)}if(r.subMeshes){i.subMeshes=[];for(var O=0;O<r.subMeshes.length;O++){var D=r.subMeshes[O];e.SubMesh.AddToMesh(D.materialIndex,D.verticesStart,D.verticesCount,D.indexStart,D.indexCount,i)}}i._shouldGenerateFlatShading&&(i.convertToFlatShadedMesh(),delete i._shouldGenerateFlatShading),i.computeWorldMatrix(!0);var I=n.selectionOctree;void 0!==I&&null!==I&&I.addMesh(i)},t._CleanMatricesWeights=function(t,r){if(e.SceneLoader.CleanBoneMatrixWeights){var i=0;if(t.skeletonId>-1){var n=r.getScene().getLastSkeletonByID(t.skeletonId);if(n){i=n.bones.length;for(var s=r.getVerticesData(e.VertexBuffer.MatricesIndicesKind),o=r.getVerticesData(e.VertexBuffer.MatricesIndicesExtraKind),a=t.matricesWeights,h=t.matricesWeightsExtra,u=t.numBoneInfluencer,l=a.length,c=0;c<l;c+=4){for(var f=0,d=-1,p=0;p<4;p++){var _=a[c+p];f+=_,_<.001&&d<0&&(d=p)}if(h)for(var p=0;p<4;p++){var _=h[c+p];f+=_,_<.001&&d<0&&(d=p+4)}if((d<0||d>u-1)&&(d=u-1),f>.001){for(var m=1/f,p=0;p<4;p++)a[c+p]*=m;if(h)for(var p=0;p<4;p++)h[c+p]*=m}else d>=4?(h[c+d-4]=1-f,o[c+d-4]=i):(a[c+d]=1-f,s[c+d]=i)}r.setVerticesData(e.VertexBuffer.MatricesIndicesKind,s),t.matricesWeightsExtra&&r.setVerticesData(e.VertexBuffer.MatricesIndicesExtraKind,o)}}}},t.Parse=function(r,i,n){if(i.getGeometryByID(r.id))return null;var s=new t(r.id,i,void 0,r.updatable);return e.Tags&&e.Tags.AddTagsTo(s,r.tags),r.delayLoadingFile?(s.delayLoadState=e.Engine.DELAYLOADSTATE_NOTLOADED,s.delayLoadingFile=n+r.delayLoadingFile,s._boundingInfo=new e.BoundingInfo(e.Vector3.FromArray(r.boundingBoxMinimum),e.Vector3.FromArray(r.boundingBoxMaximum)),s._delayInfo=[],r.hasUVs&&s._delayInfo.push(e.VertexBuffer.UVKind),r.hasUVs2&&s._delayInfo.push(e.VertexBuffer.UV2Kind),r.hasUVs3&&s._delayInfo.push(e.VertexBuffer.UV3Kind),r.hasUVs4&&s._delayInfo.push(e.VertexBuffer.UV4Kind),r.hasUVs5&&s._delayInfo.push(e.VertexBuffer.UV5Kind),r.hasUVs6&&s._delayInfo.push(e.VertexBuffer.UV6Kind),r.hasColors&&s._delayInfo.push(e.VertexBuffer.ColorKind),r.hasMatricesIndices&&s._delayInfo.push(e.VertexBuffer.MatricesIndicesKind),r.hasMatricesWeights&&s._delayInfo.push(e.VertexBuffer.MatricesWeightsKind),s._delayLoadingFunction=e.VertexData.ImportVertexData):e.VertexData.ImportVertexData(r,s),i.pushGeometry(s,!0),s},t})();e.Geometry=t;var r=(function(e){function t(t,r,i,n){void 0===i&&(i=!1),void 0===n&&(n=null);var s=e.call(this,t,r,void 0,!1,n)||this;return s._canBeRegenerated=i,s._beingRegenerated=!0,s.regenerate(),s._beingRegenerated=!1,s}return s(t,e),t.prototype.canBeRegenerated=function(){return this._canBeRegenerated},t.prototype.regenerate=function(){this._canBeRegenerated&&(this._beingRegenerated=!0,this.setAllVerticesData(this._regenerateVertexData(),!1),this._beingRegenerated=!1)},t.prototype.asNewGeometry=function(t){return e.prototype.copy.call(this,t)},t.prototype.setAllVerticesData=function(t,r){this._beingRegenerated&&e.prototype.setAllVerticesData.call(this,t,!1)},t.prototype.setVerticesData=function(t,r,i){this._beingRegenerated&&e.prototype.setVerticesData.call(this,t,r,!1)},t.prototype._regenerateVertexData=function(){throw new Error("Abstract method")},t.prototype.copy=function(e){throw new Error("Must be overriden in sub-classes.")},t.prototype.serialize=function(){var t=e.prototype.serialize.call(this);return t.canBeRegenerated=this.canBeRegenerated(),t},t})(t);e._PrimitiveGeometry=r;var i=(function(t){function r(r,i,n,s,o,a,h,u,l){void 0===l&&(l=e.Mesh.DEFAULTSIDE);var c=t.call(this,r,i,h,u)||this;return c.pathArray=n,c.closeArray=s,c.closePath=o,c.offset=a,c.side=l,c}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateRibbon({pathArray:this.pathArray,closeArray:this.closeArray,closePath:this.closePath,offset:this.offset,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.pathArray,this.closeArray,this.closePath,this.offset,this.canBeRegenerated(),void 0,this.side)},r})(r);e.RibbonGeometry=i;var n=(function(t){function r(r,i,n,s,o,a){void 0===o&&(o=null),void 0===a&&(a=e.Mesh.DEFAULTSIDE);var h=t.call(this,r,i,s,o)||this;return h.size=n,h.side=a,h}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateBox({size:this.size,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.size,this.canBeRegenerated(),void 0,this.side)},r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.size=this.size,e},r.Parse=function(t,i){if(i.getGeometryByID(t.id))return null;var n=new r(t.id,i,t.size,t.canBeRegenerated,null);return e.Tags&&e.Tags.AddTagsTo(n,t.tags),i.pushGeometry(n,!0),n},r})(r);e.BoxGeometry=n;var o=(function(t){function r(r,i,n,s,o,a,h){void 0===a&&(a=null),void 0===h&&(h=e.Mesh.DEFAULTSIDE);var u=t.call(this,r,i,o,a)||this;return u.segments=n,u.diameter=s,u.side=h,u}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateSphere({segments:this.segments,diameter:this.diameter,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.segments,this.diameter,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.segments=this.segments,e.diameter=this.diameter,e},r.Parse=function(t,i){if(i.getGeometryByID(t.id))return null;var n=new r(t.id,i,t.segments,t.diameter,t.canBeRegenerated,null);return e.Tags&&e.Tags.AddTagsTo(n,t.tags),i.pushGeometry(n,!0),n},r})(r);e.SphereGeometry=o;var a=(function(t){function r(r,i,n,s,o,a,h){void 0===a&&(a=null),void 0===h&&(h=e.Mesh.DEFAULTSIDE);var u=t.call(this,r,i,o,a)||this;return u.radius=n,u.tessellation=s,u.side=h,u}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateDisc({radius:this.radius,tessellation:this.tessellation,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.radius,this.tessellation,this.canBeRegenerated(),null,this.side)},r})(r);e.DiscGeometry=a;var h=(function(t){function r(r,i,n,s,o,a,h,u,l,c){void 0===h&&(h=1),void 0===l&&(l=null),void 0===c&&(c=e.Mesh.DEFAULTSIDE);var f=t.call(this,r,i,u,l)||this;return f.height=n,f.diameterTop=s,f.diameterBottom=o,f.tessellation=a,f.subdivisions=h,f.side=c,f}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateCylinder({height:this.height,diameterTop:this.diameterTop,diameterBottom:this.diameterBottom,tessellation:this.tessellation,subdivisions:this.subdivisions,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.height,this.diameterTop,this.diameterBottom,this.tessellation,this.subdivisions,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.height=this.height,e.diameterTop=this.diameterTop,e.diameterBottom=this.diameterBottom,e.tessellation=this.tessellation,e},r.Parse=function(t,i){if(i.getGeometryByID(t.id))return null;var n=new r(t.id,i,t.height,t.diameterTop,t.diameterBottom,t.tessellation,t.subdivisions,t.canBeRegenerated,null);return e.Tags&&e.Tags.AddTagsTo(n,t.tags),i.pushGeometry(n,!0),n},r})(r);e.CylinderGeometry=h;var u=(function(t){function r(r,i,n,s,o,a,h,u){void 0===h&&(h=null),void 0===u&&(u=e.Mesh.DEFAULTSIDE);var l=t.call(this,r,i,a,h)||this;return l.diameter=n,l.thickness=s,l.tessellation=o,l.side=u,l}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateTorus({diameter:this.diameter,thickness:this.thickness,tessellation:this.tessellation,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.diameter,this.thickness,this.tessellation,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.diameter=this.diameter,e.thickness=this.thickness,e.tessellation=this.tessellation,e},r.Parse=function(t,i){if(i.getGeometryByID(t.id))return null;var n=new r(t.id,i,t.diameter,t.thickness,t.tessellation,t.canBeRegenerated,null);return e.Tags&&e.Tags.AddTagsTo(n,t.tags),i.pushGeometry(n,!0),n},r})(r);e.TorusGeometry=u;var l=(function(t){function r(e,r,i,n,s,o,a){void 0===a&&(a=null);var h=t.call(this,e,r,o,a)||this;return h.width=i,h.height=n,h.subdivisions=s,h}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateGround({width:this.width,height:this.height,subdivisions:this.subdivisions})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.width,this.height,this.subdivisions,this.canBeRegenerated(),null)},r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.width=this.width,e.height=this.height,e.subdivisions=this.subdivisions,e},r.Parse=function(t,i){if(i.getGeometryByID(t.id))return null;var n=new r(t.id,i,t.width,t.height,t.subdivisions,t.canBeRegenerated,null);return e.Tags&&e.Tags.AddTagsTo(n,t.tags),i.pushGeometry(n,!0),n},r})(r);e.GroundGeometry=l;var c=(function(t){function r(e,r,i,n,s,o,a,h,u,l){void 0===l&&(l=null);var c=t.call(this,e,r,u,l)||this;return c.xmin=i,c.zmin=n,c.xmax=s,c.zmax=o,c.subdivisions=a,c.precision=h,c}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateTiledGround({xmin:this.xmin,zmin:this.zmin,xmax:this.xmax,zmax:this.zmax,subdivisions:this.subdivisions,precision:this.precision})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.xmin,this.zmin,this.xmax,this.zmax,this.subdivisions,this.precision,this.canBeRegenerated(),null)},r})(r);e.TiledGroundGeometry=c;var f=(function(t){function r(r,i,n,s,o,a){void 0===o&&(o=null),void 0===a&&(a=e.Mesh.DEFAULTSIDE);var h=t.call(this,r,i,s,o)||this;return h.size=n,h.side=a,h}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreatePlane({size:this.size,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.size,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.size=this.size,e},r.Parse=function(t,i){if(i.getGeometryByID(t.id))return null;var n=new r(t.id,i,t.size,t.canBeRegenerated,null);return e.Tags&&e.Tags.AddTagsTo(n,t.tags),i.pushGeometry(n,!0),n},r})(r);e.PlaneGeometry=f;var d=(function(t){function r(r,i,n,s,o,a,h,u,l,c,f){void 0===c&&(c=null),void 0===f&&(f=e.Mesh.DEFAULTSIDE);var d=t.call(this,r,i,l,c)||this;return d.radius=n,d.tube=s,d.radialSegments=o,d.tubularSegments=a,d.p=h,d.q=u,d.side=f,d}return s(r,t),r.prototype._regenerateVertexData=function(){return e.VertexData.CreateTorusKnot({radius:this.radius,tube:this.tube,radialSegments:this.radialSegments,tubularSegments:this.tubularSegments,p:this.p,q:this.q,sideOrientation:this.side})},r.prototype.copy=function(e){return new r(e,this.getScene(),this.radius,this.tube,this.radialSegments,this.tubularSegments,this.p,this.q,this.canBeRegenerated(),null,this.side)},r.prototype.serialize=function(){var e=t.prototype.serialize.call(this);return e.radius=this.radius,e.tube=this.tube,e.radialSegments=this.radialSegments,e.tubularSegments=this.tubularSegments,e.p=this.p,e.q=this.q,e},r.Parse=function(t,i){if(i.getGeometryByID(t.id))return null;var n=new r(t.id,i,t.radius,t.tube,t.radialSegments,t.tubularSegments,t.p,t.q,t.canBeRegenerated,null);return e.Tags&&e.Tags.AddTagsTo(n,t.tags),i.pushGeometry(n,!0),n},r})(r);e.TorusKnotGeometry=d})(i||(i={}));var i;!(function(e){var t=(function(){function t(e){void 0===e&&(e=30),this._enabled=!0,this._rollingFrameTime=new r(e)}return t.prototype.sampleFrame=function(t){if(void 0===t&&(t=e.Tools.Now),this._enabled){if(null!=this._lastFrameTimeMs){var r=t-this._lastFrameTimeMs;this._rollingFrameTime.add(r)}this._lastFrameTimeMs=t}},Object.defineProperty(t.prototype,"averageFrameTime",{get:function(){return this._rollingFrameTime.average},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"averageFrameTimeVariance",{get:function(){return this._rollingFrameTime.variance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instantaneousFrameTime",{get:function(){return this._rollingFrameTime.history(0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"averageFPS",{get:function(){return 1e3/this._rollingFrameTime.average},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instantaneousFPS",{get:function(){var e=this._rollingFrameTime.history(0);return 0===e?0:1e3/e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isSaturated",{get:function(){return this._rollingFrameTime.isSaturated()},enumerable:!0,configurable:!0}),t.prototype.enable=function(){this._enabled=!0},t.prototype.disable=function(){this._enabled=!1,this._lastFrameTimeMs=null},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._enabled},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()},t})();e.PerformanceMonitor=t;var r=(function(){function e(e){this._samples=new Array(e),this.reset()}return e.prototype.add=function(e){var t;if(this.isSaturated()){var r=this._samples[this._pos];t=r-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(r-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length},e.prototype.history=function(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;var t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]},e.prototype.isSaturated=function(){return this._sampleCount>=this._samples.length},e.prototype.reset=function(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0},e.prototype._wrapPosition=function(e){var t=this._samples.length;return(e%t+t)%t},e})();e.RollingAverage=r})(i||(i={}));var i;!(function(e){var t=(function(){function t(){}return t.BindEyePosition=function(e,t){if(t._forcedViewPosition)return void e.setVector3("vEyePosition",t._forcedViewPosition);e.setVector3("vEyePosition",t._mirroredCameraPosition?t._mirroredCameraPosition:t.activeCamera.globalPosition)},t.PrepareDefinesForMergedUV=function(e,t,r){t._needUVs=!0,t[r]=!0,e.getTextureMatrix().isIdentity(!0)?(t[r+"DIRECTUV"]=e.coordinatesIndex+1,0===e.coordinatesIndex?t.MAINUV1=!0:t.MAINUV2=!0):t[r+"DIRECTUV"]=0},t.BindTextureMatrix=function(e,t,r){var i=e.getTextureMatrix();i.isIdentity(!0)||t.updateMatrix(r+"Matrix",i)},t.PrepareDefinesForMisc=function(t,r,i,n,s,o,a){a._areMiscDirty&&(a.LOGARITHMICDEPTH=i,a.POINTSIZE=n,a.FOG=r.fogEnabled&&t.applyFog&&r.fogMode!==e.Scene.FOGMODE_NONE&&s,a.NONUNIFORMSCALING=t.nonUniformScaling,a.ALPHATEST=o)},t.PrepareDefinesForFrameBoundValues=function(e,t,r,i,n){void 0===n&&(n=null);var s=!1;null==n&&(n=void 0!==e.clipPlane&&null!==e.clipPlane),r.CLIPPLANE!==n&&(r.CLIPPLANE=n,s=!0),r.DEPTHPREPASS!==!t.getColorWrite()&&(r.DEPTHPREPASS=!r.DEPTHPREPASS,s=!0),r.INSTANCES!==i&&(r.INSTANCES=i,s=!0),s&&r.markAsUnprocessed()},t.PrepareDefinesForAttributes=function(t,r,i,n,s,o){if(void 0===s&&(s=!1),void 0===o&&(o=!0),!r._areAttributesDirty&&r._needNormals===r._normals&&r._needUVs===r._uvs)return!1;if(r._normals=r._needNormals,r._uvs=r._needUVs,r.NORMAL=r._needNormals&&t.isVerticesDataPresent(e.VertexBuffer.NormalKind),r._needNormals&&t.isVerticesDataPresent(e.VertexBuffer.TangentKind)&&(r.TANGENT=!0),r._needUVs?(r.UV1=t.isVerticesDataPresent(e.VertexBuffer.UVKind),r.UV2=t.isVerticesDataPresent(e.VertexBuffer.UV2Kind)):(r.UV1=!1,r.UV2=!1),i){var a=t.useVertexColors&&t.isVerticesDataPresent(e.VertexBuffer.ColorKind);r.VERTEXCOLOR=a,r.VERTEXALPHA=t.hasVertexAlpha&&a&&o}if(n&&(t.useBones&&t.computeBonesUsingShaders&&t.skeleton?(r.NUM_BONE_INFLUENCERS=t.numBoneInfluencers,r.BonesPerMesh=t.skeleton.bones.length+1):(r.NUM_BONE_INFLUENCERS=0,r.BonesPerMesh=0)),s){var h=t.morphTargetManager;h?(r.MORPHTARGETS_TANGENT=h.supportsTangents&&r.TANGENT,r.MORPHTARGETS_NORMAL=h.supportsNormals&&r.NORMAL,r.MORPHTARGETS=h.numInfluencers>0,r.NUM_MORPH_INFLUENCERS=h.numInfluencers):(r.MORPHTARGETS_TANGENT=!1,r.MORPHTARGETS_NORMAL=!1,r.MORPHTARGETS=!1,r.NUM_MORPH_INFLUENCERS=0)}return!0},t.PrepareDefinesForLights=function(t,r,i,n,s,o){if(void 0===s&&(s=4),void 0===o&&(o=!1),!i._areLightsDirty)return i._needNormals;var a=0,h=!1,u=!1,l=!1,c=!1,f=!1;if(t.lightsEnabled&&!o)for(var d=0,p=r._lightSources;d<p.length;d++){var _=p[d];h=!0,void 0===i["LIGHT"+a]&&(u=!0),i["LIGHT"+a]=!0,i["SPOTLIGHT"+a]=!1,i["HEMILIGHT"+a]=!1,i["POINTLIGHT"+a]=!1,i["DIRLIGHT"+a]=!1;var m;if(_.getTypeID()===e.Light.LIGHTTYPEID_SPOTLIGHT){m="SPOTLIGHT"+a;var g=_;i["PROJECTEDLIGHTTEXTURE"+a]=!!g.projectionTexture}else m=_.getTypeID()===e.Light.LIGHTTYPEID_HEMISPHERICLIGHT?"HEMILIGHT"+a:_.getTypeID()===e.Light.LIGHTTYPEID_POINTLIGHT?"POINTLIGHT"+a:"DIRLIGHT"+a;if(i[m]=!0,n&&!_.specular.equalsFloats(0,0,0)&&(f=!0),i["SHADOW"+a]=!1,i["SHADOWPCF"+a]=!1,i["SHADOWPCSS"+a]=!1,i["SHADOWPOISSON"+a]=!1,i["SHADOWESM"+a]=!1,i["SHADOWCUBE"+a]=!1,i["SHADOWLOWQUALITY"+a]=!1,i["SHADOWMEDIUMQUALITY"+a]=!1,r&&r.receiveShadows&&t.shadowsEnabled&&_.shadowEnabled){var v=_.getShadowGenerator();v&&(c=!0,v.prepareDefines(i,a))}if(_.lightmapMode!=e.Light.LIGHTMAP_DEFAULT?(l=!0,i["LIGHTMAPEXCLUDED"+a]=!0,i["LIGHTMAPNOSPECULAR"+a]=_.lightmapMode==e.Light.LIGHTMAP_SHADOWSONLY):(i["LIGHTMAPEXCLUDED"+a]=!1,i["LIGHTMAPNOSPECULAR"+a]=!1),++a===s)break}i.SPECULARTERM=f,i.SHADOWS=c;for(var y=a;y<s;y++)void 0!==i["LIGHT"+y]&&(i["LIGHT"+y]=!1,i["HEMILIGHT"+a]=!1,i["POINTLIGHT"+a]=!1,i["DIRLIGHT"+a]=!1,i["SPOTLIGHT"+a]=!1,i["SHADOW"+a]=!1);var b=t.getEngine().getCaps();return void 0===i.SHADOWFLOAT&&(u=!0),i.SHADOWFLOAT=c&&(b.textureFloatRender&&b.textureFloatLinearFiltering||b.textureHalfFloatRender&&b.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l,u&&i.rebuild(),h},t.PrepareUniformsAndSamplersList=function(e,t,r,i){void 0===i&&(i=4);var n,s=null;if(e.uniformsNames){var o=e;n=o.uniformsNames,s=o.uniformBuffersNames,t=o.samplers,r=o.defines,i=o.maxSimultaneousLights}else n=e,t||(t=[]);for(var a=0;a<i&&r["LIGHT"+a];a++)n.push("vLightData"+a,"vLightDiffuse"+a,"vLightSpecular"+a,"vLightDirection"+a,"vLightGround"+a,"lightMatrix"+a,"shadowsInfo"+a,"depthValues"+a),s&&s.push("Light"+a),t.push("shadowSampler"+a),t.push("depthSampler"+a),r["PROJECTEDLIGHTTEXTURE"+a]&&(t.push("projectionLightSampler"+a),n.push("textureProjectionMatrix"+a));r.NUM_MORPH_INFLUENCERS&&n.push("morphTargetInfluences")},t.HandleFallbacksForShadows=function(e,t,r,i){void 0===r&&(r=4),void 0===i&&(i=0);for(var n=0,s=0;s<r&&e["LIGHT"+s];s++)s>0&&(n=i+s,t.addFallback(n,"LIGHT"+s)),e.SHADOWS||(e["SHADOW"+s]&&t.addFallback(i,"SHADOW"+s),e["SHADOWPCF"+s]&&t.addFallback(i,"SHADOWPCF"+s),e["SHADOWPCSS"+s]&&t.addFallback(i,"SHADOWPCSS"+s),e["SHADOWPOISSON"+s]&&t.addFallback(i,"SHADOWPOISSON"+s),e["SHADOWESM"+s]&&t.addFallback(i,"SHADOWESM"+s));return n++},t.PrepareAttributesForMorphTargets=function(t,r,i){var n=i.NUM_MORPH_INFLUENCERS;if(n>0&&e.Engine.LastCreatedEngine)for(var s=e.Engine.LastCreatedEngine.getCaps().maxVertexAttribs,o=r.morphTargetManager,a=o&&o.supportsNormals&&i.NORMAL,h=o&&o.supportsTangents&&i.TANGENT,u=0;u<n;u++)t.push(e.VertexBuffer.PositionKind+u),a&&t.push(e.VertexBuffer.NormalKind+u),h&&t.push(e.VertexBuffer.TangentKind+u),t.length>s&&e.Tools.Error("Cannot add more vertex attributes for mesh "+r.name)},t.PrepareAttributesForBones=function(t,r,i,n){i.NUM_BONE_INFLUENCERS>0&&(n.addCPUSkinningFallback(0,r),t.push(e.VertexBuffer.MatricesIndicesKind),t.push(e.VertexBuffer.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(t.push(e.VertexBuffer.MatricesIndicesExtraKind),t.push(e.VertexBuffer.MatricesWeightsExtraKind)))},t.PrepareAttributesForInstances=function(e,t){t.INSTANCES&&(e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"))},t.BindLightShadow=function(e,t,r,i,n){if(e.shadowEnabled&&r.receiveShadows){var s=e.getShadowGenerator();s&&s.bindShadowLight(i,n)}},t.BindLightProperties=function(e,t,r){e.transferToEffect(t,r+"")},t.BindLights=function(r,i,n,s,o,a){void 0===o&&(o=4),void 0===a&&(a=!1);for(var h=Math.min(i._lightSources.length,o),u=0;u<h;u++){var l=i._lightSources[u],c=u.toString(),f=l.getScaledIntensity();l._uniformBuffer.bindToEffect(n,"Light"+u),t.BindLightProperties(l,n,u),l.diffuse.scaleToRef(f,e.Tmp.Color3[0]),l._uniformBuffer.updateColor4("vLightDiffuse",e.Tmp.Color3[0],a?l.radius:l.range,c),s.SPECULARTERM&&(l.specular.scaleToRef(f,e.Tmp.Color3[1]),l._uniformBuffer.updateColor3("vLightSpecular",e.Tmp.Color3[1],c)),r.shadowsEnabled&&this.BindLightShadow(l,r,i,c,n),l._uniformBuffer.update()}},t.BindFogParameters=function(t,r,i){t.fogEnabled&&r.applyFog&&t.fogMode!==e.Scene.FOGMODE_NONE&&(i.setFloat4("vFogInfos",t.fogMode,t.fogStart,t.fogEnd,t.fogDensity),i.setColor3("vFogColor",t.fogColor))},t.BindBonesParameters=function(e,t){if(t&&e&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){var r=e.skeleton.getTransformMatrices(e);r&&t.setMatrices("mBones",r)}},t.BindMorphTargetParameters=function(e,t){var r=e.morphTargetManager;e&&r&&t.setFloatArray("morphTargetInfluences",r.influences)},t.BindLogDepth=function(e,t,r){e.LOGARITHMICDEPTH&&t.setFloat("logarithmicDepthConstant",2/(Math.log(r.activeCamera.maxZ+1)/Math.LN2))},t.BindClipPlane=function(e,t){if(t.clipPlane){var r=t.clipPlane;e.setFloat4("vClipPlane",r.normal.x,r.normal.y,r.normal.z,r.d)}},t})();e.MaterialHelper=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(r,i){var n=t.call(this,r,i)||this;return n._normalMatrix=new e.Matrix,n.storeEffectOnSubMeshes=!0,n}return s(r,t),r.prototype.getEffect=function(){return this._activeEffect},r.prototype.isReady=function(e,t){return!!e&&(!e.subMeshes||0===e.subMeshes.length||this.isReadyForSubMesh(e,e.subMeshes[0],t))},r.prototype.bindOnlyWorldMatrix=function(e){this._activeEffect.setMatrix("world",e)},r.prototype.bindOnlyNormalMatrix=function(e){this._activeEffect.setMatrix("normalMatrix",e)},r.prototype.bind=function(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])},r.prototype._afterBind=function(e,r){void 0===r&&(r=null),t.prototype._afterBind.call(this,e),this.getScene()._cachedEffect=r},r.prototype._mustRebind=function(e,t,r){return void 0===r&&(r=1),e.isCachedMaterialInvalid(this,t,r)},r})(e.Material);e.PushMaterial=t})(i||(i={}));var i;!(function(e){var t=(function(e){function t(){var t=e.call(this)||this;return t.MAINUV1=!1,t.MAINUV2=!1,t.DIFFUSE=!1,t.DIFFUSEDIRECTUV=0,t.AMBIENT=!1,t.AMBIENTDIRECTUV=0,t.OPACITY=!1,t.OPACITYDIRECTUV=0,t.OPACITYRGB=!1,t.REFLECTION=!1,t.EMISSIVE=!1,t.EMISSIVEDIRECTUV=0,t.SPECULAR=!1,t.SPECULARDIRECTUV=0,t.BUMP=!1,t.BUMPDIRECTUV=0,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.SPECULAROVERALPHA=!1,t.CLIPPLANE=!1,t.ALPHATEST=!1,t.DEPTHPREPASS=!1,t.ALPHAFROMDIFFUSE=!1,t.POINTSIZE=!1,t.FOG=!1,t.SPECULARTERM=!1,t.DIFFUSEFRESNEL=!1,t.OPACITYFRESNEL=!1,t.REFLECTIONFRESNEL=!1,t.REFRACTIONFRESNEL=!1,t.EMISSIVEFRESNEL=!1,t.FRESNEL=!1,t.NORMAL=!1,t.UV1=!1,t.UV2=!1,t.VERTEXCOLOR=!1,t.VERTEXALPHA=!1,t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.INSTANCES=!1,t.GLOSSINESS=!1,t.ROUGHNESS=!1,t.EMISSIVEASILLUMINATION=!1,t.LINKEMISSIVEWITHDIFFUSE=!1,t.REFLECTIONFRESNELFROMSPECULAR=!1,t.LIGHTMAP=!1,t.LIGHTMAPDIRECTUV=0,t.OBJECTSPACE_NORMALMAP=!1,t.USELIGHTMAPASSHADOWMAP=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.LOGARITHMICDEPTH=!1,t.REFRACTION=!1,t.REFRACTIONMAP_3D=!1,t.REFLECTIONOVERALPHA=!1,t.TWOSIDEDLIGHTING=!1,t.SHADOWFLOAT=!1,t.MORPHTARGETS=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS_TANGENT=!1,t.NUM_MORPH_INFLUENCERS=0,t.NONUNIFORMSCALING=!1,t.PREMULTIPLYALPHA=!1,t.IMAGEPROCESSING=!1,t.VIGNETTE=!1,t.VIGNETTEBLENDMODEMULTIPLY=!1,t.VIGNETTEBLENDMODEOPAQUE=!1,t.TONEMAPPING=!1,t.CONTRAST=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=!1,t.SAMPLER3DBGRMAP=!1,t.IMAGEPROCESSINGPOSTPROCESS=!1,t.IS_REFLECTION_LINEAR=!1,t.IS_REFRACTION_LINEAR=!1,t.EXPOSURE=!1,t.rebuild(),t}return s(t,e),t.prototype.setReflectionMode=function(e){for(var t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"],r=0,i=t;r<i.length;r++){var n=i[r];this[n]=n===e}},t})(e.MaterialDefines);e.StandardMaterialDefines=t;var r=(function(r){function i(t,n){var s=r.call(this,t,n)||this;return s.ambientColor=new e.Color3(0,0,0),s.diffuseColor=new e.Color3(1,1,1),s.specularColor=new e.Color3(1,1,1),s.emissiveColor=new e.Color3(0,0,0),s.specularPower=64,s._useAlphaFromDiffuseTexture=!1,s._useEmissiveAsIllumination=!1,s._linkEmissiveWithDiffuse=!1,s._useSpecularOverAlpha=!1,s._useReflectionOverAlpha=!1,s._disableLighting=!1,s._useObjectSpaceNormalMap=!1,s._useParallax=!1,s._useParallaxOcclusion=!1,s.parallaxScaleBias=.05,s._roughness=0,s.indexOfRefraction=.98,s.invertRefractionY=!0,s.alphaCutOff=.4,s._useLightmapAsShadowmap=!1,s._useReflectionFresnelFromSpecular=!1,s._useGlossinessFromSpecularMapAlpha=!1,s._maxSimultaneousLights=4,s._invertNormalMapX=!1,s._invertNormalMapY=!1,s._twoSidedLighting=!1,s._renderTargets=new e.SmartArray(16),s._worldViewProjectionMatrix=e.Matrix.Zero(),s._globalAmbientColor=new e.Color3(0,0,0),s._attachImageProcessingConfiguration(null),s.getRenderTargetTextures=function(){return s._renderTargets.reset(),i.ReflectionTextureEnabled&&s._reflectionTexture&&s._reflectionTexture.isRenderTarget&&s._renderTargets.push(s._reflectionTexture),i.RefractionTextureEnabled&&s._refractionTexture&&s._refractionTexture.isRenderTarget&&s._renderTargets.push(s._refractionTexture),s._renderTargets},s}return s(i,r),Object.defineProperty(i.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!0,configurable:!0}),i.prototype._attachImageProcessingConfiguration=function(e){var t=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((function(e){t._markAllSubMeshesAsImageProcessingDirty()}))))},Object.defineProperty(i.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e},enumerable:!0,configurable:!0}),i.prototype.getClassName=function(){return"StandardMaterial"},Object.defineProperty(i.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()},enumerable:!0,configurable:!0}),i.prototype.needAlphaBlending=function(){
return this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled},i.prototype.needAlphaTesting=function(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha},i.prototype._shouldUseAlphaFromDiffuseTexture=function(){return null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture},i.prototype.getAlphaTestTexture=function(){return this._diffuseTexture},i.prototype.isReadyForSubMesh=function(r,n,s){if(void 0===s&&(s=!1),n.effect&&this.isFrozen&&this._wasPreviouslyReady&&n.effect)return!0;n._materialDefines||(n._materialDefines=new t);var o=this.getScene(),a=n._materialDefines;if(!this.checkReadyOnEveryCall&&n.effect&&a._renderId===o.getRenderId())return!0;var h=o.getEngine();if(a._needNormals=e.MaterialHelper.PrepareDefinesForLights(o,r,a,!0,this._maxSimultaneousLights,this._disableLighting),a._areTexturesDirty){if(a._needUVs=!1,a.MAINUV1=!1,a.MAINUV2=!1,o.texturesEnabled){if(this._diffuseTexture&&i.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;e.MaterialHelper.PrepareDefinesForMergedUV(this._diffuseTexture,a,"DIFFUSE")}else a.DIFFUSE=!1;if(this._ambientTexture&&i.AmbientTextureEnabled){if(!this._ambientTexture.isReadyOrNotBlocking())return!1;e.MaterialHelper.PrepareDefinesForMergedUV(this._ambientTexture,a,"AMBIENT")}else a.AMBIENT=!1;if(this._opacityTexture&&i.OpacityTextureEnabled){if(!this._opacityTexture.isReadyOrNotBlocking())return!1;e.MaterialHelper.PrepareDefinesForMergedUV(this._opacityTexture,a,"OPACITY"),a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB}else a.OPACITY=!1;if(this._reflectionTexture&&i.ReflectionTextureEnabled){if(!this._reflectionTexture.isReadyOrNotBlocking())return!1;switch(a._needNormals=!0,a.REFLECTION=!0,a.ROUGHNESS=this._roughness>0,a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===e.Texture.INVCUBIC_MODE,a.REFLECTIONMAP_3D=this._reflectionTexture.isCube,this._reflectionTexture.coordinatesMode){case e.Texture.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case e.Texture.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case e.Texture.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case e.Texture.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case e.Texture.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case e.Texture.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case e.Texture.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case e.Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case e.Texture.CUBIC_MODE:case e.Texture.INVCUBIC_MODE:default:a.setReflectionMode("REFLECTIONMAP_CUBIC")}a.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else a.REFLECTION=!1;if(this._emissiveTexture&&i.EmissiveTextureEnabled){if(!this._emissiveTexture.isReadyOrNotBlocking())return!1;e.MaterialHelper.PrepareDefinesForMergedUV(this._emissiveTexture,a,"EMISSIVE")}else a.EMISSIVE=!1;if(this._lightmapTexture&&i.LightmapTextureEnabled){if(!this._lightmapTexture.isReadyOrNotBlocking())return!1;e.MaterialHelper.PrepareDefinesForMergedUV(this._lightmapTexture,a,"LIGHTMAP"),a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap}else a.LIGHTMAP=!1;if(this._specularTexture&&i.SpecularTextureEnabled){if(!this._specularTexture.isReadyOrNotBlocking())return!1;e.MaterialHelper.PrepareDefinesForMergedUV(this._specularTexture,a,"SPECULAR"),a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha}else a.SPECULAR=!1;if(o.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&i.BumpTextureEnabled){if(!this._bumpTexture.isReady())return!1;e.MaterialHelper.PrepareDefinesForMergedUV(this._bumpTexture,a,"BUMP"),a.PARALLAX=this._useParallax,a.PARALLAXOCCLUSION=this._useParallaxOcclusion,a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else a.BUMP=!1;if(this._refractionTexture&&i.RefractionTextureEnabled){if(!this._refractionTexture.isReadyOrNotBlocking())return!1;a._needUVs=!0,a.REFRACTION=!0,a.REFRACTIONMAP_3D=this._refractionTexture.isCube}else a.REFRACTION=!1;a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else a.DIFFUSE=!1,a.AMBIENT=!1,a.OPACITY=!1,a.REFLECTION=!1,a.EMISSIVE=!1,a.LIGHTMAP=!1,a.BUMP=!1,a.REFRACTION=!1;a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,a.SPECULAROVERALPHA=this._useSpecularOverAlpha,a.PREMULTIPLYALPHA=this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED||this.alphaMode===e.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF}if(a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a),a.IS_REFLECTION_LINEAR=null!=this.reflectionTexture&&!this.reflectionTexture.gammaSpace,a.IS_REFRACTION_LINEAR=null!=this.refractionTexture&&!this.refractionTexture.gammaSpace}if(a._areFresnelDirty&&(i.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,a._needNormals=!0,a.FRESNEL=!0):a.FRESNEL=!1),e.MaterialHelper.PrepareDefinesForMisc(r,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(r),a),e.MaterialHelper.PrepareDefinesForAttributes(r,a,!0,!0,!0),e.MaterialHelper.PrepareDefinesForFrameBoundValues(o,h,a,s),a.isDirty){a.markAsProcessed(),o.resetCachedMaterial();var u=new e.EffectFallbacks;a.REFLECTION&&u.addFallback(0,"REFLECTION"),a.SPECULAR&&u.addFallback(0,"SPECULAR"),a.BUMP&&u.addFallback(0,"BUMP"),a.PARALLAX&&u.addFallback(1,"PARALLAX"),a.PARALLAXOCCLUSION&&u.addFallback(0,"PARALLAXOCCLUSION"),a.SPECULAROVERALPHA&&u.addFallback(0,"SPECULAROVERALPHA"),a.FOG&&u.addFallback(1,"FOG"),a.POINTSIZE&&u.addFallback(0,"POINTSIZE"),a.LOGARITHMICDEPTH&&u.addFallback(0,"LOGARITHMICDEPTH"),e.MaterialHelper.HandleFallbacksForShadows(a,u,this._maxSimultaneousLights),a.SPECULARTERM&&u.addFallback(0,"SPECULARTERM"),a.DIFFUSEFRESNEL&&u.addFallback(1,"DIFFUSEFRESNEL"),a.OPACITYFRESNEL&&u.addFallback(2,"OPACITYFRESNEL"),a.REFLECTIONFRESNEL&&u.addFallback(3,"REFLECTIONFRESNEL"),a.EMISSIVEFRESNEL&&u.addFallback(4,"EMISSIVEFRESNEL"),a.FRESNEL&&u.addFallback(4,"FRESNEL");var l=[e.VertexBuffer.PositionKind];a.NORMAL&&l.push(e.VertexBuffer.NormalKind),a.UV1&&l.push(e.VertexBuffer.UVKind),a.UV2&&l.push(e.VertexBuffer.UV2Kind),a.VERTEXCOLOR&&l.push(e.VertexBuffer.ColorKind),e.MaterialHelper.PrepareAttributesForBones(l,r,a,u),e.MaterialHelper.PrepareAttributesForInstances(l,a),e.MaterialHelper.PrepareAttributesForMorphTargets(l,r,a);var c="default",f=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff"],d=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler"],p=["Material","Scene"];e.ImageProcessingConfiguration&&(e.ImageProcessingConfiguration.PrepareUniforms(f,a),e.ImageProcessingConfiguration.PrepareSamplers(d,a)),e.MaterialHelper.PrepareUniformsAndSamplersList({uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:a,maxSimultaneousLights:this._maxSimultaneousLights}),this.customShaderNameResolve&&(c=this.customShaderNameResolve(c,f,p,d,a));var _=a.toString();n.setEffect(o.getEngine().createEffect(c,{attributes:l,uniformsNames:f,uniformBuffersNames:p,samplers:d,defines:_,fallbacks:u,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS}},h),a),this.buildUniformLayout()}return!(!n.effect||!n.effect.isReady())&&(a._renderId=o.getRenderId(),this._wasPreviouslyReady=!0,!0)},i.prototype.buildUniformLayout=function(){this._uniformBuffer.addUniform("diffuseLeftColor",4),this._uniformBuffer.addUniform("diffuseRightColor",4),this._uniformBuffer.addUniform("opacityParts",4),this._uniformBuffer.addUniform("reflectionLeftColor",4),this._uniformBuffer.addUniform("reflectionRightColor",4),this._uniformBuffer.addUniform("refractionLeftColor",4),this._uniformBuffer.addUniform("refractionRightColor",4),this._uniformBuffer.addUniform("emissiveLeftColor",4),this._uniformBuffer.addUniform("emissiveRightColor",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vAmbientInfos",2),this._uniformBuffer.addUniform("vOpacityInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("vReflectionPosition",3),this._uniformBuffer.addUniform("vReflectionSize",3),this._uniformBuffer.addUniform("vEmissiveInfos",2),this._uniformBuffer.addUniform("vLightmapInfos",2),this._uniformBuffer.addUniform("vSpecularInfos",2),this._uniformBuffer.addUniform("vBumpInfos",3),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("ambientMatrix",16),this._uniformBuffer.addUniform("opacityMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("emissiveMatrix",16),this._uniformBuffer.addUniform("lightmapMatrix",16),this._uniformBuffer.addUniform("specularMatrix",16),this._uniformBuffer.addUniform("bumpMatrix",16),this._uniformBuffer.addUniform("vTangentSpaceParams",2),this._uniformBuffer.addUniform("refractionMatrix",16),this._uniformBuffer.addUniform("vRefractionInfos",4),this._uniformBuffer.addUniform("vSpecularColor",4),this._uniformBuffer.addUniform("vEmissiveColor",3),this._uniformBuffer.addUniform("vDiffuseColor",4),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.create()},i.prototype.unbind=function(){if(this._activeEffect){var e=!1;this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&(this._activeEffect.setTexture("reflection2DSampler",null),e=!0),this._refractionTexture&&this._refractionTexture.isRenderTarget&&(this._activeEffect.setTexture("refraction2DSampler",null),e=!0),e&&this._markAllSubMeshesAsTexturesDirty()}r.prototype.unbind.call(this)},i.prototype.bindForSubMesh=function(t,r,n){var s=this.getScene(),o=n._materialDefines;if(o){var a=n.effect;if(a){this._activeEffect=a,this.bindOnlyWorldMatrix(t),o.OBJECTSPACE_NORMALMAP&&(t.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var h=this._mustRebind(s,a,r.visibility);if(e.MaterialHelper.BindBonesParameters(r,a),h){if(this._uniformBuffer.bindToEffect(a,"Material"),this.bindViewProjection(a),!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync){if(i.FresnelEnabled&&o.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),this._uniformBuffer.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&this._uniformBuffer.updateColor4("opacityParts",new e.Color3(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),this._uniformBuffer.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),this._uniformBuffer.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(this._uniformBuffer.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),this._uniformBuffer.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),s.texturesEnabled){if(this._diffuseTexture&&i.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),e.MaterialHelper.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse"),this._diffuseTexture.hasAlpha&&a.setFloat("alphaCutOff",this.alphaCutOff)),this._ambientTexture&&i.AmbientTextureEnabled&&(this._uniformBuffer.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),e.MaterialHelper.BindTextureMatrix(this._ambientTexture,this._uniformBuffer,"ambient")),this._opacityTexture&&i.OpacityTextureEnabled&&(this._uniformBuffer.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),e.MaterialHelper.BindTextureMatrix(this._opacityTexture,this._uniformBuffer,"opacity")),this._reflectionTexture&&i.ReflectionTextureEnabled&&(this._uniformBuffer.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),this._uniformBuffer.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){var u=this._reflectionTexture;this._uniformBuffer.updateVector3("vReflectionPosition",u.boundingBoxPosition),this._uniformBuffer.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this._emissiveTexture&&i.EmissiveTextureEnabled&&(this._uniformBuffer.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),e.MaterialHelper.BindTextureMatrix(this._emissiveTexture,this._uniformBuffer,"emissive")),this._lightmapTexture&&i.LightmapTextureEnabled&&(this._uniformBuffer.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),e.MaterialHelper.BindTextureMatrix(this._lightmapTexture,this._uniformBuffer,"lightmap")),this._specularTexture&&i.SpecularTextureEnabled&&(this._uniformBuffer.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),e.MaterialHelper.BindTextureMatrix(this._specularTexture,this._uniformBuffer,"specular")),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&i.BumpTextureEnabled&&(this._uniformBuffer.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),e.MaterialHelper.BindTextureMatrix(this._bumpTexture,this._uniformBuffer,"bump"),s._mirroredCameraPosition?this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):this._uniformBuffer.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&i.RefractionTextureEnabled){var l=1;this._refractionTexture.isCube||(this._uniformBuffer.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(l=this._refractionTexture.depth)),this._uniformBuffer.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,l,this.invertRefractionY?-1:1)}}this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),o.SPECULARTERM&&this._uniformBuffer.updateColor4("vSpecularColor",this.specularColor,this.specularPower),this._uniformBuffer.updateColor3("vEmissiveColor",this.emissiveColor),this._uniformBuffer.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha*r.visibility)}if(s.texturesEnabled&&(this._diffuseTexture&&i.DiffuseTextureEnabled&&a.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&i.AmbientTextureEnabled&&a.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&i.OpacityTextureEnabled&&a.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&i.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?a.setTexture("reflectionCubeSampler",this._reflectionTexture):a.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&i.EmissiveTextureEnabled&&a.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&i.LightmapTextureEnabled&&a.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&i.SpecularTextureEnabled&&a.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&s.getEngine().getCaps().standardDerivatives&&i.BumpTextureEnabled&&a.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&i.RefractionTextureEnabled)){var l=1;this._refractionTexture.isCube?a.setTexture("refractionCubeSampler",this._refractionTexture):a.setTexture("refraction2DSampler",this._refractionTexture)}e.MaterialHelper.BindClipPlane(a,s),s.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),e.MaterialHelper.BindEyePosition(a,s),a.setColor3("vAmbientColor",this._globalAmbientColor)}!h&&this.isFrozen||(s.lightsEnabled&&!this._disableLighting&&e.MaterialHelper.BindLights(s,r,a,o,this._maxSimultaneousLights),(s.fogEnabled&&r.applyFog&&s.fogMode!==e.Scene.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture)&&this.bindView(a),e.MaterialHelper.BindFogParameters(s,r,a),o.NUM_MORPH_INFLUENCERS&&e.MaterialHelper.BindMorphTargetParameters(r,a),e.MaterialHelper.BindLogDepth(o,a,s),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._uniformBuffer.update(),this._afterBind(r,this._activeEffect)}}},i.prototype.getAnimatables=function(){var e=[];return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e},i.prototype.getActiveTextures=function(){var e=r.prototype.getActiveTextures.call(this);return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e},i.prototype.hasTexture=function(e){return!!r.prototype.hasTexture.call(this,e)||(this._diffuseTexture===e||(this._ambientTexture===e||(this._opacityTexture===e||(this._reflectionTexture===e||(this._emissiveTexture===e||(this._specularTexture===e||(this._bumpTexture===e||(this._lightmapTexture===e||this._refractionTexture===e))))))))},i.prototype.dispose=function(e,t){t&&(this._diffuseTexture&&this._diffuseTexture.dispose(),this._ambientTexture&&this._ambientTexture.dispose(),this._opacityTexture&&this._opacityTexture.dispose(),this._reflectionTexture&&this._reflectionTexture.dispose(),this._emissiveTexture&&this._emissiveTexture.dispose(),this._specularTexture&&this._specularTexture.dispose(),this._bumpTexture&&this._bumpTexture.dispose(),this._lightmapTexture&&this._lightmapTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),r.prototype.dispose.call(this,e,t)},i.prototype.clone=function(t){var r=this,n=e.SerializationHelper.Clone((function(){return new i(t,r.getScene())}),this);return n.name=t,n.id=t,n},i.prototype.serialize=function(){return e.SerializationHelper.Serialize(this)},i.Parse=function(t,r,n){return e.SerializationHelper.Parse((function(){return new i(t.name,r)}),t,r,n)},Object.defineProperty(i,"DiffuseTextureEnabled",{get:function(){return i._DiffuseTextureEnabled},set:function(t){i._DiffuseTextureEnabled!==t&&(i._DiffuseTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"AmbientTextureEnabled",{get:function(){return i._AmbientTextureEnabled},set:function(t){i._AmbientTextureEnabled!==t&&(i._AmbientTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"OpacityTextureEnabled",{get:function(){return i._OpacityTextureEnabled},set:function(t){i._OpacityTextureEnabled!==t&&(i._OpacityTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ReflectionTextureEnabled",{get:function(){return i._ReflectionTextureEnabled},set:function(t){i._ReflectionTextureEnabled!==t&&(i._ReflectionTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"EmissiveTextureEnabled",{get:function(){return i._EmissiveTextureEnabled},set:function(t){i._EmissiveTextureEnabled!==t&&(i._EmissiveTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"SpecularTextureEnabled",{get:function(){return i._SpecularTextureEnabled},set:function(t){i._SpecularTextureEnabled!==t&&(i._SpecularTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"BumpTextureEnabled",{get:function(){return i._BumpTextureEnabled},set:function(t){i._BumpTextureEnabled!==t&&(i._BumpTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"LightmapTextureEnabled",{get:function(){return i._LightmapTextureEnabled},set:function(t){i._LightmapTextureEnabled!==t&&(i._LightmapTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"RefractionTextureEnabled",{get:function(){return i._RefractionTextureEnabled},set:function(t){i._RefractionTextureEnabled!==t&&(i._RefractionTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"ColorGradingTextureEnabled",{get:function(){return i._ColorGradingTextureEnabled},set:function(t){i._ColorGradingTextureEnabled!==t&&(i._ColorGradingTextureEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.TextureDirtyFlag))},enumerable:!0,configurable:!0}),Object.defineProperty(i,"FresnelEnabled",{get:function(){return i._FresnelEnabled},set:function(t){i._FresnelEnabled!==t&&(i._FresnelEnabled=t,e.Engine.MarkAllMaterialsAsDirty(e.Material.FresnelDirtyFlag))},enumerable:!0,configurable:!0}),i._DiffuseTextureEnabled=!0,i._AmbientTextureEnabled=!0,i._OpacityTextureEnabled=!0,i._ReflectionTextureEnabled=!0,i._EmissiveTextureEnabled=!0,i._SpecularTextureEnabled=!0,i._BumpTextureEnabled=!0,i._LightmapTextureEnabled=!0,i._RefractionTextureEnabled=!0,i._ColorGradingTextureEnabled=!0,i._FresnelEnabled=!0,n([e.serializeAsTexture("diffuseTexture")],i.prototype,"_diffuseTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],i.prototype,"diffuseTexture",void 0),n([e.serializeAsTexture("ambientTexture")],i.prototype,"_ambientTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"ambientTexture",void 0),n([e.serializeAsTexture("opacityTexture")],i.prototype,"_opacityTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesAndMiscDirty")],i.prototype,"opacityTexture",void 0),n([e.serializeAsTexture("reflectionTexture")],i.prototype,"_reflectionTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"reflectionTexture",void 0),n([e.serializeAsTexture("emissiveTexture")],i.prototype,"_emissiveTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"emissiveTexture",void 0),n([e.serializeAsTexture("specularTexture")],i.prototype,"_specularTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"specularTexture",void 0),n([e.serializeAsTexture("bumpTexture")],i.prototype,"_bumpTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"bumpTexture",void 0),n([e.serializeAsTexture("lightmapTexture")],i.prototype,"_lightmapTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"lightmapTexture",void 0),n([e.serializeAsTexture("refractionTexture")],i.prototype,"_refractionTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"refractionTexture",void 0),n([e.serializeAsColor3("ambient")],i.prototype,"ambientColor",void 0),n([e.serializeAsColor3("diffuse")],i.prototype,"diffuseColor",void 0),n([e.serializeAsColor3("specular")],i.prototype,"specularColor",void 0),n([e.serializeAsColor3("emissive")],i.prototype,"emissiveColor",void 0),n([e.serialize()],i.prototype,"specularPower",void 0),n([e.serialize("useAlphaFromDiffuseTexture")],i.prototype,"_useAlphaFromDiffuseTexture",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useAlphaFromDiffuseTexture",void 0),n([e.serialize("useEmissiveAsIllumination")],i.prototype,"_useEmissiveAsIllumination",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useEmissiveAsIllumination",void 0),n([e.serialize("linkEmissiveWithDiffuse")],i.prototype,"_linkEmissiveWithDiffuse",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"linkEmissiveWithDiffuse",void 0),n([e.serialize("useSpecularOverAlpha")],i.prototype,"_useSpecularOverAlpha",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useSpecularOverAlpha",void 0),n([e.serialize("useReflectionOverAlpha")],i.prototype,"_useReflectionOverAlpha",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useReflectionOverAlpha",void 0),n([e.serialize("disableLighting")],i.prototype,"_disableLighting",void 0),n([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],i.prototype,"disableLighting",void 0),n([e.serialize("useObjectSpaceNormalMap")],i.prototype,"_useObjectSpaceNormalMap",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useObjectSpaceNormalMap",void 0),n([e.serialize("useParallax")],i.prototype,"_useParallax",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useParallax",void 0),n([e.serialize("useParallaxOcclusion")],i.prototype,"_useParallaxOcclusion",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useParallaxOcclusion",void 0),n([e.serialize()],i.prototype,"parallaxScaleBias",void 0),n([e.serialize("roughness")],i.prototype,"_roughness",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"roughness",void 0),n([e.serialize()],i.prototype,"indexOfRefraction",void 0),n([e.serialize()],i.prototype,"invertRefractionY",void 0),n([e.serialize()],i.prototype,"alphaCutOff",void 0),n([e.serialize("useLightmapAsShadowmap")],i.prototype,"_useLightmapAsShadowmap",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useLightmapAsShadowmap",void 0),n([e.serializeAsFresnelParameters("diffuseFresnelParameters")],i.prototype,"_diffuseFresnelParameters",void 0),n([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],i.prototype,"diffuseFresnelParameters",void 0),n([e.serializeAsFresnelParameters("opacityFresnelParameters")],i.prototype,"_opacityFresnelParameters",void 0),n([e.expandToProperty("_markAllSubMeshesAsFresnelAndMiscDirty")],i.prototype,"opacityFresnelParameters",void 0),n([e.serializeAsFresnelParameters("reflectionFresnelParameters")],i.prototype,"_reflectionFresnelParameters",void 0),n([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],i.prototype,"reflectionFresnelParameters",void 0),n([e.serializeAsFresnelParameters("refractionFresnelParameters")],i.prototype,"_refractionFresnelParameters",void 0),n([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],i.prototype,"refractionFresnelParameters",void 0),n([e.serializeAsFresnelParameters("emissiveFresnelParameters")],i.prototype,"_emissiveFresnelParameters",void 0),n([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],i.prototype,"emissiveFresnelParameters",void 0),n([e.serialize("useReflectionFresnelFromSpecular")],i.prototype,"_useReflectionFresnelFromSpecular",void 0),n([e.expandToProperty("_markAllSubMeshesAsFresnelDirty")],i.prototype,"useReflectionFresnelFromSpecular",void 0),n([e.serialize("useGlossinessFromSpecularMapAlpha")],i.prototype,"_useGlossinessFromSpecularMapAlpha",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"useGlossinessFromSpecularMapAlpha",void 0),n([e.serialize("maxSimultaneousLights")],i.prototype,"_maxSimultaneousLights",void 0),n([e.expandToProperty("_markAllSubMeshesAsLightsDirty")],i.prototype,"maxSimultaneousLights",void 0),n([e.serialize("invertNormalMapX")],i.prototype,"_invertNormalMapX",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"invertNormalMapX",void 0),n([e.serialize("invertNormalMapY")],i.prototype,"_invertNormalMapY",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"invertNormalMapY",void 0),
n([e.serialize("twoSidedLighting")],i.prototype,"_twoSidedLighting",void 0),n([e.expandToProperty("_markAllSubMeshesAsTexturesDirty")],i.prototype,"twoSidedLighting",void 0),n([e.serialize()],i.prototype,"useLogarithmicDepth",null),i})(e.PushMaterial);e.StandardMaterial=r})(i||(i={}));var i;!(function(e){var t=(function(t){function r(r,i,n,s){var o=t.call(this,r,i)||this;return o._textures={},o._textureArrays={},o._floats={},o._ints={},o._floatsArrays={},o._colors3={},o._colors3Arrays={},o._colors4={},o._vectors2={},o._vectors3={},o._vectors4={},o._matrices={},o._matrices3x3={},o._matrices2x2={},o._vectors2Arrays={},o._vectors3Arrays={},o._cachedWorldViewMatrix=new e.Matrix,o._shaderPath=n,s.needAlphaBlending=s.needAlphaBlending||!1,s.needAlphaTesting=s.needAlphaTesting||!1,s.attributes=s.attributes||["position","normal","uv"],s.uniforms=s.uniforms||["worldViewProjection"],s.uniformBuffers=s.uniformBuffers||[],s.samplers=s.samplers||[],s.defines=s.defines||[],o._options=s,o}return s(r,t),r.prototype.getClassName=function(){return"ShaderMaterial"},r.prototype.needAlphaBlending=function(){return this._options.needAlphaBlending},r.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},r.prototype._checkUniform=function(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)},r.prototype.setTexture=function(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=t,this},r.prototype.setTextureArray=function(e,t){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this},r.prototype.setFloat=function(e,t){return this._checkUniform(e),this._floats[e]=t,this},r.prototype.setInt=function(e,t){return this._checkUniform(e),this._ints[e]=t,this},r.prototype.setFloats=function(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this},r.prototype.setColor3=function(e,t){return this._checkUniform(e),this._colors3[e]=t,this},r.prototype.setColor3Array=function(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((function(e,t){return t.toArray(e,e.length),e}),[]),this},r.prototype.setColor4=function(e,t){return this._checkUniform(e),this._colors4[e]=t,this},r.prototype.setVector2=function(e,t){return this._checkUniform(e),this._vectors2[e]=t,this},r.prototype.setVector3=function(e,t){return this._checkUniform(e),this._vectors3[e]=t,this},r.prototype.setVector4=function(e,t){return this._checkUniform(e),this._vectors4[e]=t,this},r.prototype.setMatrix=function(e,t){return this._checkUniform(e),this._matrices[e]=t,this},r.prototype.setMatrix3x3=function(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this},r.prototype.setMatrix2x2=function(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this},r.prototype.setArray2=function(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this},r.prototype.setArray3=function(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this},r.prototype._checkCache=function(e,t,r){return!t||(this._effect&&this._effect.defines.indexOf("#define INSTANCES"),!1)},r.prototype.isReady=function(t,r){var i=this.getScene(),n=i.getEngine();if(!this.checkReadyOnEveryCall&&this._renderId===i.getRenderId()&&this._checkCache(i,t,r))return!0;var s=[],o=[],a=new e.EffectFallbacks;r&&s.push("#define INSTANCES");for(var h=0;h<this._options.defines.length;h++)s.push(this._options.defines[h]);for(var h=0;h<this._options.attributes.length;h++)o.push(this._options.attributes[h]);t&&t.isVerticesDataPresent(e.VertexBuffer.ColorKind)&&(o.push(e.VertexBuffer.ColorKind),s.push("#define VERTEXCOLOR")),t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton?(o.push(e.VertexBuffer.MatricesIndicesKind),o.push(e.VertexBuffer.MatricesWeightsKind),t.numBoneInfluencers>4&&(o.push(e.VertexBuffer.MatricesIndicesExtraKind),o.push(e.VertexBuffer.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+t.numBoneInfluencers),s.push("#define BonesPerMesh "+(t.skeleton.bones.length+1)),a.addCPUSkinningFallback(0,t),-1===this._options.uniforms.indexOf("mBones")&&this._options.uniforms.push("mBones")):s.push("#define NUM_BONE_INFLUENCERS 0");for(var u in this._textures)if(!this._textures[u].isReady())return!1;t&&this._shouldTurnAlphaTestOn(t)&&s.push("#define ALPHATEST");var l=this._effect,c=s.join("\n");return this._effect=n.createEffect(this._shaderPath,{attributes:o,uniformsNames:this._options.uniforms,uniformBuffersNames:this._options.uniformBuffers,samplers:this._options.samplers,defines:c,fallbacks:a,onCompiled:this.onCompiled,onError:this.onError},n),!!this._effect.isReady()&&(l!==this._effect&&i.resetCachedMaterial(),this._renderId=i.getRenderId(),!0)},r.prototype.bindOnlyWorldMatrix=function(e){var t=this.getScene();this._effect&&(-1!==this._options.uniforms.indexOf("world")&&this._effect.setMatrix("world",e),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),this._effect.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("worldViewProjection")&&this._effect.setMatrix("worldViewProjection",e.multiply(t.getTransformMatrix())))},r.prototype.bind=function(t,r){if(this.bindOnlyWorldMatrix(t),this._effect&&this.getScene().getCachedMaterial()!==this){-1!==this._options.uniforms.indexOf("view")&&this._effect.setMatrix("view",this.getScene().getViewMatrix()),-1!==this._options.uniforms.indexOf("projection")&&this._effect.setMatrix("projection",this.getScene().getProjectionMatrix()),-1!==this._options.uniforms.indexOf("viewProjection")&&this._effect.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.MaterialHelper.BindBonesParameters(r,this._effect);var i;for(i in this._textures)this._effect.setTexture(i,this._textures[i]);for(i in this._textureArrays)this._effect.setTextureArray(i,this._textureArrays[i]);for(i in this._ints)this._effect.setInt(i,this._ints[i]);for(i in this._floats)this._effect.setFloat(i,this._floats[i]);for(i in this._floatsArrays)this._effect.setArray(i,this._floatsArrays[i]);for(i in this._colors3)this._effect.setColor3(i,this._colors3[i]);for(i in this._colors3Arrays)this._effect.setArray3(i,this._colors3Arrays[i]);for(i in this._colors4){var n=this._colors4[i];this._effect.setFloat4(i,n.r,n.g,n.b,n.a)}for(i in this._vectors2)this._effect.setVector2(i,this._vectors2[i]);for(i in this._vectors3)this._effect.setVector3(i,this._vectors3[i]);for(i in this._vectors4)this._effect.setVector4(i,this._vectors4[i]);for(i in this._matrices)this._effect.setMatrix(i,this._matrices[i]);for(i in this._matrices3x3)this._effect.setMatrix3x3(i,this._matrices3x3[i]);for(i in this._matrices2x2)this._effect.setMatrix2x2(i,this._matrices2x2[i]);for(i in this._vectors2Arrays)this._effect.setArray2(i,this._vectors2Arrays[i]);for(i in this._vectors3Arrays)this._effect.setArray3(i,this._vectors3Arrays[i])}this._afterBind(r)},r.prototype.getActiveTextures=function(){var e=t.prototype.getActiveTextures.call(this);for(var r in this._textures)e.push(this._textures[r]);for(var r in this._textureArrays)for(var i=this._textureArrays[r],n=0;n<i.length;n++)e.push(i[n]);return e},r.prototype.hasTexture=function(e){if(t.prototype.hasTexture.call(this,e))return!0;for(var r in this._textures)if(this._textures[r]===e)return!0;for(var r in this._textureArrays)for(var i=this._textureArrays[r],n=0;n<i.length;n++)if(i[n]===e)return!0;return!1},r.prototype.clone=function(e){return new r(e,this.getScene(),this._shaderPath,this._options)},r.prototype.dispose=function(e,r){if(r){var i;for(i in this._textures)this._textures[i].dispose();for(i in this._textureArrays)for(var n=this._textureArrays[i],s=0;s<n.length;s++)n[s].dispose()}this._textures={},t.prototype.dispose.call(this,e,r)},r.prototype.serialize=function(){var t=e.SerializationHelper.Serialize(this);t.customType="BABYLON.ShaderMaterial",t.options=this._options,t.shaderPath=this._shaderPath;var r;t.textures={};for(r in this._textures)t.textures[r]=this._textures[r].serialize();t.textureArrays={};for(r in this._textureArrays){t.textureArrays[r]=[];for(var i=this._textureArrays[r],n=0;n<i.length;n++)t.textureArrays[r].push(i[n].serialize())}t.floats={};for(r in this._floats)t.floats[r]=this._floats[r];t.FloatArrays={};for(r in this._floatsArrays)t.FloatArrays[r]=this._floatsArrays[r];t.colors3={};for(r in this._colors3)t.colors3[r]=this._colors3[r].asArray();t.colors3Arrays={};for(r in this._colors3Arrays)t.colors3Arrays[r]=this._colors3Arrays[r];t.colors4={};for(r in this._colors4)t.colors4[r]=this._colors4[r].asArray();t.vectors2={};for(r in this._vectors2)t.vectors2[r]=this._vectors2[r].asArray();t.vectors3={};for(r in this._vectors3)t.vectors3[r]=this._vectors3[r].asArray();t.vectors4={};for(r in this._vectors4)t.vectors4[r]=this._vectors4[r].asArray();t.matrices={};for(r in this._matrices)t.matrices[r]=this._matrices[r].asArray();t.matrices3x3={};for(r in this._matrices3x3)t.matrices3x3[r]=this._matrices3x3[r];t.matrices2x2={};for(r in this._matrices2x2)t.matrices2x2[r]=this._matrices2x2[r];t.vectors2Arrays={};for(r in this._vectors2Arrays)t.vectors2Arrays[r]=this._vectors2Arrays[r];t.vectors3Arrays={};for(r in this._vectors3Arrays)t.vectors3Arrays[r]=this._vectors3Arrays[r];return t},r.Parse=function(t,i,n){var s,o=e.SerializationHelper.Parse((function(){return new r(t.name,i,t.shaderPath,t.options)}),t,i,n);for(s in t.textures)o.setTexture(s,e.Texture.Parse(t.textures[s],i,n));for(s in t.textureArrays){for(var a=t.textureArrays[s],h=new Array,u=0;u<a.length;u++)h.push(e.Texture.Parse(a[u],i,n));o.setTextureArray(s,h)}for(s in t.floats)o.setFloat(s,t.floats[s]);for(s in t.floatsArrays)o.setFloats(s,t.floatsArrays[s]);for(s in t.colors3)o.setColor3(s,e.Color3.FromArray(t.colors3[s]));for(s in t.colors3Arrays){var l=t.colors3Arrays[s].reduce((function(e,t,r){return r%3==0?e.push([t]):e[e.length-1].push(t),e}),[]).map((function(t){return e.Color3.FromArray(t)}));o.setColor3Array(s,l)}for(s in t.colors4)o.setColor4(s,e.Color4.FromArray(t.colors4[s]));for(s in t.vectors2)o.setVector2(s,e.Vector2.FromArray(t.vectors2[s]));for(s in t.vectors3)o.setVector3(s,e.Vector3.FromArray(t.vectors3[s]));for(s in t.vectors4)o.setVector4(s,e.Vector4.FromArray(t.vectors4[s]));for(s in t.matrices)o.setMatrix(s,e.Matrix.FromArray(t.matrices[s]));for(s in t.matrices3x3)o.setMatrix3x3(s,t.matrices3x3[s]);for(s in t.matrices2x2)o.setMatrix2x2(s,t.matrices2x2[s]);for(s in t.vectors2Arrays)o.setArray2(s,t.vectors2Arrays[s]);for(s in t.vectors3Arrays)o.setArray3(s,t.vectors3Arrays[s]);return o},r})(e.Material);e.ShaderMaterial=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(e,r){var i=t.call(this,e,r)||this;return i.generateOctree=!1,i}return s(r,t),r.prototype.getClassName=function(){return"GroundMesh"},Object.defineProperty(r.prototype,"subdivisions",{get:function(){return Math.min(this._subdivisionsX,this._subdivisionsY)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"subdivisionsX",{get:function(){return this._subdivisionsX},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"subdivisionsY",{get:function(){return this._subdivisionsY},enumerable:!0,configurable:!0}),r.prototype.optimize=function(e,t){void 0===t&&(t=32),this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e),this.createOrUpdateSubmeshesOctree(t)},r.prototype.getHeightAtCoordinates=function(t,r){var i=this.getWorldMatrix(),n=e.Tmp.Matrix[5];i.invertToRef(n);var s=e.Tmp.Vector3[8];if(e.Vector3.TransformCoordinatesFromFloatsToRef(t,0,r,n,s),t=s.x,r=s.z,t<this._minX||t>this._maxX||r<this._minZ||r>this._maxZ)return this.position.y;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var o=this._getFacetAt(t,r),a=-(o.x*t+o.z*r+o.w)/o.y;return e.Vector3.TransformCoordinatesFromFloatsToRef(0,a,0,i,s),s.y},r.prototype.getNormalAtCoordinates=function(t,r){var i=new e.Vector3(0,1,0);return this.getNormalAtCoordinatesToRef(t,r,i),i},r.prototype.getNormalAtCoordinatesToRef=function(t,r,i){var n=this.getWorldMatrix(),s=e.Tmp.Matrix[5];n.invertToRef(s);var o=e.Tmp.Vector3[8];if(e.Vector3.TransformCoordinatesFromFloatsToRef(t,0,r,s,o),t=o.x,r=o.z,t<this._minX||t>this._maxX||r<this._minZ||r>this._maxZ)return this;this._heightQuads&&0!=this._heightQuads.length||(this._initHeightQuads(),this._computeHeightQuads());var a=this._getFacetAt(t,r);return e.Vector3.TransformNormalFromFloatsToRef(a.x,a.y,a.z,n,i),this},r.prototype.updateCoordinateHeights=function(){return this._heightQuads&&0!=this._heightQuads.length||this._initHeightQuads(),this._computeHeightQuads(),this},r.prototype._getFacetAt=function(e,t){var r=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),i=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),n=this._heightQuads[i*this._subdivisionsX+r];return t<n.slope.x*e+n.slope.y?n.facet1:n.facet2},r.prototype._initHeightQuads=function(){var t=this._subdivisionsX,r=this._subdivisionsY;this._heightQuads=new Array;for(var i=0;i<r;i++)for(var n=0;n<t;n++){var s={slope:e.Vector2.Zero(),facet1:new e.Vector4(0,0,0,0),facet2:new e.Vector4(0,0,0,0)};this._heightQuads[i*t+n]=s}return this},r.prototype._computeHeightQuads=function(){var t=this.getVerticesData(e.VertexBuffer.PositionKind);if(!t)return this;for(var r=e.Tmp.Vector3[3],i=e.Tmp.Vector3[2],n=e.Tmp.Vector3[1],s=e.Tmp.Vector3[0],o=e.Tmp.Vector3[4],a=e.Tmp.Vector3[5],h=e.Tmp.Vector3[6],u=e.Tmp.Vector3[7],l=e.Tmp.Vector3[8],c=0,f=0,d=0,p=0,_=0,m=0,g=0,v=this._subdivisionsX,y=this._subdivisionsY,b=0;b<y;b++)for(var T=0;T<v;T++){c=3*T,f=b*(v+1)*3,d=(b+1)*(v+1)*3,r.x=t[f+c],r.y=t[f+c+1],r.z=t[f+c+2],i.x=t[f+c+3],i.y=t[f+c+4],i.z=t[f+c+5],n.x=t[d+c],n.y=t[d+c+1],n.z=t[d+c+2],s.x=t[d+c+3],s.y=t[d+c+4],s.z=t[d+c+5],p=(s.z-r.z)/(s.x-r.x),_=r.z-p*r.x,i.subtractToRef(r,o),n.subtractToRef(r,a),s.subtractToRef(r,h),e.Vector3.CrossToRef(h,a,u),e.Vector3.CrossToRef(o,h,l),u.normalize(),l.normalize(),m=-(u.x*r.x+u.y*r.y+u.z*r.z),g=-(l.x*i.x+l.y*i.y+l.z*i.z);var E=this._heightQuads[b*v+T];E.slope.copyFromFloats(p,_),E.facet1.copyFromFloats(u.x,u.y,u.z,m),E.facet2.copyFromFloats(l.x,l.y,l.z,g)}return this},r.prototype.serialize=function(e){t.prototype.serialize.call(this,e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height},r.Parse=function(e,t){var i=new r(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i},r})(e.Mesh);e.GroundMesh=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(e,r){var i=t.call(this,e,r.getScene())||this;return r.instances.push(i),i._sourceMesh=r,i.position.copyFrom(r.position),i.rotation.copyFrom(r.rotation),i.scaling.copyFrom(r.scaling),r.rotationQuaternion&&(i.rotationQuaternion=r.rotationQuaternion.clone()),i.infiniteDistance=r.infiniteDistance,i.setPivotMatrix(r.getPivotMatrix()),i.refreshBoundingInfo(),i._syncSubMeshes(),i}return s(r,t),r.prototype.getClassName=function(){return"InstancedMesh"},Object.defineProperty(r.prototype,"receiveShadows",{get:function(){return this._sourceMesh.receiveShadows},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"material",{get:function(){return this._sourceMesh.material},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"visibility",{get:function(){return this._sourceMesh.visibility},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"skeleton",{get:function(){return this._sourceMesh.skeleton},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"renderingGroupId",{get:function(){return this._sourceMesh.renderingGroupId},set:function(t){this._sourceMesh&&t!==this._sourceMesh.renderingGroupId&&e.Tools.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")},enumerable:!0,configurable:!0}),r.prototype.getTotalVertices=function(){return this._sourceMesh.getTotalVertices()},Object.defineProperty(r.prototype,"sourceMesh",{get:function(){return this._sourceMesh},enumerable:!0,configurable:!0}),r.prototype.isReady=function(e){return void 0===e&&(e=!1),this._sourceMesh.isReady(e,!0)},r.prototype.getVerticesData=function(e,t){return this._sourceMesh.getVerticesData(e,t)},r.prototype.setVerticesData=function(e,t,r,i){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,r,i),this.sourceMesh},r.prototype.updateVerticesData=function(e,t,r,i){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,r,i),this.sourceMesh},r.prototype.setIndices=function(e,t){return void 0===t&&(t=null),this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh},r.prototype.isVerticesDataPresent=function(e){return this._sourceMesh.isVerticesDataPresent(e)},r.prototype.getIndices=function(){return this._sourceMesh.getIndices()},Object.defineProperty(r.prototype,"_positions",{get:function(){return this._sourceMesh._positions},enumerable:!0,configurable:!0}),r.prototype.refreshBoundingInfo=function(){var t=this._sourceMesh.getBoundingInfo();return this._boundingInfo=new e.BoundingInfo(t.minimum.clone(),t.maximum.clone()),this._updateBoundingInfo(),this},r.prototype._preActivate=function(){return this._currentLOD&&this._currentLOD._preActivate(),this},r.prototype._activate=function(e){return this._currentLOD&&this._currentLOD._registerInstanceForRenderId(this,e),this},r.prototype.getLOD=function(e){if(!e)return this;var t=this.getBoundingInfo();return this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere),this._currentLOD===this.sourceMesh?this:this._currentLOD},r.prototype._syncSubMeshes=function(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(var e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this},r.prototype._generatePointsArray=function(){return this._sourceMesh._generatePointsArray()},r.prototype.clone=function(t,r,i){var n=this._sourceMesh.createInstance(t);if(e.Tools.DeepCopy(this,n,["name","subMeshes","uniqueId"],[]),this.refreshBoundingInfo(),r&&(n.parent=r),!i)for(var s=0;s<this.getScene().meshes.length;s++){var o=this.getScene().meshes[s];o.parent===this&&o.clone(o.name,n)}return n.computeWorldMatrix(!0),n},r.prototype.dispose=function(e,r){void 0===r&&(r=!1);var i=this._sourceMesh.instances.indexOf(this);this._sourceMesh.instances.splice(i,1),t.prototype.dispose.call(this,e,r)},r})(e.AbstractMesh);e.InstancedMesh=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(r,i,n,s,o,a,h){void 0===i&&(i=null),void 0===n&&(n=null);var u=t.call(this,r,i,n,s,o)||this;u.useVertexColor=a,u.useVertexAlpha=h,u.color=new e.Color3(1,1,1),u.alpha=1,s&&(u.color=s.color.clone(),u.alpha=s.alpha,u.useVertexColor=s.useVertexColor,u.useVertexAlpha=s.useVertexAlpha),u._intersectionThreshold=.1;var l=[],c={attributes:[e.VertexBuffer.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:l};return!1===h&&(c.needAlphaBlending=!1),a?(c.defines.push("#define VERTEXCOLOR"),c.attributes.push(e.VertexBuffer.ColorKind)):c.uniforms.push("color"),u._colorShader=new e.ShaderMaterial("colorShader",u.getScene(),"color",c),u}return s(r,t),Object.defineProperty(r.prototype,"intersectionThreshold",{get:function(){return this._intersectionThreshold},set:function(t){this._intersectionThreshold!==t&&(this._intersectionThreshold=t,this.geometry&&(this.geometry.boundingBias=new e.Vector2(0,t)))},enumerable:!0,configurable:!0}),r.prototype.getClassName=function(){return"LinesMesh"},Object.defineProperty(r.prototype,"material",{get:function(){return this._colorShader},set:function(e){},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"checkCollisions",{get:function(){return!1},enumerable:!0,configurable:!0}),r.prototype.createInstance=function(e){throw new Error("LinesMeshes do not support createInstance.")},r.prototype._bind=function(e,t,r){return this._geometry?(this._geometry._bind(this._colorShader.getEffect()),this.useVertexColor||this._colorShader.setColor4("color",this.color.toColor4(this.alpha)),this):this},r.prototype._draw=function(t,r,i){return this._geometry&&this._geometry.getVertexBuffers()&&(this._unIndexed||this._geometry.getIndexBuffer())?(this.getScene().getEngine().drawElementsType(e.Material.LineListDrawMode,t.indexStart,t.indexCount),this):this},r.prototype.dispose=function(e){this._colorShader.dispose(),t.prototype.dispose.call(this,e)},r.prototype.clone=function(e,t,i){return new r(e,this.getScene(),t,this,i)},r})(e.Mesh);e.LinesMesh=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(){}return t.updateSideOrientation=function(t){return t==e.Mesh.DOUBLESIDE?e.Mesh.DOUBLESIDE:void 0===t||null===t?e.Mesh.FRONTSIDE:t},t.CreateBox=function(r,i,n){void 0===n&&(n=null);var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreateBox(i).applyToMesh(s,i.updatable),s},t.CreateSphere=function(r,i,n){var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreateSphere(i).applyToMesh(s,i.updatable),s},t.CreateDisc=function(r,i,n){void 0===n&&(n=null);var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreateDisc(i).applyToMesh(s,i.updatable),s},t.CreateIcoSphere=function(r,i,n){var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreateIcoSphere(i).applyToMesh(s,i.updatable),s},t.CreateRibbon=function(r,i,n){void 0===n&&(n=null);var s=i.pathArray,o=i.closeArray,a=i.closePath,h=t.updateSideOrientation(i.sideOrientation),u=i.instance,l=i.updatable;if(u){e.Vector3.FromFloatsToRef(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,e.Tmp.Vector3[0]),e.Vector3.FromFloatsToRef(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,e.Tmp.Vector3[1]);var c=u.getVerticesData(e.VertexBuffer.PositionKind);if(function(t){for(var r=s[0].length,i=0,n=u._originalBuilderSideOrientation===e.Mesh.DOUBLESIDE?2:1,o=1;o<=n;o++)for(var a=0;a<s.length;a++){var h=s[a],l=h.length;r=r<l?r:l;for(var c=0;c<r;)t[i]=h[c].x,t[i+1]=h[c].y,t[i+2]=h[c].z,h[c].x<e.Tmp.Vector3[0].x&&(e.Tmp.Vector3[0].x=h[c].x),h[c].x>e.Tmp.Vector3[1].x&&(e.Tmp.Vector3[1].x=h[c].x),h[c].y<e.Tmp.Vector3[0].y&&(e.Tmp.Vector3[0].y=h[c].y),h[c].y>e.Tmp.Vector3[1].y&&(e.Tmp.Vector3[1].y=h[c].y),h[c].z<e.Tmp.Vector3[0].z&&(e.Tmp.Vector3[0].z=h[c].z),h[c].z>e.Tmp.Vector3[1].z&&(e.Tmp.Vector3[1].z=h[c].z),c++,i+=3;u._closePath&&(t[i]=h[0].x,t[i+1]=h[0].y,t[i+2]=h[0].z,i+=3)}}(c),u._boundingInfo=new e.BoundingInfo(e.Tmp.Vector3[0],e.Tmp.Vector3[1]),u._boundingInfo.update(u._worldMatrix),u.updateVerticesData(e.VertexBuffer.PositionKind,c,!1,!1),i.colors){for(var f=u.getVerticesData(e.VertexBuffer.ColorKind),d=0;d<i.colors.length;d++)f[4*d]=i.colors[d].r,f[4*d+1]=i.colors[d].g,f[4*d+2]=i.colors[d].b,f[4*d+3]=i.colors[d].a;u.updateVerticesData(e.VertexBuffer.ColorKind,f,!1,!1)}if(i.uvs){for(var p=u.getVerticesData(e.VertexBuffer.UVKind),_=0;_<i.uvs.length;_++)p[2*_]=i.uvs[_].x,p[2*_+1]=i.uvs[_].y;u.updateVerticesData(e.VertexBuffer.UVKind,p,!1,!1)}if(!u.areNormalsFrozen||u.isFacetDataEnabled){var m=u.getIndices(),g=u.getVerticesData(e.VertexBuffer.NormalKind),v=u.isFacetDataEnabled?u.getFacetDataParameters():null;if(e.VertexData.ComputeNormals(c,m,g,v),u._closePath)for(var y=0,b=0,T=0;T<s.length;T++)y=3*u._idx[T],b=T+1<s.length?3*(u._idx[T+1]-1):g.length-3,g[y]=.5*(g[y]+g[b]),g[y+1]=.5*(g[y+1]+g[b+1]),g[y+2]=.5*(g[y+2]+g[b+2]),g[b]=g[y],g[b+1]=g[y+1],g[b+2]=g[y+2];u.areNormalsFrozen||u.updateVerticesData(e.VertexBuffer.NormalKind,g,!1,!1)}return u}var E=new e.Mesh(r,n);E._originalBuilderSideOrientation=h;var x=e.VertexData.CreateRibbon(i);return a&&(E._idx=x._idx),E._closePath=a,E._closeArray=o,x.applyToMesh(E,l),E},t.CreateCylinder=function(r,i,n){var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreateCylinder(i).applyToMesh(s,i.updatable),s},t.CreateTorus=function(r,i,n){var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreateTorus(i).applyToMesh(s,i.updatable),s},t.CreateTorusKnot=function(r,i,n){var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreateTorusKnot(i).applyToMesh(s,i.updatable),s},t.CreateLineSystem=function(t,r,i){var n=r.instance,s=r.lines,o=r.colors;if(n){var a,h,u=n.getVerticesData(e.VertexBuffer.PositionKind);o&&(a=n.getVerticesData(e.VertexBuffer.ColorKind));for(var l=0,c=0,f=0;f<s.length;f++)for(var d=s[f],p=0;p<d.length;p++)u[l]=d[p].x,u[l+1]=d[p].y,u[l+2]=d[p].z,o&&a&&(h=o[f],a[c]=h[p].r,a[c+1]=h[p].g,a[c+2]=h[p].b,a[c+3]=h[p].a,c+=4),l+=3;return n.updateVerticesData(e.VertexBuffer.PositionKind,u,!1,!1),o&&a&&n.updateVerticesData(e.VertexBuffer.ColorKind,a,!1,!1),n}var _=!!o,m=new e.LinesMesh(t,i,null,void 0,void 0,_,r.useVertexAlpha);return e.VertexData.CreateLineSystem(r).applyToMesh(m,r.updatable),m},t.CreateLines=function(e,r,i){void 0===i&&(i=null);var n=r.colors?[r.colors]:null;return t.CreateLineSystem(e,{lines:[r.points],updatable:r.updatable,instance:r.instance,colors:n,useVertexAlpha:r.useVertexAlpha},i)},t.CreateDashedLines=function(t,r,i){void 0===i&&(i=null);var n=r.points,s=r.instance,o=r.gapSize||1,a=r.dashSize||3;if(s){var h=function(t){var r=e.Vector3.Zero(),i=t.length/6,o=0,a=0,h=0,u=0,l=0,c=0,f=0,d=0;for(f=0;f<n.length-1;f++)n[f+1].subtractToRef(n[f],r),o+=r.length();for(h=o/i,u=s.dashSize*h/(s.dashSize+s.gapSize),f=0;f<n.length-1;f++)for(n[f+1].subtractToRef(n[f],r),a=Math.floor(r.length()/h),r.normalize(),d=0;d<a&&c<t.length;)l=h*d,t[c]=n[f].x+l*r.x,t[c+1]=n[f].y+l*r.y,t[c+2]=n[f].z+l*r.z,t[c+3]=n[f].x+(l+u)*r.x,t[c+4]=n[f].y+(l+u)*r.y,t[c+5]=n[f].z+(l+u)*r.z,c+=6,d++;for(;c<t.length;)t[c]=n[f].x,t[c+1]=n[f].y,t[c+2]=n[f].z,c+=3};return s.updateMeshPositions(h,!1),s}var u=new e.LinesMesh(t,i);return e.VertexData.CreateDashedLines(r).applyToMesh(u,r.updatable),u.dashSize=a,u.gapSize=o,u},t.ExtrudeShape=function(r,i,n){void 0===n&&(n=null);var s=i.path,o=i.shape,a=i.scale||1,h=i.rotation||0,u=0===i.cap?0:i.cap||e.Mesh.NO_CAP,l=i.updatable,c=t.updateSideOrientation(i.sideOrientation),f=i.instance||null,d=i.invertUV||!1;return t._ExtrudeShapeGeneric(r,o,s,a,h,null,null,!1,!1,u,!1,n,!!l,c,f,d,i.frontUVs||null,i.backUVs||null)},t.ExtrudeShapeCustom=function(r,i,n){var s=i.path,o=i.shape,a=i.scaleFunction||function(){return 1},h=i.rotationFunction||function(){return 0},u=i.ribbonCloseArray||!1,l=i.ribbonClosePath||!1,c=0===i.cap?0:i.cap||e.Mesh.NO_CAP,f=i.updatable,d=t.updateSideOrientation(i.sideOrientation),p=i.instance,_=i.invertUV||!1;return t._ExtrudeShapeGeneric(r,o,s,null,null,a,h,u,l,c,!0,n,!!f,d,p||null,_,i.frontUVs||null,i.backUVs||null)},t.CreateLathe=function(r,i,n){var s,o=i.arc?i.arc<=0||i.arc>1?1:i.arc:1,a=void 0===i.closed||i.closed,h=i.shape,u=i.radius||1,l=i.tessellation||64,c=i.updatable,f=t.updateSideOrientation(i.sideOrientation),d=i.cap||e.Mesh.NO_CAP,p=2*Math.PI,_=new Array,m=i.invertUV||!1,g=0,v=0,y=p/l*o,b=new Array;for(g=0;g<=l;g++){var b=[];for(d!=e.Mesh.CAP_START&&d!=e.Mesh.CAP_ALL||(b.push(new e.Vector3(0,h[0].y,0)),b.push(new e.Vector3(Math.cos(g*y)*h[0].x*u,h[0].y,Math.sin(g*y)*h[0].x*u))),v=0;v<h.length;v++)s=new e.Vector3(Math.cos(g*y)*h[v].x*u,h[v].y,Math.sin(g*y)*h[v].x*u),b.push(s);d!=e.Mesh.CAP_END&&d!=e.Mesh.CAP_ALL||(b.push(new e.Vector3(Math.cos(g*y)*h[h.length-1].x*u,h[h.length-1].y,Math.sin(g*y)*h[h.length-1].x*u)),b.push(new e.Vector3(0,h[h.length-1].y,0))),_.push(b)}return t.CreateRibbon(r,{pathArray:_,closeArray:a,sideOrientation:f,updatable:c,invertUV:m,frontUVs:i.frontUVs,backUVs:i.backUVs},n)},t.CreatePlane=function(r,i,n){var s=new e.Mesh(r,n);if(i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreatePlane(i).applyToMesh(s,i.updatable),i.sourcePlane){s.translate(i.sourcePlane.normal,i.sourcePlane.d);var o=Math.acos(e.Vector3.Dot(i.sourcePlane.normal,e.Axis.Z)),a=e.Vector3.Cross(e.Axis.Z,i.sourcePlane.normal);s.rotate(a,o)}return s},t.CreateGround=function(t,r,i){var n=new e.GroundMesh(t,i);return n._setReady(!1),n._subdivisionsX=r.subdivisionsX||r.subdivisions||1,n._subdivisionsY=r.subdivisionsY||r.subdivisions||1,n._width=r.width||1,n._height=r.height||1,n._maxX=n._width/2,n._maxZ=n._height/2,n._minX=-n._maxX,n._minZ=-n._maxZ,e.VertexData.CreateGround(r).applyToMesh(n,r.updatable),n._setReady(!0),n},t.CreateTiledGround=function(t,r,i){var n=new e.Mesh(t,i);return e.VertexData.CreateTiledGround(r).applyToMesh(n,r.updatable),n},t.CreateGroundFromHeightMap=function(t,r,i,n){var s=i.width||10,o=i.height||10,a=i.subdivisions||1,h=i.minHeight||0,u=i.maxHeight||1,l=i.colorFilter||new e.Color3(.3,.59,.11),c=i.updatable,f=i.onReady,d=new e.GroundMesh(t,n);d._subdivisionsX=a,d._subdivisionsY=a,d._width=s,d._height=o,d._maxX=d._width/2,d._maxZ=d._height/2,d._minX=-d._maxX,d._minZ=-d._maxZ,d._setReady(!1);var p=function(t){var r=document.createElement("canvas"),i=r.getContext("2d");if(!i)throw new Error("Unable to get 2d context for CreateGroundFromHeightMap");if(!n.isDisposed){var p=t.width,_=t.height;r.width=p,r.height=_,i.drawImage(t,0,0);var m=i.getImageData(0,0,p,_).data;e.VertexData.CreateGroundFromHeightMap({width:s,height:o,subdivisions:a,minHeight:h,maxHeight:u,colorFilter:l,buffer:m,bufferWidth:p,bufferHeight:_}).applyToMesh(d,c),f&&f(d),d._setReady(!0)}};return e.Tools.LoadImage(r,p,(function(){}),n.database),d},t.CreatePolygon=function(r,i,n){i.sideOrientation=t.updateSideOrientation(i.sideOrientation);for(var s=i.shape,o=i.holes||[],a=i.depth||0,h=[],u=[],l=0;l<s.length;l++)h[l]=new e.Vector2(s[l].x,s[l].z);h[0].equalsWithEpsilon(h[h.length-1],1e-8)&&h.pop();for(var c=new e.PolygonMeshBuilder(r,h,n),f=0;f<o.length;f++){u=[];for(var d=0;d<o[f].length;d++)u.push(new e.Vector2(o[f][d].x,o[f][d].z));c.addHole(u)}var p=c.build(i.updatable,a);return p._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreatePolygon(p,i.sideOrientation,i.faceUV,i.faceColors,i.frontUVs,i.backUVs).applyToMesh(p,i.updatable),p},t.ExtrudePolygon=function(e,r,i){return t.CreatePolygon(e,r,i)},t.CreateTube=function(r,i,n){var s=i.path,o=i.instance,a=1;o&&(a=o.radius),void 0!==i.radius&&(a=i.radius);var h=i.tessellation||64,u=i.radiusFunction||null,l=i.cap||e.Mesh.NO_CAP,c=i.invertUV||!1,f=i.updatable,d=t.updateSideOrientation(i.sideOrientation);i.arc=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1;var p,_,m=function(t,r,i,n,s,o,a,h){for(var u,l,c,f,d=r.getTangents(),p=r.getNormals(),_=r.getDistances(),m=2*Math.PI,g=m/s*h,v=function(){return n},y=o||v,b=e.Tmp.Matrix[0],T=a===e.Mesh._NO_CAP||a===e.Mesh.CAP_END?0:2,E=0;E<t.length;E++){l=y(E,_[E]),u=Array(),c=p[E];for(var x=0;x<s;x++)e.Matrix.RotationAxisToRef(d[E],g*x,b),f=u[x]?u[x]:e.Vector3.Zero(),e.Vector3.TransformCoordinatesToRef(c,b,f),f.scaleInPlace(l).addInPlace(t[E]),u[x]=f;i[T]=u,T++}var A=function(e,r){for(var i=Array(),n=0;n<e;n++)i.push(t[r]);return i};switch(a){case e.Mesh.NO_CAP:break;case e.Mesh.CAP_START:i[0]=A(s,0),i[1]=i[2].slice(0);break;case e.Mesh.CAP_END:i[T]=i[T-1].slice(0),i[T+1]=A(s,t.length-1);break;case e.Mesh.CAP_ALL:i[0]=A(s,0),i[1]=i[2].slice(0),i[T]=i[T-1].slice(0),i[T+1]=A(s,t.length-1)}return i};if(o){var g=i.arc||o.arc;return p=o.path3D.update(s),_=m(s,p,o.pathArray,a,o.tessellation,u,o.cap,g),o=t.CreateRibbon("",{pathArray:_,instance:o}),o.path3D=p,o.pathArray=_,o.arc=g,o.radius=a,o}
p=new e.Path3D(s);var v=new Array;l=l<0||l>3?0:l,_=m(s,p,v,a,h,u,l,i.arc);var y=t.CreateRibbon(r,{pathArray:_,closePath:!0,closeArray:!1,updatable:f,sideOrientation:d,invertUV:c,frontUVs:i.frontUVs,backUVs:i.backUVs},n);return y.pathArray=_,y.path3D=p,y.tessellation=h,y.cap=l,y.arc=i.arc,y.radius=a,y},t.CreatePolyhedron=function(r,i,n){var s=new e.Mesh(r,n);return i.sideOrientation=t.updateSideOrientation(i.sideOrientation),s._originalBuilderSideOrientation=i.sideOrientation,e.VertexData.CreatePolyhedron(i).applyToMesh(s,i.updatable),s},t.CreateDecal=function(t,r,i){var n=r.getIndices(),s=r.getVerticesData(e.VertexBuffer.PositionKind),o=r.getVerticesData(e.VertexBuffer.NormalKind),a=i.position||e.Vector3.Zero(),h=i.normal||e.Vector3.Up(),u=i.size||e.Vector3.One(),l=i.angle||0;if(!h){var c=new e.Vector3(0,0,1),f=r.getScene().activeCamera,d=e.Vector3.TransformCoordinates(c,f.getWorldMatrix());h=f.globalPosition.subtract(d)}var p=-Math.atan2(h.z,h.x)-Math.PI/2,_=Math.sqrt(h.x*h.x+h.z*h.z),m=Math.atan2(h.y,_),g=e.Matrix.RotationYawPitchRoll(p,m,l).multiply(e.Matrix.Translation(a.x,a.y,a.z)),v=e.Matrix.Invert(g),y=r.getWorldMatrix(),b=y.multiply(v),T=new e.VertexData;T.indices=[],T.positions=[],T.normals=[],T.uvs=[];for(var E=0,x=function(t){var r=new e.PositionNormalVertex;if(!n||!s||!o)return r;var i=n[t];return r.position=new e.Vector3(s[3*i],s[3*i+1],s[3*i+2]),r.position=e.Vector3.TransformCoordinates(r.position,b),r.normal=new e.Vector3(o[3*i],o[3*i+1],o[3*i+2]),r.normal=e.Vector3.TransformNormal(r.normal,b),r},A=function(t,r){if(0===t.length)return t;for(var i=.5*Math.abs(e.Vector3.Dot(u,r)),n=function(t,n){var s=e.Vector3.GetClipFactor(t.position,n.position,r,i);return new e.PositionNormalVertex(e.Vector3.Lerp(t.position,n.position,s),e.Vector3.Lerp(t.normal,n.normal,s))},s=new Array,o=0;o<t.length;o+=3){var a,h,l,c=null,f=null,d=null,p=null,_=e.Vector3.Dot(t[o].position,r)-i,m=e.Vector3.Dot(t[o+1].position,r)-i,g=e.Vector3.Dot(t[o+2].position,r)-i;switch(a=_>0,h=m>0,l=g>0,(a?1:0)+(h?1:0)+(l?1:0)){case 0:s.push(t[o]),s.push(t[o+1]),s.push(t[o+2]);break;case 1:if(a&&(c=t[o+1],f=t[o+2],d=n(t[o],c),p=n(t[o],f)),h){c=t[o],f=t[o+2],d=n(t[o+1],c),p=n(t[o+1],f),s.push(d),s.push(f.clone()),s.push(c.clone()),s.push(f.clone()),s.push(d.clone()),s.push(p);break}l&&(c=t[o],f=t[o+1],d=n(t[o+2],c),p=n(t[o+2],f)),c&&f&&d&&p&&(s.push(c.clone()),s.push(f.clone()),s.push(d),s.push(p),s.push(d.clone()),s.push(f.clone()));break;case 2:a||(c=t[o].clone(),f=n(c,t[o+1]),d=n(c,t[o+2]),s.push(c),s.push(f),s.push(d)),h||(c=t[o+1].clone(),f=n(c,t[o+2]),d=n(c,t[o]),s.push(c),s.push(f),s.push(d)),l||(c=t[o+2].clone(),f=n(c,t[o]),d=n(c,t[o+1]),s.push(c),s.push(f),s.push(d))}}return s},M=0;M<n.length;M+=3){var P=new Array;if(P.push(x(M)),P.push(x(M+1)),P.push(x(M+2)),P=A(P,new e.Vector3(1,0,0)),P=A(P,new e.Vector3(-1,0,0)),P=A(P,new e.Vector3(0,1,0)),P=A(P,new e.Vector3(0,-1,0)),P=A(P,new e.Vector3(0,0,1)),P=A(P,new e.Vector3(0,0,-1)),0!==P.length)for(var R=0;R<P.length;R++){var S=P[R];T.indices.push(E),S.position.toArray(T.positions,3*E),S.normal.toArray(T.normals,3*E),T.uvs.push(.5+S.position.x/u.x),T.uvs.push(.5+S.position.y/u.y),E++}}var C=new e.Mesh(t,r.getScene());return T.applyToMesh(C),C.position=a.clone(),C.rotation=new e.Vector3(m,p,l),C},t._ExtrudeShapeGeneric=function(r,i,n,s,o,a,h,u,l,c,f,d,p,_,m,g,v,y){var b,T,E=function(t,r,i,n,s,o,a,h,u,l){for(var c=i.getTangents(),f=i.getNormals(),d=i.getBinormals(),p=i.getDistances(),_=0,m=function(){return null!==s?s:1},g=function(){return null!==o?o:0},v=l&&h?h:g,y=l&&a?a:m,b=u===e.Mesh.NO_CAP||u===e.Mesh.CAP_END?0:2,T=e.Tmp.Matrix[0],E=0;E<r.length;E++){for(var x=new Array,A=v(E,p[E]),M=y(E,p[E]),P=0;P<t.length;P++){e.Matrix.RotationAxisToRef(c[E],_,T);var R=c[E].scale(t[P].z).add(f[E].scale(t[P].x)).add(d[E].scale(t[P].y)),S=x[P]?x[P]:e.Vector3.Zero();e.Vector3.TransformCoordinatesToRef(R,T,S),S.scaleInPlace(M).addInPlace(r[E]),x[P]=S}n[b]=x,_+=A,b++}var C=function(t){var r,i=Array(),n=e.Vector3.Zero();for(r=0;r<t.length;r++)n.addInPlace(t[r]);for(n.scaleInPlace(1/t.length),r=0;r<t.length;r++)i.push(n);return i};switch(u){case e.Mesh.NO_CAP:break;case e.Mesh.CAP_START:n[0]=C(n[2]),n[1]=n[2];break;case e.Mesh.CAP_END:n[b]=n[b-1],n[b+1]=C(n[b-1]);break;case e.Mesh.CAP_ALL:n[0]=C(n[2]),n[1]=n[2],n[b]=n[b-1],n[b+1]=C(n[b-1])}return n};if(m)return b=m.path3D.update(n),T=E(i,n,m.path3D,m.pathArray,s,o,a,h,m.cap,f),m=e.Mesh.CreateRibbon("",T,!1,!1,0,d||void 0,!1,0,m);b=new e.Path3D(n);var x=new Array;c=c<0||c>3?0:c,T=E(i,n,b,x,s,o,a,h,c,f);var A=t.CreateRibbon(r,{pathArray:T,closeArray:u,closePath:l,updatable:p,sideOrientation:_,invertUV:g,frontUVs:v||void 0,backUVs:y||void 0},d);return A.pathArray=T,A.path3D=b,A.cap=c,A},t})();e.MeshBuilder=t})(i||(i={}));var i;!(function(e){e.CameraInputTypes={};var t=(function(){function t(e){this.attached={},this.camera=e,this.checkInputs=function(){}}return t.prototype.add=function(t){var r=t.getSimpleName();if(this.attached[r])return void e.Tools.Warn("camera input of type "+r+" already exists on camera");this.attached[r]=t,t.camera=this.camera,t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t))),this.attachedElement&&t.attachControl(this.attachedElement)},t.prototype.remove=function(e){for(var t in this.attached){var r=this.attached[t];r===e&&(r.detachControl(this.attachedElement),r.camera=null,delete this.attached[t],this.rebuildInputCheck())}},t.prototype.removeByType=function(e){for(var t in this.attached){var r=this.attached[t];r.getClassName()===e&&(r.detachControl(this.attachedElement),r.camera=null,delete this.attached[t],this.rebuildInputCheck())}},t.prototype._addCheckInputs=function(e){var t=this.checkInputs;return function(){t(),e()}},t.prototype.attachInput=function(e){this.attachedElement&&e.attachControl(this.attachedElement,this.noPreventDefault)},t.prototype.attachElement=function(t,r){if(void 0===r&&(r=!1),!this.attachedElement){r=!e.Camera.ForceAttachControlToAlwaysPreventDefault&&r,this.attachedElement=t,this.noPreventDefault=r;for(var i in this.attached)this.attached[i].attachControl(t,r)}},t.prototype.detachElement=function(e,t){if(void 0===t&&(t=!1),this.attachedElement===e){for(var r in this.attached)this.attached[r].detachControl(e),t&&(this.attached[r].camera=null);this.attachedElement=null}},t.prototype.rebuildInputCheck=function(){this.checkInputs=function(){};for(var e in this.attached){var t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}},t.prototype.clear=function(){this.attachedElement&&this.detachElement(this.attachedElement,!0),this.attached={},this.attachedElement=null,this.checkInputs=function(){}},t.prototype.serialize=function(t){var r={};for(var i in this.attached){var n=this.attached[i],s=e.SerializationHelper.Serialize(n);r[n.getClassName()]=s}t.inputsmgr=r},t.prototype.parse=function(t){var r=t.inputsmgr;if(r){this.clear();for(var i in r){var n=e.CameraInputTypes[i];if(n){var s=r[i],o=e.SerializationHelper.Parse((function(){return new n}),s,null);this.add(o)}}}else for(var i in this.attached){var n=e.CameraInputTypes[this.attached[i].getClassName()];if(n){var o=e.SerializationHelper.Parse((function(){return new n}),t,null);this.remove(this.attached[i]),this.add(o)}}},t})();e.CameraInputsManager=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(r,i,n,s){void 0===s&&(s=!0);var o=t.call(this,r,i,n,s)||this;return o.cameraDirection=new e.Vector3(0,0,0),o.cameraRotation=new e.Vector2(0,0),o.rotation=new e.Vector3(0,0,0),o.speed=2,o.noRotationConstraint=!1,o.lockedTarget=null,o._currentTarget=e.Vector3.Zero(),o._viewMatrix=e.Matrix.Zero(),o._camMatrix=e.Matrix.Zero(),o._cameraTransformMatrix=e.Matrix.Zero(),o._cameraRotationMatrix=e.Matrix.Zero(),o._referencePoint=new e.Vector3(0,0,1),o._currentUpVector=new e.Vector3(0,1,0),o._transformedReferencePoint=e.Vector3.Zero(),o._globalCurrentTarget=e.Vector3.Zero(),o._globalCurrentUpVector=e.Vector3.Zero(),o}return s(r,t),r.prototype.getFrontPosition=function(e){this.getWorldMatrix();var t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)},r.prototype._getLockedTargetPosition=function(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null},r.prototype.storeState=function(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),t.prototype.storeState.call(this)},r.prototype._restoreStateValues=function(){return!!t.prototype._restoreStateValues.call(this)&&(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0)},r.prototype._initCache=function(){t.prototype._initCache.call(this),this._cache.lockedTarget=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new e.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new e.Quaternion(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},r.prototype._updateCache=function(e){e||t.prototype._updateCache.call(this);var r=this._getLockedTargetPosition();r?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(r):this._cache.lockedTarget=r.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)},r.prototype._isSynchronizedViewMatrix=function(){if(!t.prototype._isSynchronizedViewMatrix.call(this))return!1;var e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))},r.prototype._computeLocalCameraSpeed=function(){var e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(100*e.getFps()))},r.prototype.setTarget=function(t){this.upVector.normalize(),e.Matrix.LookAtLHToRef(this.position,t,this.upVector,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);var r=t.subtract(this.position);r.x>=0?this.rotation.y=-Math.atan(r.z/r.x)+Math.PI/2:this.rotation.y=-Math.atan(r.z/r.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&e.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)},r.prototype.getTarget=function(){return this._currentTarget},r.prototype._decideIfNeedsToMove=function(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},r.prototype._updatePosition=function(){if(this.parent)return this.parent.getWorldMatrix().invertToRef(e.Tmp.Matrix[0]),e.Vector3.TransformNormalToRef(this.cameraDirection,e.Tmp.Matrix[0],e.Tmp.Vector3[0]),void this.position.addInPlace(e.Tmp.Vector3[0]);this.position.addInPlace(this.cameraDirection)},r.prototype._checkInputs=function(){var r=this._decideIfNeedsToMove(),i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;if(r&&this._updatePosition(),i){if(this.rotation.x+=this.cameraRotation.x,this.rotation.y+=this.cameraRotation.y,this.rotationQuaternion){this.rotation.lengthSquared()&&e.Quaternion.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}if(!this.noRotationConstraint){var n=Math.PI/2*.95;this.rotation.x>n&&(this.rotation.x=n),this.rotation.x<-n&&(this.rotation.x=-n)}}r&&(Math.abs(this.cameraDirection.x)<this.speed*e.Epsilon&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*e.Epsilon&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*e.Epsilon&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*e.Epsilon&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*e.Epsilon&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),t.prototype._checkInputs.call(this)},r.prototype._updateCameraRotationMatrix=function(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):e.Matrix.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix),e.Vector3.TransformNormalToRef(this.upVector,this._cameraRotationMatrix,this._currentUpVector)},r.prototype._getViewMatrix=function(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),e.Vector3.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this._computeViewMatrix(this.position,this._currentTarget,this._currentUpVector),this._viewMatrix},r.prototype._computeViewMatrix=function(t,r,i){if(this.parent){var n=this.parent.getWorldMatrix();e.Vector3.TransformCoordinatesToRef(this.position,n,this._globalPosition),e.Vector3.TransformCoordinatesToRef(r,n,this._globalCurrentTarget),e.Vector3.TransformNormalToRef(i,n,this._globalCurrentUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(this.position),this._globalCurrentTarget.copyFrom(r),this._globalCurrentUpVector.copyFrom(i);this.getScene().useRightHandedSystem?e.Matrix.LookAtRHToRef(this._globalPosition,this._globalCurrentTarget,this._globalCurrentUpVector,this._viewMatrix):e.Matrix.LookAtLHToRef(this._globalPosition,this._globalCurrentTarget,this._globalCurrentUpVector,this._viewMatrix)},r.prototype.createRigCamera=function(t,i){if(this.cameraRigMode!==e.Camera.RIG_MODE_NONE){var n=new r(t,this.position.clone(),this.getScene());return this.cameraRigMode!==e.Camera.RIG_MODE_VR&&this.cameraRigMode!==e.Camera.RIG_MODE_WEBVR||(this.rotationQuaternion||(this.rotationQuaternion=new e.Quaternion),n._cameraRigParams={},n.rotationQuaternion=new e.Quaternion),n}return null},r.prototype._updateRigCameras=function(){var r=this._rigCameras[0],i=this._rigCameras[1];switch(this.cameraRigMode){case e.Camera.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case e.Camera.RIG_MODE_STEREOSCOPIC_OVERUNDER:var n=this.cameraRigMode===e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===e.Camera.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*n,r.position),this._getRigCamPosition(this._cameraRigParams.stereoHalfAngle*s,i.position),r.setTarget(this.getTarget()),i.setTarget(this.getTarget());break;case e.Camera.RIG_MODE_VR:r.rotationQuaternion?(r.rotationQuaternion.copyFrom(this.rotationQuaternion),i.rotationQuaternion.copyFrom(this.rotationQuaternion)):(r.rotation.copyFrom(this.rotation),i.rotation.copyFrom(this.rotation)),r.position.copyFrom(this.position),i.position.copyFrom(this.position)}t.prototype._updateRigCameras.call(this)},r.prototype._getRigCamPosition=function(t,r){this._rigCamTransformMatrix||(this._rigCamTransformMatrix=new e.Matrix);var i=this.getTarget();e.Matrix.Translation(-i.x,-i.y,-i.z).multiplyToRef(e.Matrix.RotationY(t),this._rigCamTransformMatrix),this._rigCamTransformMatrix=this._rigCamTransformMatrix.multiply(e.Matrix.Translation(i.x,i.y,i.z)),e.Vector3.TransformCoordinatesToRef(this.position,this._rigCamTransformMatrix,r)},r.prototype.getClassName=function(){return"TargetCamera"},n([e.serializeAsVector3()],r.prototype,"rotation",void 0),n([e.serialize()],r.prototype,"speed",void 0),n([e.serializeAsMeshReference("lockedTargetId")],r.prototype,"lockedTarget",void 0),r})(e.Camera);e.TargetCamera=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(e){void 0===e&&(e=!0),this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this.previousPosition=null}return t.prototype.attachControl=function(t,r){var i=this,n=this.camera.getEngine();this._pointerInput||(this._pointerInput=function(s,o){var a=s.event;if(!n.isInVRExclusivePointerMode&&(i.touchEnabled||"touch"!==a.pointerType)&&(s.type===e.PointerEventTypes.POINTERMOVE||-1!==i.buttons.indexOf(a.button))){var h=a.srcElement||a.target;if(s.type===e.PointerEventTypes.POINTERDOWN&&h){try{h.setPointerCapture(a.pointerId)}catch(e){}i.previousPosition={x:a.clientX,y:a.clientY},r||(a.preventDefault(),t.focus())}else if(s.type===e.PointerEventTypes.POINTERUP&&h){try{h.releasePointerCapture(a.pointerId)}catch(e){}i.previousPosition=null,r||a.preventDefault()}else if(s.type===e.PointerEventTypes.POINTERMOVE){if(!i.previousPosition||n.isPointerLock)return;var u=a.clientX-i.previousPosition.x;i.camera.getScene().useRightHandedSystem&&(u*=-1),i.camera.parent&&i.camera.parent._getWorldMatrixDeterminant()<0&&(u*=-1),i.camera.cameraRotation.y+=u/i.angularSensibility;var l=a.clientY-i.previousPosition.y;i.camera.cameraRotation.x+=l/i.angularSensibility,i.previousPosition={x:a.clientX,y:a.clientY},r||a.preventDefault()}}}),this._onMouseMove=function(e){if(n.isPointerLock&&!n.isInVRExclusivePointerMode){var t=e.movementX||e.mozMovementX||e.webkitMovementX||e.msMovementX||0;i.camera.getScene().useRightHandedSystem&&(t*=-1),i.camera.parent&&i.camera.parent._getWorldMatrixDeterminant()<0&&(t*=-1),i.camera.cameraRotation.y+=t/i.angularSensibility;var s=e.movementY||e.mozMovementY||e.webkitMovementY||e.msMovementY||0;i.camera.cameraRotation.x+=s/i.angularSensibility,i.previousPosition=null,r||e.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,e.PointerEventTypes.POINTERDOWN|e.PointerEventTypes.POINTERUP|e.PointerEventTypes.POINTERMOVE),t.addEventListener("mousemove",this._onMouseMove,!1)},t.prototype.detachControl=function(e){this._observer&&e&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._onMouseMove&&e.removeEventListener("mousemove",this._onMouseMove),this._observer=null,this._onMouseMove=null,this.previousPosition=null)},t.prototype.getClassName=function(){return"FreeCameraMouseInput"},t.prototype.getSimpleName=function(){return"mouse"},n([e.serialize()],t.prototype,"buttons",void 0),n([e.serialize()],t.prototype,"angularSensibility",void 0),t})();e.FreeCameraMouseInput=t,e.CameraInputTypes.FreeCameraMouseInput=t})(i||(i={}));var i;!(function(e){var t=(function(){function t(){this._keys=new Array,this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39]}return t.prototype.attachControl=function(t,r){var i=this;this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((function(){i._keys=[]})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((function(t){var n=t.event;if(t.type===e.KeyboardEventTypes.KEYDOWN){if(-1!==i.keysUp.indexOf(n.keyCode)||-1!==i.keysDown.indexOf(n.keyCode)||-1!==i.keysLeft.indexOf(n.keyCode)||-1!==i.keysRight.indexOf(n.keyCode)){var s=i._keys.indexOf(n.keyCode);-1===s&&i._keys.push(n.keyCode),r||n.preventDefault()}}else if(-1!==i.keysUp.indexOf(n.keyCode)||-1!==i.keysDown.indexOf(n.keyCode)||-1!==i.keysLeft.indexOf(n.keyCode)||-1!==i.keysRight.indexOf(n.keyCode)){var s=i._keys.indexOf(n.keyCode);s>=0&&i._keys.splice(s,1),r||n.preventDefault()}})))},t.prototype.detachControl=function(e){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},t.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var t=this.camera,r=0;r<this._keys.length;r++){var i=this._keys[r],n=t._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(i)?t._localDirection.copyFromFloats(-n,0,0):-1!==this.keysUp.indexOf(i)?t._localDirection.copyFromFloats(0,0,n):-1!==this.keysRight.indexOf(i)?t._localDirection.copyFromFloats(n,0,0):-1!==this.keysDown.indexOf(i)&&t._localDirection.copyFromFloats(0,0,-n),t.getScene().useRightHandedSystem&&(t._localDirection.z*=-1),t.getViewMatrix().invertToRef(t._cameraTransformMatrix),e.Vector3.TransformNormalToRef(t._localDirection,t._cameraTransformMatrix,t._transformedDirection),t.cameraDirection.addInPlace(t._transformedDirection)}},t.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"},t.prototype._onLostFocus=function(e){this._keys=[]},t.prototype.getSimpleName=function(){return"keyboard"},n([e.serialize()],t.prototype,"keysUp",void 0),n([e.serialize()],t.prototype,"keysDown",void 0),n([e.serialize()],t.prototype,"keysLeft",void 0),n([e.serialize()],t.prototype,"keysRight",void 0),t})();e.FreeCameraKeyboardMoveInput=t,e.CameraInputTypes.FreeCameraKeyboardMoveInput=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(e){return t.call(this,e)||this}return s(r,t),r.prototype.addKeyboard=function(){return this.add(new e.FreeCameraKeyboardMoveInput),this},r.prototype.addMouse=function(t){return void 0===t&&(t=!0),this.add(new e.FreeCameraMouseInput(t)),this},r.prototype.addGamepad=function(){return this.add(new e.FreeCameraGamepadInput),this},r.prototype.addDeviceOrientation=function(){return this.add(new e.FreeCameraDeviceOrientationInput),this},r.prototype.addTouch=function(){return this.add(new e.FreeCameraTouchInput),this},r.prototype.addVirtualJoystick=function(){return this.add(new e.FreeCameraVirtualJoystickInput),this},r})(e.CameraInputsManager);e.FreeCameraInputsManager=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(r,i,n,s){void 0===s&&(s=!0);var o=t.call(this,r,i,n,s)||this;return o.ellipsoid=new e.Vector3(.5,1,.5),o.ellipsoidOffset=new e.Vector3(0,0,0),o.checkCollisions=!1,o.applyGravity=!1,o._needMoveForGravity=!1,o._oldPosition=e.Vector3.Zero(),o._diffPosition=e.Vector3.Zero(),o._newPosition=e.Vector3.Zero(),o._collisionMask=-1,o._onCollisionPositionChange=function(t,r,i){void 0===i&&(i=null),o.getScene().workerCollisions&&r.multiplyInPlace(o._collider._radius);!(function(t){o._newPosition.copyFrom(t),o._newPosition.subtractToRef(o._oldPosition,o._diffPosition),o._diffPosition.length()>e.Engine.CollisionsEpsilon&&(o.position.addInPlace(o._diffPosition),o.onCollide&&i&&o.onCollide(i))})(r)},o.inputs=new e.FreeCameraInputsManager(o),o.inputs.addKeyboard().addMouse(),o}return s(r,t),Object.defineProperty(r.prototype,"angularSensibility",{get:function(){var e=this.inputs.attached.mouse;return e?e.angularSensibility:0},set:function(e){var t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"keysUp",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysUp:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysUp=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"keysDown",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysDown:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysDown=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"keysLeft",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysLeft:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"keysRight",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysRight:[]},set:function(e){var t=this.inputs.attached.keyboard;t&&(t.keysRight=e)},enumerable:!0,configurable:!0}),r.prototype.attachControl=function(e,t){this.inputs.attachElement(e,t)},r.prototype.detachControl=function(t){this.inputs.detachElement(t),this.cameraDirection=new e.Vector3(0,0,0),this.cameraRotation=new e.Vector2(0,0)},Object.defineProperty(r.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=isNaN(e)?-1:e},enumerable:!0,configurable:!0}),r.prototype._collideWithWorld=function(t){var r;r=this.parent?e.Vector3.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position,r.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset),this._collider||(this._collider=new e.Collider),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var i=t;this.applyGravity&&(i=t.add(this.getScene().gravity)),this.getScene().collisionCoordinator.getNewPosition(this._oldPosition,i,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},r.prototype._checkInputs=function(){this._localDirection||(this._localDirection=e.Vector3.Zero(),this._transformedDirection=e.Vector3.Zero()),this.inputs.checkInputs(),t.prototype._checkInputs.call(this)},r.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},r.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):t.prototype._updatePosition.call(this)},r.prototype.dispose=function(){this.inputs.clear(),t.prototype.dispose.call(this)},r.prototype.getClassName=function(){return"FreeCamera"},n([e.serializeAsVector3()],r.prototype,"ellipsoid",void 0),n([e.serializeAsVector3()],r.prototype,"ellipsoidOffset",void 0),n([e.serialize()],r.prototype,"checkCollisions",void 0),n([e.serialize()],r.prototype,"applyGravity",void 0),r})(e.TargetCamera);e.FreeCamera=t})(i||(i={}));var i;!(function(e){var t=(function(t){function r(r,i,n){var s=t.call(this,r,n)||this;return s.groundColor=new e.Color3(0,0,0),s.direction=i||e.Vector3.Up(),s}return s(r,t),r.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",3),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},r.prototype.getClassName=function(){return"HemisphericLight"},r.prototype.setDirectionToTarget=function(t){return this.direction=e.Vector3.Normalize(t.subtract(e.Vector3.Zero())),this.direction},r.prototype.getShadowGenerator=function(){return null},r.prototype.transferToEffect=function(t,r){var i=e.Vector3.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,r),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),r),this},r.prototype._getWorldMatrix=function(){return this._worldMatrix||(this._worldMatrix=e.Matrix.Identity()),this._worldMatrix},r.prototype.getTypeID=function(){return e.Light.LIGHTTYPEID_HEMISPHERICLIGHT},n([e.serializeAsColor3()],r.prototype,"groundColor",void 0),n([e.serializeAsVector3()],r.prototype,"direction",void 0),r})(e.Light);e.HemisphericLight=t})(i||(i={})),i.Effect.ShadersStore={defaultVertexShader:"#include<__decl__defaultVertex>\n\n#define CUSTOM_VERTEX_BEGIN\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nvarying vec2 vDiffuseUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nvarying vec2 vSpecularUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL \nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif \n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uv=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uv;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(DIFFUSE) && DIFFUSEDIRECTUV == 0\nif (vDiffuseInfos.x == 0.)\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM) && SPECULARDIRECTUV == 0\nif (vSpecularInfos.x == 0.)\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvSpecularUV=vec2(specularMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#include<bumpVertex>\n#include<clipPlaneVertex>\n#include<fogVertex>\n#include<shadowsVertex>[0..maxSimultaneousLights]\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n#include<pointCloudVertex>\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}\n",
defaultPixelShader:"#include<__decl__defaultFragment>\n#if defined(BUMP) || !defined(NORMAL)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define RECIPROCAL_PI2 0.15915494\nuniform vec3 vEyePosition;\nuniform vec3 vAmbientColor;\n\nvarying vec3 vPositionW;\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n\n#include<helperFunctions>\n\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<lightsFragmentFunctions>\n#include<shadowsFragmentFunctions>\n\n#ifdef DIFFUSE\n#if DIFFUSEDIRECTUV == 1\n#define vDiffuseUV vMainUV1\n#elif DIFFUSEDIRECTUV == 2\n#define vDiffuseUV vMainUV2\n#else\nvarying vec2 vDiffuseUV;\n#endif\nuniform sampler2D diffuseSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY \n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFRACTION\n#ifdef REFRACTIONMAP_3D\nuniform samplerCube refractionCubeSampler;\n#else\nuniform sampler2D refraction2DSampler;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\n#if SPECULARDIRECTUV == 1\n#define vSpecularUV vMainUV1\n#elif SPECULARDIRECTUV == 2\n#define vSpecularUV vMainUV2\n#else\nvarying vec2 vSpecularUV;\n#endif\nuniform sampler2D specularSampler;\n#endif\n#ifdef ALPHATEST\nuniform float alphaCutOff;\n#endif\n\n#include<fresnelFunction>\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\nuniform samplerCube reflectionCubeSampler;\n#else\nuniform sampler2D reflection2DSampler;\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#include<reflectionFunction>\n#endif\n#include<imageProcessingDeclaration>\n#include<imageProcessingFunctions>\n#include<bumpFragmentFunctions>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n#define CUSTOM_FRAGMENT_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\nvec3 viewDirectionW=normalize(vEyePosition-vPositionW);\n\nvec4 baseColor=vec4(1.,1.,1.,1.);\nvec3 diffuseColor=vDiffuseColor.rgb;\n\nfloat alpha=vDiffuseColor.a;\n\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));\n#endif\n#include<bumpFragment>\n#ifdef TWOSIDEDLIGHTING\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n#ifdef DIFFUSE\nbaseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);\n#ifdef ALPHATEST\nif (baseColor.a<alphaCutOff)\ndiscard;\n#endif\n#ifdef ALPHAFROMDIFFUSE\nalpha*=baseColor.a;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\nbaseColor.rgb*=vDiffuseInfos.y;\n#endif\n#include<depthPrePass>\n#ifdef VERTEXCOLOR\nbaseColor.rgb*=vColor.rgb;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE\n\nvec3 baseAmbientColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nbaseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n\n#ifdef SPECULARTERM\nfloat glossiness=vSpecularColor.a;\nvec3 specularColor=vSpecularColor.rgb;\n#ifdef SPECULAR\nvec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);\nspecularColor=specularMapColor.rgb;\n#ifdef GLOSSINESS\nglossiness=glossiness*specularMapColor.a;\n#endif\n#endif\n#else\nfloat glossiness=0.;\n#endif\n\nvec3 diffuseBase=vec3(0.,0.,0.);\nlightingInfo info;\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\nfloat shadow=1.;\n#ifdef LIGHTMAP\nvec3 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset).rgb*vLightmapInfos.y;\n#endif\n#include<lightFragment>[0..maxSimultaneousLights]\n\nvec3 refractionColor=vec3(0.,0.,0.);\n#ifdef REFRACTION\nvec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));\n#ifdef REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nif (dot(refractionVector,viewDirectionW)<1.0) {\nrefractionColor=textureCube(refractionCubeSampler,refractionVector).rgb;\n}\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\nrefractionColor=texture2D(refraction2DSampler,refractionCoords).rgb;\n#endif\n#ifdef IS_REFRACTION_LINEAR\nrefractionColor=toGammaSpace(refractionColor);\n#endif\nrefractionColor*=vRefractionInfos.x;\n#endif\n\nvec3 reflectionColor=vec3(0.,0.,0.);\n#ifdef REFLECTION\nvec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#ifdef REFLECTIONMAP_3D\n#ifdef ROUGHNESS\nfloat bias=vReflectionInfos.y;\n#ifdef SPECULARTERM\n#ifdef SPECULAR\n#ifdef GLOSSINESS\nbias*=(1.0-specularMapColor.a);\n#endif\n#endif\n#endif\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias).rgb;\n#else\nreflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW).rgb;\n#endif\n#else\nvec2 coords=vReflectionUVW.xy;\n#ifdef REFLECTIONMAP_PROJECTION\ncoords/=vReflectionUVW.z;\n#endif\ncoords.y=1.0-coords.y;\nreflectionColor=texture2D(reflection2DSampler,coords).rgb;\n#endif\n#ifdef IS_REFLECTION_LINEAR\nreflectionColor=toGammaSpace(reflectionColor);\n#endif\nreflectionColor*=vReflectionInfos.x;\n#ifdef REFLECTIONFRESNEL\nfloat reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);\n#ifdef REFLECTIONFRESNELFROMSPECULAR\n#ifdef SPECULARTERM\nreflectionColor*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#else\nreflectionColor*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;\n#endif\n#endif\n#endif\n#ifdef REFRACTIONFRESNEL\nfloat refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);\nrefractionColor*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#ifdef OPACITYRGB\nopacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);\nalpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;\n#else\nalpha*=opacityMap.a*vOpacityInfos.y;\n#endif\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#ifdef OPACITYFRESNEL\nfloat opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);\nalpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;\n#endif\n\nvec3 emissiveColor=vEmissiveColor;\n#ifdef EMISSIVE\nemissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;\n#endif\n#ifdef EMISSIVEFRESNEL\nfloat emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);\nemissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;\n#endif\n\n#ifdef DIFFUSEFRESNEL\nfloat diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);\ndiffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\n#ifdef LINKEMISSIVEWITHDIFFUSE\nvec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#else\nvec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;\n#endif\n#endif\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase*specularColor;\n#ifdef SPECULAROVERALPHA\nalpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n#else\nvec3 finalSpecular=vec3(0.0);\n#endif\n#ifdef REFLECTIONOVERALPHA\nalpha=clamp(alpha+dot(reflectionColor,vec3(0.3,0.59,0.11)),0.,1.);\n#endif\n\n#ifdef EMISSIVEASILLUMINATION\nvec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+emissiveColor+refractionColor,0.0,1.0),alpha);\n#else\nvec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor+refractionColor,alpha);\n#endif\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\ncolor.rgb*=lightmapColor;\n#else\ncolor.rgb+=lightmapColor;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\ncolor.rgb=max(color.rgb,0.);\n#include<logDepthFragment>\n#include<fogFragment>\n\n\n#ifdef IMAGEPROCESSINGPOSTPROCESS\ncolor.rgb=toLinearSpace(color.rgb);\n#else\n#ifdef IMAGEPROCESSING\ncolor.rgb=toLinearSpace(color.rgb);\ncolor=applyImageProcessing(color);\n#endif\n#endif\n#ifdef PREMULTIPLYALPHA\n\ncolor.rgb*=color.a;\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\ngl_FragColor=color;\n}\n",colorVertexShader:"\nattribute vec3 position;\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<bonesDeclaration>\n\nuniform mat4 viewProjection;\nuniform mat4 world;\n\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\nvoid main(void) {\nmat4 finalWorld=world;\n#include<bonesVertex>\ngl_Position=viewProjection*finalWorld*vec4(position,1.0);\n#ifdef VERTEXCOLOR\n\nvColor=color;\n#endif\n}",colorPixelShader:"#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#else\nuniform vec4 color;\n#endif\nvoid main(void) {\n#ifdef VERTEXCOLOR\ngl_FragColor=vColor;\n#else\ngl_FragColor=color;\n#endif\n}"},i.Effect.IncludesShadersStore={depthPrePass:"#ifdef DEPTHPREPASS\ngl_FragColor=vec4(0.,0.,0.,1.0);\nreturn;\n#endif",bonesDeclaration:"#if NUM_BONE_INFLUENCERS>0\nuniform mat4 mBones[BonesPerMesh];\nattribute vec4 matricesIndices;\nattribute vec4 matricesWeights;\n#if NUM_BONE_INFLUENCERS>4\nattribute vec4 matricesIndicesExtra;\nattribute vec4 matricesWeightsExtra;\n#endif\n#endif",instancesDeclaration:"#ifdef INSTANCES\nattribute vec4 world0;\nattribute vec4 world1;\nattribute vec4 world2;\nattribute vec4 world3;\n#else\nuniform mat4 world;\n#endif",pointCloudVertexDeclaration:"#ifdef POINTSIZE\nuniform float pointSize;\n#endif",bumpVertexDeclaration:"#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#endif\n",clipPlaneVertexDeclaration:"#ifdef CLIPPLANE\nuniform vec4 vClipPlane;\nvarying float fClipDistance;\n#endif",fogVertexDeclaration:"#ifdef FOG\nvarying vec3 vFogDistance;\n#endif",morphTargetsVertexGlobalDeclaration:"#ifdef MORPHTARGETS\nuniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];\n#endif",morphTargetsVertexDeclaration:"#ifdef MORPHTARGETS\nattribute vec3 position{X};\n#ifdef MORPHTARGETS_NORMAL\nattribute vec3 normal{X};\n#endif\n#ifdef MORPHTARGETS_TANGENT\nattribute vec3 tangent{X};\n#endif\n#endif",logDepthDeclaration:"#ifdef LOGARITHMICDEPTH\nuniform float logarithmicDepthConstant;\nvarying float vFragmentDepth;\n#endif",morphTargetsVertex:"#ifdef MORPHTARGETS\npositionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];\n#ifdef MORPHTARGETS_NORMAL\nnormalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];\n#endif\n#ifdef MORPHTARGETS_TANGENT\ntangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];\n#endif\n#endif",instancesVertex:"#ifdef INSTANCES\nmat4 finalWorld=mat4(world0,world1,world2,world3);\n#else\nmat4 finalWorld=world;\n#endif",bonesVertex:"#if NUM_BONE_INFLUENCERS>0\nmat4 influence;\ninfluence=mBones[int(matricesIndices[0])]*matricesWeights[0];\n#if NUM_BONE_INFLUENCERS>1\ninfluence+=mBones[int(matricesIndices[1])]*matricesWeights[1];\n#endif \n#if NUM_BONE_INFLUENCERS>2\ninfluence+=mBones[int(matricesIndices[2])]*matricesWeights[2];\n#endif \n#if NUM_BONE_INFLUENCERS>3\ninfluence+=mBones[int(matricesIndices[3])]*matricesWeights[3];\n#endif \n#if NUM_BONE_INFLUENCERS>4\ninfluence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];\n#endif \n#if NUM_BONE_INFLUENCERS>5\ninfluence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];\n#endif \n#if NUM_BONE_INFLUENCERS>6\ninfluence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];\n#endif \n#if NUM_BONE_INFLUENCERS>7\ninfluence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];\n#endif \nfinalWorld=finalWorld*influence;\n#endif",bumpVertex:"#if defined(BUMP) || defined(PARALLAX)\n#if defined(TANGENT) && defined(NORMAL)\nvec3 tbnNormal=normalize(normalUpdated);\nvec3 tbnTangent=normalize(tangentUpdated.xyz);\nvec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;\nvTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);\n#endif\n#endif",clipPlaneVertex:"#ifdef CLIPPLANE\nfClipDistance=dot(worldPos,vClipPlane);\n#endif",fogVertex:"#ifdef FOG\nvFogDistance=(view*worldPos).xyz;\n#endif",shadowsVertex:"#ifdef SHADOWS\n#if defined(SHADOW{X}) && !defined(SHADOWCUBE{X})\nvPositionFromLight{X}=lightMatrix{X}*worldPos;\nvDepthMetric{X}=((vPositionFromLight{X}.z+light{X}.depthValues.x)/(light{X}.depthValues.y));\n#endif\n#endif",pointCloudVertex:"#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif",logDepthVertex:"#ifdef LOGARITHMICDEPTH\nvFragmentDepth=1.0+gl_Position.w;\ngl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;\n#endif",helperFunctions:"const float PI=3.1415926535897932384626433832795;\nconst float LinearEncodePowerApprox=2.2;\nconst float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;\nconst vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);\nmat3 transposeMat3(mat3 inMatrix) {\nvec3 i0=inMatrix[0];\nvec3 i1=inMatrix[1];\nvec3 i2=inMatrix[2];\nmat3 outMatrix=mat3(\nvec3(i0.x,i1.x,i2.x),\nvec3(i0.y,i1.y,i2.y),\nvec3(i0.z,i1.z,i2.z)\n);\nreturn outMatrix;\n}\n\nmat3 inverseMat3(mat3 inMatrix) {\nfloat a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];\nfloat a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];\nfloat a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];\nfloat b01=a22*a11-a12*a21;\nfloat b11=-a22*a10+a12*a20;\nfloat b21=a21*a10-a11*a20;\nfloat det=a00*b01+a01*b11+a02*b21;\nreturn mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),\nb11,(a22*a00-a02*a20),(-a12*a00+a02*a10),\nb21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;\n}\nfloat computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)\n{\nfloat mask=smoothstep(1.0-frustumEdgeFalloff,1.0,clamp(dot(clipSpace,clipSpace),0.,1.));\nreturn mix(value,1.0,mask);\n}\nvec3 applyEaseInOut(vec3 x){\nreturn x*x*(3.0-2.0*x);\n}\nvec3 toLinearSpace(vec3 color)\n{\nreturn pow(color,vec3(LinearEncodePowerApprox));\n}\nvec3 toGammaSpace(vec3 color)\n{\nreturn pow(color,vec3(GammaEncodePowerApprox));\n}\nfloat square(float value)\n{\nreturn value*value;\n}\nfloat getLuminance(vec3 color)\n{\nreturn clamp(dot(color,LuminanceEncodeApprox),0.,1.);\n}\n\nfloat getRand(vec2 seed) {\nreturn fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);\n}\nfloat dither(vec2 seed,float varianceAmount) {\nfloat rand=getRand(seed);\nfloat dither=mix(-varianceAmount/255.0,varianceAmount/255.0,rand);\nreturn dither;\n}\n\nconst float rgbdMaxRange=255.0;\nvec4 toRGBD(vec3 color) {\nfloat maxRGB=max(0.0000001,max(color.r,max(color.g,color.b)));\nfloat D=max(rgbdMaxRange/maxRGB,1.);\nD=clamp(floor(D)/255.0,0.,1.);\n\nvec3 rgb=color.rgb*D;\n\nrgb=toGammaSpace(rgb);\nreturn vec4(rgb,D); \n}\nvec3 fromRGBD(vec4 rgbd) {\n\nrgbd.rgb=toLinearSpace(rgbd.rgb);\n\nreturn rgbd.rgb/rgbd.a;\n}",lightFragmentDeclaration:"#ifdef LIGHT{X}\nuniform vec4 vLightData{X};\nuniform vec4 vLightDiffuse{X};\n#ifdef SPECULARTERM\nuniform vec3 vLightSpecular{X};\n#else\nvec3 vLightSpecular{X}=vec3(0.);\n#endif\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X};\n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\nuniform vec4 shadowsInfo{X};\nuniform vec2 depthValues{X};\n#endif\n#ifdef SPOTLIGHT{X}\nuniform vec4 vLightDirection{X};\n#endif\n#ifdef HEMILIGHT{X}\nuniform vec3 vLightGround{X};\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#endif",lightsFragmentFunctions:"\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef NDOTL\nfloat ndl;\n#endif\n};\nlightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 lightVectorW;\nfloat attenuation=1.0;\nif (lightData.w == 0.)\n{\nvec3 direction=lightData.xyz-vPositionW;\nattenuation=max(0.,1.0-length(direction)/range);\nlightVectorW=normalize(direction);\n}\nelse\n{\nlightVectorW=normalize(-lightData.xyz);\n}\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nlightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {\nlightingInfo result;\nvec3 direction=lightData.xyz-vPositionW;\nvec3 lightVectorW=normalize(direction);\nfloat attenuation=max(0.,1.0-length(direction)/range);\n\nfloat cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));\nif (cosAngle>=lightDirection.w)\n{\ncosAngle=max(0.,pow(cosAngle,lightData.w));\nattenuation*=cosAngle;\n\nfloat ndl=max(0.,dot(vNormal,lightVectorW));\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=ndl*diffuseColor*attenuation;\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightVectorW);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor*attenuation;\n#endif\nreturn result;\n}\nresult.diffuse=vec3(0.);\n#ifdef SPECULARTERM\nresult.specular=vec3(0.);\n#endif\n#ifdef NDOTL\nresult.ndl=0.;\n#endif\nreturn result;\n}\nlightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {\nlightingInfo result;\n\nfloat ndl=dot(vNormal,lightData.xyz)*0.5+0.5;\n#ifdef NDOTL\nresult.ndl=ndl;\n#endif\nresult.diffuse=mix(groundColor,diffuseColor,ndl);\n#ifdef SPECULARTERM\n\nvec3 angleW=normalize(viewDirectionW+lightData.xyz);\nfloat specComp=max(0.,dot(vNormal,angleW));\nspecComp=pow(specComp,max(1.,glossiness));\nresult.specular=specComp*specularColor;\n#endif\nreturn result;\n}\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn textureColor;\n}",lightUboDeclaration:"#ifdef LIGHT{X}\nuniform Light{X}\n{\nvec4 vLightData;\nvec4 vLightDiffuse;\nvec3 vLightSpecular;\n#ifdef SPOTLIGHT{X}\nvec4 vLightDirection;\n#endif\n#ifdef HEMILIGHT{X}\nvec3 vLightGround;\n#endif\nvec4 shadowsInfo;\nvec2 depthValues;\n} light{X};\n#ifdef PROJECTEDLIGHTTEXTURE{X}\nuniform mat4 textureProjectionMatrix{X};\nuniform sampler2D projectionLightSampler{X};\n#endif\n#ifdef SHADOW{X}\n#if defined(SHADOWCUBE{X})\nuniform samplerCube shadowSampler{X}; \n#else\nvarying vec4 vPositionFromLight{X};\nvarying float vDepthMetric{X};\n#if defined(SHADOWPCSS{X})\nuniform highp sampler2DShadow shadowSampler{X};\nuniform highp sampler2D depthSampler{X};\n#elif defined(SHADOWPCF{X})\nuniform highp sampler2DShadow shadowSampler{X};\n#else\nuniform sampler2D shadowSampler{X};\n#endif\nuniform mat4 lightMatrix{X};\n#endif\n#endif\n#endif",defaultVertexDeclaration:"\nuniform mat4 viewProjection;\nuniform mat4 view;\n#ifdef DIFFUSE\nuniform mat4 diffuseMatrix;\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\nuniform mat4 specularMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n",defaultFragmentDeclaration:"uniform vec4 vDiffuseColor;\n#ifdef SPECULARTERM\nuniform vec4 vSpecularColor;\n#endif\nuniform vec3 vEmissiveColor;\n\n#ifdef DIFFUSE\nuniform vec2 vDiffuseInfos;\n#endif\n#ifdef AMBIENT\nuniform vec2 vAmbientInfos;\n#endif\n#ifdef OPACITY \nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)\nuniform mat4 view;\n#endif\n#ifdef REFRACTION\nuniform vec4 vRefractionInfos;\n#ifndef REFRACTIONMAP_3D\nuniform mat4 refractionMatrix;\n#endif\n#ifdef REFRACTIONFRESNEL\nuniform vec4 refractionLeftColor;\nuniform vec4 refractionRightColor;\n#endif\n#endif\n#if defined(SPECULAR) && defined(SPECULARTERM)\nuniform vec2 vSpecularInfos;\n#endif\n#ifdef DIFFUSEFRESNEL\nuniform vec4 diffuseLeftColor;\nuniform vec4 diffuseRightColor;\n#endif\n#ifdef OPACITYFRESNEL\nuniform vec4 opacityParts;\n#endif\n#ifdef EMISSIVEFRESNEL\nuniform vec4 emissiveLeftColor;\nuniform vec4 emissiveRightColor;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REFLECTIONMAP_SKYBOX\n#else\n#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION)\nuniform mat4 reflectionMatrix;\n#endif\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize; \n#endif\n#endif\n#ifdef REFLECTIONFRESNEL\nuniform vec4 reflectionLeftColor;\nuniform vec4 reflectionRightColor;\n#endif\n#endif",defaultUboDeclaration:"layout(std140,column_major) uniform;\nuniform Material\n{\nvec4 diffuseLeftColor;\nvec4 diffuseRightColor;\nvec4 opacityParts;\nvec4 reflectionLeftColor;\nvec4 reflectionRightColor;\nvec4 refractionLeftColor;\nvec4 refractionRightColor;\nvec4 emissiveLeftColor; \nvec4 emissiveRightColor;\nvec2 vDiffuseInfos;\nvec2 vAmbientInfos;\nvec2 vOpacityInfos;\nvec2 vReflectionInfos;\nvec3 vReflectionPosition;\nvec3 vReflectionSize;\nvec2 vEmissiveInfos;\nvec2 vLightmapInfos;\nvec2 vSpecularInfos;\nvec3 vBumpInfos;\nmat4 diffuseMatrix;\nmat4 ambientMatrix;\nmat4 opacityMatrix;\nmat4 reflectionMatrix;\nmat4 emissiveMatrix;\nmat4 lightmapMatrix;\nmat4 specularMatrix;\nmat4 bumpMatrix; \nvec4 vTangentSpaceParams;\nmat4 refractionMatrix;\nvec4 vRefractionInfos;\nvec4 vSpecularColor;\nvec3 vEmissiveColor;\nvec4 vDiffuseColor;\nfloat pointSize; \n};\nuniform Scene {\nmat4 viewProjection;\nmat4 view;\n};",
shadowsFragmentFunctions:"#ifdef SHADOWS\n#ifndef SHADOWFLOAT\nfloat unpack(vec4 color)\n{\nconst vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);\nreturn dot(color,bit_shift);\n}\n#endif\nfloat computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadow=textureCube(shadowSampler,directionToLight).x;\n#endif\nif (depth>shadow)\n{\nreturn darkness;\n}\nreturn 1.0;\n}\nfloat computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\ndepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\nfloat visibility=1.;\nvec3 poissonDisk[4];\npoissonDisk[0]=vec3(-1.0,1.0,-1.0);\npoissonDisk[1]=vec3(1.0,-1.0,-1.0);\npoissonDisk[2]=vec3(-1.0,-1.0,-1.0);\npoissonDisk[3]=vec3(1.0,-1.0,1.0);\n\n#ifndef SHADOWFLOAT\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;\nif (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;\n#else\nif (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;\nif (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;\n#endif\nreturn min(1.0,visibility+darkness);\n}\nfloat computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); \nreturn esm;\n}\nfloat computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)\n{\nvec3 directionToLight=vPositionW-lightPosition;\nfloat depth=length(directionToLight);\ndepth=(depth+depthValues.x)/(depthValues.y);\nfloat shadowPixelDepth=clamp(depth,0.,1.0);\ndirectionToLight=normalize(directionToLight);\ndirectionToLight.y=-directionToLight.y;\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));\n#else\nfloat shadowMapSample=textureCube(shadowSampler,directionToLight).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn esm;\n}\nfloat computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadow=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadow=texture2D(shadowSampler,uv).x;\n#endif\nif (shadowPixelDepth>shadow)\n{\nreturn computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff);\n}\nreturn 1.;\n}\nfloat computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\nfloat visibility=1.;\nvec2 poissonDisk[4];\npoissonDisk[0]=vec2(-0.94201624,-0.39906216);\npoissonDisk[1]=vec2(0.94558609,-0.76890725);\npoissonDisk[2]=vec2(-0.094184101,-0.92938870);\npoissonDisk[3]=vec2(0.34495938,0.29387760);\n\n#ifndef SHADOWFLOAT\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<shadowPixelDepth) visibility-=0.25;\nif (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<shadowPixelDepth) visibility-=0.25;\n#else\nif (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<shadowPixelDepth) visibility-=0.25;\nif (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<shadowPixelDepth) visibility-=0.25;\n#endif\nreturn computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0);\n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)\n{\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec2 uv=0.5*clipSpace.xy+vec2(0.5);\nif (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)\n{\nreturn 1.0;\n}\nfloat shadowPixelDepth=clamp(depthMetric,0.,1.0); \n#ifndef SHADOWFLOAT\nfloat shadowMapSample=unpack(texture2D(shadowSampler,uv));\n#else\nfloat shadowMapSample=texture2D(shadowSampler,uv).x;\n#endif\nfloat esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);\nreturn computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);\n}\n#ifdef WEBGL2\n\nfloat computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nfloat shadow=texture2D(shadowSampler,uvDepth);\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n\n\n\nfloat computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \n\n\n\n\nvec2 uvw0=3.-2.*st;\nvec2 uvw1=1.+2.*st;\nvec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;\nvec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));\nshadow=shadow/16.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\n\n\n\nfloat computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nvec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; \nuv+=0.5; \nvec2 st=fract(uv); \nvec2 base_uv=floor(uv)-0.5; \nbase_uv*=shadowMapSizeAndInverse.y; \n\n\nvec2 uvw0=4.-3.*st;\nvec2 uvw1=vec2(7.);\nvec2 uvw2=1.+3.*st;\nvec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;\nvec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;\nfloat shadow=0.;\nshadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));\nshadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));\nshadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z));\nshadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));\nshadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));\nshadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z));\nshadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z));\nshadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z));\nshadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z));\nshadow=shadow/144.;\nshadow=mix(darkness,1.,shadow);\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\nconst vec3 PoissonSamplers32[64]=vec3[64](\nvec3(0.06407013,0.05409927,0.),\nvec3(0.7366577,0.5789394,0.),\nvec3(-0.6270542,-0.5320278,0.),\nvec3(-0.4096107,0.8411095,0.),\nvec3(0.6849564,-0.4990818,0.),\nvec3(-0.874181,-0.04579735,0.),\nvec3(0.9989998,0.0009880066,0.),\nvec3(-0.004920578,-0.9151649,0.),\nvec3(0.1805763,0.9747483,0.),\nvec3(-0.2138451,0.2635818,0.),\nvec3(0.109845,0.3884785,0.),\nvec3(0.06876755,-0.3581074,0.),\nvec3(0.374073,-0.7661266,0.),\nvec3(0.3079132,-0.1216763,0.),\nvec3(-0.3794335,-0.8271583,0.),\nvec3(-0.203878,-0.07715034,0.),\nvec3(0.5912697,0.1469799,0.),\nvec3(-0.88069,0.3031784,0.),\nvec3(0.5040108,0.8283722,0.),\nvec3(-0.5844124,0.5494877,0.),\nvec3(0.6017799,-0.1726654,0.),\nvec3(-0.5554981,0.1559997,0.),\nvec3(-0.3016369,-0.3900928,0.),\nvec3(-0.5550632,-0.1723762,0.),\nvec3(0.925029,0.2995041,0.),\nvec3(-0.2473137,0.5538505,0.),\nvec3(0.9183037,-0.2862392,0.),\nvec3(0.2469421,0.6718712,0.),\nvec3(0.3916397,-0.4328209,0.),\nvec3(-0.03576927,-0.6220032,0.),\nvec3(-0.04661255,0.7995201,0.),\nvec3(0.4402924,0.3640312,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.),\nvec3(0.,0.,0.)\n);\nconst vec3 PoissonSamplers64[64]=vec3[64](\nvec3(-0.613392,0.617481,0.),\nvec3(0.170019,-0.040254,0.),\nvec3(-0.299417,0.791925,0.),\nvec3(0.645680,0.493210,0.),\nvec3(-0.651784,0.717887,0.),\nvec3(0.421003,0.027070,0.),\nvec3(-0.817194,-0.271096,0.),\nvec3(-0.705374,-0.668203,0.),\nvec3(0.977050,-0.108615,0.),\nvec3(0.063326,0.142369,0.),\nvec3(0.203528,0.214331,0.),\nvec3(-0.667531,0.326090,0.),\nvec3(-0.098422,-0.295755,0.),\nvec3(-0.885922,0.215369,0.),\nvec3(0.566637,0.605213,0.),\nvec3(0.039766,-0.396100,0.),\nvec3(0.751946,0.453352,0.),\nvec3(0.078707,-0.715323,0.),\nvec3(-0.075838,-0.529344,0.),\nvec3(0.724479,-0.580798,0.),\nvec3(0.222999,-0.215125,0.),\nvec3(-0.467574,-0.405438,0.),\nvec3(-0.248268,-0.814753,0.),\nvec3(0.354411,-0.887570,0.),\nvec3(0.175817,0.382366,0.),\nvec3(0.487472,-0.063082,0.),\nvec3(-0.084078,0.898312,0.),\nvec3(0.488876,-0.783441,0.),\nvec3(0.470016,0.217933,0.),\nvec3(-0.696890,-0.549791,0.),\nvec3(-0.149693,0.605762,0.),\nvec3(0.034211,0.979980,0.),\nvec3(0.503098,-0.308878,0.),\nvec3(-0.016205,-0.872921,0.),\nvec3(0.385784,-0.393902,0.),\nvec3(-0.146886,-0.859249,0.),\nvec3(0.643361,0.164098,0.),\nvec3(0.634388,-0.049471,0.),\nvec3(-0.688894,0.007843,0.),\nvec3(0.464034,-0.188818,0.),\nvec3(-0.440840,0.137486,0.),\nvec3(0.364483,0.511704,0.),\nvec3(0.034028,0.325968,0.),\nvec3(0.099094,-0.308023,0.),\nvec3(0.693960,-0.366253,0.),\nvec3(0.678884,-0.204688,0.),\nvec3(0.001801,0.780328,0.),\nvec3(0.145177,-0.898984,0.),\nvec3(0.062655,-0.611866,0.),\nvec3(0.315226,-0.604297,0.),\nvec3(-0.780145,0.486251,0.),\nvec3(-0.371868,0.882138,0.),\nvec3(0.200476,0.494430,0.),\nvec3(-0.494552,-0.711051,0.),\nvec3(0.612476,0.705252,0.),\nvec3(-0.578845,-0.768792,0.),\nvec3(-0.772454,-0.090976,0.),\nvec3(0.504440,0.372295,0.),\nvec3(0.155736,0.065157,0.),\nvec3(0.391522,0.849605,0.),\nvec3(-0.620106,-0.328104,0.),\nvec3(0.789239,-0.419965,0.),\nvec3(-0.545396,0.538133,0.),\nvec3(-0.178564,-0.596057,0.)\n);\n\n\n\n\n\nfloat computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)\n{\nif (depthMetric>1.0 || depthMetric<0.0) {\nreturn 1.0;\n}\nvec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;\nvec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));\nfloat blockerDepth=0.0;\nfloat sumBlockerDepth=0.0;\nfloat numBlocker=0.0;\nfor (int i=0; i<searchTapCount; i ++) {\nblockerDepth=texture(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy)).r;\nif (blockerDepth<depthMetric) {\nsumBlockerDepth+=blockerDepth;\nnumBlocker++;\n}\n}\nif (numBlocker<1.0) {\nreturn 1.0;\n}\nfloat avgBlockerDepth=sumBlockerDepth/numBlocker;\n\nfloat AAOffset=shadowMapSizeInverse*10.;\n\n\nfloat penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);\nfloat filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;\nfloat random=getRand(vPositionFromLight.xy);\nfloat rotationAngle=random*3.1415926;\nvec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));\nfloat shadow=0.;\nfor (int i=0; i<pcfTapCount; i++) {\nvec3 offset=poissonSamplers[i];\n\noffset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);\nshadow+=texture2D(shadowSampler,uvDepth+offset*filterRadius);\n}\nshadow/=float(pcfTapCount);\n\nshadow=mix(shadow,1.,depthMetric-avgBlockerDepth);\n\nshadow=mix(darkness,1.,shadow);\n\nreturn computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);\n}\nfloat computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);\n}\nfloat computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);\n}\nfloat computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)\n{\nreturn computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);\n}\n#endif\n#endif\n",fresnelFunction:"#ifdef FRESNEL\nfloat computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)\n{\nfloat fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);\nreturn clamp(fresnelTerm,0.,1.);\n}\n#endif",reflectionFunction:"#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\nvec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {\n\nvec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;\nvec3 halfSize=cubeSize*0.5;\nvec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;\nvec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;\n\nvec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);\n\nfloat distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);\n\nvec3 intersectPositionWS=vertexPos+origVec*distance;\n\nreturn intersectPositionWS-cubePos;\n}\n#endif\nvec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)\n{\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvec3 direction=vDirectionW;\nfloat t=clamp(direction.y*-0.5+0.5,0.,1.0);\nfloat s=atan(direction.z,direction.x)*RECIPROCAL_PI2+0.5;\n#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED\nreturn vec3(1.0-s,t,0);\n#else\nreturn vec3(s,t,0);\n#endif\n#endif\n#ifdef REFLECTIONMAP_EQUIRECTANGULAR\nvec3 cameraToVertex=normalize(worldPos.xyz-vEyePosition.xyz);\nvec3 r=reflect(cameraToVertex,worldNormal);\nfloat t=clamp(r.y*-0.5+0.5,0.,1.0);\nfloat s=atan(r.z,r.x)*RECIPROCAL_PI2+0.5;\nreturn vec3(s,t,0);\n#endif\n#ifdef REFLECTIONMAP_SPHERICAL\nvec3 viewDir=normalize(vec3(view*worldPos));\nvec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));\nvec3 r=reflect(viewDir,viewNormal);\nr.z=r.z-1.0;\nfloat m=2.0*length(r);\nreturn vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);\n#endif\n#ifdef REFLECTIONMAP_PLANAR\nvec3 viewDir=worldPos.xyz-vEyePosition.xyz;\nvec3 coords=normalize(reflect(viewDir,worldNormal));\nreturn vec3(reflectionMatrix*vec4(coords,1));\n#endif\n#ifdef REFLECTIONMAP_CUBIC\nvec3 viewDir=normalize(worldPos.xyz-vEyePosition.xyz);\n\nvec3 coords=reflect(viewDir,worldNormal);\n#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC\ncoords=parallaxCorrectNormal(worldPos.xyz,coords,vReflectionSize,vReflectionPosition);\n#endif\ncoords=vec3(reflectionMatrix*vec4(coords,0));\n#ifdef INVERTCUBICMAP\ncoords.y*=-1.0;\n#endif\nreturn coords;\n#endif\n#ifdef REFLECTIONMAP_PROJECTION\nreturn vec3(reflectionMatrix*(view*worldPos));\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nreturn vPositionUVW;\n#endif\n#ifdef REFLECTIONMAP_EXPLICIT\nreturn vec3(0,0,0);\n#endif\n}",imageProcessingDeclaration:"#ifdef EXPOSURE\nuniform float exposureLinear;\n#endif\n#ifdef CONTRAST\nuniform float contrast;\n#endif\n#ifdef VIGNETTE\nuniform vec2 vInverseScreenSize;\nuniform vec4 vignetteSettings1;\nuniform vec4 vignetteSettings2;\n#endif\n#ifdef COLORCURVES\nuniform vec4 vCameraColorCurveNegative;\nuniform vec4 vCameraColorCurveNeutral;\nuniform vec4 vCameraColorCurvePositive;\n#endif\n#ifdef COLORGRADING\n#ifdef COLORGRADING3D\nuniform highp sampler3D txColorTransform;\n#else\nuniform sampler2D txColorTransform;\n#endif\nuniform vec4 colorTransformSettings;\n#endif",imageProcessingFunctions:"#if defined(COLORGRADING) && !defined(COLORGRADING3D)\n\nvec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)\n{\nfloat sliceSize=2.0*sampler3dSetting.x; \n#ifdef SAMPLER3DGREENDEPTH\nfloat sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;\n#else\nfloat sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;\n#endif\nfloat sliceInteger=floor(sliceContinuous);\n\n\nfloat sliceFraction=sliceContinuous-sliceInteger;\n#ifdef SAMPLER3DGREENDEPTH\nvec2 sliceUV=color.rb;\n#else\nvec2 sliceUV=color.rg;\n#endif\nsliceUV.x*=sliceSize;\nsliceUV.x+=sliceInteger*sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice0Color=texture2D(colorTransform,sliceUV);\nsliceUV.x+=sliceSize;\nsliceUV=clamp(sliceUV,0.,1.);\nvec4 slice1Color=texture2D(colorTransform,sliceUV);\nvec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);\n#ifdef SAMPLER3DBGRMAP\ncolor.rgb=result.rgb;\n#else\ncolor.rgb=result.bgr;\n#endif\nreturn color;\n}\n#endif\nvec4 applyImageProcessing(vec4 result) {\n#ifdef EXPOSURE\nresult.rgb*=exposureLinear;\n#endif\n#ifdef VIGNETTE\n\nvec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;\nviewportXY=viewportXY*2.0-1.0;\nvec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);\nfloat vignetteTerm=dot(vignetteXY1,vignetteXY1);\nfloat vignette=pow(vignetteTerm,vignetteSettings2.w);\n\nvec3 vignetteColor=vignetteSettings2.rgb;\n#ifdef VIGNETTEBLENDMODEMULTIPLY\nvec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);\nresult.rgb*=vignetteColorMultiplier;\n#endif\n#ifdef VIGNETTEBLENDMODEOPAQUE\nresult.rgb=mix(vignetteColor,result.rgb,vignette);\n#endif\n#endif\n#ifdef TONEMAPPING\nconst float tonemappingCalibration=1.590579;\nresult.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);\n#endif\n\nresult.rgb=toGammaSpace(result.rgb);\nresult.rgb=clamp(result.rgb,0.0,1.0);\n#ifdef CONTRAST\n\nvec3 resultHighContrast=applyEaseInOut(result.rgb);\nif (contrast<1.0) {\n\nresult.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);\n} else {\n\nresult.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);\n}\n#endif\n\n#ifdef COLORGRADING\nvec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;\n#ifdef COLORGRADING3D\nvec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;\n#else\nvec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;\n#endif\nresult.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);\n#endif\n#ifdef COLORCURVES\n\nfloat luma=getLuminance(result.rgb);\nvec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));\nvec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;\nresult.rgb*=colorCurve.rgb;\nresult.rgb=mix(vec3(luma),result.rgb,colorCurve.a);\n#endif\nreturn result;\n}",bumpFragmentFunctions:"#ifdef BUMP\n#if BUMPDIRECTUV == 1\n#define vBumpUV vMainUV1\n#elif BUMPDIRECTUV == 2\n#define vBumpUV vMainUV2\n#else\nvarying vec2 vBumpUV;\n#endif\nuniform sampler2D bumpSampler;\n#if defined(TANGENT) && defined(NORMAL) \nvarying mat3 vTBN;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat4 normalMatrix;\n#endif\n\nmat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv)\n{\n\nuv=gl_FrontFacing ? uv : -uv;\n\nvec3 dp1=dFdx(p);\nvec3 dp2=dFdy(p);\nvec2 duv1=dFdx(uv);\nvec2 duv2=dFdy(uv);\n\nvec3 dp2perp=cross(dp2,normal);\nvec3 dp1perp=cross(normal,dp1);\nvec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;\nvec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;\n\ntangent*=vTangentSpaceParams.x;\nbitangent*=vTangentSpaceParams.y;\n\nfloat invmax=inversesqrt(max(dot(tangent,tangent),dot(bitangent,bitangent)));\nreturn mat3(tangent*invmax,bitangent*invmax,normal);\n}\nvec3 perturbNormal(mat3 cotangentFrame,vec2 uv)\n{\nvec3 map=texture2D(bumpSampler,uv).xyz;\nmap=map*2.0-1.0;\n#ifdef NORMALXYSCALE\nmap=normalize(map*vec3(vBumpInfos.y,vBumpInfos.y,1.0));\n#endif\nreturn normalize(cotangentFrame*map);\n}\n#ifdef PARALLAX\nconst float minSamples=4.;\nconst float maxSamples=15.;\nconst int iMaxSamples=15;\n\nvec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {\nfloat parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;\nparallaxLimit*=parallaxScale;\nvec2 vOffsetDir=normalize(vViewDirCoT.xy);\nvec2 vMaxOffset=vOffsetDir*parallaxLimit;\nfloat numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));\nfloat stepSize=1.0/numSamples;\n\nfloat currRayHeight=1.0;\nvec2 vCurrOffset=vec2(0,0);\nvec2 vLastOffset=vec2(0,0);\nfloat lastSampledHeight=1.0;\nfloat currSampledHeight=1.0;\nfor (int i=0; i<iMaxSamples; i++)\n{\ncurrSampledHeight=texture2D(bumpSampler,vBumpUV+vCurrOffset).w;\n\nif (currSampledHeight>currRayHeight)\n{\nfloat delta1=currSampledHeight-currRayHeight;\nfloat delta2=(currRayHeight+stepSize)-lastSampledHeight;\nfloat ratio=delta1/(delta1+delta2);\nvCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;\n\nbreak;\n}\nelse\n{\ncurrRayHeight-=stepSize;\nvLastOffset=vCurrOffset;\nvCurrOffset+=stepSize*vMaxOffset;\nlastSampledHeight=currSampledHeight;\n}\n}\nreturn vCurrOffset;\n}\nvec2 parallaxOffset(vec3 viewDir,float heightScale)\n{\n\nfloat height=texture2D(bumpSampler,vBumpUV).w;\nvec2 texCoordOffset=heightScale*viewDir.xy*height;\nreturn -texCoordOffset;\n}\n#endif\n#endif",clipPlaneFragmentDeclaration:"#ifdef CLIPPLANE\nvarying float fClipDistance;\n#endif",fogFragmentDeclaration:"#ifdef FOG\n#define FOGMODE_NONE 0.\n#define FOGMODE_EXP 1.\n#define FOGMODE_EXP2 2.\n#define FOGMODE_LINEAR 3.\n#define E 2.71828\nuniform vec4 vFogInfos;\nuniform vec3 vFogColor;\nvarying vec3 vFogDistance;\nfloat CalcFogFactor()\n{\nfloat fogCoeff=1.0;\nfloat fogStart=vFogInfos.y;\nfloat fogEnd=vFogInfos.z;\nfloat fogDensity=vFogInfos.w;\nfloat fogDistance=length(vFogDistance);\nif (FOGMODE_LINEAR == vFogInfos.x)\n{\nfogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);\n}\nelse if (FOGMODE_EXP == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDensity);\n}\nelse if (FOGMODE_EXP2 == vFogInfos.x)\n{\nfogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);\n}\nreturn clamp(fogCoeff,0.0,1.0);\n}\n#endif",clipPlaneFragment:"#ifdef CLIPPLANE\nif (fClipDistance>0.0)\n{\ndiscard;\n}\n#endif",bumpFragment:"vec2 uvOffset=vec2(0.0,0.0);\n#if defined(BUMP) || defined(PARALLAX)\n#ifdef NORMALXYSCALE\nfloat normalScale=1.0;\n#else \nfloat normalScale=vBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBN=vTBN;\n#else\nmat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,vBumpUV);\n#endif\n#endif\n#ifdef PARALLAX\nmat3 invTBN=transposeMat3(TBN);\n#ifdef PARALLAXOCCLUSION\nuvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);\n#else\nuvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);\n#endif\n#endif\n#ifdef BUMP\n#ifdef OBJECTSPACE_NORMALMAP\nnormalW=normalize(texture2D(bumpSampler,vBumpUV).xyz*2.0-1.0);\nnormalW=normalize(mat3(normalMatrix)*normalW); \n#else\nnormalW=perturbNormal(TBN,vBumpUV+uvOffset);\n#endif\n#endif",
lightFragment:"#ifdef LIGHT{X}\n#if defined(SHADOWONLY) || (defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X}))\n\n#else\n#ifdef PBR\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,roughness,NdotV,specularEnvironmentR0,specularEnvironmentR90,geometricRoughnessFactor,NdotL);\n#endif\n#else\n#ifdef SPOTLIGHT{X}\ninfo=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#ifdef HEMILIGHT{X}\ninfo=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightGround,glossiness);\n#endif\n#if defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})\ninfo=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular,light{X}.vLightDiffuse.a,glossiness);\n#endif\n#endif\n#ifdef PROJECTEDLIGHTTEXTURE{X}\ninfo.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});\n#endif\n#endif\n#ifdef SHADOW{X}\n#ifdef SHADOWCLOSEESM{X}\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWESM{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);\n#else\nshadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPOISSON{X})\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCF{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#elif defined(SHADOWPCSS{X})\n#if defined(SHADOWLOWQUALITY{X})\nshadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#elif defined(SHADOWMEDIUMQUALITY{X})\nshadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#else\nshadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#else\n#if defined(SHADOWCUBE{X})\nshadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);\n#else\nshadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);\n#endif\n#endif\n#ifdef SHADOWONLY\n#ifndef SHADOWINUSE\n#define SHADOWINUSE\n#endif\nglobalShadow+=shadow;\nshadowLightCount+=1.0;\n#endif\n#else\nshadow=1.;\n#endif\n#ifndef SHADOWONLY\n#ifdef CUSTOMUSERLIGHTING\ndiffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);\n#ifdef SPECULARTERM\nspecularBase+=computeCustomSpecularLighting(info,specularBase,shadow);\n#endif\n#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})\ndiffuseBase+=lightmapColor*shadow;\n#ifdef SPECULARTERM\n#ifndef LIGHTMAPNOSPECULAR{X}\nspecularBase+=info.specular*shadow*lightmapColor;\n#endif\n#endif\n#else\ndiffuseBase+=info.diffuse*shadow;\n#ifdef SPECULARTERM\nspecularBase+=info.specular*shadow;\n#endif\n#endif\n#endif\n#endif",logDepthFragment:"#ifdef LOGARITHMICDEPTH\ngl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;\n#endif",fogFragment:"#ifdef FOG\nfloat fog=CalcFogFactor();\ncolor.rgb=fog*color.rgb+(1.0-fog)*vFogColor;\n#endif"};var a="undefined"!=typeof global?global:"undefined"!=typeof window?window:this;return a.BABYLON=i,void 0!==r&&(a.Earcut={earcut:r}),i}));